C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE FUNC
OBJECT MODULE PLACED IN .\Objects\func.obj
COMPILER INVOKED BY: C:\Users\M\AppData\Local\Keil\Keil_v4\C51\BIN\C51.EXE ..\lib\user\src\func.c LARGE OPTIMIZE(8,SPEED
                    -) BROWSE INCDIR(..\lib\n76e003\Include;..\lib\user\inc) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\Listings\func.lst
                    -) TABS(2) OBJECT(.\Objects\func.obj)

line level    source

   1          #include "func.h"
   2          #include "io.h"
   3          
   4          void timeCount(void);
   5          void workFunc(void);
   6          void displayInDifferentStates(void);
   7          void keyFunc(unsigned char timeBase);
   8          void setDisplayNumber(unsigned char num1,unsigned char num2,unsigned char num3);
   9          void displayLed(void);
  10          
  11          void parseDataFromBottom(void);
  12          void OneWire_init(void);
  13          void oneWire_write(unsigned char* buff,unsigned char len);
  14          unsigned char oneWire_read(unsigned char* buff);
  15          
  16          unsigned char figureSum(unsigned char* buff,unsigned char len);
  17          // void uart0_sendData(unsigned char* buff,unsigned char len);
  18          
  19          void init(void)
  20          {
  21   1        initAdc();
  22   1        OneWire_init();
  23   1      
  24   1        //ledå’Œæ•°ç ç®¡å…¨äº®
  25   1        ledEnable(4);
  26   1        dispalyNumber(98);
  27   1        //500ms
  28   1        Timer3_Delay100ms(15);
  29   1      
  30   1        global.device.nextStartLightCountDown = 1000;
  31   1        global.device.endLightCountDown = 1000;
  32   1        global.device.nextStartWaterCountDown = 1000;
  33   1        global.device.endWaterCountDown = 1000;
  34   1      }
  35          
  36          //
  37          //è¿è¡Œåœ¨ main.c çš„ Timer3_ISR ä¸­ï¼Œä¸­æ–­æ—¶é—´è®¾ç½®çš„æ˜¯ 1ms
  38          //
  39          void run(void)
  40          {
  41   1        static unsigned char flow = 0;
  42   1        static unsigned int count = 0;
  43   1        //æ˜¾ç¤ºåˆ·æ–°æ—¶é—´ç‰‡
  44   1        switch(flow)
  45   1        {
  46   2          case 0: { LED_ALL_OFF; LED_EN0; dispalyNumber(global.display.number1); } break;
  47   2          case 1: { LED_ALL_OFF; LED_EN1; dispalyNumber(global.display.number2); } break;
  48   2          case 2: { LED_ALL_OFF; LED_EN2; dispalyNumber(global.display.number3); } break;
  49   2          case 3: LED_ALL_OFF; displayLed(); break;
  50   2        }
  51   1        flow == 3? flow = 0:++flow;
  52   1      
  53   1        if(++count == 10) //10msè¿›å…¥ä¸€æ¬¡
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 2   

  54   1        {
  55   2          count = 0;
  56   2          keyFunc(10);  //æŒ‰é”®åŠŸèƒ½
  57   2        }
  58   1      
  59   1        timeCount();  //å¤„ç†ä¸€äº›è®¡æ—¶åŠŸèƒ½
  60   1      }
  61          
  62          //
  63          //è¿è¡Œåœ¨ main.c çš„ main å‡½æ•°çš„ while ä¸­
  64          //ä¸»è¦ç”¨äºå®Œæˆä¸€äº›è€—æ—¶æ“ä½œ
  65          //
  66          void runMain(void)
  67          {
  68   1        displayInDifferentStates(); //ä¸åŒçŠ¶æ€ä¸‹çš„æ˜¾ç¤º
  69   1        workFunc(); //ä¸€äº›è€—æ—¶æ“ä½œ
  70   1      }
  71          
  72          //
  73          //å¤„ç†ä¸€äº›è®¡æ—¶åŠŸèƒ½
  74          //è¯¥å‡½æ•°æ”¾åœ¨ run å‡½æ•°ä¸­ï¼Œæ ¹æ®å®šæ—¶å™¨çš„é…ç½®ï¼Œæ¯æ¯«ç§’è¿›å…¥ä¸€æ¬¡
  75          //è¯¥å‡½æ•°å†…çš„å˜é‡éƒ½æ˜¯ç±»ä¼¼çš„æ¨¡å¼ï¼Œå½“å˜é‡å¤§äºç­‰äº1çš„æ—¶å€™å¼€å§‹è®¡æ•°ï¼Œå½“è®¡æ•°åˆ°ä
             -¸€å®šå€¼çš„æ—¶å€™è§¦å‘æ ‡å¿—
  76          //
  77          void timeCount(void)
  78          {
  79   1        //////////////////////////////////////////å®šæ—¶å‘åº•æ¿å‘é€è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚çš„è®¡æ—¶/////////
             -//////////////////////
  80   1        if(++global.device.getDataTimeCOunt >= 2000)
  81   1        {
  82   2          global.device.getDataTimeCOunt = 0;
  83   2          if(global.device.getDataFlag == false)
  84   2          {
  85   3            global.device.getDataFlag = true;
  86   3          }
  87   2        }
  88   1        //////////////////////////////////////////ä¸²å£æ¨¡å—çš„è®¡æ—¶///////////////////////////////
  89   1        //ä¸²å£æ¥æ”¶è¶…æ—¶è®¡æ—¶
  90   1        if(global.uart.recTimeOutCount)
  91   1        {
  92   2          //å¤§äº100mså³ä¸ºè¶…æ—¶
  93   2          if(++global.uart.recTimeOutCount >= 100)
  94   2          {
  95   3            global.uart.recTimeOutCount = 0;
  96   3            global.uart.nowIndex = 0; //æ”¾å¼ƒå½“å‰æ¥æ”¶çš„æ•°æ®åŒ…ï¼Œå‡†å¤‡æ¥æ”¶ä¸‹ä¸€ç»„æ•°æ®åŒ…
  97   3          }
  98   2        }
  99   1        //ä¸²å£å‘é€åç­‰å¾…å“åº”è¶…æ—¶è®¡æ—¶
 100   1        if(global.uart.sendTimeOutCount)
 101   1        {
 102   2          //å¤§äº250mså³ä¸ºè¶…æ—¶
 103   2          if(++global.uart.sendTimeOutCount >= 250)
 104   2          {
 105   3            global.uart.sendTimeOutCount = 0;
 106   3            global.uart.sendTimeOutFlag = true; //ç½®ä½è¶…æ—¶æ ‡å¿—
 107   3          }
 108   2        }
 109   1        
 110   1        //////////////////////////////////////////ä¼ æ„Ÿå™¨æ¨¡å—çš„è®¡æ—¶///////////////////////////////
 111   1        if(global.work.getTemperatureSate == free)  //å¦‚æœæ²¡åœ¨è·å–ä¼ æ„Ÿå™¨æ•°æ®
 112   1        {
 113   2          if(++global.work.getTemperatureTimeCount >= 1000) //1s
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 3   

 114   2          {
 115   3            global.work.getTemperatureTimeCount = 0;
 116   3            global.work.getTemperatureSate = start; //å¼€å§‹è·å–ä¼ æ„Ÿå™¨æ•°æ®
 117   3          }
 118   2        }
 119   1        //////////////////////////////////////////èœ‚é¸£å™¨æ¨¡å—çš„è®¡æ—¶///////////////////////////////
 120   1        //èœ‚é¸£å™¨åªç”¨äºæ‹‰è­¦æŠ¥
 121   1        if(global.device.nowater == light && global.work.warnFlag == false) //è®¾å¤‡çŠ¶æ€ä¸ºç¼ºæ°´,ä¸”æ²¡æœ‰æ‹‰è
             -¿‡è­¦æŠ¥
 122   1        {
 123   2          if(++global.work.warnCountDown >= 60000)  //è­¦æŠ¥60s
 124   2          {
 125   3            global.work.warnCountDown = 0;
 126   3            global.work.warnFlag = true;  //æ ‡è®°å·²ç»è­¦æŠ¥è¿‡äº†
 127   3          }
 128   2          Beep(); //800msä¸ºä¸€å‘¨æœŸï¼Œæ¯å‘¨æœŸå“100ms
 129   2        }
 130   1        else if(global.device.nowater == dark)
 131   1        {
 132   2          global.work.warnCountDown = 0;  //æ¸…è­¦æŠ¥è®¡æ—¶
 133   2          global.work.warnFlag = false; //æ¸…è­¦æŠ¥æ ‡å¿—
 134   2          BEEP_OFF;
 135   2        }
 136   1      
 137   1        //å› ä¸ºéƒ½æ˜¯èœ‚é¸£å™¨æ‰€ä»¥æ”¾åœ¨è¿™å„¿äº†ï¼Œè¿™æ˜¯æŒ‰é”®è§¦å‘çš„èœ‚é¸£
 138   1        keyBeep(&global.work.keyPressBeepFlag);
 139   1        //////////////////////////////////////////ç•Œé¢åˆ‡æ¢çš„è®¡æ—¶///////////////////////////////
 140   1        //æ³¨æ„ï¼šrunState çš„åˆ‡æ¢é™¤äº†åœ¨è¿™å„¿ï¼Œè¿˜æœ‰ workFunc çš„è®¾ç½®å‚æ•°å¤„
 141   1        if(global.work.runState <= rs_normal2)  //æ­£å¸¸è¿è¡Œæ—¶æ˜¾ç¤ºçš„ä¸‰ä¸ªç•Œé¢
 142   1        {
 143   2          if(global.work.switchTimeCount == 1)  //å¼€å§‹æ˜¾ç¤ºæ¸©åº¦
 144   2          {
 145   3            global.display.light = global.device.light; //æŒ‰ç…§è®¾å¤‡çŠ¶æ€æ˜¾ç¤ºæŒ‡ç¤ºç¯
 146   3            global.display.water = global.device.water;
 147   3            global.work.runState = rs_normal;
 148   3          }
 149   2          else if(global.work.switchTimeCount == 20000) //å¼€å§‹æ˜¾ç¤ºç…§æ˜å€’è®¡æ—¶
 150   2          {
 151   3            global.display.light = blink; //ç…§æ˜ç¯é—ªçƒ
 152   3            global.work.runState = rs_normal1;
 153   3          }
 154   2          else if(global.work.switchTimeCount == 25000) //å¼€å§‹æ˜¾ç¤ºæµ‡æ°´å€’è®¡æ—¶
 155   2          {
 156   3            global.display.water = blink; //æµ‡æ°´ç¯é—ªçƒ
 157   3            global.work.runState = rs_normal2;
 158   3          }
 159   2          //30sä¸ºä¸€å‘¨æœŸ
 160   2          global.work.switchTimeCount == 30000 ? (global.work.switchTimeCount = 0):(++global.work.switchTimeCount)
             -;
 161   2        }
 162   1        else if(global.work.runState >= rs_sLH) //è®¾ç½®çŠ¶æ€ä¸‹çš„æ˜¾ç¤ºåˆ‡æ¢
 163   1        {
 164   2          if(++global.set.switchTimeCount >= 5000)  //5s
 165   2          {
 166   3            global.set.switchTimeCount = 0; //è¯¥è®¡æ—¶å˜é‡ä¼šåœ¨æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œåœ¨ keyFunc ä¸­è¢«æ¸…é›¶
 167   3            //å€’è®¡æ—¶ç»“æŸæ—¶ï¼ŒçŠ¶æ€åœ¨è®¾ç½®çš„æœ€åä¸€é¡¹ï¼Œåˆ™è¯´æ˜è®¾ç½®å®Œæˆ
 168   3            if(global.work.runState == rs_wCD || global.work.runState == rs_rtcM) //é¢„çº¦æˆ–rtcè®¾ç½®å®Œæˆ
 169   3            {
 170   4              global.work.runState = rs_normal; //åˆ‡å›æ­£å¸¸çŠ¶æ€
 171   4              global.work.switchTimeCount = 0;  //å¹¶æŠŠæ­£å¸¸çŠ¶æ€ä¸‹çš„è®¡æ—¶æ¸…é›¶
 172   4              global.set.setDataSate = end; //è®¾ç½®å‚æ•°çŠ¶æ€åˆ‡æ¢ä¸ºç»“æŸï¼Œå°†åœ¨ workFunc ä¸­å‘é€è®¾ç½®å‚
             -æ•°è®¾ç½®è¯·æ±‚
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 4   

 173   4            }
 174   3            else  //æœªåˆ°è¾¾ç»“æŸçŠ¶æ€åˆ™è®©çŠ¶æ€åˆ‡æ¢è‡³åä¸€ä¸ª
 175   3            {
 176   4              ++global.work.runState;
 177   4            }
 178   3          }
 179   2        }
 180   1      
 181   1        if(global.set.setDataSate == waitAck)
 182   1        {
 183   2          if(global.set.setWaitTimeOut < 5000) ++global.set.setWaitTimeOut;
 184   2        }
 185   1        else
 186   1        {
 187   2          global.set.setWaitTimeOut = 0;
 188   2        }
 189   1        
 190   1      }
 191          
 192          //
 193          //ç”¨äºå¤„ç†ä¸€äº›è€—æ—¶æ“ä½œ
 194          //
 195          void workFunc(void)
 196          {
 197   1        parseDataFromBottom();  //æ¥æ”¶å¤„ç†æ¥è‡ªåº•æ¿çš„æ•°æ®
 198   1        //////////////////////////////////////////ä¼ æ„Ÿå™¨æ¨¡å—çš„æ“ä½œ///////////////////////////////
 199   1        if(global.work.getTemperatureSate == start) //è·å–ä¼ æ„Ÿå™¨æ•°æ®
 200   1        {
 201   2          global.work.temperature =  getAdc();  //å®é™…æ¸©åº¦å€¼*10ï¼Œä¾‹å¦‚255 = 25.5æ‘„æ°åº¦,æœ€å¤§å€¼ä¸º1000 =
             - 100.0
 202   2          global.work.getTemperatureSate = free;
 203   2        }
 204   1        //////////////////////////////////////////éœ€è¦å‘ä¸²å£çš„æ“ä½œ///////////////////////////////
 205   1        //////////////å‘åº•æ¿å‘é€è®¾å¤‡çŠ¶æ€è·å–çš„è¯·æ±‚///////////
 206   1        if(global.set.setDataSate != free || global.set.setSateSate != free)  //åªæœ‰ç©ºé—²çš„æ—¶å€™æ‰å¯ä»¥è¯·æ
             -±‚
 207   1          global.device.getDataFlag = false;
 208   1        if(global.device.getDataFlag == true)
 209   1        {
 210   2          global.uart.sendBuff[0] = 0x96; //å¤´
 211   2          global.uart.sendBuff[1] = 7;  //é•¿åº¦
 212   2          global.uart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹-é«˜8ä½
 213   2          global.uart.sendBuff[3] = 0x01; //æ¶ˆæ¯ç±»å‹-ä½8ä½
 214   2          global.uart.sendBuff[4] = (unsigned char)(global.work.temperature>>8);  //æ¸©åº¦
 215   2          global.uart.sendBuff[5] = (unsigned char)(global.work.temperature&0xff);
 216   2          global.uart.sendBuff[6] = figureSum(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //æ ¡éªŒ 0x9e
 217   2      
 218   2          oneWire_write(global.uart.sendBuff,global.uart.sendBuff[1]);  //å‘é€è¯·æ±‚
 219   2          global.device.getDataFlag = false;
 220   2        }
 221   1        ///////////////è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚///////////////////////
 222   1        if(global.set.setSateSate == start)
 223   1        {
 224   2          global.device.getDataTimeCOunt = 0;
 225   2          global.device.getDataFlag = false;
 226   2          
 227   2          global.uart.sendBuff[0] = 0x96; //å¤´
 228   2          global.uart.sendBuff[1] = 6;  //é•¿åº¦
 229   2          global.uart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹-é«˜8ä½
 230   2          global.uart.sendBuff[3] = 0x05; //æ¶ˆæ¯ç±»å‹-ä½8ä½
 231   2          global.uart.sendBuff[4] = global.set.setSateData; //è¦è®¾ç½®çš„è®¾å¤‡çŠ¶æ€æ•°æ®
 232   2          global.uart.sendBuff[5] = figureSum(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //æ ¡éªŒ 0x9e
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 5   

 233   2      
 234   2          oneWire_write(global.uart.sendBuff,global.uart.sendBuff[1]);  //å‘é€è¯·æ±‚
 235   2          global.set.setSateSate = free;  //è¿›å…¥ç©ºé—²çŠ¶æ€
 236   2        }
 237   1        else if(global.set.setSateSate == waitAck)  //ç­‰å¾…å“åº”
 238   1        {
 239   2          // if(global.set.setWaitTimeOut >= 3000)
 240   2          // {
 241   2          //  global.set.setSateSate = free;  //çŠ¶æ€åˆ‡å›ç©ºé—²
 242   2          //  global.work.runState = rs_normal; //çŠ¶æ€åˆ‡æ¢ä¸ºæ­£å¸¸
 243   2          // }
 244   2        //  if(global.uart.sendTimeOutFlag) //ç­‰å¾…å“åº”è¶…æ—¶äº†
 245   2        //  { //å¼€å§‹è®¾ç½®æ—¶å°†æ— æ³•è¿›å…¥è®¾ç½®ï¼Œç»“æŸè®¾ç½®æ—¶å°†ä¿å­˜è®¾ç½®å¤±è´¥
 246   2      
 247   2        //    global.uart.sendTimeOutFlag = false;
 248   2        //    if(global.uart.resendCount >= 5)  //é‡å‘å››æ¬¡éƒ½å¤±è´¥
 249   2        //    {
 250   2        //      global.set.setSateSate = free;  //çŠ¶æ€åˆ‡å›ç©ºé—²
 251   2        //      global.uart.resendCount = 0;
 252   2        //    }
 253   2        //    else
 254   2        //    {
 255   2        //      ++global.uart.resendCount;  //é‡å‘æ¬¡æ•°åŠ ä¸€
 256   2        //      global.set.setSateSate = start;
 257   2        //    }
 258   2            
 259   2        //  }
 260   2        // }
 261   2        // else if(global.set.setSateSate == end) //å¾—åˆ°å“åº”ï¼Œç»“æŸ
 262   2        // {
 263   2        //  global.set.setSateSate = free;
 264   2        //  global.uart.resendCount = 0;
 265   2        }
 266   1        
 267   1        ////////////////////////è®¾ç½®å‚æ•°//////////////////////////
 268   1        if(global.set.setDataSate == start) //å¼€å§‹è®¾ç½®æ—¶ï¼Œå‘é€è®¾ç½®å‚æ•°è·å–è¯·æ±‚
 269   1        {
 270   2          global.uart.sendBuff[0] = 0x96; //å¤´
 271   2          global.uart.sendBuff[1] = 5;  //é•¿åº¦
 272   2          global.uart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹-é«˜8ä½
 273   2          global.uart.sendBuff[3] = 0x03; //æ¶ˆæ¯ç±»å‹-ä½8ä½
 274   2          global.uart.sendBuff[4] = figureSum(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //æ ¡éªŒ 0x9e
 275   2      
 276   2          global.work.runState = rs_wait; //çŠ¶æ€åˆ‡æ¢ä¸ºç­‰å¾…
 277   2          global.set.setDataSate = waitAck; //è¿›å…¥ç­‰å¾…å“åº”çŠ¶æ€
 278   2          oneWire_write(global.uart.sendBuff,global.uart.sendBuff[1]);  //å‘é€è¯·æ±‚
 279   2        }
 280   1        else if(global.set.setDataSate == end)  //ç»“æŸè®¾ç½®æ—¶ï¼Œå‘é€è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
 281   1        {
 282   2          global.uart.sendBuff[0] = 0x96; //å¤´
 283   2          global.uart.sendBuff[1] = 16; //é•¿åº¦
 284   2          global.uart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹-é«˜8ä½
 285   2          global.uart.sendBuff[3] = 0x06; //æ¶ˆæ¯ç±»å‹-ä½8ä½
 286   2          if(global.set.setAppointmentFlag == 2)  //å¦‚æœæ˜¯é¢„çº¦è®¾ç½®
 287   2          {
 288   3            global.uart.sendBuff[4] = 0xff; //rtc-å°æ—¶--ä¸ä¿®æ”¹
 289   3            global.uart.sendBuff[5] = 0xff; //rtc-åˆ†é’Ÿ--ä¸ä¿®æ”¹
 290   3          }
 291   2          if(global.set.setRtcFlag == 2)
 292   2          {
 293   3            global.uart.sendBuff[4] = global.set.hour;  //rtc-å°æ—¶
 294   3            global.uart.sendBuff[5] = global.set.minute;  //rtc-åˆ†é’Ÿ
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 6   

 295   3          }
 296   2          global.uart.sendBuff[6] = global.set.startLightHour;  //å¼€å§‹ç…§æ˜çš„æ—¶é—´-å°æ—¶
 297   2          global.uart.sendBuff[7] = global.set.startLightMinute;  //å¼€å§‹ç…§æ˜çš„æ—¶é—´-åˆ†é’Ÿ
 298   2          global.uart.sendBuff[8] = global.set.keepLightHour; //æŒç»­ç…§æ˜çš„æ—¶é—´-å°æ—¶
 299   2          global.uart.sendBuff[9] = global.set.keepLightMinute; //æŒç»­ç…§æ˜çš„æ—¶é—´-åˆ†é’Ÿ
 300   2          global.uart.sendBuff[10] = global.set.startWaterHour; //å¼€å§‹æµ‡æ°´çš„æ—¶é—´-å°æ—¶
 301   2          global.uart.sendBuff[11] = global.set.startWaterMinute; //å¼€å§‹æµ‡æ°´çš„æ—¶é—´-åˆ†é’Ÿ
 302   2          global.uart.sendBuff[12] = global.set.keepWaterHour;  //æŒç»­æµ‡æ°´çš„æ—¶é—´-å°æ—¶
 303   2          global.uart.sendBuff[13] = global.set.keepWaterMinute;  //æŒç»­æµ‡æ°´çš„æ—¶é—´-åˆ†é’Ÿ
 304   2          global.uart.sendBuff[14] = global.set.waterCycleDay;  //æµ‡æ°´çš„å‘¨æœŸ-å¤©
 305   2          global.uart.sendBuff[15] = figureSum(global.uart.sendBuff,global.uart.sendBuff[1]-1); //æ ¡éªŒ
 306   2      
 307   2          global.work.runState = rs_wait; //çŠ¶æ€åˆ‡æ¢ä¸ºç­‰å¾…
 308   2          global.set.setDataSate = waitAck; //è¿›å…¥ç­‰å¾…å“åº”çŠ¶æ€
 309   2          oneWire_write(global.uart.sendBuff,global.uart.sendBuff[1]);  //å‘é€è¯·æ±‚
 310   2        }
 311   1        else if(global.set.setDataSate == ing)  //å¾—åˆ°å“åº”è¿›å…¥è®¾ç½®
 312   1        {
 313   2          if(global.set.setAppointmentFlag == true) //å¦‚æœæ˜¯é¢„çº¦è®¾ç½®
 314   2          {
 315   3            global.set.setAppointmentFlag = 2;
*** WARNING C259 IN LINE 315 OF ..\lib\user\src\func.c: '=': different enumeration types
 316   3            global.work.runState = rs_sLH;  //åˆ‡æ¢çŠ¶æ€è‡³é¢„çº¦è®¾ç½®çš„ç¬¬ä¸€é¡¹
 317   3          }
 318   2          if(global.set.setRtcFlag == true) //å¦‚æœæ—¶rtcè®¾ç½®
 319   2          {
 320   3            global.set.setRtcFlag = 2;
*** WARNING C259 IN LINE 320 OF ..\lib\user\src\func.c: '=': different enumeration types
 321   3            global.work.runState = rs_rtcH; //åˆ‡æ¢çŠ¶æ€è‡³rtcè®¾ç½®çš„ç¬¬ä¸€é¡¹
 322   3          }
 323   2          global.uart.resendCount = 0;
 324   2          global.set.setDataSate = ing; //å½“è®¾ç½®å®Œæˆåä¼šè¢«è®¾ä¸º end
 325   2        }
 326   1        else if(global.set.setDataSate == waitAck)  //ç­‰å¾…å“åº”
 327   1        {
 328   2          if(global.set.setWaitTimeOut >= 3000)
 329   2          {
 330   3            global.set.setDataSate = free;  //çŠ¶æ€åˆ‡å›ç©ºé—²
 331   3            global.work.runState = rs_normal; //çŠ¶æ€åˆ‡æ¢ä¸ºæ­£å¸¸
 332   3          }
 333   2          // if(global.uart.sendTimeOutFlag)  //ç­‰å¾…å“åº”è¶…æ—¶äº†
 334   2          // {  //å¼€å§‹è®¾ç½®æ—¶å°†æ— æ³•è¿›å…¥è®¾ç½®ï¼Œç»“æŸè®¾ç½®æ—¶å°†ä¿å­˜è®¾ç½®å¤±è´¥
 335   2      
 336   2          //  global.uart.sendTimeOutFlag = false;
 337   2          //  if(global.uart.resendCount >= 20) //é‡å‘å››æ¬¡éƒ½å¤±è´¥
 338   2          //  {
 339   2          //    global.set.setDataSate = free;  //çŠ¶æ€åˆ‡å›ç©ºé—²
 340   2          //    global.work.runState = rs_normal; //çŠ¶æ€åˆ‡æ¢ä¸ºæ­£å¸¸
 341   2          //    global.work.switchTimeCount = 0;
 342   2          //    global.uart.resendCount = 0;
 343   2          //    global.set.setAppointmentFlag = false;
 344   2          //    global.set.setRtcFlag = false;
 345   2          //  }
 346   2          //  else
 347   2          //  {
 348   2          //    ++global.uart.resendCount;  //é‡å‘æ¬¡æ•°åŠ ä¸€
 349   2          //    if(global.set.setAppointmentFlag == true || global.set.setRtcFlag == true)  //æœ‰ä¸€ä¸ªä¸ºtrueè¯´æ˜
             -æœªè¿›å…¥endçŠ¶æ€ï¼Œè¯´æ˜ä¸Šä¸€ä¸ªå‘é€è¯·æ±‚çš„çŠ¶æ€ä¸ºstart
 350   2          //    {
 351   2          //      global.set.setDataSate = start;
 352   2          //    }
 353   2          //    else
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 7   

 354   2          //    {
 355   2          //      global.set.setDataSate = end;
 356   2          //    }
 357   2          //  }
 358   2            
 359   2          // }
 360   2        }
 361   1        else if(global.set.setDataSate == ack)  //å“åº”
 362   1        {
 363   2          global.set.setDataSate = free;
 364   2          global.work.runState = rs_normal; //çŠ¶æ€åˆ‡æ¢ä¸ºæ­£å¸¸
 365   2          global.work.switchTimeCount = 0;
 366   2          global.uart.resendCount = 0;
 367   2          global.set.setAppointmentFlag = false;
 368   2          global.set.setRtcFlag = false;
 369   2        }
 370   1      }
 371          
 372          //
 373          //ä¸åŒçŠ¶æ€ä¸‹çš„æ˜¾ç¤º
 374          //
 375          void displayInDifferentStates(void)
 376          {
 377   1        global.display.wifi = global.device.wifi;
 378   1        global.display.nowater = global.device.nowater;
 379   1        switch(global.work.runState)
 380   1        {
 381   2          case rs_normal: //æ˜¾ç¤ºæ¸©åº¦
 382   2          {
 383   3            global.display.appointment = global.device.appointment; //é™¤äº†è®¾ç½®æ—¶ï¼Œå…¶ä»–æ—¶å€™ä¸ç‚¹äº®
 384   3            global.display.light = global.device.light; //æ­£å¸¸æƒ…å†µå°±æŒ‰ç…§è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
 385   3            global.display.water = global.device.water; //æ­£å¸¸æƒ…å†µå°±æŒ‰ç…§è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
 386   3            //ç¬¬äºŒä¸ªå‚æ•°åŠ 10æ˜¯å› ä¸º10-19è¡¨ç¤ºæ˜¾ç¤º 0.-9. ï¼Œä½¿ä¸ªä½åé¢æœ‰å°æ•°ç‚¹
 387   3            setDisplayNumber(global.work.temperature/100,global.work.temperature/10%10 + 10,global.work.temperature
             -%10);
 388   3          }break;
 389   2          case rs_normal1:  //æ˜¾ç¤ºç…§æ˜å€’è®¡æ—¶
 390   2          {
 391   3            global.display.light = blink;
 392   3            global.display.water = dark;
 393   3            if(global.device.nextStartLightCountDown != 0)  //è¿™é‡Œæ˜¯ä¸ºäº†ä¸æ˜¾ç¤º0çš„å€’è®¡æ—¶,å½“ä¸º0æ—¶ç›´æ¥
             -æ˜¾ç¤ºä¸‹ä¸€ä¸ªå€’è®¡æ—¶
 394   3            {
 395   4              //å¼€å§‹çš„å°äºäºç»“æŸçš„ï¼Œè¯´æ˜å…ˆåˆ°è¾¾å¼€å§‹ï¼Œé‚£å°±æ˜¾ç¤ºè·ç¦»å¼€å§‹çš„å€’è®¡æ—¶
 396   4              if(global.device.nextStartLightCountDown < global.device.endLightCountDown || global.device.endLightCo
             -untDown == 0)
 397   4              {
 398   5                //æœ€å¤§ä¹Ÿå°±æ˜¯24*60åˆ†é’Ÿ
 399   5                if(global.device.nextStartLightCountDown/60 >= 999) //æ­£å¸¸æƒ…å†µä¸‹ä¸å¯èƒ½å‡ºç°è¿™ä¸ªå€¼,è¿™é‡Œä
             -¸ºä¸€ä¸ªé™å®š
 400   5                  setDisplayNumber(9,9,9);
 401   5                else if(global.device.nextStartLightCountDown/60 >= 100)  //å¤§äºç­‰äº100å°æ—¶
 402   5                  setDisplayNumber(global.device.nextStartLightCountDown/60/100,global.device.nextStartLightCountDown/
             -60/10%10,global.device.nextStartLightCountDown/60%10);
 403   5                else if(global.device.nextStartLightCountDown/60 >= 10) //å¤§äºç­‰äº10å°æ—¶
 404   5                  setDisplayNumber(0,global.device.nextStartLightCountDown/60/10,global.device.nextStartLightCountDown
             -/60%10);
 405   5                else if(global.device.nextStartLightCountDown/60 >= 1)  //å¤§äºç­‰äº1å°æ—¶
 406   5                  setDisplayNumber(0,0,global.device.nextStartLightCountDown/60);
 407   5                else if(global.device.nextStartLightCountDown >= 10)  //å¤§äºç­‰äº10åˆ†é’Ÿ
 408   5                  setDisplayNumber(10,global.device.nextStartLightCountDown/10,global.device.nextStartLightCountDown%1
             -0);  //ä»¥0.å¼€å¤´
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 8   

 409   5                else if(global.device.nextStartLightCountDown >= 1) //å¤§äºç­‰äº1åˆ†é’Ÿ
 410   5                  setDisplayNumber(10,0,global.device.nextStartLightCountDown%10);  //ä»¥0.å¼€å¤´
 411   5                else if(global.device.nextStartLightCountDown == 0) //ç­‰äº0åˆ†é’Ÿ
 412   5                  setDisplayNumber(10,0,0); //ä»¥0.å¼€å¤´
 413   5              }
 414   4            }
 415   3            if(global.device.endLightCountDown != 0)
 416   3            {
 417   4              //æ˜¾ç¤ºè·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹çš„å€’è®¡æ—¶
 418   4              if(global.device.endLightCountDown < global.device.nextStartLightCountDown || global.device.nextStartL
             -ightCountDown == 0)
 419   4              {
 420   5                //æœ€å¤§ä¹Ÿå°±æ˜¯24*60åˆ†é’Ÿ
 421   5                if(global.device.endLightCountDown/60 >= 999) //æ­£å¸¸æƒ…å†µä¸‹ä¸å¯èƒ½å‡ºç°è¿™ä¸ªå€¼,è¿™é‡Œä¸ºä¸€ä
             -¸ªé™å®š
 422   5                  setDisplayNumber(9,9,9);
 423   5                else if(global.device.endLightCountDown/60 >= 100)  //å¤§äºç­‰äº100å°æ—¶
 424   5                  setDisplayNumber(global.device.endLightCountDown/60/100,global.device.endLightCountDown/60/10%10,glo
             -bal.device.endLightCountDown/60%10);
 425   5                else if(global.device.endLightCountDown/60 >= 10) //å¤§äºç­‰äº10å°æ—¶
 426   5                  setDisplayNumber(0,global.device.endLightCountDown/60/10,global.device.endLightCountDown/60%10);
 427   5                else if(global.device.endLightCountDown/60 >= 1)  //å¤§äºç­‰äº1å°æ—¶
 428   5                  setDisplayNumber(0,0,global.device.endLightCountDown/60);
 429   5                else if(global.device.endLightCountDown >= 10)  //å¤§äºç­‰äº10åˆ†é’Ÿ
 430   5                  setDisplayNumber(10,global.device.endLightCountDown/10,global.device.endLightCountDown%10); //ä»¥0.å
             -¼€å¤´
 431   5                else if(global.device.endLightCountDown >= 1) //å¤§äºç­‰äº1åˆ†é’Ÿ
 432   5                  setDisplayNumber(10,0,global.device.endLightCountDown%10);  //ä»¥0.å¼€å¤´
 433   5                else if(global.device.endLightCountDown == 0) //ç­‰äº0åˆ†é’Ÿ
 434   5                  setDisplayNumber(10,0,0); //ä»¥0.å¼€å¤´
 435   5              }
 436   4            }
 437   3            //å½“ç›¸ç­‰çš„æ—¶å€™ï¼Œä¸ç®¡æ—¶0è¿˜æ˜¯å¤šå°‘ï¼Œåæ­£æ˜¾ç¤ºä¸€ä¸ªå€¼å°±è¡Œäº†,æ­£å¸¸æƒ…å†µæ˜¯ä¸ä¼šå‡º
             -ç°çš„,è¿™é‡Œä¸åŠ çš„è¯ï¼Œå¯èƒ½ä¼šå‡ºç°å½“ç›¸ç­‰æˆ–éƒ½ä¸º0çš„æ—¶å€™,å€’è®¡æ—¶æ˜¾ç¤ºå¼‚å¸¸
 438   3            if(global.device.nextStartLightCountDown == global.device.endLightCountDown)
 439   3            {
 440   4              //æœ€å¤§ä¹Ÿå°±æ˜¯24*60åˆ†é’Ÿ
 441   4              if(global.device.endLightCountDown/60 >= 999) //æ­£å¸¸æƒ…å†µä¸‹ä¸å¯èƒ½å‡ºç°è¿™ä¸ªå€¼,è¿™é‡Œä¸ºä¸€ä¸
             -ªé™å®š
 442   4                setDisplayNumber(9,9,9);
 443   4              else if(global.device.endLightCountDown/60 >= 100)  //å¤§äºç­‰äº100å°æ—¶
 444   4                setDisplayNumber(global.device.endLightCountDown/60/100,global.device.endLightCountDown/60/10%10,glob
             -al.device.endLightCountDown/60%10);
 445   4              else if(global.device.endLightCountDown/60 >= 10) //å¤§äºç­‰äº10å°æ—¶
 446   4                setDisplayNumber(0,global.device.endLightCountDown/60/10,global.device.endLightCountDown/60%10);
 447   4              else if(global.device.endLightCountDown/60 >= 1)  //å¤§äºç­‰äº1å°æ—¶
 448   4                setDisplayNumber(0,0,global.device.endLightCountDown/60);
 449   4              else if(global.device.endLightCountDown >= 10)  //å¤§äºç­‰äº10åˆ†é’Ÿ
 450   4                setDisplayNumber(10,global.device.endLightCountDown/10,global.device.endLightCountDown%10); //ä»¥0.å¼
             -€å¤´
 451   4              else if(global.device.endLightCountDown >= 1) //å¤§äºç­‰äº1åˆ†é’Ÿ
 452   4                setDisplayNumber(10,0,global.device.endLightCountDown%10);  //ä»¥0.å¼€å¤´
 453   4              else if(global.device.endLightCountDown == 0) //ç­‰äº0åˆ†é’Ÿ
 454   4                setDisplayNumber(10,0,0); //ä»¥0.å¼€å¤´
 455   4            }
 456   3          }break;
 457   2          case rs_normal2:  //æ˜¾ç¤ºæµ‡æ°´å€’è®¡æ—¶
 458   2          {
 459   3            global.display.light = dark;
 460   3            global.display.water = blink;
 461   3            if(global.device.nextStartWaterCountDown != 0)
 462   3            {
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 9   

 463   4              //å¼€å§‹çš„å°äºäºç»“æŸçš„ï¼Œè¯´æ˜å…ˆåˆ°è¾¾å¼€å§‹ï¼Œé‚£å°±æ˜¾ç¤ºè·ç¦»å¼€å§‹çš„å€’è®¡æ—¶
 464   4              if(global.device.nextStartWaterCountDown < global.device.endWaterCountDown || global.device.endWaterCo
             -untDown == 0)
 465   4              {
 466   5                //æœ€å¤§ä¹Ÿå°±æ˜¯30*24*60åˆ†é’Ÿï¼Œ720å°æ—¶
 467   5                if(global.device.nextStartWaterCountDown/60 >= 999) //æ­£å¸¸æƒ…å†µä¸‹ä¸å¯èƒ½å‡ºç°è¿™ä¸ªå€¼,è¿™é‡Œä
             -¸ºä¸€ä¸ªé™å®š
 468   5                  setDisplayNumber(9,9,9);
 469   5                else if(global.device.nextStartWaterCountDown/60 >= 100)  //å¤§äºç­‰äº100å°æ—¶
 470   5                  setDisplayNumber(global.device.nextStartWaterCountDown/60/100,global.device.nextStartWaterCountDown/
             -60/10%10,global.device.nextStartWaterCountDown/60%10);
 471   5                else if(global.device.nextStartWaterCountDown/60 >= 10) //å¤§äºç­‰äº10å°æ—¶
 472   5                  setDisplayNumber(0,global.device.nextStartWaterCountDown/60/10,global.device.nextStartWaterCountDown
             -/60%10);
 473   5                else if(global.device.nextStartWaterCountDown/60 >= 1)  //å¤§äºç­‰äº1å°æ—¶
 474   5                  setDisplayNumber(0,0,global.device.nextStartWaterCountDown/60);
 475   5                else if(global.device.nextStartWaterCountDown >= 10)  //å¤§äºç­‰äº10åˆ†é’Ÿ
 476   5                  setDisplayNumber(10,global.device.nextStartWaterCountDown/10,global.device.nextStartWaterCountDown%1
             -0);  //ä»¥0.å¼€å¤´
 477   5                else if(global.device.nextStartWaterCountDown >= 1) //å¤§äºç­‰äº1åˆ†é’Ÿ
 478   5                  setDisplayNumber(10,0,global.device.nextStartWaterCountDown%10);  //ä»¥0.å¼€å¤´
 479   5                else if(global.device.nextStartWaterCountDown == 0) //ç­‰äº0åˆ†é’Ÿ
 480   5                  setDisplayNumber(10,0,0); //ä»¥0.å¼€å¤´
 481   5              }
 482   4            }
 483   3            if(global.device.endWaterCountDown != 0)
 484   3            {
 485   4              if(global.device.endWaterCountDown < global.device.nextStartWaterCountDown || global.device.nextStartW
             -aterCountDown == 0) //è¯´æ˜æœªåœ¨ç…§æ˜ï¼Œé‚£å°±æ˜¾ç¤ºè·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹çš„å€’è®¡æ—¶
 486   4              {
 487   5                //æœ€å¤§ä¹Ÿå°±æ˜¯15*24*60åˆ†é’Ÿï¼Œ360å°æ—¶
 488   5                if(global.device.endWaterCountDown/60 >= 999) //æ­£å¸¸æƒ…å†µä¸‹ä¸å¯èƒ½å‡ºç°è¿™ä¸ªå€¼,è¿™é‡Œä¸ºä¸€ä
             -¸ªé™å®š
 489   5                  setDisplayNumber(9,9,9);
 490   5                else if(global.device.endWaterCountDown/60 >= 100)  //å¤§äºç­‰äº100å°æ—¶
 491   5                  setDisplayNumber(global.device.endWaterCountDown/60/100,global.device.endWaterCountDown/60/10%10,glo
             -bal.device.endWaterCountDown/60%10);
 492   5                else if(global.device.endWaterCountDown/60 >= 10) //å¤§äºç­‰äº10å°æ—¶
 493   5                  setDisplayNumber(0,global.device.endWaterCountDown/60/10,global.device.endWaterCountDown/60%10);
 494   5                else if(global.device.endWaterCountDown/60 >= 1)  //å¤§äºç­‰äº1å°æ—¶
 495   5                  setDisplayNumber(0,0,global.device.endWaterCountDown/60);
 496   5                else if(global.device.endWaterCountDown >= 10)  //å¤§äºç­‰äº10åˆ†é’Ÿ
 497   5                  setDisplayNumber(10,global.device.endWaterCountDown/10,global.device.endWaterCountDown%10); //ä»¥0.å
             -¼€å¤´
 498   5                else if(global.device.endWaterCountDown >= 1) //å¤§äºç­‰äº1åˆ†é’Ÿ
 499   5                  setDisplayNumber(10,0,global.device.endWaterCountDown%10);  //ä»¥0.å¼€å¤´
 500   5                else if(global.device.endWaterCountDown == 0) //ç­‰äº0åˆ†é’Ÿ
 501   5                  setDisplayNumber(10,0,0); //ä»¥0.å¼€å¤´
 502   5              }
 503   4            }
 504   3            //å½“ç›¸ç­‰çš„æ—¶å€™ï¼Œä¸ç®¡æ—¶0è¿˜æ˜¯å¤šå°‘ï¼Œåæ­£æ˜¾ç¤ºä¸€ä¸ªå€¼å°±è¡Œäº†,æ­£å¸¸æƒ…å†µæ˜¯ä¸ä¼šå‡º
             -ç°çš„,è¿™é‡Œä¸åŠ çš„è¯ï¼Œå¯èƒ½ä¼šå‡ºç°å½“ç›¸ç­‰æˆ–éƒ½ä¸º0çš„æ—¶å€™,å€’è®¡æ—¶æ˜¾ç¤ºå¼‚å¸¸
 505   3            if(global.device.endWaterCountDown == global.device.nextStartWaterCountDown)
 506   3            {
 507   4              //æœ€å¤§ä¹Ÿå°±æ˜¯15*24*60åˆ†é’Ÿï¼Œ360å°æ—¶
 508   4              if(global.device.endWaterCountDown/60 >= 999) //æ­£å¸¸æƒ…å†µä¸‹ä¸å¯èƒ½å‡ºç°è¿™ä¸ªå€¼,è¿™é‡Œä¸ºä¸€ä¸
             -ªé™å®š
 509   4                setDisplayNumber(9,9,9);
 510   4              else if(global.device.endWaterCountDown/60 >= 100)  //å¤§äºç­‰äº100å°æ—¶
 511   4                setDisplayNumber(global.device.endWaterCountDown/60/100,global.device.endWaterCountDown/60/10%10,glob
             -al.device.endWaterCountDown/60%10);
 512   4              else if(global.device.endWaterCountDown/60 >= 10) //å¤§äºç­‰äº10å°æ—¶
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 10  

 513   4                setDisplayNumber(0,global.device.endWaterCountDown/60/10,global.device.endWaterCountDown/60%10);
 514   4              else if(global.device.endWaterCountDown/60 >= 1)  //å¤§äºç­‰äº1å°æ—¶
 515   4                setDisplayNumber(0,0,global.device.endWaterCountDown/60);
 516   4              else if(global.device.endWaterCountDown >= 10)  //å¤§äºç­‰äº10åˆ†é’Ÿ
 517   4                setDisplayNumber(10,global.device.endWaterCountDown/10,global.device.endWaterCountDown%10); //ä»¥0.å¼
             -€å¤´
 518   4              else if(global.device.endWaterCountDown >= 1) //å¤§äºç­‰äº1åˆ†é’Ÿ
 519   4                setDisplayNumber(10,0,global.device.endWaterCountDown%10);  //ä»¥0.å¼€å¤´
 520   4              else if(global.device.endWaterCountDown == 0) //ç­‰äº0åˆ†é’Ÿ
 521   4                setDisplayNumber(10,0,0); //ä»¥0.å¼€å¤´
 522   4            }
 523   3          }break;
 524   2          case rs_wait:
 525   2          {
 526   3            setDisplayNumber(30,30,30); //---
 527   3          }break;
 528   2        }
 529   1        
 530   1        //è®¾ç½®æ¨¡å¼ä¸‹
 531   1        if(global.set.setDataSate == ing) //è®¾ç½®ä¸­
 532   1        {
 533   2          switch(global.work.runState)
 534   2          {
 535   3            case rs_sLH:  //é¢„çº¦è®¾ç½®--å¼€å§‹ç…§æ˜-å°æ—¶
 536   3            {
 537   4              global.display.appointment = light;
 538   4              global.display.light = blink;
 539   4              global.display.water = dark;
 540   4              setDisplayNumber(11,global.set.startLightHour/10,global.set.startLightHour%10);
 541   4            }break;
 542   3            case rs_sLM:  //é¢„çº¦è®¾ç½®--å¼€å§‹ç…§æ˜-åˆ†é’Ÿ
 543   3            {
 544   4              global.display.appointment = light;
 545   4              global.display.light = blink;
 546   4              global.display.water = dark;
 547   4              setDisplayNumber(12,global.set.startLightMinute/10,global.set.startLightMinute%10);
 548   4            }break;
 549   3            case rs_kLH:  //é¢„çº¦è®¾ç½®--æŒç»­ç…§æ˜-å°æ—¶
 550   3            {
 551   4              global.display.appointment = light;
 552   4              global.display.light = blink;
 553   4              global.display.water = dark;
 554   4              setDisplayNumber(13,global.set.keepLightHour/10,global.set.keepLightHour%10);
 555   4            }break;
 556   3            case rs_kLM:  //é¢„çº¦è®¾ç½®--æŒç»­ç…§æ˜-åˆ†é’Ÿ
 557   3            {
 558   4              global.display.appointment = light;
 559   4              global.display.light = blink;
 560   4              global.display.water = dark;
 561   4              setDisplayNumber(14,global.set.keepLightMinute/10,global.set.keepLightMinute%10);
 562   4            }break;
 563   3            case rs_sWH:  //é¢„çº¦è®¾ç½®--å¼€å§‹æµ‡æ°´-å°æ—¶
 564   3            {
 565   4              global.display.appointment = light;
 566   4              global.display.light = dark;
 567   4              global.display.water = blink;
 568   4              setDisplayNumber(11,global.set.startWaterHour/10,global.set.startWaterHour%10);
 569   4            }break;
 570   3            case rs_sWM:  //é¢„çº¦è®¾ç½®--å¼€å§‹æµ‡æ°´-åˆ†é’Ÿ
 571   3            {
 572   4              global.display.appointment = light;
 573   4              global.display.light = dark;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 11  

 574   4              global.display.water = blink;
 575   4              setDisplayNumber(12,global.set.startWaterMinute/10,global.set.startWaterMinute%10);
 576   4            }break;
 577   3            case rs_kWH:  //é¢„çº¦è®¾ç½®--æŒç»­æµ‡æ°´-å°æ—¶
 578   3            {
 579   4              global.display.appointment = light;
 580   4              global.display.light = dark;
 581   4              global.display.water = blink;
 582   4              setDisplayNumber(13,global.set.keepWaterHour/10,global.set.keepWaterHour%10);
 583   4            }break;
 584   3            case rs_kWM:  //é¢„çº¦è®¾ç½®--æŒç»­æµ‡æ°´-åˆ†é’Ÿ
 585   3            {
 586   4              global.display.appointment = light;
 587   4              global.display.light = dark;
 588   4              global.display.water = blink;
 589   4              setDisplayNumber(14,global.set.keepWaterMinute/10,global.set.keepWaterMinute%10);
 590   4            }break;
 591   3            case rs_wCD:  //é¢„çº¦è®¾ç½®--æµ‡æ°´å‘¨æœŸ-å¤©
 592   3            {
 593   4              global.display.appointment = light;
 594   4              global.display.light = dark;
 595   4              global.display.water = blink;
 596   4              setDisplayNumber(15,global.set.waterCycleDay/10,global.set.waterCycleDay%10);
 597   4            }break;
 598   3            case rs_rtcH: //rtcè®¾ç½®--å°æ—¶
 599   3            {
 600   4              global.display.appointment = blink;
 601   4              global.display.light = dark;
 602   4              global.display.water = dark;
 603   4              setDisplayNumber(11,global.set.hour/10,global.set.hour%10);
 604   4            }break;
 605   3            case rs_rtcM: //rtcè®¾ç½®--åˆ†é’Ÿ
 606   3            {
 607   4              global.display.appointment = blink;
 608   4              global.display.light = dark;
 609   4              global.display.water = dark;
 610   4              setDisplayNumber(12,global.set.minute/10,global.set.minute%10);
 611   4            }break;
 612   3          }
 613   2        }
 614   1        else if(global.set.setDataSate == waitAck)
 615   1        {
 616   2          setDisplayNumber(30,30,30); //ä¸‰ä¸ªçŸ­æ¨ª
 617   2        }
 618   1      }
 619          
 620          //
 621          //æŒ‰é”®åŠŸèƒ½ï¼Œåœ¨ run ä¸­æ¯ 10ms è°ƒç”¨ä¸€æ¬¡
 622          //
 623          void keyFunc(unsigned char timeBase)
 624          {
 625   1        static unsigned char shortLongPressFlag = false;
 626   1        unsigned char shortlongtime100 = 1;
 627   1        keyScanf(timeBase); //æ¯10msæ‰«æä¸€æ¬¡
 628   1      
 629   1        if(ioData.key.vlaue == noneKey) //æ²¡æœ‰é”®å€¼
 630   1        {
 631   2          shortLongPressFlag = false;
 632   2          return;
 633   2        }
 634   1      
 635   1        if(ioData.key.vlaue == shortlongKey1 || ioData.key.vlaue == shortlongKey2)  //å½“é”®å€¼æ˜¯è¿ç»­æŒ‰æ—¶
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 12  

 636   1        {
 637   2          if(global.work.runState >= rs_sLH && shortLongPressFlag == false) //å½“å¤„äºè®¾ç½®æ¨¡å¼æ—¶ï¼Œå¹¶ä¸”æ˜¯
             -è¿ç»­æŒ‰çš„ç¬¬ä¸€æ¬¡è§¦å‘
 638   2          {
 639   3            shortLongPressFlag = true;
 640   3            global.work.keyPressBeepFlag = true;  //æœ‰é”®å€¼åˆ™ç½®ä½æ ‡å¿—ï¼Œå“æŒ‰é”®éŸ³
 641   3          }
 642   2        }
 643   1        else  //ä¸æ˜¯è¿ç»­æŒ‰çš„æ—¶å€™
 644   1        {
 645   2          global.work.keyPressBeepFlag = true;  //æœ‰é”®å€¼åˆ™ç½®ä½æ ‡å¿—ï¼Œå“æŒ‰é”®éŸ³
 646   2        }
 647   1      
 648   1        switch(ioData.key.vlaue)
 649   1        {
 650   2          case noneKey:  break;
 651   2          /////////////////////////////////////////////çŸ­æŒ‰ç…§æ˜é”®////////////////////////////////////////////
             -///////
 652   2          case shortKey1:
 653   2          {
 654   3            global.set.switchTimeCount = 0; //æ¸…é™¤è®¾ç½®çŠ¶æ€ä¸‹çš„è‡ªåŠ¨åˆ‡æ¢è®¡æ—¶
 655   3      
 656   3            if(global.work.runState <= rs_normal2)  //åœ¨æ­£å¸¸è¿è¡Œçš„ä¸‰ä¸ªçŠ¶æ€ä¸­
 657   3            {
 658   4              if(global.device.light == light)  //å¦‚æœåœ¨ç…§æ˜
 659   4              {
 660   5                global.set.setSateData = 0x10;  //ç…§æ˜å…³
 661   5              }
 662   4              else
 663   4              {
 664   5                global.set.setSateData = 0x11;  //ç…§æ˜å¼€
 665   5              }
 666   4              if(global.set.setSateSate == free)
 667   4              {
 668   5                global.set.setSateSate = start; //å°†åœ¨ workFunc ä¸­å‘é€è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚
 669   5              }
 670   4            }
 671   3            else
 672   3            {
 673   4              switch (global.work.runState)
 674   4              {
 675   5                case rs_sLH:  //å‡ å¼€å§‹ç…§æ˜æ—¶é—´-å°æ—¶
 676   5                {
 677   6                  global.set.startLightHour == 0 ? (global.set.startLightHour = 23):(--global.set.startLightHour);
 678   6                }break;
 679   5                case rs_sLM:  //å‡ å¼€å§‹ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 680   5                {
 681   6                  global.set.startLightMinute == 0 ? (global.set.startLightMinute = 59):(--global.set.startLightMinute
             -);
 682   6                }break;
 683   5                case rs_kLH:  //å‡ æŒç»­ç…§æ˜æ—¶é—´-å°æ—¶
 684   5                {
 685   6                  global.set.keepLightHour == 0 ? (global.set.keepLightHour = 23):(--global.set.keepLightHour);
 686   6                }break;
 687   5                case rs_kLM:  //å‡ æŒç»­ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 688   5                {
 689   6                  global.set.keepLightMinute == 0 ? (global.set.keepLightMinute = 59):(--global.set.keepLightMinute);
 690   6                }break;
 691   5                case rs_sWH:  //å‡ å¼€å§‹æµ‡æ°´æ—¶é—´-å°æ—¶
 692   5                {
 693   6                  global.set.startWaterHour == 0 ? (global.set.startWaterHour = 23):(--global.set.startWaterHour);
 694   6                }break;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 13  

 695   5                case rs_sWM:  //å‡ å¼€å§‹æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 696   5                {
 697   6                  global.set.startWaterMinute == 0 ? (global.set.startWaterMinute = 59):(--global.set.startWaterMinute
             -);
 698   6                }break;
 699   5                case rs_kWH:  //å‡ æŒç»­æµ‡æ°´æ—¶é—´-å°æ—¶
 700   5                {
 701   6                  global.set.keepWaterHour == 0 ? (global.set.keepWaterHour = 23):(--global.set.keepWaterHour);
 702   6                }break;
 703   5                case rs_kWM:  //å‡ æŒç»­æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 704   5                {
 705   6                  global.set.keepWaterMinute == 0 ? (global.set.keepWaterMinute = 59):(--global.set.keepWaterMinute);
 706   6                }break;
 707   5                case rs_wCD:  //å‡ æµ‡æ°´å‘¨æœŸ-å¤©
 708   5                {
 709   6                  global.set.waterCycleDay == 1 ? (global.set.waterCycleDay = 30):(--global.set.waterCycleDay);
 710   6                }break;
 711   5                case rs_rtcH: //å‡ rtcæ—¶é—´-å°æ—¶
 712   5                {
 713   6                  global.set.hour == 0 ? (global.set.hour = 23):(--global.set.hour);
 714   6                }break;
 715   5                case rs_rtcM: //å‡ rtcæ—¶é—´-åˆ†é’Ÿ
 716   5                {
 717   6                  global.set.minute == 0 ? (global.set.minute = 59):(--global.set.minute);
 718   6                }break;
 719   5              }
 720   4            }
 721   3          }break;
 722   2          //////////////////////////////////////////////////////////çŸ­æŒ‰æµ‡æ°´é”®///////////////////////////////
             -///////////////////////////
 723   2          case shortKey2:
 724   2          {
 725   3            global.set.switchTimeCount = 0; //æ¸…é™¤è®¾ç½®çŠ¶æ€ä¸‹çš„è‡ªåŠ¨åˆ‡æ¢è®¡æ—¶
 726   3      
 727   3            if(global.work.runState <= rs_normal2)  //åœ¨æ­£å¸¸è¿è¡Œçš„ä¸‰ä¸ªçŠ¶æ€ä¸­
 728   3            {
 729   4              if(global.device.water == light)  //å¦‚æœåœ¨æµ‡æ°´
 730   4              {
 731   5                global.set.setSateData = 0x20;  //æµ‡æ°´å…³
 732   5              }
 733   4              else
 734   4              {
 735   5                global.set.setSateData = 0x21;  //æµ‡æ°´å¼€
 736   5              }
 737   4              if(global.set.setSateSate == free)
 738   4              {
 739   5                global.set.setSateSate = start; //å°†åœ¨ workFunc ä¸­å‘é€è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚
 740   5              }
 741   4            }
 742   3            else
 743   3            {
 744   4              switch (global.work.runState)
 745   4              {
 746   5                case rs_sLH:  //åŠ  å¼€å§‹ç…§æ˜æ—¶é—´-å°æ—¶
 747   5                {
 748   6                  global.set.startLightHour == 23 ? (global.set.startLightHour = 0):(++global.set.startLightHour);
 749   6                }break;
 750   5                case rs_sLM:  //åŠ  å¼€å§‹ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 751   5                {
 752   6                  global.set.startLightMinute == 59 ? (global.set.startLightMinute = 0):(++global.set.startLightMinute
             -);
 753   6                }break;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 14  

 754   5                case rs_kLH:  //åŠ  æŒç»­ç…§æ˜æ—¶é—´-å°æ—¶
 755   5                {
 756   6                  global.set.keepLightHour == 23 ? (global.set.keepLightHour = 0):(++global.set.keepLightHour);
 757   6                }break;
 758   5                case rs_kLM:  //åŠ  æŒç»­ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 759   5                {
 760   6                  global.set.keepLightMinute == 59 ? (global.set.keepLightMinute = 0):(++global.set.keepLightMinute);
 761   6                }break;
 762   5                case rs_sWH:  //åŠ  å¼€å§‹æµ‡æ°´æ—¶é—´-å°æ—¶
 763   5                {
 764   6                  global.set.startWaterHour == 23 ? (global.set.startWaterHour = 0):(++global.set.startWaterHour);
 765   6                }break;
 766   5                case rs_sWM:  //åŠ  å¼€å§‹æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 767   5                {
 768   6                  global.set.startWaterMinute == 59 ? (global.set.startWaterMinute = 0):(++global.set.startWaterMinute
             -);
 769   6                }break;
 770   5                case rs_kWH:  //åŠ  æŒç»­æµ‡æ°´æ—¶é—´-å°æ—¶
 771   5                {
 772   6                  global.set.keepWaterHour == 23 ? (global.set.keepWaterHour = 0):(++global.set.keepWaterHour);
 773   6                }break;
 774   5                case rs_kWM:  //åŠ  æŒç»­æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 775   5                {
 776   6                  global.set.keepWaterMinute == 59 ? (global.set.keepWaterMinute = 0):(++global.set.keepWaterMinute);
 777   6                }break;
 778   5                case rs_wCD:  //åŠ  æµ‡æ°´å‘¨æœŸ-å¤©
 779   5                {
 780   6                  global.set.waterCycleDay == 30 ? (global.set.waterCycleDay = 1):(++global.set.waterCycleDay);
 781   6                }break;
 782   5                case rs_rtcH: //åŠ  rtcæ—¶é—´-å°æ—¶
 783   5                {
 784   6                  global.set.hour == 23 ? (global.set.hour = 0):(++global.set.hour);
 785   6                }break;
 786   5                case rs_rtcM: //åŠ  rtcæ—¶é—´-åˆ†é’Ÿ
 787   5                {
 788   6                  global.set.minute == 59 ? (global.set.minute = 0):(++global.set.minute);
 789   6                }break;
 790   5              }
 791   4            }
 792   3          }break;
 793   2          //////////////////////////////////////////////////////////æŒç»­æŒ‰ç…§æ˜é”®--å³è®¾ç½®æ¨¡å¼ä¸‹çš„è¿ç»
             -­+-//////////////////////////////////////////////////////////
 794   2          case shortlongKey1:
 795   2          {
 796   3            global.set.switchTimeCount = 0; //æ¸…é™¤è®¾ç½®çŠ¶æ€ä¸‹çš„è‡ªåŠ¨åˆ‡æ¢è®¡æ—¶
 797   3            
 798   3            if(global.work.runState < rs_sLH) break;
 799   3            
 800   3            switch (global.work.runState)
 801   3            {
 802   4              case rs_sLH:  //å‡ å¼€å§‹ç…§æ˜æ—¶é—´-å°æ—¶
 803   4              {
 804   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 805   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 806   5                {
 807   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 808   6                  global.set.startLightHour == 0 ? (global.set.startLightHour = 23):(--global.set.startLightHour);
 809   6                }
 810   5              }break;
 811   4              case rs_sLM:  //å‡ å¼€å§‹ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 812   4              {
 813   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 15  

 814   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 815   5                {
 816   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 817   6                  global.set.startLightMinute == 0 ? (global.set.startLightMinute = 59):(--global.set.startLightMinute
             -);
 818   6                }
 819   5              }break;
 820   4              case rs_kLH:  //å‡ æŒç»­ç…§æ˜æ—¶é—´-å°æ—¶
 821   4              {
 822   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 823   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 824   5                {
 825   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 826   6                  global.set.keepLightHour == 0 ? (global.set.keepLightHour = 23):(--global.set.keepLightHour);
 827   6                }
 828   5              }break;
 829   4              case rs_kLM:  //å‡ æŒç»­ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 830   4              {
 831   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 832   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 833   5                {
 834   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 835   6                  global.set.keepLightMinute == 0 ? (global.set.keepLightMinute = 59):(--global.set.keepLightMinute);
 836   6                }
 837   5              }break;
 838   4              case rs_sWH:  //å‡ å¼€å§‹æµ‡æ°´æ—¶é—´-å°æ—¶
 839   4              {
 840   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 841   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 842   5                {
 843   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 844   6                  global.set.startWaterHour == 0 ? (global.set.startWaterHour = 23):(--global.set.startWaterHour);
 845   6                }
 846   5              }break;
 847   4              case rs_sWM:  //å‡ å¼€å§‹æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 848   4              {
 849   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 850   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 851   5                {
 852   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 853   6                  global.set.startWaterMinute == 0 ? (global.set.startWaterMinute = 59):(--global.set.startWaterMinute
             -);
 854   6                }
 855   5              }break;
 856   4              case rs_kWH:  //å‡ æŒç»­æµ‡æ°´æ—¶é—´-å°æ—¶
 857   4              {
 858   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 859   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 860   5                {
 861   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 862   6                  global.set.keepWaterHour == 0 ? (global.set.keepWaterHour = 23):(--global.set.keepWaterHour);
 863   6                }
 864   5              }break;
 865   4              case rs_kWM:  //å‡ æŒç»­æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 866   4              {
 867   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 868   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 869   5                {
 870   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 871   6                  global.set.keepWaterMinute == 0 ? (global.set.keepWaterMinute = 59):(--global.set.keepWaterMinute);
 872   6                }
 873   5              }break;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 16  

 874   4              case rs_wCD:  //å‡ æµ‡æ°´å‘¨æœŸ-å¤©
 875   4              {
 876   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 877   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 878   5                {
 879   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 880   6                  global.set.waterCycleDay == 1 ? (global.set.waterCycleDay = 30):(--global.set.waterCycleDay);
 881   6                }
 882   5              }break;
 883   4              case rs_rtcH: //å‡ rtcæ—¶é—´-å°æ—¶
 884   4              {
 885   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 886   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 887   5                {
 888   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 889   6                  global.set.hour == 0 ? (global.set.hour = 23):(--global.set.hour);
 890   6                }
 891   5              }break;
 892   4              case rs_rtcM: //å‡ rtcæ—¶é—´-åˆ†é’Ÿ
 893   4              {
 894   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 895   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 896   5                {
 897   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 898   6                  global.set.minute == 0 ? (global.set.minute = 59):(--global.set.minute);
 899   6                }
 900   5              }break;
 901   4            }
 902   3          }break;
 903   2          //////////////////////////////////////////////////////////æŒç»­æŒ‰æµ‡æ°´é”®--å³è®¾ç½®æ¨¡å¼ä¸‹çš„è¿ç»
             -­+-//////////////////////////////////////////////////////////
 904   2          case shortlongKey2:
 905   2          {
 906   3            global.set.switchTimeCount = 0; //æ¸…é™¤è®¾ç½®çŠ¶æ€ä¸‹çš„è‡ªåŠ¨åˆ‡æ¢è®¡æ—¶
 907   3            
 908   3            if(global.work.runState < rs_sLH) break;
 909   3      
 910   3            switch (global.work.runState)
 911   3            {
 912   4              case rs_sLH:  //åŠ  å¼€å§‹ç…§æ˜æ—¶é—´-å°æ—¶
 913   4              {
 914   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 915   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 916   5                {
 917   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 918   6                  global.set.startLightHour == 23 ? (global.set.startLightHour = 0):(++global.set.startLightHour);
 919   6                }
 920   5              }break;
 921   4              case rs_sLM:  //åŠ  å¼€å§‹ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 922   4              {
 923   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 924   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 925   5                {
 926   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 927   6                  global.set.startLightMinute == 59 ? (global.set.startLightMinute = 0):(++global.set.startLightMinute
             -);
 928   6                }
 929   5              }break;
 930   4              case rs_kLH:  //åŠ  æŒç»­ç…§æ˜æ—¶é—´-å°æ—¶
 931   4              {
 932   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 933   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 17  

 934   5                {
 935   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 936   6                  global.set.keepLightHour == 23 ? (global.set.keepLightHour = 0):(++global.set.keepLightHour);
 937   6                }
 938   5              }break;
 939   4              case rs_kLM:  //åŠ  æŒç»­ç…§æ˜æ—¶é—´-åˆ†é’Ÿ
 940   4              {
 941   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 942   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 943   5                {
 944   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 945   6                  global.set.keepLightMinute == 59 ? (global.set.keepLightMinute = 0):(++global.set.keepLightMinute);
 946   6                }
 947   5              }break;
 948   4              case rs_sWH:  //åŠ  å¼€å§‹æµ‡æ°´æ—¶é—´-å°æ—¶
 949   4              {
 950   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 951   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 952   5                {
 953   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 954   6                  global.set.startWaterHour == 23 ? (global.set.startWaterHour = 0):(++global.set.startWaterHour);
 955   6                }
 956   5              }break;
 957   4              case rs_sWM:  //åŠ  å¼€å§‹æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 958   4              {
 959   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 960   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 961   5                {
 962   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 963   6                  global.set.startWaterMinute == 59 ? (global.set.startWaterMinute = 0):(++global.set.startWaterMinute
             -);
 964   6                }
 965   5              }break;
 966   4              case rs_kWH:  //åŠ  æŒç»­æµ‡æ°´æ—¶é—´-å°æ—¶
 967   4              {
 968   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 969   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 970   5                {
 971   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 972   6                  global.set.keepWaterHour == 23 ? (global.set.keepWaterHour = 0):(++global.set.keepWaterHour);
 973   6                }
 974   5              }break;
 975   4              case rs_kWM:  //åŠ  æŒç»­æµ‡æ°´æ—¶é—´-åˆ†é’Ÿ
 976   4              {
 977   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 978   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 979   5                {
 980   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 981   6                  global.set.keepWaterMinute == 59 ? (global.set.keepWaterMinute = 0):(++global.set.keepWaterMinute);
 982   6                }
 983   5              }break;
 984   4              case rs_wCD:  //åŠ  æµ‡æ°´å‘¨æœŸ-å¤©
 985   4              {
 986   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 987   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 988   5                {
 989   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 990   6                  global.set.waterCycleDay == 30 ? (global.set.waterCycleDay = 1):(++global.set.waterCycleDay);
 991   6                }
 992   5              }break;
 993   4              case rs_rtcH: //åŠ  rtcæ—¶é—´-å°æ—¶
 994   4              {
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 18  

 995   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
 996   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
 997   5                {
 998   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
 999   6                  global.set.hour == 23 ? (global.set.hour = 0):(++global.set.hour);
1000   6                }
1001   5              }break;
1002   4              case rs_rtcM: //åŠ  rtcæ—¶é—´-åˆ†é’Ÿ
1003   4              {
1004   5                ioData.key.modeLock = shortlongKey1;  //é”å®šåœ¨è¯¥æ¨¡å¼,é¿å…è¿‡ä¹…çš„é•¿æŒ‰è§¦å‘é•¿æŒ‰é”®å€¼
1005   5                if(ioData.key.pressTime_100ms >= shortlongtime100)  //msè§¦å‘ä¸€æ¬¡
1006   5                {
1007   6                  ioData.key.timeCount = 0; //æ¸…ç©ºè®¡æ•°ï¼Œé‡æ–°è®¡æ—¶
1008   6                  global.set.minute == 59 ? (global.set.minute = 0):(++global.set.minute);
1009   6                }
1010   5              }break;
1011   4            }
1012   3          }break;
1013   2          //////////////////////////////////////////////////////////é•¿æŒ‰ç…§æ˜é”®///////////////////////////////
             -///////////////////////////
1014   2          case longKey1:
1015   2          {
1016   3            if(global.work.runState <= rs_normal2)
1017   3            {
1018   4              global.set.setSateData = 0x01;  //è¿æ¥wifi
1019   4              if(global.set.setSateSate == free)
1020   4              {
1021   5                global.set.setSateSate = start; //å°†åœ¨ workFunc ä¸­å‘é€è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚
1022   5              }
1023   4            }
1024   3          }break;
1025   2          //////////////////////////////////////////////////////////é•¿æŒ‰æµ‡æ°´é”®///////////////////////////////
             -///////////////////////////
1026   2          case longKey2:
1027   2          {
1028   3            if(global.work.runState <= rs_normal2)
1029   3            {
1030   4              global.set.setAppointmentFlag = true; //ç½®ä½é¢„çº¦è®¾ç½®æ ‡å¿—ï¼Œå°†åœ¨å¾—åˆ°åº”ç­”ååœ¨ workFunc ä
             -¸­è¢«ä½¿ç”¨
1031   4              global.set.setDataSate = start; //å°†åœ¨ workFunc ä¸­å‘é€è®¾ç½®å‚æ•°è·å–è¯·æ±‚
1032   4            }
1033   3          }break;
1034   2          //////////////////////////////////////////////////////////é•¿æŒ‰ç»„åˆé”®///////////////////////////////
             -///////////////////////////
1035   2          case longDoubleKey:
1036   2          {
1037   3            if(global.work.runState <= rs_normal2)
1038   3            {
1039   4              global.set.setRtcFlag = true; //ç½®ä½é¢„çº¦è®¾ç½®æ ‡å¿—
1040   4              global.set.setDataSate = start; //å°†åœ¨ workFunc ä¸­å‘é€è®¾ç½®å‚æ•°è·å–è¯·æ±‚
1041   4            }
1042   3          }break;
1043   2          default:  break;
1044   2        }
1045   1      }
1046          
1047          ////////////////////////////////////////////////////LEDæ˜¾ç¤ºéƒ¨åˆ†///////////////////////////////////////
             -///////////////////////////////
1048          
1049          void setDisplayNumber(unsigned char num1,unsigned char num2,unsigned char num3)
1050          {
1051   1        global.display.number1 = num1;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 19  

1052   1        global.display.number2 = num2;
1053   1        global.display.number3 = num3;
1054   1      }
1055          
1056          void displayLed(void)
1057          {
1058   1        static unsigned int LedBlinkTimerCount = 0,LedBlinkTimerCount1 = 0;
1059   1        unsigned char timeBase0 = 250,timeBase1 = 125;
1060   1        static unsigned char timeBase2 = 0,timeBase3 = 0;
1061   1        LedBlinkTimerCount >= timeBase0? LedBlinkTimerCount = 0: ++LedBlinkTimerCount;
1062   1        LedBlinkTimerCount1 >= timeBase2? LedBlinkTimerCount1 = 0: ++LedBlinkTimerCount1;
1063   1      
1064   1        LED_EN3;
1065   1        switch(global.display.wifi)
1066   1        { //////åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­ 4ms è¿›å…¥ä¸€æ¬¡
1067   2          case offline: resetLed(0); break; //ç¦»çº¿,å¸¸ç­
1068   2          case connecting:  //ä¸€é”®é…ç½®,å‘¨æœŸ40ms,äº®20ms,ç­20ms
1069   2          {
1070   3            timeBase2 = 100; timeBase3 = 50;
1071   3            LedBlinkTimerCount1 < timeBase3? setLed(0):resetLed(0);
1072   3          }break;
1073   2          case connectToAp: //è¿æ¥è·¯ç”±,å‘¨æœŸ100ms,äº®20ms,ç­80ms
1074   2          {
1075   3            timeBase2 = 250; timeBase3 = 50;
1076   3            LedBlinkTimerCount1 < timeBase3? setLed(0):resetLed(0);
1077   3          }break;
1078   2          case connectToService:  //è¿æ¥è·¯ç”±,å‘¨æœŸ100ms,äº®50ms,ç­50ms
1079   2          {
1080   3            timeBase2 = 250; timeBase3 = 125;
1081   3            LedBlinkTimerCount1 < timeBase3? setLed(0):resetLed(0);
1082   3          }break;
1083   2          case online: setLed(0); break;  //åœ¨çº¿,å¸¸äº®
1084   2        }
1085   1        switch(global.display.appointment)
1086   1        {
1087   2          case light: setLed(1); break;
1088   2          case dark: resetLed(1); break;
1089   2          case blink:
1090   2          {
1091   3            LedBlinkTimerCount >= timeBase1? setLed(1):resetLed(1);
1092   3          }break;
1093   2        }
1094   1        switch(global.display.light)
1095   1        {
1096   2          case light: setLed(2); break;
1097   2          case dark: resetLed(2); break;
1098   2          case blink:
1099   2          {
1100   3            LedBlinkTimerCount >= timeBase1? setLed(2):resetLed(2);
1101   3          }break;
1102   2        }
1103   1        switch(global.display.water)
1104   1        {
1105   2          case light: setLed(3); break;
1106   2          case dark: resetLed(3); break;
1107   2          case blink:
1108   2          {
1109   3            LedBlinkTimerCount >= timeBase1? setLed(3):resetLed(3);
1110   3          }break;
1111   2        }
1112   1        switch(global.display.nowater)
1113   1        {
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 20  

1114   2          case light: setLed(4); break;
1115   2          case dark: resetLed(4); break;
1116   2          case blink:
1117   2          {
1118   3            LedBlinkTimerCount >= timeBase1? setLed(4):resetLed(4);
1119   3          }break;
1120   2        }
1121   1      }
1122          
1123          ////////////////////////////////////////////////////é€šä¿¡æ•°æ®è§£æ////////////////////////////////////
             -//////////////////////////////////
1124          
1125          void parseDataFromBottom(void)
1126          {
1127   1        unsigned char len = 0,sum = 0;
1128   1        unsigned char buff[32] = {0};
1129   1        unsigned int cmd = 0,temp = 0;
1130   1        len = oneWire_read(buff);
1131   1        if(len != 0)  //å¤§äº0åˆ™è¯´æ˜æœ‰æ•°æ®åŒ…
1132   1        {
1133   2          sum = figureSum(buff,len-1);
1134   2          if(buff[0] == 0x96 && buff[len-1] == sum) //ç¡®è®¤åŒ…å¤´å’Œæ ¡éªŒ
1135   2          {
1136   3            cmd = buff[2]<<8 | buff[3];
1137   3            switch(cmd)
1138   3            {
1139   4              case 0x0002:  //è®¾å¤‡çŠ¶æ€è·å–çš„å“åº”
1140   4              {
1141   5                global.device.wifi = buff[4]; //wifiæŒ‡ç¤ºç¯çš„çŠ¶æ€
1142   5                global.device.appointment = buff[5];  //é¢„çº¦æŒ‡ç¤ºç¯çš„çŠ¶æ€
1143   5                global.device.light = buff[6];  //ç…§æ˜æŒ‡ç¤ºç¯çš„çŠ¶æ€
1144   5                global.device.water = buff[7];  //æµ‡æ°´æŒ‡ç¤ºç¯çš„çŠ¶æ€
1145   5                global.device.nowater = buff[8];  //ç¼ºæ°´æŒ‡ç¤ºç¯çš„çŠ¶æ€
1146   5                temp = buff[9]<<8 | buff[10]; //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹ç…§æ˜çš„å€’è®¡æ—¶ï¼Œå•ä½åˆ†é’Ÿ
1147   5                global.device.nextStartLightCountDown = temp;
1148   5                // if(temp > 999) global.device.nextStartLightCountDown = 999;
1149   5                // else global.device.nextStartLightCountDown = temp;
1150   5                temp = buff[11]<<8 | buff[12];  //è·ç¦»ç»“æŸç…§æ˜çš„å€’è®¡æ—¶ï¼Œå•ä½åˆ†é’Ÿ
1151   5                global.device.endLightCountDown = temp;
1152   5                // if(temp > 999) global.device.endLightCountDown = 999;
1153   5                // else global.device.endLightCountDown = temp;
1154   5                temp  = buff[13]<<8 | buff[14]; //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹æµ‡æ°´çš„å€’è®¡æ—¶ï¼Œå•ä½åˆ†é’Ÿ
1155   5                global.device.nextStartWaterCountDown = temp;
1156   5                // if(temp > 999) global.device.nextStartWaterCountDown = 999;
1157   5                // else global.device.nextStartWaterCountDown = temp;
1158   5                temp = buff[15]<<8 | buff[16];  //è·ç¦»ç»“æŸæµ‡æ°´çš„å€’è®¡æ—¶ï¼Œå•ä½åˆ†é’Ÿ
1159   5                global.device.endWaterCountDown = temp;
1160   5                // if(temp > 999) global.device.endWaterCountDown = 999;
1161   5                // else global.device.endWaterCountDown = temp;
1162   5      
1163   5                // global.set.setSateSate = free;
1164   5              }break;
1165   4              case 0x0004:  //è®¾ç½®å‚æ•°è·å–çš„å“åº”
1166   4              {
1167   5                if(buff[4] > 23) global.set.hour = 23;  //åˆ¤æ–­æ˜¯å¦è¶…å‡ºèŒƒå›´
1168   5                else global.set.hour = buff[4]; //rtcæ—¶é—´-å°æ—¶
1169   5                if(buff[5] > 59) global.set.minute = 59;
1170   5                else global.set.minute = buff[5]; //rtcæ—¶é—´-åˆ†é’Ÿ
1171   5                if(buff[6] > 23) global.set.startLightHour = 23;
1172   5                else global.set.startLightHour = buff[6]; //é¢„çº¦å¼€å§‹ç…§æ˜çš„æ—¶é—´-å°æ—¶
1173   5                if(buff[7] > 59) global.set.startLightMinute = 59;
1174   5                else global.set.startLightMinute = buff[7]; //é¢„çº¦å¼€å§‹ç…§æ˜çš„æ—¶é—´-åˆ†é’Ÿ
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 21  

1175   5                if(buff[8] > 23) global.set.keepLightHour = 23;
1176   5                else global.set.keepLightHour = buff[8];  //é¢„çº¦æŒç»­ç…§æ˜çš„æ—¶é—´-å°æ—¶
1177   5                if(buff[9] > 59) global.set.keepLightMinute = 59;
1178   5                else global.set.keepLightMinute = buff[9];  //é¢„çº¦æŒç»­ç…§æ˜çš„æ—¶é—´-åˆ†é’Ÿ
1179   5                if(buff[10] > 23) global.set.startWaterHour = 23;
1180   5                else global.set.startWaterHour = buff[10];  //é¢„çº¦å¼€å§‹æµ‡æ°´çš„æ—¶é—´-å°æ—¶
1181   5                if(buff[11] > 59) global.set.startWaterMinute = 59;
1182   5                else global.set.startWaterMinute = buff[11];  //é¢„çº¦å¼€å§‹æµ‡æ°´çš„æ—¶é—´-åˆ†é’Ÿ
1183   5                if(buff[12] > 23) global.set.keepWaterHour = 23;
1184   5                else global.set.keepWaterHour = buff[12]; //é¢„çº¦æŒç»­æµ‡æ°´çš„æ—¶é—´-å°æ—¶
1185   5                if(buff[13] > 59) global.set.keepWaterMinute = 59;
1186   5                else global.set.keepWaterMinute = buff[13]; //é¢„çº¦æŒç»­æµ‡æ°´çš„æ—¶é—´-åˆ†é’Ÿ
1187   5                if(buff[14] > 30) global.set.waterCycleDay = 30;
1188   5                else global.set.waterCycleDay = buff[14]; //é¢„çº¦æµ‡æ°´çš„å‘¨æœŸ-å¤©
1189   5                //å¿…é¡»åœ¨è·å–å®Œå‚æ•°åæ‰å¯ä»¥åˆ‡æ¢çŠ¶æ€
1190   5                if(global.set.setDataSate == waitAck) //å¦‚æœè®¾ç½®çŠ¶æ€å¤„äºå¾…åº”ç­”
1191   5                {
1192   6                  global.set.setDataSate = ing; //å°†çŠ¶æ€åˆ‡æ¢åˆ°è®¾ç½®ä¸­
1193   6                }
1194   5              }break;
1195   4              case 0x0007:  //è®¾ç½®å‚æ•°å®Œæˆçš„å“åº”
1196   4              {
1197   5                if(global.set.setDataSate == waitAck) //å¦‚æœè®¾ç½®çŠ¶æ€å¤„äºå¾…åº”ç­”
1198   5                {
1199   6                  global.set.setDataSate = ack; //å°†çŠ¶æ€åˆ‡æ¢åˆ°å·²åº”ç­”
1200   6                }
1201   5              }break;
1202   4            }
1203   3          }
1204   2        }
1205   1      }
1206          
1207          /////////////////////////////////////////////////å•æ€»çº¿é€šä¿¡//////////////////////////////////////////
             -//////////////
1208          
1209          #define ONE_WIRE_A P06
1210          #define ONE_WIRE_A_MODE P06_Quasi_Mode
1211          #define ONE_WIRE_A_H set_P06
1212          #define ONE_WIRE_A_L clr_P06
1213          #define ONE_WIRE_B P07
1214          #define ONE_WIRE_B_MODE P07_Quasi_Mode
1215          #define ONE_WIRE_B_H set_P07
1216          #define ONE_WIRE_B_L clr_P07
1217          
1218          #define ONE_WIRE_READ ONE_WIRE_A
1219          #define ONE_WIRE_WRITE(b) if(b) ONE_WIRE_B_H; else ONE_WIRE_B_L
1220          
1221          void OneWire_init(void)
1222          {
1223   1        ONE_WIRE_A_MODE;
1224   1        ONE_WIRE_B_MODE;
1225   1      
1226   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿
1227   1      }
1228          
1229          void oneWire_start(void)
1230          {
1231   1        ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºèµ·å§‹ä¿¡å·
1232   1        Timer0_Delay1ms(10);
1233   1      }
1234          
1235          void oneWire_stop(void)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 22  

1236          {
1237   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿ä½œä¸ºåœæ­¢ä¿¡å·
1238   1      }
1239          
1240          //
1241          //  å†™ä¸€ä¸ªå­—èŠ‚å…«ä½æ•°æ®
1242          //
1243          void oneWire_writeByte(unsigned char dat)
1244          {
1245   1        unsigned char i = 8;
1246   1      
1247   1        while(i--)
1248   1        {
1249   2          ONE_WIRE_WRITE(1);  //æ‹‰é«˜å†™æ€»çº¿ä¼ è¾“ä¸€ä½æ•°æ®
1250   2          if(dat & 0x80)
1251   2            Timer0_Delay100us(5); //å†™é«˜ç”µå¹³
1252   2          else
1253   2            Timer0_Delay100us(2); //å†™ä½ç”µå¹³
1254   2          dat <<= 1;
1255   2          ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºä½ä¹‹é—´çš„é—´éš”
1256   2          Timer0_Delay100us(2);
1257   2        }
1258   1      }
1259          
1260          //
1261          //  å†™æ•°æ®åŒ…ï¼Œé€šä¿¡è§„åˆ™ä¸­ï¼Œèµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¿…é¡»ä¸ºæ•°æ®åŒ…çš„é•¿åº¦(è¯¥å­—èŠ‚
             -ä¸è®¡ç®—åœ¨é•¿åº¦å†…)
1262          //
1263          void oneWire_write(unsigned char* buff,unsigned char len)
1264          {
1265   1        oneWire_start();  //èµ·å§‹ä¿¡å·
1266   1        oneWire_writeByte(len); //å‘é€æ•°æ®é•¿åº¦
1267   1        while(len--)  //æ•°æ®åŒ…é•¿åº¦
1268   1        {
1269   2          oneWire_writeByte(*buff); //å‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®
1270   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
1271   2        }
1272   1        oneWire_stop(); //åœæ­¢ä¿¡å·
1273   1      }
1274          
1275          //
1276          //  è¯»æ•°æ®åŒ…ï¼ŒæˆåŠŸåè¿”å›æ•°æ®åŒ…é•¿åº¦,å¤±è´¥ä¸º0
1277          //
1278          unsigned char oneWire_read(unsigned char* buff)
1279          {
1280   1        unsigned int timeOut = 0;
1281   1        unsigned char count = 0,dat = 0,transFlag = 0,index = 0,lenFlag = 0,lenCount = 0,len = 0;
1282   1        if(!ONE_WIRE_READ)  //ä½ç”µå¹³ï¼Œæ”¶åˆ°èµ·å§‹ä¿¡å·
1283   1        {
1284   2          while(1)
1285   2          {
1286   3            if(ONE_WIRE_READ) //é«˜ç”µå¹³ï¼Œè®¡ç®—æŒç»­æ—¶é—´
1287   3            {
1288   4              ++count;  //è®°å½•é«˜ç”µå¹³æŒç»­æ—¶é—´
1289   4              transFlag = 1;  //ç”µå¹³è·³å˜æ ‡å¿—
1290   4            }
1291   3            else if(!ONE_WIRE_READ && transFlag == 1) //è¯»æ€»çº¿ä¸ºä½ç”µå¹³å¹¶ä¸”åªæœ‰åœ¨ç”µå¹³è·³å˜åæ‰è¿›å…
             -¥
1292   3            { //ä¸€ä½æ•°æ®ç»“æŸï¼Œåˆ¤æ–­ä¹‹å‰çš„é«˜ç”µå¹³ä¼ è¾“çš„æ˜¯1è¿˜æ˜¯0
1293   4              dat <<= 1;
1294   4              if(count > 3) //å¤§äº300uså°±ç®—é«˜ç”µå¹³
1295   4                dat |= 1;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 23  

1296   4              count = 0;  //æ¸…é«˜ç”µå¹³è®¡æ•°
1297   4              timeOut = 0;  //æ¸…è¶…æ—¶è®¡æ•°
1298   4              transFlag = 0;  //æ¸…ç”µå¹³è·³å˜æ ‡å¿—
1299   4              if(++index == 8)  //æ¯è¯»å…«ä½ï¼Œå³ä¸€ä¸ªå­—èŠ‚è¿›å…¥ä¸€æ¬¡
1300   4              {
1301   5                if(lenFlag == 0)  //èµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œç”¨äºè¯´æ˜æ•°æ®åŒ…çš„é•¿åº¦
1302   5                {
1303   6                  lenFlag = 1;  //å·²æ¥æ”¶åˆ°é•¿åº¦
1304   6                  len = dat;
1305   6                }
1306   5                else  //æ•°æ®åŒ…çš„å†…å®¹
1307   5                {
1308   6                  *buff = dat;
1309   6                  if(++lenCount == len) //æ•°æ®åŒ…æ¥æ”¶å®Œæˆ
1310   6                  {
1311   7                    Timer0_Delay100us(3); //ç­‰ä½ç”µå¹³è¿‡å»ï¼Œä»¥é˜²æ­¢è¿ç»­ä¼ è¾“æ—¶é”™è¯¯çš„å°†ç”¨ä½œé—´éš”çš„ä½
             -ç”µå¹³è¯†åˆ«ä¸ºèµ·å§‹ä¿¡å·
1312   7                    return len; //ç»“æŸ,å¹¶è¿”å›é•¿åº¦
1313   7                  }
1314   6                  else  //æ²¡æ¥æ”¶å®Œæˆå°±ç»§ç»­æ¥æ”¶ï¼Œè¿™é‡Œå•ç‹¬è‡ªå¢æ˜¯ä¸ºäº†é˜²æ­¢æº¢å‡º
1315   6                  {
1316   7                    ++buff;
1317   7                  }
1318   6                }
1319   5                index = 0;  //æ¸…è®¡æ•°
1320   5                dat = 0x00; //æ¸…å˜é‡
1321   5              }
1322   4            }
1323   3            Timer0_Delay100us(1); //è¶…æ—¶å¤„ç†
1324   3            if(++timeOut > 200) return 0; //è¶…æ—¶
1325   3          }
1326   2        }
1327   1        return 0;
1328   1      }
1329          
1330          
1331          //
1332          //å’Œæ ¡éªŒè®¡ç®—
1333          //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
1334          //
1335          unsigned char figureSum(unsigned char* buff,unsigned char len)
1336          {
1337   1        unsigned char sum = 0;
1338   1      
1339   1        while(len--)
1340   1        {
1341   2          sum += *buff;
1342   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
1343   2        }
1344   1        return sum;
1345   1      }
1346          
1347          ///////////////////////////////////////////////ä¸²å£0æ¥æ”¶è§£æ////////////////////////////////////////
             -//////////////
1348          
1349          // //
1350          // //å’Œæ ¡éªŒè®¡ç®—
1351          // //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
1352          // //
1353          // unsigned char figureSum(unsigned char* buff,unsigned char len)
1354          // {
1355          //  unsigned char sum = 0;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 24  

1356          
1357          //  sum += *buff++;
1358          //  while(--len)
1359          //  {
1360          //    sum += *buff++;
1361          //  }
1362          //  return sum;
1363          // }
1364          
1365          // void uart0_fun(unsigned char* buff)
1366          // {
1367          //  switch(buff[3]) //ä¸‹æ ‡2å’Œ3ä¸ºæ¶ˆæ¯ç±»å‹ï¼Œä½†ç›®å‰2ä¸º0x00æ‰€ä»¥åˆ¤æ–­3å³å¯
1368          //  {
1369          //    case 0x02:  //è®¾å¤‡çŠ¶æ€è·å–çš„å“åº”
1370          //    {
1371          //      //wifiæŒ‡ç¤ºç¯çš„çŠ¶æ€
1372          //      global.device.wifi = buff[4]; //WiFiæŒ‡ç¤ºç¯çŠ¶æ€
1373          //      global.device.appointment = buff[5];  //é¢„çº¦æŒ‡ç¤ºç¯çš„çŠ¶æ€
1374          //      global.device.light = buff[6];  //ç…§æ˜æŒ‡ç¤ºç¯çš„çŠ¶æ€
1375          //      global.device.water = buff[7];  //æµ‡æ°´æŒ‡ç¤ºç¯çš„çŠ¶æ€
1376          //      global.device.nowater = buff[8];  //ç¼ºæ°´æŒ‡ç¤ºç¯çš„çŠ¶æ€
1377          //      global.device.nextStartLightCountDown = buff[9]<<8 | buff[10];  //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹ç…§æ˜çš„å€’è®
             -¡æ—¶ï¼Œå•ä½åˆ†é’Ÿ
1378          //      global.device.endLightCountDown = buff[11]<<8 | buff[12]; //è·ç¦»ç»“æŸç…§æ˜çš„å€’è®¡æ—¶ï¼Œå•ä½å
             -ˆ†é’Ÿ
1379          //      global.device.nextStartWaterCountDown = buff[13]<<8 | buff[14]; //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹æµ‡æ°´çš„å€’è
             -®¡æ—¶ï¼Œå•ä½åˆ†é’Ÿ
1380          //      global.device.endWaterCountDown = buff[15]<<8 | buff[16]; //è·ç¦»ç»“æŸæµ‡æ°´çš„å€’è®¡æ—¶ï¼Œå•ä½å
             -ˆ†é’Ÿ
1381          
1382          //      global.set.setSateSate = end;
1383          //    }break;
1384          //    case 0x04:  //è®¾ç½®å‚æ•°è·å–çš„å“åº”
1385          //    {
1386          //      global.set.hour = buff[4];  //rtcæ—¶é—´-å°æ—¶
1387          //      global.set.minute = buff[5];  //rtcæ—¶é—´-åˆ†é’Ÿ
1388          //      global.set.startLightHour = buff[6];  //é¢„çº¦å¼€å§‹ç…§æ˜çš„æ—¶é—´-å°æ—¶
1389          //      global.set.startLightMinute = buff[7];  //é¢„çº¦å¼€å§‹ç…§æ˜çš„æ—¶é—´-åˆ†é’Ÿ
1390          //      global.set.keepLightHour = buff[8]; //é¢„çº¦æŒç»­ç…§æ˜çš„æ—¶é—´-å°æ—¶
1391          //      global.set.keepLightMinute = buff[9]; //é¢„çº¦æŒç»­ç…§æ˜çš„æ—¶é—´-åˆ†é’Ÿ
1392          //      global.set.startWaterHour = buff[10]; //é¢„çº¦å¼€å§‹æµ‡æ°´çš„æ—¶é—´-å°æ—¶
1393          //      global.set.startWaterMinute = buff[11]; //é¢„çº¦å¼€å§‹æµ‡æ°´çš„æ—¶é—´-åˆ†é’Ÿ
1394          //      global.set.keepWaterHour = buff[12];  //é¢„çº¦æŒç»­æµ‡æ°´çš„æ—¶é—´-å°æ—¶
1395          //      global.set.keepWaterMinute = buff[13];  //é¢„çº¦æŒç»­æµ‡æ°´çš„æ—¶é—´-åˆ†é’Ÿ
1396          //      global.set.waterCycleDay = buff[14];  //é¢„çº¦æµ‡æ°´çš„å‘¨æœŸ-å¤©
1397          //      //å¿…é¡»åœ¨è·å–å®Œå‚æ•°åæ‰å¯ä»¥åˆ‡æ¢çŠ¶æ€
1398          //      if(global.set.setDataSate == waitAck) //å¦‚æœè®¾ç½®çŠ¶æ€å¤„äºå¾…åº”ç­”
1399          //      {
1400          //        global.set.setDataSate = ing; //å°†çŠ¶æ€åˆ‡æ¢åˆ°è®¾ç½®ä¸­
1401          //      }
1402          //    }break;
1403          //    case 0x07:  //è®¾ç½®å‚æ•°å®Œæˆçš„å“åº”
1404          //    {
1405          //      if(global.set.setDataSate == waitAck) //å¦‚æœè®¾ç½®çŠ¶æ€å¤„äºå¾…åº”ç­”
1406          //      {
1407          //        global.set.setDataSate = ack; //å°†çŠ¶æ€åˆ‡æ¢åˆ°å·²åº”ç­”
1408          //      }
1409          //    }break;
1410          //  }
1411          // }
1412          
1413          // void uart0_isr(unsigned char dat)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 25  

1414          // {
1415          //  unsigned char i,sum = 0;
1416          //  //åˆ¤æ–­æ¥æ”¶çš„æ•°æ®æ˜¯å¦ç¬¦åˆé€šä¿¡æ ¼å¼
1417          //  if(global.uart.nowIndex == 0 && dat == 0x96)  //å¤´
1418          //  {
1419          //    global.uart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½“å‰
             -æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1420          //    global.uart.recBuff[global.uart.nowIndex] = dat;
1421          //    ++global.uart.nowIndex;
1422          //  }
1423          //  else if(global.uart.nowIndex == 1)  //æ•°æ®é•¿åº¦
1424          //  {
1425          //    global.uart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”
             -¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1426          //    global.uart.recBuff[global.uart.nowIndex] = dat;  //é•¿åº¦ï¼šä»å¤´åˆ°æ ¡éªŒ
1427          //    ++global.uart.nowIndex;
1428          //  }
1429          //  else if(global.uart.nowIndex >= 2 && global.uart.nowIndex <= global.uart.recBuff[1]-2)  //å‡å»äº†æ ¡é
             -ªŒå­—èŠ‚ï¼Œå› ä¸ºä¸‹æ ‡æ¯”å®é™…é•¿åº¦å°1ï¼Œæ‰€ä»¥-2
1430          //  {
1431          //    global.uart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”
             -¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1432          //    global.uart.recBuff[global.uart.nowIndex] = dat;  //æ•°æ®
1433          //    ++global.uart.nowIndex;
1434          //  }
1435          //  else if(global.uart.nowIndex == global.uart.recBuff[1]-1) //æ ¡éªŒ
1436          //  {
1437          //    //ä¹‹åæ›´æ”¹æ¨¡å¼ï¼Œå°†è€—æ—¶æ“ä½œéƒ½ç§»èµ°
1438          
1439          //    global.uart.recTimeOutCount = 0;  //å…³é—­è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ™ä¸è®¡æ—¶
1440          //    global.uart.sendTimeOutCount = 0;
1441          //    for(i = 0;i <= global.uart.recBuff[1] - 2;i++)  //è®¡ç®—æ ¡éªŒå’Œ
1442          //    {
1443          //      sum += global.uart.recBuff[i];
1444          //    }
1445          //    if(sum == dat)  //æ ¡éªŒé€šè¿‡
1446          //    {
1447          //      global.uart.recBuff[global.uart.nowIndex] = dat;  //æ ¡éªŒ
1448          //      uart0_fun(global.uart.recBuff); //åŠŸèƒ½åˆ¤æ–­
1449          //    }
1450          //    global.uart.nowIndex = 0;
1451          //  }
1452          // }
1453          
1454          // void delay(unsigned int a)
1455          // {
1456          //  unsigned int b = 0;
1457          //  for(;a > 0;a--)
1458          //  {
1459          //    for(;b < 100;b++);
1460          //  }
1461          // }
1462          
1463          // void uart0_sendData(unsigned char* buff,unsigned char len)
1464          // {
1465          //  global.uart.sendTimeOutCount = 1;
1466            
1467          //  while(len--)
1468          //  {
1469          //    SBUF = *buff++;
1470          //      while(TI==0);
1471          //    delay(20);
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:52 PAGE 26  

1472          //  }
1473          // }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   7790    ----
   CONSTANT SIZE    =     32    ----
   XDATA SIZE       =     10      58
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
