C51 COMPILER V9.60.0.0   KEY                                                               08/12/2019 14:05:33 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\Objects\key.obj
COMPILER INVOKED BY: C:\Users\W\AppData\Local\Keil\Keil_v4\C51\BIN\C51.EXE ..\lib\user\src\key.c OPTIMIZE(8,SPEED) BROWS
                    -E INCDIR(..\lib\n76e003\Include;..\lib\user\inc) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\Listings\key.lst) TABS(2
                    -) OBJECT(.\Objects\key.obj)

line level    source

   1          #include "key.h"
   2          
   3          Struct_BeepData BeepData = {0};
   4          
   5          
   6          static unsigned char keySetFlag = 0,keySetFlow = 0;
   7          
   8          void keyFunction(void)
   9          {
  10   1        switch(keyScanf())
  11   1        {
  12   2          case noneKey: return; break;
  13   2          ////////////////////////////////////////短按照明键//////////////////////////////////////////////
  14   2          case shortKey1:
  15   2          {
  16   3            if(keySetFlag)
  17   3            {
  18   4              switch(keySetFlow)
  19   4              {
  20   5                case 0: //设置照明预约时长
  21   5                {
  22   6                  runData.displayLed_light = light;
  23   6                  runData.displayLed_water = dark;
  24   6                  userData.setTime_light == 0 ? (userData.setTime_light = 24):(--userData.setTime_light);
  25   6                  runData.displayNumber = userData.setTime_light;
  26   6                }break;
  27   5                case 1: //设置照明时长
  28   5                {
  29   6                  runData.displayLed_light = light;
  30   6                  runData.displayLed_water = dark;
  31   6                  userData.workTime_light == 0 ? (userData.workTime_light = 24):(--userData.workTime_light);
  32   6                  runData.displayNumber = userData.workTime_light;
  33   6                }break;
  34   5                case 2: //设置浇水预约时长
  35   5                {
  36   6                  runData.displayLed_light = dark;
  37   6                  runData.displayLed_water = light;
  38   6                  userData.setTime_water == 0 ? (userData.setTime_water = 24):(--userData.setTime_water);
  39   6                  runData.displayNumber = userData.setTime_water;
  40   6                }break;
  41   5                case 3: //设置浇水时长
  42   5                {
  43   6                  runData.displayLed_light = dark;
  44   6                  runData.displayLed_water = light;
  45   6                  userData.workTime_water == 0 ? (userData.workTime_water = 24):(--userData.workTime_water);
  46   6                  runData.displayNumber = userData.workTime_water;
  47   6                }break;
  48   5              }
  49   4            }
  50   3            else if(runData.runMode == mode_keySetHour )  ////设置时间-减--时
  51   3            {
  52   4              runData.rtcHour == 0 ? (runData.rtcHour = 23):(--runData.rtcHour);
  53   4            }
C51 COMPILER V9.60.0.0   KEY                                                               08/12/2019 14:05:33 PAGE 2   

  54   3            else if(runData.runMode == mode_keySetMinute )  ////设置时间-减--分
  55   3            {
  56   4              runData.rtcMinute == 0 ? (runData.rtcMinute = 59):(--runData.rtcMinute);
  57   4            }
  58   3            else
  59   3            {
  60   4              //这里发送照明指令
  61   4              runData.displayLed_light = light;
  62   4              runData.runLightFlag = 1;
  63   4            }
  64   3          }break;
  65   2          ////////////////////////////////////////长按WIFI键//////////////////////////////////////////////
  66   2          case longKey1:
  67   2          {
  68   3            if(!keySetFlag && runData.runMode == mode_normal)
  69   3            {
  70   4              //这里发送连wifi指令
  71   4              runData.displayLed_wifi = blink;
  72   4              runData.connectWifiFlag = 1;
  73   4            }
  74   3          }break;
  75   2          ////////////////////////////////////////短按浇水键//////////////////////////////////////////////
  76   2          case shortKey2:
  77   2          {
  78   3            if(keySetFlag)
  79   3            {
  80   4              switch(keySetFlow)
  81   4              {
  82   5                case 0: //设置照明预约时长
  83   5                {
  84   6                  runData.displayLed_light = light;
  85   6                  runData.displayLed_water = dark;
  86   6                  userData.setTime_light == 24 ? (userData.setTime_light = 0):(++userData.setTime_light);
  87   6                  runData.displayNumber = userData.setTime_light;
  88   6                }break;
  89   5                case 1: //设置照明时长
  90   5                {
  91   6                  runData.displayLed_light = light;
  92   6                  runData.displayLed_water = dark;
  93   6                  userData.workTime_light == 24 ? (userData.workTime_light = 0):(++userData.workTime_light);
  94   6                  runData.displayNumber = userData.workTime_light;
  95   6                }break;
  96   5                case 2: //设置浇水预约时长
  97   5                {
  98   6                  runData.displayLed_light = dark;
  99   6                  runData.displayLed_water = light;
 100   6                  userData.setTime_water == 24 ? (userData.setTime_water = 0):(++userData.setTime_water);
 101   6                  runData.displayNumber = userData.setTime_water;
 102   6                }break;
 103   5                case 3: //设置浇水时长
 104   5                {
 105   6                  runData.displayLed_light = dark;
 106   6                  runData.displayLed_water = light;
 107   6                  userData.workTime_water == 24 ? (userData.workTime_water = 0):(++userData.workTime_water);
 108   6                  runData.displayNumber = userData.workTime_water;
 109   6                }break;
 110   5              }
 111   4            }
 112   3            else if(runData.runMode == mode_keySetHour )  ////设置时间-加--时
 113   3            {
 114   4              runData.rtcHour == 23 ? (runData.rtcHour = 0):(++runData.rtcHour);
 115   4              runData.displayNumber = runData.rtcHour;
C51 COMPILER V9.60.0.0   KEY                                                               08/12/2019 14:05:33 PAGE 3   

 116   4            }
 117   3            else if(runData.runMode == mode_keySetMinute )  ////设置时间-加--分
 118   3            {
 119   4              runData.rtcMinute == 59 ? (runData.rtcMinute = 0):(++runData.rtcMinute);
 120   4              runData.displayNumber = runData.rtcMinute;
 121   4            } 
 122   3            else
 123   3            {
 124   4              //这里发送浇水指令
 125   4              runData.displayLed_water = light;
 126   4              runData.runWaterFlag = 1;
 127   4            }
 128   3          }break;
 129   2          ////////////////////////////////////////长按预约键//////////////////////////////////////////////
 130   2          case longKey2:
 131   2          {
 132   3            if(!keySetFlag && runData.runMode == mode_normal)
 133   3            {
 134   4              keySetFlag = 1;
 135   4              keySetFlow = 0;
 136   4              runData.displayLed_set = blink;
 137   4              runData.displayLed_light = light;
 138   4              runData.displayLed_water = dark;
 139   4              runData.displayNumState = light;
 140   4            }
 141   3          }break;
 142   2          ////////////////////////////////////////长按组合键//////////////////////////////////////////////
 143   2          case longDoubleKey:
 144   2          {
 145   3            runData.runMode = mode_keySetHour;  //将运行模式跳转到 按键_时间设置
 146   3          }
 147   2        }
 148   1      }
 149          
 150          enum KeyVlaue keyScanf(void)
 151          {
 152   1        static unsigned char pressFlag = 0,keyvalue = 0;
 153   1        static unsigned int keyTimeCount = 0,keySetTimeCount = 0;
 154   1        KEY_EN;
 155   1        
 156   1        if(keySetFlag || runData.rtcMinute != mode_normal)
 157   1        {
 158   2          if(++keySetTimeCount == 600)
 159   2          {
 160   3            keySetTimeCount = 0;
 161   3            Beep(bi);
 162   3            if(keySetFlag)  ////按键设置预约
 163   3            {
 164   4              switch(++keySetFlow)
 165   4              {
 166   5                case 0: ////照明预约
 167   5                {
 168   6                  runData.displayLed_set = blink;
 169   6                  runData.displayLed_light = light;
 170   6                  runData.displayLed_water = dark;
 171   6                }break;
 172   5                case 1: //照明时长
 173   5                {
 174   6                  runData.displayLed_set = dark;
 175   6                  runData.displayLed_light = blink;
 176   6                  runData.displayLed_water = dark;
 177   6                }break;
C51 COMPILER V9.60.0.0   KEY                                                               08/12/2019 14:05:33 PAGE 4   

 178   5                case 2: //浇水预约
 179   5                {
 180   6                  runData.displayLed_set = blink;
 181   6                  runData.displayLed_light = dark;
 182   6                  runData.displayLed_water = light;
 183   6                }break;
 184   5                case 3: //浇水时长
 185   5                {
 186   6                  runData.displayLed_set = dark;
 187   6                  runData.displayLed_light = dark;
 188   6                  runData.displayLed_water = blink;
 189   6                }break;
 190   5                case 4: //设置预约结束
 191   5                {
 192   6                  keySetFlow = 0;
 193   6                  keySetFlag = 0;
 194   6                  runData.saveUserDataFlag = 1;
 195   6                  runData.displayLed_set = dark;
 196   6                  runData.displayLed_light = dark;
 197   6                  runData.displayLed_water = dark;
 198   6                  runData.displayNumState = dark;
 199   6                }break;
 200   5              }
 201   4            }
 202   3            else if(runData.runMode != mode_normal)
 203   3            {
 204   4              switch(runData.runMode)
 205   4              {
 206   5                case mode_keySetHour:
 207   5                {
 208   6                  runData.runMode = mode_keySetMinute;
 209   6                }break;
 210   5                case mode_keySetMinute:
 211   5                {
 212   6                  runData.runMode = mode_setRtc;
 213   6                }break;
 214   5              }
 215   4            }
 216   3          }
 217   2        }
 218   1        else
 219   1        {
 220   2          keySetTimeCount = 0;
 221   2          keySetFlow = 0;
 222   2        }
 223   1        
 224   1        switch(pressFlag)
 225   1        {
 226   2          case 0:
 227   2          {
 228   3            if(KEY_PRESS)
 229   3            {
 230   4              ++keyTimeCount;
 231   4              if(keyTimeCount >= 2)
 232   4              {
 233   5                keyTimeCount = 0;
 234   5                pressFlag = 1;
 235   5                keySetTimeCount = 0;
 236   5                Beep(bi);
 237   5                if(KEY_PRESS1) keyvalue = 1;
 238   5                else if(KEY_PRESS2) keyvalue = 2;
 239   5                else if(KEY_PRESS1 && KEY_PRESS2) keyvalue = 3;
C51 COMPILER V9.60.0.0   KEY                                                               08/12/2019 14:05:33 PAGE 5   

 240   5              }
 241   4            }
 242   3            else keyTimeCount = 0;
 243   3          }break;
 244   2          case 1:
 245   2          {
 246   3            if(++keyTimeCount >= 500)
 247   3            {
 248   4              keyTimeCount = 0;
 249   4              pressFlag = 2;
 250   4              Beep(bbbi);
 251   4            }
 252   3            if(KEY_NOPRESS)
 253   3            {
 254   4              pressFlag = 0;
 255   4              keyTimeCount = 0;
 256   4              if(keyvalue == 1) return shortKey1;
 257   4              else if(keyvalue == 2) return shortKey2;
 258   4              else if(keyvalue == 3) return noneKey;
 259   4            }
 260   3          }break;
 261   2          case 2:
 262   2          {
 263   3            if(KEY_NOPRESS)
 264   3            {
 265   4              pressFlag = 0;
 266   4              if(keyvalue == 1) return longKey1;
 267   4              else if(keyvalue == 2) return longKey2;
 268   4              else if(keyvalue == 3) return longDoubleKey;
 269   4            }
 270   3          }break;
 271   2        }
 272   1        
 273   1        return noneKey;
 274   1      }
 275          
 276          void Beep(enum BeepVoice kv)
 277          {
 278   1        switch(kv)
 279   1        {
 280   2          case bi:
 281   2          {
 282   3            BeepData.beepEn = 1;
 283   3            BeepData.beepTime = BEEP_TIME_BASE;
 284   3          }break;
 285   2          case bibi:
 286   2          {
 287   3            BeepData.beepEn = 2;
 288   3            BeepData.beepTime = BEEP_TIME_BASE;
 289   3          }break;
 290   2          case bibibi:
 291   2          {
 292   3            BeepData.beepEn = 3;
 293   3            BeepData.beepTime = BEEP_TIME_BASE;
 294   3          }break;
 295   2          case bbbi:
 296   2          {
 297   3            BeepData.beepEn = 1;
 298   3            BeepData.beepTime = BEEP_TIME_BASE*3;
 299   3          }break;
 300   2        }
 301   1      }
C51 COMPILER V9.60.0.0   KEY                                                               08/12/2019 14:05:33 PAGE 6   

 302          
 303          void useBeep(void)
 304          {
 305   1        static unsigned int beepCount = 0;
 306   1        if(BeepData.beepEn > 0)
 307   1        {
 308   2          BEEP_ON;
 309   2          if(++beepCount >= BeepData.beepTime)
 310   2          {
 311   3            BEEP_OFF;
 312   3            beepCount = 0;
 313   3            --BeepData.beepEn;
 314   3          }
 315   2        }
 316   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    888    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
