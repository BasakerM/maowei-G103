C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE FUNC
OBJECT MODULE PLACED IN .\Objects\func.obj
COMPILER INVOKED BY: C:\Users\M\AppData\Local\Keil\Keil_v4\C51\BIN\C51.EXE ..\lib\user\src\func.c LARGE OPTIMIZE(8,SPEED
                    -) BROWSE INCDIR(..\lib\n76e003\Include;..\lib\user\inc) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\Listings\func.lst
                    -) TABS(2) OBJECT(.\Objects\func.obj)

line level    source

   1          #include "func.h"
   2          
   3          void updateDeviceState(void);
   4          void configWifi(void);
   5          void sendDeviceStateToWifi(void);
   6          void topRequestForSet(void);
   7          
   8          void sendDeviceStateToTop(void);
   9          void sendSetDataToTop(void);
  10          void sendAckToTop(void);
  11          
  12          unsigned char isNoWater(void);
  13          
  14          void parseDataFromTop(void);
  15          void OneWire_init(void);
  16          void oneWire_write(unsigned char* buff,unsigned char len);
  17          unsigned char oneWire_read(unsigned char* buff);
  18          unsigned char figureSum(unsigned char* buff,unsigned char len);
  19          
  20          void parseDataFromWifi(void);
  21          unsigned char figureSum0(unsigned char* buff,unsigned char len);
  22          void uart0_sendData(unsigned char* buff,unsigned char len);
  23          
  24          void initRtc(void);
  25          void firstInitRtc(void);
  26          void rtcGetTime(void);
  27          void rtcSetTime(void);
  28          
  29          unsigned char isFristStart(void);
  30          void saveDataToFlash(void);
  31          void readDataFromFlash(void);
  32          
  33          void figureCountdown(void);
  34          void figureEndTime(void);
  35          
  36          #define initWifiResetPin() P05_PushPull_Mode;set_P05
  37          #define WifiReset() P05_PushPull_Mode;clr_P05
  38          
  39          void init(void)
  40          {
  41   1        LIGHT_CLOSE;
  42   1        global.device.light = false;
  43   1        global.set.light = false;
  44   1        WATER_CLOSE;
  45   1        global.device.water = false;
  46   1        global.set.water = false;
  47   1        OneWire_init();
  48   1        initRtc();
  49   1        initWifiResetPin();
  50   1        // Timer3_Delay100ms(5);
  51   1      
  52   1        //å¦‚æœä¸ºç¬¬ä¸€æ¬¡å¼€æœº
  53   1        if(isFristStart() == true)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 2   

  54   1        {
  55   2          firstInitRtc(); //åˆå§‹åŒ–rtcè®¾ç½®
  56   2          //è¿™é‡Œå¯ä»¥åˆå§‹åŒ–é¢„çº¦æ•°æ®ï¼Œé»˜è®¤åˆå§‹åŒ–ä¸º0
  57   2          global.set.startLightHour = 0;
  58   2          global.set.startLightMinute = 0;
  59   2          global.set.keepLightHour = 0;
  60   2          global.set.keepLightMinute = 0;
  61   2          global.set.endLightHour = 0;
  62   2          global.set.endLightMinute = 0;
  63   2          global.set.startWaterHour = 0;
  64   2          global.set.startWaterHour = 0;
  65   2          global.set.keepWaterHour = 0;
  66   2          global.set.keepWaterMinute = 0;
  67   2          global.set.endWaterHour = 0;
  68   2          global.set.endWaterMinute = 0;
  69   2          global.set.waterCycleDay = 1;
  70   2          global.device.nextWaterDayCountDown = 1;
  71   2          saveDataToFlash();
  72   2          #ifdef DEBUG
                  uart0_sendData("is first",8);
                  #endif
  75   2        }
  76   1        else
  77   1        {
  78   2          readDataFromFlash();  //è¯»å–é¢„çº¦æ•°æ®
  79   2          #ifdef DEBUG
                  uart0_sendData("not first",9);
                  #endif
  82   2        }
  83   1      #ifdef OFFLINE
  84   1        rtcGetTime();
  85   1        figureEndTime();  //ä¸Šç”µæ—¶å…ˆè®¡ç®—ä¸€æ¬¡å¼€å§‹ç»“æŸçš„æ—¶é—´
  86   1        figureCountdown();  //è®¡ç®—å€’è®¡æ—¶
  87   1      #endif
  88   1        // Timer3_Delay100ms(5);
  89   1      }
  90          
  91          ///////////////////////////////////////////////Run//////////////////////////////////////////////////////
  92          
  93          //è¿è¡Œåœ¨å®šæ—¶å™¨3ä¸­ï¼Œä¸­æ–­æ—¶é—´ä¸º1ms
  94          void run(void)
  95          {
  96   1        /////////////////////////å¤„ç†ä¸€äº›è®¡æ—¶åŠŸèƒ½//////////////////////////
  97   1      #ifdef ONLINE
                if(++global.work.workTimeCount >= 2000) //2s
                {
                  global.work.workTimeCount = 0;
              
                  global.time.getTimeFlag = true; //è·å–ä¸€æ¬¡rtcæ—¶é—´
                }
                //ä¸²å£æ¥æ”¶è¶…æ—¶è®¡æ—¶
                if(global.uart.recTimeOutCount > 0 && global.uart.recTimeOutCount < 1000)
                {
                  ++global.iouart.recTimeOutCount;
                }
              
                if(global.uart.recvDataTimeOutFlag == false && global.uart.recvDataTimeOutClear == false) //æœªè¶…æ—¶ä¸”æ
             -œªåœ¨æ¸…ç†è®¡æ—¶
                {
                  if(++global.uart.recvDataTimeOutMs >= 1000) //1ç§’
                  {
                    global.uart.recvDataTimeOutMs = 0;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 3   

                    if(++global.uart.recvDataTimeOutSec >= 60)  //1åˆ†é’Ÿ
                    {
                      global.uart.recvDataTimeOutSec = 0;
                      if(++global.uart.recvDataTimeOutMinute >= 10) //10åˆ†é’Ÿ
                      {
                        global.uart.recvDataTimeOutMs = 0;
                        global.uart.recvDataTimeOutSec = 0;
                        global.uart.recvDataTimeOutMinute = 0;
                        global.uart.recvDataTimeOutFlag = true; //è¶…æ—¶
                      }
                    }
                  }
                }
                else if(global.uart.recvDataTimeOutFlag == true)  //ååˆ†é’Ÿæ²¡æœ‰æ”¶åˆ°æ¥è‡ªWiFiçš„æ•°æ®ï¼Œåˆ™æœ‰å¯èƒ
             -½é”™è¯¯è¿›å…¥ä¸€é”®é…ç½®,å¤ä½WiFi
                {
                  if(++global.uart.recvDataTimeOutMs >= 500)  //500ms
                  {
                    global.uart.recvDataTimeOutMs = 0;
                    global.uart.recvDataTimeOutSec = 0;
                    global.uart.recvDataTimeOutMinute = 0;
                    global.uart.recvDataTimeOutFlag = false;
                    initWifiResetPin();
                  }
                  else
                  {
                    WifiReset();  //å¤ä½WiFi
                  }
                }
              #endif
 144   1      #ifdef OFFLINE
 145   1        if(++global.work.workTimeCount >= 1000) //1s
 146   1        {
 147   2          global.work.workTimeCount = 0;
 148   2      
 149   2          global.time.getTimeFlag = true; //è·å–ä¸€æ¬¡rtcæ—¶é—´
 150   2        }
 151   1      #endif
 152   1      }
 153          
 154          //
 155          //è¿è¡Œåœ¨main-whileä¸­
 156          //ç”¨äºæ‰§è¡Œä¸€äº›è€—æ—¶æ“ä½œ
 157          //
 158          void runMain(void)
 159          {
 160   1        static char lastMinute = -1;
 161   1      
 162   1      #ifdef ONLINE
                parseDataFromTop();
                parseDataFromWifi();
              
                //åˆ¤æ–­æ˜¯å¦ç¼ºæ°´
                if(isNoWater())
                {
                  global.device.noWater = true;
                  global.device.water = false;
                  WATER_CLOSE;
                  // global.set.noWater = true;
                }
                else
                {
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 4   

                  global.device.noWater = false;
                  // global.set.noWater = false;
                }
              
                //è·å–RTCæ—¶é—´
                if(global.time.getTimeFlag == true)
                {
                  rtcGetTime();
                  global.time.getTimeFlag = false;
                }
                //æ¯è¿‡ä¸€åˆ†é’Ÿæ‰§è¡Œçš„æ“ä½œ
                if(lastMinute != global.time.minute)
                {
                  lastMinute = global.time.minute;  //è®°å½•å½“å‰çš„åˆ†é’Ÿ
                  // figureCountdown();
                }
              
              /////////////////////////////////////////////////////////////////////////////////
              
                updateDeviceState();  //æ›´æ–°è®¾å¤‡çŠ¶æ€
              
              ////////////////////////////////////////////////////////å’Œ wifi æ¨¡å—çš„é€šä¿¡//////////////////////////
             -///////////////////////////////////////
              /////////////////////////æ¥æ”¶/////////////////////////
                // ///////// wifi è®¾ç½®è®¾å¤‡æ•°æ®//////////
                if(global.work.wifiSetDeviceFlag == true)
                {
                  global.device.light = global.set.light;
                  if(global.device.light == true) { LIGHT_OPEN; }
                  else { LIGHT_CLOSE; }
                  global.device.water = global.set.water;
                  if(global.device.water == true && global.device.noWater == false) { WATER_OPEN; } //
                  else { WATER_CLOSE; global.device.water =  false; }
                  global.device.getStateFlag = true;  //å°†æ›´æ–°çš„è®¾å¤‡çŠ¶æ€å‘Šè¯‰ä»æœº
                  global.work.wifiSetDeviceFlag = false;
                }
              /////////////////////////å‘é€/////////////////////////
                ////////ä¸€é”®é…ç½®////////
                if(global.work.wifiConfigFlag == true)
                {
                  global.work.wifiConfigFlag = false;
                  configWifi();
                }
                /////////é¡¶æ¿è¯·æ±‚è®¾ç½®è®¾å¤‡æ•°æ®/////////
                if(global.work.serventSetDevieDataFlag == true)
                {
                  global.work.serventSetDevieDataFlag = false;
                  topRequestForSet();
                }
                /////////å¾€ wifi å‘é€è®¾å¤‡æ•°æ®////////
                if(global.work.wifiGetDeviceFlag == true)
                {
                  global.work.wifiGetDeviceFlag = false;
                  sendDeviceStateToWifi();
                  if(global.device.wifi == online) rtcSetTime();  //åˆ¤æ–­æ—¶é—´å·®åï¼Œæœ‰æ¡ä»¶é€‰æ‹©è®¾ç½®ä¸å¦
                }
              
              ////////////////////////////////////////////////////////å’Œ é¡¶æ¿ çš„é€šä¿¡//////////////////////////////
             -///////////////////////////////////
              /////////////////////////æ¥æ”¶/////////////////////////
                //////////é¡¶æ¿çš„è¯·æ±‚///////////////
                if(global.work.serventSetDevieSateFlag == true)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 5   

                {
                  global.work.serventSetDevieSateFlag = false;
                  switch(global.work.keyDo)
                  {
                    case 0x01: { global.device.wifi = connecting; global.work.wifiConfigFlag = true;}break;
                    case 0x10: { global.set.light = false; global.work.serventSetDevieDataFlag = true;}break;
                    case 0x11: { global.set.light = true; global.work.serventSetDevieDataFlag = true;}break;
                    case 0x20: { global.set.water = false; global.work.serventSetDevieDataFlag = true;}break;
                    case 0x21: { global.set.water = true; global.work.serventSetDevieDataFlag = true;}break;
                  }
                }
              
              /////////////////////////å‘é€/////////////////////////
                //////////å¾€ é¡¶æ¿ å‘é€è®¾å¤‡æ•°æ®///////////////////
                if(global.device.getStateFlag == true)  //æ”¶åˆ°è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚æˆ–è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚ï¼Œä»–ä
             -»¬çš„å“åº”ç›¸åŒ
                {
                  sendDeviceStateToTop();
                  global.device.getStateFlag = false;
                }
                //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®///////////////////
                if(global.set.getDataFlag == true)
                {
                  global.set.getDataFlag = false;
                  sendSetDataToTop();
                }
                //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®å“åº”///////////////////
                if(global.set.setDatFlag == true) //æ”¶åˆ°è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
                {
                  global.set.setDatFlag = false;
                  sendAckToTop();
                  if(global.set.setRtcTimeDataFlag == true) //ç­‰äº0xffè¯´æ˜ä¸ä¿®æ”¹rtcï¼Œé‚£ä¸ç­‰äºæ—¶ä¿®æ”¹
                  {
                    rtcSetTime();
                  }
                  global.work.serventSetDevieDataFlag = true; //å‘WIFIå‘èµ·è®¾ç½®è¯·æ±‚
                }
              #endif
 273   1      #ifdef OFFLINE
 274   1        parseDataFromTop();
 275   1      
 276   1        //åˆ¤æ–­æ˜¯å¦ç¼ºæ°´
 277   1        if(isNoWater())
 278   1        {
 279   2          global.device.noWater = true;
 280   2          global.device.water = false;
 281   2          WATER_CLOSE;
 282   2          // global.set.noWater = true;
 283   2        }
 284   1        else
 285   1        {
 286   2          global.device.noWater = false;
 287   2          // global.set.noWater = false;
 288   2        }
 289   1      
 290   1        //è·å–RTCæ—¶é—´
 291   1        if(global.time.getTimeFlag == true)
 292   1        {
 293   2          rtcGetTime();
 294   2          global.time.getTimeFlag = false;
 295   2        }
 296   1        //æ¯è¿‡ä¸€åˆ†é’Ÿæ‰§è¡Œçš„æ“ä½œ
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 6   

 297   1        if(lastMinute != global.time.minute)
 298   1        {
 299   2          lastMinute = global.time.minute;  //è®°å½•å½“å‰çš„åˆ†é’Ÿ
 300   2          figureEndTime();  //å…ˆè®¡ç®—ä¸€æ¬¡å¼€å§‹ç»“æŸçš„æ—¶é—´
 301   2          figureCountdown();  //è®¡ç®—å€’è®¡æ—¶
 302   2        }
 303   1        
 304   1      /////////////////////////////////////////////////////////////////////////////////
 305   1      
 306   1        if(global.device.light == true) { LIGHT_OPEN; }
 307   1        else if(global.device.light == false) { LIGHT_CLOSE; }
 308   1        if(global.device.water == true && global.device.noWater == false) { WATER_OPEN; }
 309   1        else if(global.device.water == false || global.device.noWater == true) { WATER_CLOSE; }
 310   1      
 311   1      ////////////////////////////////////////////////////////å’Œ é¡¶æ¿ çš„é€šä¿¡//////////////////////////////
             -///////////////////////////////////
 312   1      /////////////////////////æ¥æ”¶/////////////////////////
 313   1        //////////é¡¶æ¿çš„è¯·æ±‚///////////////
 314   1        if(global.work.serventSetDevieSateFlag == true)
 315   1        {
 316   2          global.work.serventSetDevieSateFlag = false;
 317   2          switch(global.work.keyDo)
 318   2          {
 319   3            case 0x10: { global.device.light = false; global.device.getStateFlag = true; }break;
 320   3            case 0x11: { global.device.light = true; global.device.getStateFlag = true; }break;
 321   3            case 0x20: { global.device.water = false; global.device.getStateFlag = true; }break;
 322   3            case 0x21: { global.device.water = true; global.device.getStateFlag = true; }break;
 323   3          }
 324   2        }
 325   1      
 326   1      /////////////////////////å‘é€/////////////////////////
 327   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾å¤‡æ•°æ®///////////////////
 328   1        if(global.device.getStateFlag == true)  //æ”¶åˆ°è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚æˆ–è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚ï¼Œä»–ä
             -»¬çš„å“åº”ç›¸åŒ
 329   1        {
 330   2          sendDeviceStateToTop();
 331   2          global.device.getStateFlag = false;
 332   2        }
 333   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®///////////////////
 334   1        if(global.set.getDataFlag == true)
 335   1        {
 336   2          global.set.getDataFlag = false;
 337   2          readDataFromFlash();
 338   2          sendSetDataToTop();
 339   2        }
 340   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®å“åº”///////////////////
 341   1        if(global.set.setDatFlag == true) //æ”¶åˆ°è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
 342   1        {
 343   2          global.set.setDatFlag = false;
 344   2          if(global.set.setRtcTimeDataFlag == true) //ç­‰äº0xffè¯´æ˜ä¸ä¿®æ”¹rtcï¼Œé‚£ä¸ç­‰äºæ—¶ä¿®æ”¹
 345   2          {
 346   3            global.set.setRtcTimeDataFlag = false;
 347   3            rtcSetTime();
 348   3          }
 349   2          if(global.set.setTimeDataFlag == true)  //ä¿å­˜é¢„çº¦å‚æ•°
 350   2          {
 351   3            global.set.setTimeDataFlag = false;
 352   3            saveDataToFlash();
 353   3          }
 354   2          sendAckToTop(); //å‘é€å“åº”
 355   2          figureEndTime();  //è®¡ç®—å¼€å§‹ç»“æŸçš„æ—¶é—´
 356   2          figureCountdown();  //è®¡ç®—å€’è®¡æ—¶
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 7   

 357   2        }
 358   1      #endif
 359   1      }
 360          
 361          //
 362          //æ›´æ–°è®¾å¤‡çŠ¶æ€
 363          //
 364          void updateDeviceState(void)
 365          {
 366   1        //æ›´æ–° wifi è¿æ¥çŠ¶æ€
 367   1        if(global.work.wifiStateUpdateFlag == true)
 368   1        {
 369   2          global.work.wifiStateUpdateFlag = false;
 370   2          global.device.wifi = global.set.wifiConnectState;
 371   2        }
 372   1        //æ›´æ–° ç…§æ˜ çŠ¶æ€
 373   1        if(global.work.lightSateUpdateFlag == true)
 374   1        {
 375   2          global.work.lightSateUpdateFlag = false;
 376   2          global.device.light = global.set.light;
 377   2        }
 378   1        //æ›´æ–° æµ‡æ°´ çŠ¶æ€
 379   1        if(global.work.waterSateUpdateFlag == true)
 380   1        {
 381   2          global.work.waterSateUpdateFlag = false;
 382   2          global.device.water = global.set.water;
 383   2        }
 384   1        //æ›´æ–° ç¼ºæ°´ çŠ¶æ€
 385   1        if(global.work.nowaterSateUpdateFlag == true)
 386   1        {
 387   2          global.work.nowaterSateUpdateFlag = false;
 388   2          global.device.noWater = global.set.noWater;
 389   2        }
 390   1      }
 391          
 392          //
 393          // å‘ wifi å‘é€ä¸€é”®é…ç½®å‘½ä»¤
 394          //
 395          void configWifi(void)
 396          {
 397   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 398   1        global.uart.sendBuff[1] = 11; //é•¿åº¦
 399   1      
 400   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 401   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 402   1        global.uart.sendBuff[4] = 0x10; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 403   1        global.uart.sendBuff[5] = 0x01; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 404   1      
 405   1        global.uart.sendBuff[6] = 0x11;
 406   1        global.uart.sendBuff[7] = 0x22;
 407   1        global.uart.sendBuff[8] = 0x33;
 408   1        global.uart.sendBuff[9] = 0x44;
 409   1        global.uart.sendBuff[10] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 410   1      
 411   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 412   1      }
 413          
 414          //
 415          //å‘ wifi å‘é€è®¾å¤‡çŠ¶æ€
 416          //
 417          void sendDeviceStateToWifi(void)
 418          {
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 8   

 419   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 420   1        global.uart.sendBuff[1] = 20; //é•¿åº¦
 421   1      
 422   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 423   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 424   1        global.uart.sendBuff[4] = 0x28; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 425   1        global.uart.sendBuff[5] = 0x01; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 426   1      
 427   1        global.uart.sendBuff[6] = global.time.year; //rtcå¹´è°ƒæ•´
 428   1        global.uart.sendBuff[7] = global.time.month;  //rtcæœˆè°ƒæ•´
 429   1        global.uart.sendBuff[8] = global.time.day;  //rtcæ—¥è°ƒæ•´
 430   1        global.uart.sendBuff[9] = global.time.hour; //rtcæ—¶è°ƒæ•´
 431   1        global.uart.sendBuff[10] = global.time.minute;  //rtcåˆ†è°ƒæ•´
 432   1        global.uart.sendBuff[11] = global.time.sec; //rtcç§’è°ƒæ•´
 433   1      
 434   1        global.uart.sendBuff[12] = global.device.temperature>>8;
 435   1        global.uart.sendBuff[13] = global.device.temperature&0xff;
 436   1        global.uart.sendBuff[14] = global.device.water; //æµ‡æ°´çŠ¶æ€
 437   1        global.uart.sendBuff[15] = global.device.light; //ç…§æ˜çŠ¶æ€
 438   1        global.uart.sendBuff[16] = global.device.noWater; //ç¼ºæ°´çŠ¶æ€
 439   1      
 440   1        global.uart.sendBuff[17] = 0x01;  //ç‰ˆæœ¬ä¿¡æ¯é«˜å­—èŠ‚
 441   1        global.uart.sendBuff[18] = 0x01;  //ç‰ˆæœ¬ä¿¡æ¯ä½å­—èŠ‚
 442   1        global.uart.sendBuff[19] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 443   1      
 444   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 445   1      }
 446          
 447          //
 448          //å‘ wifi å‘é€æ¥è‡ª Top çš„è®¾ç½®è¯·æ±‚
 449          //
 450          void topRequestForSet(void)
 451          {
 452   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 453   1        global.uart.sendBuff[1] = 24; //é•¿åº¦
 454   1      
 455   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 456   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 457   1        global.uart.sendBuff[4] = 0x10; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 458   1        global.uart.sendBuff[5] = 0x03; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 459   1      
 460   1        if(global.set.setTimeDataFlag == true)
 461   1        {
 462   2          global.uart.sendBuff[6] = global.set.startLightHour;  //ç…§æ˜å¯åŠ¨å°æ—¶è°ƒæ•´--0xFFå³ä¸åšè°ƒæ•´
 463   2          global.uart.sendBuff[7] = global.set.startLightMinute;  //ç…§æ˜å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 464   2          global.uart.sendBuff[8] = global.set.keepLightHour; //ç…§æ˜æŒç»­å°æ—¶è°ƒæ•´
 465   2          global.uart.sendBuff[9] = global.set.keepLightMinute; //ç…§æ˜æŒç»­åˆ†é’Ÿè°ƒæ•´
 466   2          global.uart.sendBuff[10] = global.set.startWaterHour; //æµ‡æ°´å¯åŠ¨å°æ—¶è°ƒæ•´
 467   2          global.uart.sendBuff[11] = global.set.startWaterMinute; //æµ‡æ°´å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 468   2          global.uart.sendBuff[12] = global.set.keepWaterHour;  //æµ‡æ°´æŒç»­å°æ—¶è°ƒæ•´
 469   2          global.uart.sendBuff[13] = global.set.keepWaterMinute;  //æµ‡æ°´æŒç»­åˆ†é’Ÿè°ƒæ•´
 470   2          global.uart.sendBuff[14] = global.set.waterCycleDay;  //æµ‡æ°´å‘¨æœŸæ—¶é—´è°ƒæ•´
 471   2          global.set.setTimeDataFlag = false;
 472   2        }
 473   1        else
 474   1        {
 475   2          global.uart.sendBuff[6] = 0xff;//global.set.startLightHour; //ç…§æ˜å¯åŠ¨å°æ—¶è°ƒæ•´--0xFFå³ä¸åšè°ƒ
             -æ•´
 476   2          global.uart.sendBuff[7] = 0xff;//global.set.startLightMinute; //ç…§æ˜å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 477   2          global.uart.sendBuff[8] = 0xff;//global.set.keepLightHour;  //ç…§æ˜æŒç»­å°æ—¶è°ƒæ•´
 478   2          global.uart.sendBuff[9] = 0xff;//global.set.keepLightMinute;  //ç…§æ˜æŒç»­åˆ†é’Ÿè°ƒæ•´
 479   2          global.uart.sendBuff[10] = 0xff;//global.set.startWaterHour;  //æµ‡æ°´å¯åŠ¨å°æ—¶è°ƒæ•´
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 9   

 480   2          global.uart.sendBuff[11] = 0xff;//global.set.startWaterMinute;  //æµ‡æ°´å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 481   2          global.uart.sendBuff[12] = 0xff;//global.set.keepWaterHour; //æµ‡æ°´æŒç»­å°æ—¶è°ƒæ•´
 482   2          global.uart.sendBuff[13] = 0xff;//global.set.keepWaterMinute; //æµ‡æ°´æŒç»­åˆ†é’Ÿè°ƒæ•´
 483   2          global.uart.sendBuff[14] = 0xff;//global.set.waterCycleDay; //æµ‡æ°´å‘¨æœŸæ—¶é—´è°ƒæ•´
 484   2        }
 485   1      
 486   1        global.uart.sendBuff[15] = global.set.light;  //è¯·æ±‚ç…§æ˜è®¾ç½®
 487   1        global.uart.sendBuff[16] = global.set.water;  //è¯·æ±‚æµ‡æ°´è®¾ç½®
 488   1      
 489   1        global.uart.sendBuff[17] = 0xff;//global.set.year;  //å¹´è°ƒæ•´
 490   1        global.uart.sendBuff[18] = 0xff;//global.set.month; //æœˆè°ƒæ•´
 491   1        global.uart.sendBuff[19] = 0xff;//global.set.day; //æ—¥è°ƒæ•´
 492   1        if(global.set.setRtcTimeDataFlag == true)
 493   1        {
 494   2          global.uart.sendBuff[20] = global.set.hour; //æ—¶è°ƒæ•´
 495   2          global.uart.sendBuff[21] = global.set.minute; //åˆ†è°ƒæ•´
 496   2          global.uart.sendBuff[22] = 0;//global.set.sec;  //ç§’è°ƒæ•´
 497   2          global.set.setRtcTimeDataFlag = false;
 498   2        }
 499   1        else
 500   1        {
 501   2          global.uart.sendBuff[20] = 0xff;//global.set.hour;  //æ—¶è°ƒæ•´
 502   2          global.uart.sendBuff[21] = 0xff;//global.set.minute;  //åˆ†è°ƒæ•´
 503   2          global.uart.sendBuff[22] = 0xff;//global.set.sec; //ç§’è°ƒæ•´
 504   2        }
 505   1      
 506   1        global.uart.sendBuff[23] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 507   1      
 508   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 509   1      }
 510          
 511          //
 512          //å‘ é¡¶æ¿ å‘é€è®¾å¤‡çŠ¶æ€
 513          //
 514          void sendDeviceStateToTop(void)
 515          {
 516   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 517   1        global.iouart.sendBuff[1] = 18; //é•¿åº¦
 518   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 519   1        global.iouart.sendBuff[3] = 0x02; //æ¶ˆæ¯ç±»å‹dä½8ä½
 520   1      #ifdef ONLINE
                global.iouart.sendBuff[4] = global.device.wifi;
              #endif
 523   1      #ifdef OFFLINE
 524   1        global.iouart.sendBuff[4] = offline;
 525   1      #endif
 526   1        global.iouart.sendBuff[5] = 0x00;
 527   1        global.iouart.sendBuff[6] = global.device.light;
 528   1        global.iouart.sendBuff[7] = global.device.water;
 529   1        global.iouart.sendBuff[8] = global.device.noWater;
 530   1        global.iouart.sendBuff[9] = global.device.nextStartLightCountDown>>8;
 531   1        global.iouart.sendBuff[10] = global.device.nextStartLightCountDown&0x00ff;
 532   1        global.iouart.sendBuff[11] = global.device.endLightCountDown>>8;
 533   1        global.iouart.sendBuff[12] = global.device.endLightCountDown&0x00ff;
 534   1        global.iouart.sendBuff[13] = global.device.nextStartWaterCountDown>>8;
 535   1        global.iouart.sendBuff[14] = global.device.nextStartWaterCountDown&0x00ff;
 536   1        global.iouart.sendBuff[15] = global.device.endWaterCountDown>>8;
 537   1        global.iouart.sendBuff[16] = global.device.endWaterCountDown&0x00ff;
 538   1        global.iouart.sendBuff[17] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 539   1      
 540   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 541   1      }
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 10  

 542          
 543          //
 544          //å‘ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®
 545          //
 546          void sendSetDataToTop(void)
 547          {
 548   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 549   1        global.iouart.sendBuff[1] = 16; //é•¿åº¦
 550   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 551   1        global.iouart.sendBuff[3] = 0x04; //æ¶ˆæ¯ç±»å‹dä½8ä½
 552   1        global.iouart.sendBuff[4] = global.time.hour;
 553   1        global.iouart.sendBuff[5] = global.time.minute;
 554   1        global.iouart.sendBuff[6] = global.set.startLightHour;
 555   1        global.iouart.sendBuff[7] = global.set.startLightMinute;
 556   1        global.iouart.sendBuff[8] = global.set.keepLightHour;
 557   1        global.iouart.sendBuff[9] = global.set.keepLightMinute;
 558   1        global.iouart.sendBuff[10] = global.set.startWaterHour;
 559   1        global.iouart.sendBuff[11] = global.set.startWaterMinute;
 560   1        global.iouart.sendBuff[12] = global.set.keepWaterHour;
 561   1        global.iouart.sendBuff[13] = global.set.keepWaterMinute;
 562   1        global.iouart.sendBuff[14] = global.set.waterCycleDay;
 563   1        global.iouart.sendBuff[15] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 564   1      
 565   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 566   1        #ifdef DEBUG
                uart0_sendData(global.iouart.sendBuff,global.iouart.sendBuff[1]);
                #endif
 569   1      }
 570          
 571          //
 572          //å‘ é¡¶æ¿ å‘é€å“åº”
 573          //
 574          void sendAckToTop(void)
 575          {
 576   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 577   1        global.iouart.sendBuff[1] = 5;  //é•¿åº¦
 578   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 579   1        global.iouart.sendBuff[3] = 0x07; //æ¶ˆæ¯ç±»å‹dä½8ä½
 580   1        global.iouart.sendBuff[4] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 581   1      
 582   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 583   1      }
 584          
 585          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 586          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 587          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 588          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 589          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 590          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 591          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 592          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 593          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 594          //////////////////////////////////////////////////////////////////////////////////////////////////////////
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 11  

             -//////////////////////////////////////////////////////////////////////////
 595          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 596          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 597          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 598          
 599          unsigned char isNoWater(void)
 600          {
 601   1        NOWATER_INIT;
 602   1        if(IS_NOWATER == 0)
 603   1        {
 604   2          return true;
 605   2        }
 606   1      
 607   1        return false;
 608   1      }
 609          
 610          void parseDataFromTop(void)
 611          {
 612   1        unsigned char len = 0,sum = 0;
 613   1        unsigned char buff[32] = {0};
 614   1        unsigned int cmd = 0;
 615   1        len = oneWire_read(buff);
 616   1        if(len != 0)  //å¤§äº0åˆ™è¯´æ˜æœ‰æ•°æ®åŒ…
 617   1        {
 618   2          sum = figureSum(buff,len-1);
 619   2          if(buff[0] == 0x96 && buff[len-1] == sum) //ç¡®è®¤åŒ…å¤´å’Œæ ¡éªŒ
 620   2          {
 621   3            cmd = buff[2]<<8 | buff[3];
 622   3            switch(cmd)
 623   3            {
 624   4              case 0x0001:  //è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚  //é¡¶æ¿ç´¢è¦è®¾å¤‡çŠ¶æ€æ•°æ®ï¼Œå¹¶ç»™å‡ºå½“å‰æ¸©åº¦
 625   4              {
 626   5                global.device.temperature = buff[4]<<8 | buff[5]; //æ‹¿åˆ°æ¸©åº¦
 627   5                global.device.getStateFlag = true;  //æ ‡è®°è·å–çŠ¶æ€æ ‡å¿—ï¼Œå°†è¦å‘é€è®¾å¤‡çŠ¶æ€ç»™é¡¶æ¿
 628   5              }break;
 629   4              case 0x0003:  //è®¾ç½®å‚æ•°è·å–è¯·æ±‚
 630   4              {
 631   5                global.set.getDataFlag = true;
 632   5              }break;
 633   4              case 0x0005:  //è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚ï¼ŒæŒ‰ä¸‹ç…§æ˜æˆ–æµ‡æ°´æˆ–è¿wifi
 634   4              {
 635   5                global.work.keyDo = buff[4];
 636   5                global.work.serventSetDevieSateFlag = true; //åˆ¤æ–­é”®å€¼ï¼Œå¹¶ä¸”å‘é€ç»™æ¨¡å—å†³æ–­
 637   5              }break;
 638   4              case 0x0006:  //è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
 639   4              {
 640   5                if(buff[4] != 0xff)
 641   5                {
 642   6                  global.set.hour = buff[4];
 643   6                  global.set.minute = buff[5];
 644   6                  global.set.sec = 0;
 645   6                  global.set.setRtcTimeDataFlag = true; //è®¾ç½®äº†rtcæ—¶é—´
 646   6                }
 647   5                else global.set.setRtcTimeDataFlag = false;
 648   5                if(buff[6] != 0xff)
 649   5                {
 650   6                  global.set.startLightHour = buff[6];
 651   6                  global.set.startLightMinute = buff[7];
 652   6                  global.set.keepLightHour = buff[8];
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 12  

 653   6                  global.set.keepLightMinute = buff[9];
 654   6                  global.set.startWaterHour = buff[10];
 655   6                  global.set.startWaterMinute = buff[11];
 656   6                  global.set.keepWaterHour = buff[12];
 657   6                  global.set.keepWaterMinute = buff[13];
 658   6                  global.set.waterCycleDay = buff[14];
 659   6                  global.device.nextWaterDayCountDown = buff[14];
 660   6                  global.set.setTimeDataFlag = true;  //è®¾ç½®äº†ç…§æ˜æµ‡æ°´çš„æ—¶é—´
 661   6                }
 662   5                else global.set.setTimeDataFlag = false;
 663   5      
 664   5                global.set.setDatFlag = true;
 665   5              }break;
 666   4            }
 667   3          }
 668   2        }
 669   1      }
 670          
 671          /////////////////////////////////////////////////å•æ€»çº¿é€šä¿¡//////////////////////////////////////////
             -//////////////
 672          
 673          #define ONE_WIRE_A P03
 674          #define ONE_WIRE_A_MODE P03_Quasi_Mode
 675          #define ONE_WIRE_A_H set_P03
 676          #define ONE_WIRE_A_L clr_P03
 677          #define ONE_WIRE_B P04
 678          #define ONE_WIRE_B_MODE P04_Quasi_Mode
 679          #define ONE_WIRE_B_H set_P04
 680          #define ONE_WIRE_B_L clr_P04
 681          
 682          #define ONE_WIRE_READ ONE_WIRE_B
 683          #define ONE_WIRE_WRITE(b) if(b) ONE_WIRE_A_H; else ONE_WIRE_A_L
 684          
 685          void OneWire_init(void)
 686          {
 687   1        ONE_WIRE_A_MODE;
 688   1        ONE_WIRE_B_MODE;
 689   1      
 690   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿
 691   1      }
 692          
 693          void oneWire_start(void)
 694          {
 695   1        ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºèµ·å§‹ä¿¡å·
 696   1        Timer0_Delay1ms(10);
 697   1      }
 698          
 699          void oneWire_stop(void)
 700          {
 701   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿ä½œä¸ºåœæ­¢ä¿¡å·
 702   1      }
 703          
 704          //
 705          //  å†™ä¸€ä¸ªå­—èŠ‚å…«ä½æ•°æ®
 706          //
 707          void oneWire_writeByte(unsigned char dat)
 708          {
 709   1        unsigned char i = 8;
 710   1      
 711   1        while(i--)
 712   1        {
 713   2          ONE_WIRE_WRITE(1);  //æ‹‰é«˜å†™æ€»çº¿ä¼ è¾“ä¸€ä½æ•°æ®
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 13  

 714   2          if(dat & 0x80)
 715   2            Timer0_Delay100us(5); //å†™é«˜ç”µå¹³
 716   2          else
 717   2            Timer0_Delay100us(2); //å†™ä½ç”µå¹³
 718   2          dat <<= 1;
 719   2          ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºä½ä¹‹é—´çš„é—´éš”
 720   2          Timer0_Delay100us(2);
 721   2        }
 722   1      }
 723          
 724          //
 725          //  å†™æ•°æ®åŒ…ï¼Œé€šä¿¡è§„åˆ™ä¸­ï¼Œèµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¿…é¡»ä¸ºæ•°æ®åŒ…çš„é•¿åº¦(è¯¥å­—èŠ‚
             -ä¸è®¡ç®—åœ¨é•¿åº¦å†…)
 726          //
 727          void oneWire_write(unsigned char* buff,unsigned char len)
 728          {
 729   1        oneWire_start();  //èµ·å§‹ä¿¡å·
 730   1        oneWire_writeByte(len); //å‘é€æ•°æ®é•¿åº¦
 731   1        while(len--)  //æ•°æ®åŒ…é•¿åº¦
 732   1        {
 733   2          oneWire_writeByte(*buff); //å‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®
 734   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 735   2        }
 736   1        oneWire_stop(); //åœæ­¢ä¿¡å·
 737   1      }
 738          
 739          //
 740          //  è¯»æ•°æ®åŒ…ï¼ŒæˆåŠŸåè¿”å›æ•°æ®åŒ…é•¿åº¦,å¤±è´¥ä¸º0
 741          //
 742          unsigned char oneWire_read(unsigned char* buff)
 743          {
 744   1        unsigned int timeOut = 0;
 745   1        unsigned char count = 0,dat = 0,transFlag = 0,index = 0,lenFlag = 0,lenCount = 0,len = 0;
 746   1        if(!ONE_WIRE_READ)  //ä½ç”µå¹³ï¼Œæ”¶åˆ°èµ·å§‹ä¿¡å·
 747   1        {
 748   2          while(1)
 749   2          {
 750   3            if(ONE_WIRE_READ) //é«˜ç”µå¹³ï¼Œè®¡ç®—æŒç»­æ—¶é—´
 751   3            {
 752   4              ++count;  //è®°å½•é«˜ç”µå¹³æŒç»­æ—¶é—´
 753   4              transFlag = 1;  //ç”µå¹³è·³å˜æ ‡å¿—
 754   4            }
 755   3            else if(!ONE_WIRE_READ && transFlag == 1) //è¯»æ€»çº¿ä¸ºä½ç”µå¹³å¹¶ä¸”åªæœ‰åœ¨ç”µå¹³è·³å˜åæ‰è¿›å…
             -¥
 756   3            { //ä¸€ä½æ•°æ®ç»“æŸï¼Œåˆ¤æ–­ä¹‹å‰çš„é«˜ç”µå¹³ä¼ è¾“çš„æ˜¯1è¿˜æ˜¯0
 757   4              dat <<= 1;
 758   4              if(count > 3) //å¤§äº300uså°±ç®—é«˜ç”µå¹³
 759   4                dat |= 1;
 760   4              count = 0;  //æ¸…é«˜ç”µå¹³è®¡æ•°
 761   4              timeOut = 0;  //æ¸…è¶…æ—¶è®¡æ•°
 762   4              transFlag = 0;  //æ¸…ç”µå¹³è·³å˜æ ‡å¿—
 763   4              if(++index == 8)  //æ¯è¯»å…«ä½ï¼Œå³ä¸€ä¸ªå­—èŠ‚è¿›å…¥ä¸€æ¬¡
 764   4              {
 765   5                if(lenFlag == 0)  //èµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œç”¨äºè¯´æ˜æ•°æ®åŒ…çš„é•¿åº¦
 766   5                {
 767   6                  lenFlag = 1;  //å·²æ¥æ”¶åˆ°é•¿åº¦
 768   6                  len = dat;
 769   6                }
 770   5                else  //æ•°æ®åŒ…çš„å†…å®¹
 771   5                {
 772   6                  *buff = dat;
 773   6                  if(++lenCount == len) //æ•°æ®åŒ…æ¥æ”¶å®Œæˆ
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 14  

 774   6                  {
 775   7                    Timer0_Delay100us(3); //ç­‰ä½ç”µå¹³è¿‡å»ï¼Œä»¥é˜²æ­¢è¿ç»­ä¼ è¾“æ—¶é”™è¯¯çš„å°†ç”¨ä½œé—´éš”çš„ä½
             -ç”µå¹³è¯†åˆ«ä¸ºèµ·å§‹ä¿¡å·
 776   7                    return len; //ç»“æŸ,å¹¶è¿”å›é•¿åº¦
 777   7                  }
 778   6                  else  //æ²¡æ¥æ”¶å®Œæˆå°±ç»§ç»­æ¥æ”¶ï¼Œè¿™é‡Œå•ç‹¬è‡ªå¢æ˜¯ä¸ºäº†é˜²æ­¢æº¢å‡º
 779   6                  {
 780   7                    ++buff;
 781   7                  }
 782   6                  
 783   6                }
 784   5                index = 0;  //æ¸…è®¡æ•°
 785   5                dat = 0x00; //æ¸…å˜é‡
 786   5              }
 787   4            }
 788   3            Timer0_Delay100us(1); //è¶…æ—¶å¤„ç†
 789   3            if(++timeOut > 200) return 0; //è¶…æ—¶
 790   3          }
 791   2        }
 792   1        return 0;
 793   1      }
 794          
 795          //
 796          //å’Œæ ¡éªŒè®¡ç®—
 797          //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
 798          //
 799          unsigned char figureSum(unsigned char* buff,unsigned char len)
 800          {
 801   1        unsigned char sum = 0;
 802   1      
 803   1        while(len--)
 804   1        {
 805   2          sum += *buff;
 806   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 807   2        }
 808   1        return sum;
 809   1      }
 810          
 811          ///////////////////////////////////////////////ä¸²å£0åŠŸèƒ½//////////////////////////////////////////////
             -////////
 812          
 813          void uart0_fun(unsigned char* buff);  //å£°æ˜
 814          //
 815          //  å¤„ç†æ•°æ®
 816          //
 817          void parseDataFromWifi(void)
 818          {
 819   1        unsigned char sum = 0;
 820   1        if(global.uart.recvCmdCount > 0)  //æœ‰å¾…å¤„ç†çš„æŒ‡ä»¤
 821   1        {
 822   2          if(global.uart.recvCmdCount > UARTBUFFCMDMAXSIZE - 1) //å¦‚æœå¾…å¤„ç†çš„æŒ‡ä»¤è¿‡å¤šï¼Œå¤§äºä¸Šé™-1(
             -å› ä¸ºæ­£åœ¨æ¥æ”¶çš„æŒ‡ä»¤ä¼šå ç”¨ä¸€æ¡ï¼Œæ‰€ä»¥è¦-1)
 823   2          {
 824   3            //å› ä¸ºå¾…å¤„ç†è¿‡å¤šäº†ï¼Œæ‰€ä»¥ç¼“å†²åŒºä¸­æ¯ä¸€æ¡éƒ½è¢«å ç”¨äº†ï¼Œæ‰€ä»¥å¤„ç†å½“å‰åœ¨æ¥æ”¶çš
             -„ä¸‹æ ‡çš„+2ï¼Œä¹‹æ‰€ä»¥ä¸æ˜¯+1æ˜¯ä¸ºäº†é˜²æ­¢è¿˜åœ¨å¤„ç†+1æ—¶ï¼Œå½“å‰çš„ä¸‹æ ‡å°±æ¥æ”¶å®Œäº†æ¥ç€åˆå¼€å§‹æ¥æ”¶+1
             -å¯¼è‡´æ•°æ®é”™ä¹±
 825   3            //ä¾‹å¦‚å½“å‰åœ¨æ¥æ”¶çš„ä¸‹æ ‡æ˜¯0ï¼Œé‚£ä¹ˆå¦‚æœå¤„ç†1æ—¶ï¼Œè¿˜æœªå¤„ç†å®Œ1å°±æ¥æ”¶å®Œ0äº†ï¼Œæ¥ç
             -€åˆå¼€å§‹æ¥æ”¶1ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´é”™ä¹±
 826   3            if(global.uart.recvCmdNowIndex + 2 > UARTBUFFCMDMAXSIZE - 1)  //å¦‚æœä¸‹æ ‡+2ä¼šè¶…è¿‡æœ€å¤§ä¸‹æ ‡ï¼Œåˆ
             -™è®¡ç®—ä¸‹æ ‡
 827   3            {
 828   4              global.uart.recvCmdIndex = 2 - (UARTBUFFCMDMAXSIZE - 1 - global.uart.recvCmdNowIndex);  //è¶…å‡ºå¤šå°‘å
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 15  

             -ˆ™ä»0åŠ ä¸Šå¤šå°‘ï¼Œæœ€å¤šåŠ 2
 829   4            }
 830   3            else
 831   3            {
 832   4              global.uart.recvCmdIndex = global.uart.recvCmdNowIndex + 2;
 833   4            }
 834   3          }
 835   2          else  //å¾…å¤„ç†çš„æŒ‡ä»¤ä¸å¤š,åˆ™ç›´æ¥å¤„ç†å½“å‰æ¥æ”¶çš„ä¸Šä¸€æ¡
 836   2          {
 837   3            if(global.uart.recvCmdNowIndex == 0)
 838   3            {
 839   4              global.uart.recvCmdIndex = UARTBUFFCMDMAXSIZE - 1;
 840   4            }
 841   3            else
 842   3            {
 843   4              global.uart.recvCmdIndex = global.uart.recvCmdNowIndex - 1;
 844   4            }
 845   3          }
 846   2          
 847   2          //å¤„ç†æŒ‡ä»¤
 848   2          sum = figureSum0(global.uart.recvDealBuff[global.uart.recvCmdIndex],global.uart.recvDealBuff[global.uart
             -.recvCmdIndex][1]-1);
 849   2          if(sum == global.uart.recvDealBuff[global.uart.recvCmdIndex][global.uart.recvDealBuff[global.uart.recvCm
             -dIndex][1]-1])  //æ ¡éªŒé€šè¿‡
 850   2          {
 851   3            global.uart.recvDataTimeOutClear = true;  //å¼€å¯æ¸…ç†æ ‡å¿—ï¼Œé˜²æ­¢æ¸…ç†æ—¶è¢«ä¸­æ–­ä¿®æ”¹
 852   3            global.uart.recvDataTimeOutMs = 0;
 853   3            global.uart.recvDataTimeOutSec = 0;
 854   3            global.uart.recvDataTimeOutMinute = 0;
 855   3            global.uart.recvDataTimeOutClear = false; //å…³é—­æ¸…ç†æ ‡å¿—ï¼Œè®©ä¸­æ–­ç»§ç»­è®¡æ—¶
 856   3            uart0_fun(global.uart.recvDealBuff[global.uart.recvCmdIndex]);  //åŠŸèƒ½åˆ¤æ–­
 857   3          }
 858   2          --global.uart.recvCmdCount; //å¾…å¤„ç†æŒ‡ä»¤-1
 859   2        }
 860   1      }
 861          
 862          //
 863          //å’Œæ ¡éªŒè®¡ç®—
 864          //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
 865          //
 866          unsigned char figureSum0(unsigned char* buff,unsigned char len)
 867          {
 868   1        unsigned char sum = 0;
 869   1      
 870   1        while(len--)
 871   1        {
 872   2          sum += *buff;
 873   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 874   2        }
 875   1        sum = ~sum;
 876   1        sum += 1;
 877   1        return sum;
 878   1      }
 879          
 880          void uart0_fun(unsigned char* buff)
 881          {
 882   1        unsigned int messageType = 0,temp = 0;
 883   1        messageType = (buff[4]<<8) | buff[5];
 884   1        switch(messageType)
 885   1        {
 886   2          case 0x1801:  //ä¸€é”®é…ç½®å“åº”
 887   2          {
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 16  

 888   3            
 889   3          }break;
 890   2          case 0x1803:  //è®¾ç½®å‚æ•°å“åº”
 891   2          {
 892   3            
 893   3          }break;
 894   2          case 0x1002:  //ç½‘ç»œçŠ¶æ€
 895   2          {
 896   3            if(buff[7] == 0x00) global.set.wifiConnectState = connectToAp;  //è¿æ¥è·¯ç”±
 897   3            else if(buff[7] == 0x01 && buff[8] == 0x00) global.set.wifiConnectState = connectToService; //è¿æ¥è‡³
             -è·¯ç”±
 898   3            else if(buff[8] == 0x01)  global.set.wifiConnectState = online; //è¿æ¥è‡³æœåŠ¡å™¨
 899   3      
 900   3            global.work.wifiStateUpdateFlag = true; //ç½®ä½ wifi çŠ¶æ€æ›´æ–°æ ‡å¿—
 901   3          }break;
 902   2          case 0x2001:  //WIFIæ¨¡å—è¯·æ±‚è®¾å¤‡çŠ¶æ€å¹¶ç»™æ—¶é—´
 903   2          {
 904   3            if(buff[6] != 0xff)
 905   3            {
 906   4              global.set.year = buff[6];// + 2000;
 907   4            }
 908   3            if(buff[7] != 0xff)
 909   3            {
 910   4              global.set.month = buff[7];
 911   4            }
 912   3            if(buff[8] != 0xff)
 913   3            {
 914   4              global.set.day = buff[8];
 915   4            }
 916   3            if(buff[9] != 0xff)
 917   3            {
 918   4              global.set.hour = buff[9];
 919   4            }
 920   3            if(buff[10] != 0xff)
 921   3            {
 922   4              global.set.minute = buff[10];
 923   4            }
 924   3            if(buff[11] != 0xff)
 925   3            {
 926   4              global.set.sec = buff[11];
 927   4            }
 928   3            global.work.wifiGetDeviceFlag = true;
 929   3          }break;
 930   2          case 0x2002:  //WIFIæ¨¡å—è¯·æ±‚è®¾ç½®è®¾å¤‡
 931   2          {
 932   3            if(buff[6] == 0x00) global.set.water = false;
 933   3            else if(buff[6] == 0x01) global.set.water = true;
 934   3            if(buff[7] == 0x00) global.set.light = false;
 935   3            else if(buff[7] == 0x01) global.set.light = true;
 936   3      
 937   3            temp = (buff[8]<<8) | buff[9];
 938   3            global.device.nextStartWaterCountDown = temp;
 939   3            //å› ä¸ºåº•æ¿ä¸é¡¶æ¿äº¤äº’æ˜¾ç¤ºå€’è®¡æ—¶çš„æœºåˆ¶ï¼Œæ‰€ä»¥ä¸å†åˆ¤æ–­
 940   3            // if(temp != 0xffff)
 941   3            // {
 942   3            //  global.device.nextStartWaterCountDown = temp;
 943   3            // }
 944   3            temp = (buff[10]<<8) | buff[11];
 945   3            global.device.endWaterCountDown = temp;
 946   3            // if(temp != 0xffff)
 947   3            // {
 948   3            //  global.device.endWaterCountDown = temp;
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 17  

 949   3            // }
 950   3            temp = (buff[12]<<8) | buff[13];
 951   3            global.device.nextStartLightCountDown = temp;
 952   3            // if(temp != 0xffff)
 953   3            // {
 954   3            //  global.device.nextStartLightCountDown = temp;
 955   3            // }
 956   3            temp = (buff[14]<<8) | buff[15];
 957   3            global.device.endLightCountDown = temp;
 958   3            // if(temp != 0xffff)
 959   3            // {
 960   3            //  global.device.endLightCountDown = temp;
 961   3            // }
 962   3      
 963   3            if(buff[16] != 0xff)
 964   3            {
 965   4              global.set.startLightHour = buff[16];
 966   4            }
 967   3            if(buff[17] != 0xff)
 968   3            {
 969   4              global.set.startLightMinute = buff[17];
 970   4            }
 971   3            if(buff[18] != 0xff)
 972   3            {
 973   4              global.set.keepLightHour = buff[18];
 974   4            }
 975   3            if(buff[19] != 0xff)
 976   3            {
 977   4              global.set.keepLightMinute = buff[19];
 978   4            }
 979   3            if(buff[20] != 0xff)
 980   3            {
 981   4              global.set.startWaterHour = buff[20];
 982   4            }
 983   3            if(buff[21] != 0xff)
 984   3            {
 985   4              global.set.startWaterMinute = buff[21];
 986   4            }
 987   3            if(buff[22] != 0xff)
 988   3            {
 989   4              global.set.keepWaterHour = buff[22];
 990   4            }
 991   3            if(buff[23] != 0xff)
 992   3            {
 993   4              global.set.keepWaterMinute = buff[23];
 994   4            }
 995   3            if(buff[24] != 0xff)
 996   3            {
 997   4              global.set.waterCycleDay = buff[24];
 998   4            }
 999   3      
1000   3            global.work.wifiSetDeviceFlag = true;
1001   3          }break;
1002   2        }
1003   1      }
1004          
1005          void uart0_isr(unsigned char dat)
1006          {
1007   1        unsigned char sum = 0,i = 0;
1008   1        
1009   1        //è¶…æ—¶å¤„ç†
1010   1        if(global.uart.recTimeOutCount == 1000)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 18  

1011   1        {
1012   2          global.uart.recTimeOutCount = 0;  //å·²è¶…æ—¶ï¼Œå…³æ‰è¶…æ—¶è®¡æ—¶
1013   2          global.uart.nowIndex = 0; //é‡ç½®ä¸‹æ ‡
1014   2        }
1015   1        
1016   1        //åˆ¤æ–­æ¥æ”¶çš„æ•°æ®æ˜¯å¦ç¬¦åˆé€šä¿¡æ ¼å¼
1017   1        if(global.uart.nowIndex == 0 && dat == 0xAA)  //å¤´
1018   1        {
1019   2          global.uart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½“å‰æ•
             -°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1020   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;
1021   2          ++global.uart.nowIndex;
1022   2        }
1023   1        else if(global.uart.nowIndex == 1)  //æ•°æ®é•¿åº¦
1024   1        {
1025   2          if(dat > UARTBUFFDATAMAXSIZE - 14)  //é•¿åº¦å¤§äºç¼“å†²åŒºæœ€å¤§-14ï¼Œåˆ™é€€å‡ºç¨‹åºï¼Œé˜²æ­¢æº¢å‡º
1026   2          {
1027   3            global.uart.nowIndex = 0;
1028   3            return;
1029   3          }
1030   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //é•¿åº¦ï¼šä»å¤´åˆ°æ
             - ¡éªŒ
1031   2          ++global.uart.nowIndex;
1032   2        }
1033   1        else if(global.uart.nowIndex >= 2 && global.uart.nowIndex <= global.uart.recvDealBuff[global.uart.recvCmd
             -NowIndex][1]-2) //å‡å»äº†æ ¡éªŒå­—èŠ‚ï¼Œå› ä¸ºä¸‹æ ‡æ¯”å®é™…é•¿åº¦å°1ï¼Œæ‰€ä»¥-2
1034   1        {
1035   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //æ•°æ®
1036   2          ++global.uart.nowIndex;
1037   2        }
1038   1        else if(global.uart.nowIndex == global.uart.recvDealBuff[global.uart.recvCmdNowIndex][1]-1) //è®°å½•æ”¶åˆ
             -°çš„æŒ‡ä»¤ï¼Œä¹‹ååœ¨ä¸»å¾ªç¯ä¸­å¤„ç†ï¼Œå¤„ç†æ—¶å†åšæ ¡éªŒ
1039   1        {
1040   2          global.uart.recTimeOutCount = 0;  //æ¥æ”¶åˆ°ä¸€ä¸ªå¯èƒ½å®Œæ•´çš„æ•°æ®åŒ…ï¼Œå…³æ‰è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ
             -™ä¸è®¡æ—¶
1041   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //æ•°æ®
1042   2      
1043   2          ++global.uart.recvCmdCount; //å¯¹æ¥æ”¶åˆ°çš„æŒ‡ä»¤è¿›è¡Œè®¡æ•°
1044   2          if(global.uart.recvCmdNowIndex == UARTBUFFCMDMAXSIZE - 1) //æ¥æ”¶çš„æŒ‡ä»¤æ•°é‡å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œå›
             - ä¸ºç”¨ä½œæ•°ç»„ä¸‹æ ‡æ‰€ä»¥è¿™é‡Œéœ€è¦å‡1
1045   2          {
1046   3            global.uart.recvCmdNowIndex = 0;  //é‡ç½®æˆ–è€…ä¹Ÿæœ‰å¯èƒ½ä¼šé€ æˆè¦†ç›–
1047   3          }
1048   2          else
1049   2          {
1050   3            ++global.uart.recvCmdNowIndex;
1051   3          }
1052   2      
1053   2          global.uart.nowIndex = 0;
1054   2        }
1055   1      }
1056          
1057          void delay(unsigned int a)
1058          {
1059   1        unsigned int b = 0;
1060   1        for(;a > 0;a--)
1061   1        {
1062   2          for(;b < 100;b++);
1063   2        }
1064   1      }
1065          
1066          void uart0_sendData(unsigned char* buff,unsigned char len)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 19  

1067          {
1068   1        while(len--)
1069   1        {
1070   2          //å› ä¸ºä¸‹é¢çš„é˜»å¡ç­‰å¾…ï¼Œæ‰€ä»¥è¯¥å˜é‡ä¸ä¼šå­˜åœ¨åŒæ—¶åœ¨ä¸­æ–­å’Œå‡½æ•°è°ƒç”¨æ—¶åŒæ—¶è¢«ä¿®
             -æ”¹çš„æƒ…å†µ
1071   2          global.uart.sendIsrFlag = false;  //å‘é€å®Œæˆä¼šåœ¨ä¸­æ–­ä¸­è¢«ç½®ä½
1072   2          SBUF = *buff;
1073   2          //è¿™é‡Œå­˜åœ¨å¯èƒ½å¯¼è‡´æ­»æœºçš„é—®é¢˜ï¼Œå½“å‘é€åè¢«æŸä¸­æ–­æ‰“æ–­
1074   2          //åœ¨å›åˆ°è¿™é‡Œä¹‹å‰ï¼Œä¸²å£å·²ç»å‘é€å®Œæˆï¼Œä¸­æ–­ä¸­ TI è¢«æ¸… 0
1075   2          //å¯¼è‡´å›åˆ°è¿™é‡Œä¹‹åï¼Œæ— æ³•è·³å‡ºå¾ªç¯
1076   2            // while(TI==0);
1077   2          //è¿™é‡Œä½¿ç”¨é¢å¤–çš„å˜é‡æ ‡è®°ä¸²å£å‘é€å®Œæˆæ ‡å¿—
1078   2          //å½“ä¸Šè¿°çš„æƒ…å†µå‘ç”Ÿä¹‹åï¼Œè¯¥æ ‡å¿—ä¾ç„¶æ­£å¸¸è¢«ç½®ä½
1079   2          while(global.uart.sendIsrFlag == false);  //æœªè¢«ç½®ä½å°±é˜»å¡ç­‰å¾…
1080   2          delay(20);
1081   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
1082   2        }
1083   1      }
1084          
1085          ///////////////////////////////////////////////RTC//////////////////////////////////////////////////////
1086          
1087          #define RTC_RST_H set_P01
1088          #define RTC_RST_L clr_P01
1089          #define RTC_SCL_H set_P13
1090          #define RTC_SCL_L clr_P13
1091          #define RTC_SDA_H set_P14
1092          #define RTC_SDA_L clr_P14
1093          #define RTC_SDA P14
1094          
1095          #define RTCADDR_SEC 0x80
1096          #define RTCADDR_MINUTE 0x82
1097          #define RTCADDR_HOUR 0x84
1098          #define RTCADDR_DAY 0x86
1099          #define RTCADDR_MONTH 0x88
1100          #define RTCADDR_YEAR 0x8c
1101          #define RTCADDR_WP 0x8e //å†™ä¿æŠ¤
1102          #define RTCADDR_CHARGER 0x90  //æ¶“æµå……ç”µ
1103          
1104          #define RTC_WP_OPEN 0x80 //å†™ä¿æŠ¤å¼€
1105          #define RTC_WP_CLOSE  0x00 //å†™ä¿æŠ¤å…³
1106          #define RTC_CHARGER_LEVEL4 0xa9 //
1107          #define RTC_CHARGER_LEVEL6 0xab //åº”è¯¥æ˜¯æœ€æ…¢çš„å……ç”µ
1108          
1109          void rctWriteByte(unsigned char addr,unsigned char dat);
1110          unsigned char rtcReadByte(unsigned char addr);
1111          
1112          void initRtc(void)
1113          {
1114   1        P01_PushPull_Mode;  //NRST
1115   1        P13_PushPull_Mode;  //SCL
1116   1        P14_PushPull_Mode;  //SDA
1117   1      
1118   1        RTC_RST_L;
1119   1        RTC_SCL_H;
1120   1        RTC_SDA_H;
1121   1      }
1122          
1123          void firstInitRtc(void)
1124          {
1125   1        rctWriteByte(RTCADDR_WP,RTC_WP_CLOSE);  //å…³é—­å†™ä¿æŠ¤
1126   1        rctWriteByte(RTCADDR_SEC,0x00); //å¼€å¯è®¡æ—¶,ç§’æ¸…é›¶
1127   1        rctWriteByte(RTCADDR_HOUR,0x00);  //æ¸…é›¶å°æ—¶
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 20  

1128   1        rctWriteByte(RTCADDR_MINUTE,0x00);  //æ¸…é›¶åˆ†é’Ÿ
1129   1        rctWriteByte(RTCADDR_CHARGER,RTC_CHARGER_LEVEL4);
1130   1        // rctWriteByte(RTCADDR_CHARGER,RTC_CHARGER_LEVEL6);  //è®¾ç½®æ¶“æµå……ç”µ
1131   1        rctWriteByte(RTCADDR_WP,RTC_WP_OPEN); //å¼€å¯å†™ä¿æŠ¤
1132   1      }
1133          
1134          void rctWriteByte(unsigned char addr,unsigned char dat)
1135          {
1136   1        unsigned char count;
1137   1      
1138   1        P14_PushPull_Mode;
1139   1      
1140   1        RTC_SCL_L;
1141   1        RTC_RST_H;
1142   1      
1143   1        addr &= 0xfe;
1144   1      
1145   1        for(count = 0;count < 8;count++)
1146   1        {
1147   2          RTC_SCL_L;
1148   2          if(addr & 0x01)
1149   2          {
1150   3            RTC_SDA_H;
1151   3          }
1152   2          else
1153   2          {
1154   3            RTC_SDA_L;
1155   3          }
1156   2          addr >>= 1;
1157   2          RTC_SCL_H;
1158   2        }
1159   1      
1160   1        for(count = 0;count < 8;count++)
1161   1        {
1162   2          RTC_SCL_L;
1163   2          if(dat & 0x01)
1164   2          {
1165   3            RTC_SDA_H;
1166   3          }
1167   2          else
1168   2          {
1169   3            RTC_SDA_L;
1170   3          }
1171   2          dat >>= 1;
1172   2          RTC_SCL_H;
1173   2        }
1174   1      
1175   1        RTC_RST_L;
1176   1      }
1177          
1178          unsigned char rtcReadByte(unsigned char addr)
1179          {
1180   1        unsigned char count,dat = 0;
1181   1      
1182   1        P14_PushPull_Mode;
1183   1      
1184   1        RTC_SCL_L;
1185   1        RTC_RST_H;
1186   1      
1187   1        addr |= 0x01;
1188   1      
1189   1        for(count = 0;count < 8;count++)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 21  

1190   1        {
1191   2          RTC_SCL_L;
1192   2          if(addr & 0x01)
1193   2          {
1194   3            RTC_SDA_H;
1195   3          }
1196   2          else
1197   2          {
1198   3            RTC_SDA_L;
1199   3          }
1200   2          addr >>= 1;
1201   2          RTC_SCL_H;
1202   2        }
1203   1      
1204   1        P14_Input_Mode;
1205   1      
1206   1        for(count = 0;count < 8;count++)
1207   1        {
1208   2          RTC_SCL_H;
1209   2          if(RTC_SDA)
1210   2          {
1211   3            dat |= 0x80;
1212   3          }
1213   2          RTC_SCL_L;  
1214   2          dat >>= 1;
1215   2        }
1216   1        RTC_RST_L;
1217   1      
1218   1        return dat;
1219   1      }
1220          
1221          void rtcGetTime(void)
1222          {
1223   1        unsigned char temp = 0;
1224   1        temp = rtcReadByte(RTCADDR_YEAR);
1225   1        global.time.year = ((temp>>4)*10) + (temp&0x0f);
1226   1        temp = rtcReadByte(RTCADDR_MONTH);
1227   1        global.time.month = ((temp>>4)*10) + (temp&0x0f);
1228   1        temp = rtcReadByte(RTCADDR_DAY);
1229   1        global.time.day = ((temp>>4)*10) + (temp&0x0f);
1230   1        temp = rtcReadByte(RTCADDR_HOUR);
1231   1        global.time.hour = ((temp>>4)*10) + (temp&0x0f);
1232   1        temp = rtcReadByte(RTCADDR_MINUTE);
1233   1        global.time.minute = ((temp>>4)*10) + (temp&0x0f);
1234   1        temp = rtcReadByte(RTCADDR_SEC);
1235   1        global.time.sec = ((temp>>4)*10) + (temp&0x0f);
1236   1      }
1237          
1238          void rtcSetTime(void)
1239          {
1240   1        unsigned char temp = 0;
1241   1        
1242   1        //å½“å¹´æœˆæ—¥æ—¶åˆ†éƒ½ç›¸åŒä¸”ç§’ç›¸å·®å°äº5ç§’åˆ™é€€å‡ºä¸è®¾ç½®ï¼Œå¦åˆ™è®¾ç½®
1243   1        if(global.set.year == global.time.year && global.set.month == global.time.month && global.set.day == glob
             -al.time.day &&
1244   1          global.set.hour == global.time.hour && global.set.minute == global.time.minute)
1245   1        {
1246   2          if(global.set.sec == global.time.sec)
1247   2            return;
1248   2          else if(global.set.sec > global.time.sec)
1249   2            temp = global.set.sec - global.time.sec;
1250   2          else if(global.set.sec < global.time.sec)
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 22  

1251   2            temp = global.time.sec - global.set.sec;
1252   2          if(temp < 5) return;
1253   2        }
1254   1      
1255   1        rctWriteByte(RTCADDR_WP,RTC_WP_CLOSE);  //å…³é—­å†™ä¿æŠ¤
1256   1        temp = ((global.set.year/10)<<4) | (global.set.year%10);
1257   1        rctWriteByte(RTCADDR_YEAR,temp);
1258   1        temp = ((global.set.month/10)<<4) | (global.set.month%10);
1259   1        rctWriteByte(RTCADDR_MONTH,temp);
1260   1        temp = ((global.set.day/10)<<4) | (global.set.day%10);
1261   1        rctWriteByte(RTCADDR_DAY,temp);
1262   1        temp = ((global.set.hour/10)<<4) | (global.set.hour%10);
1263   1        rctWriteByte(RTCADDR_HOUR,temp);
1264   1        temp = ((global.set.minute/10)<<4) | (global.set.minute%10);
1265   1        rctWriteByte(RTCADDR_MINUTE,temp);
1266   1        temp = ((global.set.sec/10)<<4) | (global.set.sec%10);
1267   1        rctWriteByte(RTCADDR_SEC,0);
1268   1        rctWriteByte(RTCADDR_WP,RTC_WP_OPEN); //å¼€å¯å†™ä¿æŠ¤
1269   1        rtcGetTime();
1270   1      }
1271          
1272          ///////////////////////////////////////////////IAP Flash//////////////////////////////////////////////////
             -////
1273          
1274          #define PAGE_ERASE_AP 0x22
1275          #define BYTE_PROGRAM_AP 0x21
1276          
1277          #define FLASHADDRHEARD 0x4550 //å­˜å‚¨é¦–åœ°å€
1278          
1279          //å­˜å‚¨åŒº--é¦–åœ°å€ç”¨äºå­˜å‚¨é¦–æ¬¡å¼€æœºæ ‡å¿—
1280          // volatile unsigned char code Data_Flash[128] _at_ 0x4550;
1281          
1282          unsigned char flash_readByte(unsigned int code* addr)
1283          {
1284   1        return (unsigned char)((*addr)>>8);
1285   1      }
1286          
1287          void iapEnable(void)
1288          {
1289   1        clr_EA;
1290   1        //ä½¿èƒ½IAP
1291   1        TA = 0xAA; //CHPCON is TA protected
1292   1        TA = 0x55;
1293   1        CHPCON |= 0x01; //IAPEN = 1, enable IAP mode
1294   1        TA = 0xAA; //IAPUEN is TA protected
1295   1        TA = 0x55;
1296   1        IAPUEN |= 0x01; //APUEN = 1, enable APROM update
1297   1        set_EA;
1298   1      }
1299          
1300          void iapErasePage(unsigned int addr)
1301          {
1302   1        //å†™å­—èŠ‚
1303   1        IAPCN = PAGE_ERASE_AP; // Program 201h with 55h
1304   1        IAPAH = HIBYTE(addr);
1305   1        IAPAL = LOBYTE(addr);
1306   1        IAPFD = 0xff;
1307   1      }
1308          
1309          void iapWriteByte(unsigned int addr,unsigned char dat)
1310          {
1311   1        //å†™å­—èŠ‚
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 23  

1312   1        IAPCN = BYTE_PROGRAM_AP; // Program 201h with 55h
1313   1        IAPAH = HIBYTE(addr);
1314   1        IAPAL = LOBYTE(addr);
1315   1        IAPFD = dat;
1316   1      }
1317          
1318          void iapTrigger(void)
1319          {
1320   1        clr_EA;
1321   1        //æ‰§è¡ŒIAP
1322   1        TA = 0xAA;
1323   1        TA = 0x55;
1324   1        IAPTRG |= 0x01; //write â€˜1â€™ to IAPGO to trigger IAP process
1325   1        set_EA;
1326   1      }
1327          
1328          void iapUnenable(void)
1329          {
1330   1        clr_EA;
1331   1        //å¤±èƒ½IAP
1332   1        TA = 0xAA; //IAPUEN is TA protected
1333   1        TA = 0x55;
1334   1        IAPUEN &= ~0x01; //APUEN = 0, disable APROM update
1335   1        TA = 0xAA; //CHPCON is TA protected
1336   1        TA = 0x55;
1337   1        CHPCON &= ~0x01; //IAPEN = 0, disable IAP mode
1338   1        set_EA;
1339   1      }
1340          
1341          unsigned char isFristStart(void)
1342          {
1343   1        if(flash_readByte(FLASHADDRHEARD) == 0xff)
1344   1        {
1345   2          iapEnable();
1346   2          iapWriteByte(FLASHADDRHEARD,0x96);  //å†™å·²å¼€æœºæ ‡å¿—
1347   2          iapTrigger();
1348   2          iapUnenable();
1349   2          return true;
1350   2        }
1351   1        else if(flash_readByte(FLASHADDRHEARD) == 0x96)
1352   1        {
1353   2          return false;
1354   2        }
1355   1        return false;
1356   1      }
1357          
1358          void resetFlash(void)
1359          {
1360   1        iapEnable();
1361   1        iapErasePage(FLASHADDRHEARD);
1362   1        iapTrigger();
1363   1        iapUnenable();
1364   1      }
1365          
1366          void saveDataToFlash(void)
1367          {
1368   1        //å…ˆè¯»å‡ºæ•°æ®
1369   1        
1370   1        //å†æ“¦é™¤
1371   1        resetFlash();
1372   1        iapEnable();
1373   1        //å†™é¦–æ¬¡å¼€æœºæ ‡å¿—
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 24  

1374   1        iapWriteByte(FLASHADDRHEARD,0x96);  //éƒ½èƒ½å­˜é¢„çº¦æ•°æ®äº†ï¼Œé‚£è‚¯å®šå¼€æœºäº†ï¼Œé‚£å°±è¦é‡æ–°å†™æ 
             -‡å¿—
1375   1        iapTrigger();
1376   1        //å­˜é¢„çº¦æ•°æ®
1377   1        iapWriteByte(FLASHADDRHEARD+1,global.set.startLightHour);
1378   1        iapTrigger();
1379   1        iapWriteByte(FLASHADDRHEARD+2,global.set.startLightMinute);
1380   1        iapTrigger();
1381   1        iapWriteByte(FLASHADDRHEARD+3,global.set.keepLightHour);
1382   1        iapTrigger();
1383   1        iapWriteByte(FLASHADDRHEARD+4,global.set.keepLightMinute);
1384   1        iapTrigger();
1385   1        iapWriteByte(FLASHADDRHEARD+5,global.set.endLightHour);
1386   1        iapTrigger();
1387   1        iapWriteByte(FLASHADDRHEARD+6,global.set.endLightMinute);
1388   1        iapTrigger();
1389   1        iapWriteByte(FLASHADDRHEARD+7,global.set.startWaterHour);
1390   1        iapTrigger();
1391   1        iapWriteByte(FLASHADDRHEARD+8,global.set.startWaterMinute);
1392   1        iapTrigger();
1393   1        iapWriteByte(FLASHADDRHEARD+9,global.set.keepWaterHour);
1394   1        iapTrigger();
1395   1        iapWriteByte(FLASHADDRHEARD+10,global.set.keepWaterMinute);
1396   1        iapTrigger();
1397   1        iapWriteByte(FLASHADDRHEARD+11,global.set.endWaterHour);
1398   1        iapTrigger();
1399   1        iapWriteByte(FLASHADDRHEARD+12,global.set.endWaterMinute);
1400   1        iapTrigger();
1401   1        iapWriteByte(FLASHADDRHEARD+13,global.set.waterCycleDay);
1402   1        iapTrigger();
1403   1        iapWriteByte(FLASHADDRHEARD+14,global.device.nextWaterDayCountDown);
1404   1        iapTrigger();
1405   1        iapUnenable();
1406   1      }
1407          
1408          void readDataFromFlash(void)
1409          {
1410   1        global.set.startLightHour = flash_readByte(FLASHADDRHEARD+1);
1411   1        global.set.startLightMinute = flash_readByte(FLASHADDRHEARD+2);
1412   1        global.set.keepLightHour = flash_readByte(FLASHADDRHEARD+3);
1413   1        global.set.keepLightMinute = flash_readByte(FLASHADDRHEARD+4);
1414   1        global.set.endLightHour = flash_readByte(FLASHADDRHEARD+5);
1415   1        global.set.endLightMinute = flash_readByte(FLASHADDRHEARD+6);
1416   1        global.set.startWaterHour = flash_readByte(FLASHADDRHEARD+7);
1417   1        global.set.startWaterMinute = flash_readByte(FLASHADDRHEARD+8);
1418   1        global.set.keepWaterHour = flash_readByte(FLASHADDRHEARD+9);
1419   1        global.set.keepWaterMinute = flash_readByte(FLASHADDRHEARD+10);
1420   1        global.set.endWaterHour = flash_readByte(FLASHADDRHEARD+11);
1421   1        global.set.endWaterMinute = flash_readByte(FLASHADDRHEARD+12);
1422   1        global.set.waterCycleDay = flash_readByte(FLASHADDRHEARD+13);
1423   1        global.device.nextWaterDayCountDown = flash_readByte(FLASHADDRHEARD+14);
1424   1      }
1425          
1426          
1427          
1428          //
1429          //è®¡ç®—å€’è®¡æ—¶ï¼Œç„¶åæ‰§è¡Œè®¡æ—¶ç»“æŸçš„ä¸€äº›æ“ä½œï¼Œæ”¾åœ¨ runMain ä¸­ï¼Œæ¯åˆ†é’Ÿè¿›å…¥ä¸€æ¬¡
1430          //
1431          void figureCountdown(void)
1432          {
1433   1        //////////////////////////////////////ç…§æ˜/////////////////////////////////////
1434   1        //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹ç…§æ˜å€’è®¡æ—¶çš„è®¡ç®—
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 25  

1435   1        if(global.set.startLightHour > global.time.hour)  //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶è¿˜æœªåˆ°
1436   1        {
1437   2          if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1438   2          {
1439   3            global.device.nextStartLightCountDown = (global.set.startLightHour - global.time.hour)*60 + (global.set
             -.startLightMinute - global.time.minute);
1440   3          }
1441   2          else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1442   2          {
1443   3            global.device.nextStartLightCountDown = (global.set.startLightHour - global.time.hour)*60 - (global.tim
             -e.minute - global.set.startLightMinute);
1444   3          }
1445   2        }
1446   1        else if(global.set.startLightHour == global.time.hour)
1447   1        {
1448   2          if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1449   2          {
1450   3            global.device.nextStartLightCountDown = global.set.startLightMinute - global.time.minute;
1451   3          }
1452   2          else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1453   2          {
1454   3            global.device.nextStartLightCountDown = 24*60 - (global.time.minute - global.set.startLightMinute);
1455   3          }
1456   2        }
1457   1        else if(global.set.startLightHour < global.time.hour) //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶å·²è¶…è¿‡
1458   1        {
1459   2          if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1460   2          {
1461   3            global.device.nextStartLightCountDown = (24 - global.time.hour + global.set.startLightHour)*60 + (globa
             -l.set.startLightMinute - global.time.minute);
1462   3          }
1463   2          else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1464   2          {
1465   3            global.device.nextStartLightCountDown = (24 - global.time.hour + global.set.startLightHour)*60 - (globa
             -l.time.minute - global.set.startLightMinute);
1466   3          }
1467   2        }
1468   1        //è·ç¦»ç»“æŸç…§æ˜å€’è®¡æ—¶çš„è®¡ç®—
1469   1        if(global.set.endLightHour > global.time.hour)  //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1470   1        {
1471   2          if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1472   2          {
1473   3            global.device.endLightCountDown = (global.set.endLightHour - global.time.hour)*60 + (global.set.endLigh
             -tMinute - global.time.minute);
1474   3          }
1475   2          else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1476   2          {
1477   3            global.device.endLightCountDown = (global.set.endLightHour - global.time.hour)*60 - (global.time.minute
             - - global.set.endLightMinute);
1478   3          }
1479   2        }
1480   1        else if(global.set.endLightHour == global.time.hour)
1481   1        {
1482   2          if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1483   2          {
1484   3            global.device.endLightCountDown = global.set.endLightMinute - global.time.minute;
1485   3          }
1486   2          else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1487   2          {
1488   3            global.device.endLightCountDown = 24*60 - (global.time.minute - global.set.endLightMinute);
1489   3          }
1490   2        }
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 26  

1491   1        else if(global.set.endLightHour < global.time.hour) //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶å·²è¶…è¿‡
1492   1        {
1493   2          if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1494   2          {
1495   3            global.device.endLightCountDown = (24 - global.time.hour + global.set.endLightHour)*60 + (global.set.en
             -dLightMinute - global.time.minute);
1496   3          }
1497   2          else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1498   2          {
1499   3            global.device.endLightCountDown = (24 - global.time.hour + global.set.endLightHour)*60 - (global.time.m
             -inute - global.set.endLightMinute);
1500   3          }
1501   2        }
1502   1      
1503   1        //////////////////////////////////////æµ‡æ°´/////////////////////////////////////
1504   1      
1505   1        if(global.time.hour == 0 && global.time.minute == 0)  //é›¶ç‚¹ï¼Œåšæµ‡æ°´å‘¨æœŸè®¡ç®—
1506   1        {
1507   2          //æ¯å¤©é›¶ç‚¹å‡ä¸€å¤©ï¼Œå‡åˆ°1åˆ™å½“å¤©æµ‡æ°´ï¼Œæµ‡æ°´ç»“æŸåé‡ç½®ã€‚
1508   2          if(global.device.nextWaterDayCountDown > 1) --global.device.nextWaterDayCountDown;
1509   2      
1510   2          if(global.device.nextWaterDayCountDown == 0)  //å¦‚æœä¸º0ï¼Œåˆ™é‡ç½®
1511   2          {
1512   3            global.device.nextWaterDayCountDown = global.set.waterCycleDay;
1513   3          }
1514   2          saveDataToFlash();
1515   2        }
1516   1      
1517   1        //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹æµ‡æ°´å€’è®¡æ—¶çš„è®¡ç®—
1518   1        if(global.set.startWaterHour > global.time.hour)  //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1519   1        {
1520   2          if(global.set.startWaterMinute > global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1521   2          {
1522   3            global.device.nextStartWaterCountDown = (global.set.startWaterHour - global.time.hour)*60 + (global.set
             -.startWaterMinute - global.time.minute);
1523   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60; //å†åŠ ä¸Šå‘¨æ
             -œŸå¤©æ•°çš„åç§»
1524   3          }
1525   2          else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1526   2          {
1527   3            global.device.nextStartWaterCountDown = (global.set.startWaterHour - global.time.hour)*60 - (global.tim
             -e.minute - global.set.startWaterMinute);
1528   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1529   3          }
1530   2        }
1531   1        else if(global.set.startWaterHour == global.time.hour)
1532   1        {
1533   2          if(global.set.startWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1534   2          {
1535   3            global.device.nextStartWaterCountDown = global.set.startWaterMinute - global.time.minute;
1536   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60; //å†åŠ ä¸Šå‘¨æ
             -œŸå¤©æ•°çš„åç§»
1537   3          }
1538   2          else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1539   2          {
1540   3            global.device.nextStartWaterCountDown = 24*60 - (global.time.minute - global.set.startWaterMinute);
1541   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1542   3          }
1543   2        }
1544   1        else if(global.set.startWaterHour < global.time.hour) //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶å·²è¶…è¿‡
1545   1        {
1546   2          if(global.set.startWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 27  

1547   2          {
1548   3            global.device.nextStartWaterCountDown = (24 - global.time.hour + global.set.startWaterHour)*60 + (globa
             -l.set.startWaterMinute - global.time.minute);
1549   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1550   3          }
1551   2          else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1552   2          {
1553   3            global.device.nextStartWaterCountDown = (24 - global.time.hour + global.set.startWaterHour)*60 - (globa
             -l.time.minute - global.set.startWaterMinute);
1554   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1555   3          }
1556   2        }
1557   1        //è·ç¦»ç»“æŸæµ‡æ°´å€’è®¡æ—¶çš„è®¡ç®—
1558   1        if(global.set.endWaterHour > global.time.hour)  //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1559   1        {
1560   2          if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1561   2          {
1562   3            global.device.endWaterCountDown = (global.set.endWaterHour - global.time.hour)*60 + (global.set.endWate
             -rMinute - global.time.minute);
1563   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1564   3          }
1565   2          else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1566   2          {
1567   3            global.device.endWaterCountDown = (global.set.endWaterHour - global.time.hour)*60 - (global.time.minute
             - - global.set.endWaterMinute);
1568   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1569   3          }
1570   2        }
1571   1        else if(global.set.endWaterHour == global.time.hour)
1572   1        {
1573   2          if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1574   2          {
1575   3            global.device.endWaterCountDown = global.set.endWaterMinute - global.time.minute;
1576   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1577   3          }
1578   2          else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1579   2          {
1580   3            global.device.endWaterCountDown = 24*60 - (global.time.minute - global.set.endWaterMinute);
1581   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1582   3          }
1583   2        }
1584   1        else if(global.set.endWaterHour < global.time.hour) //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶å·²è¶…è¿‡
1585   1        {
1586   2          if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1587   2          {
1588   3            global.device.endWaterCountDown = (24 - global.time.hour + global.set.endWaterHour)*60 + (global.set.en
             -dWaterMinute - global.time.minute);
1589   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1590   3          }
1591   2          else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1592   2          {
1593   3            global.device.endWaterCountDown = (24 - global.time.hour + global.set.endWaterHour)*60 - (global.time.m
             -inute - global.set.endWaterMinute);
1594   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1595   3          }
1596   2        }
1597   1      
1598   1        /////////////////////////////////////////////////////////////æ ¹æ®å€’è®¡æ—¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå¯¹åº”æ“ä½
             -œ//////////////////////////////////////////////////////////////
1599   1        if(global.device.nextStartWaterCountDown == 0)  //ç»“æŸç…§æ˜,è¿™é‡Œçš„ä¸ç®¡åœ¨çº¿ç¦»çº¿ï¼Œåªæ˜¯ä¸ºäº†é
             -‡ç½®æµ‡æ°´å‘¨æœŸçš„è®¡æ—¶
1600   1        {
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 28  

1601   2          global.device.nextWaterDayCountDown = global.set.waterCycleDay;
1602   2        }
1603   1        /////////////å‰ææ˜¯å¤„äºç¦»çº¿çŠ¶æ€ï¼Œåœ¨çº¿çŠ¶æ€çš„æ§åˆ¶æœ‰wifiæ¨¡å—è´Ÿè´£///////////////
1604   1        if(global.device.wifi == offline)
1605   1        {
1606   2          if(global.device.nextStartLightCountDown == 0)  //è®¡æ—¶åˆ°0ï¼Œè¯´æ˜å¯ä»¥å¼€å§‹ç…§æ˜äº†
1607   2          {
1608   3            global.device.light = true;
1609   3            LIGHT_OPEN;
1610   3          }
1611   2          if(global.device.endLightCountDown == 0)  //ç»“æŸç…§æ˜
1612   2          {
1613   3            global.device.light = false;
1614   3            LIGHT_CLOSE;
1615   3          }
1616   2          if(global.device.nextStartWaterCountDown == 0)  //è®¡æ—¶åˆ°0ï¼Œè¯´æ˜å¯ä»¥å¼€å§‹æµ‡æ°´äº†
1617   2          {
1618   3            global.device.water = true;
1619   3            WATER_OPEN;
1620   3          }
1621   2          if(global.device.endWaterCountDown == 0)  //ç»“æŸç…§æ˜
1622   2          {
1623   3            global.device.water = false;
1624   3            WATER_CLOSE;
1625   3          }
1626   2        }
1627   1      }
1628          
1629          //é€šè¿‡å¼€å§‹å’ŒæŒç»­æ—¶é—´ï¼Œè®¡ç®—ç»“æŸæ—¶é—´
1630          void figureEndTime(void)
1631          {
1632   1        //////é¦–å…ˆè®¡ç®—åˆ†é’Ÿ//////////
1633   1        if(global.set.startLightMinute + global.set.keepLightMinute >= 60)  //ä¸åœ¨åŒä¸€å°æ—¶äº†ï¼Œéœ€è¦è®©å°
             -æ—¶åŠ ä¸€
1634   1        {
1635   2          global.set.endLightMinute = global.set.startLightMinute + global.set.keepLightMinute - 60;
1636   2          if((global.set.startLightHour + global.set.keepLightHour + 1) >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1637   2          {
1638   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour + 1 - 24;
1639   3          }
1640   2          else  //åœ¨åŒä¸€å¤©
1641   2          {
1642   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour + 1;
1643   3          }
1644   2          
1645   2        }
1646   1        else  //åœ¨åŒä¸€å°æ—¶
1647   1        {
1648   2          global.set.endLightMinute = global.set.startLightMinute + global.set.keepLightMinute;
1649   2          if(global.set.startLightHour + global.set.keepLightHour >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1650   2          {
1651   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour - 24;
1652   3          }
1653   2          else  //åœ¨åŒä¸€å¤©
1654   2          {
1655   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour;
1656   3          }
1657   2        }
1658   1      
1659   1        
1660   1        if(global.set.startWaterMinute + global.set.keepWaterMinute >= 60)  //ä¸åœ¨åŒä¸€å°æ—¶äº†ï¼Œéœ€è¦è®©å°
             -æ—¶åŠ ä¸€
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 29  

1661   1        {
1662   2          global.set.endWaterMinute = global.set.startWaterMinute + global.set.keepWaterMinute - 60;
1663   2          if((global.set.startWaterHour + global.set.keepWaterHour + 1) >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1664   2          {
1665   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour + 1 - 24;
1666   3          }
1667   2          else  //åœ¨åŒä¸€å¤©
1668   2          {
1669   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour + 1;
1670   3          }
1671   2          
1672   2        }
1673   1        else  //åœ¨åŒä¸€å°æ—¶
1674   1        {
1675   2          global.set.endWaterMinute = global.set.startWaterMinute + global.set.keepWaterMinute;
1676   2          if(global.set.startWaterHour + global.set.keepWaterHour >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1677   2          {
1678   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour - 24;
1679   3          }
1680   2          else  //åœ¨åŒä¸€å¤©
1681   2          {
1682   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour;
1683   3          }
1684   2        }
1685   1      }
1686          
1687          
1688          ///////////////////////////////////////////////////////////////////////////////////è¢«åºŸå¼ƒçš„æ–¹æ³•/////
             -///////////////////////////////////////////////////////////
1689          
1690          ///////////////////////////////////////////////ä¸²å£9åŠŸèƒ½//////////////////////////////////////////////
             -////////
1691          
1692          // void uart9_fun(unsigned char* buff)
1693          // {
1694          //  switch(buff[3]) //ä¸‹æ ‡2å’Œ3ä¸ºæ¶ˆæ¯ç±»å‹ï¼Œä½†ç›®å‰2ä¸º0x00æ‰€ä»¥åˆ¤æ–­3å³å¯
1695          //  {
1696          //    case 0x01:  //è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚  //é¡¶æ¿ç´¢è¦è®¾å¤‡çŠ¶æ€æ•°æ®ï¼Œå¹¶ç»™å‡ºå½“å‰æ¸©åº¦
1697          //    {
1698          //      global.device.temperature = buff[4]<<8 | buff[5]; //æ‹¿åˆ°æ¸©åº¦
1699          //      global.device.getStateFlag = true;  //æ ‡è®°è·å–çŠ¶æ€æ ‡å¿—ï¼Œå°†è¦å‘é€è®¾å¤‡çŠ¶æ€ç»™é¡¶æ¿
1700          //    }break;
1701          //    case 0x03:  //è®¾ç½®å‚æ•°è·å–è¯·æ±‚
1702          //    {
1703          //      global.set.getDataFlag = true;
1704          //    }break;
1705          //    case 0x05:  //è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚ï¼ŒæŒ‰ä¸‹ç…§æ˜æˆ–æµ‡æ°´æˆ–è¿wifi
1706          //    {
1707          //      global.work.keyDo = buff[4];
1708          //      global.work.serventSetDevieSateFlag = true; //åˆ¤æ–­é”®å€¼ï¼Œå¹¶ä¸”å‘é€ç»™æ¨¡å—å†³æ–­
1709          //    }break;
1710          //    case 0x06:  //è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
1711          //    {
1712          //      global.set.hour = buff[4];
1713          //      global.set.minute = buff[5];
1714          //      global.set.startLightHour = buff[6];
1715          //      global.set.startLightMinute = buff[7];
1716          //      global.set.keepLightHour = buff[8];
1717          //      global.set.keepLightMinute = buff[9];
1718          //      global.set.startWaterHour = buff[10];
1719          //      global.set.startWaterMinute = buff[11];
1720          //      global.set.keepWaterHour = buff[12];
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 30  

1721          //      global.set.keepWaterMinute = buff[13];
1722          //      global.set.waterCycleDay = buff[14];
1723          
1724          //      global.set.setDatFlag = true;
1725          //    }break;
1726          //  }
1727          // }
1728          
1729          // ////å‘é€ä¸€ä¸ªå­—èŠ‚
1730          // void uart9SendByte(unsigned char dat)
1731          // {
1732          //  // while(runData.iouart.recEnable); //å½“æ¥æ”¶ä½¿èƒ½æ—¶ï¼Œä¸å‘é€æ•°æ®ï¼Œç­‰å¾…æ¥æ”¶å®Œæ¯•å†å‘é
             -€  //æµ‹è¯•åå‘ç°å¹¶æ²¡æœ‰è½¯ç”¨
1733          //  global.iouart.sendData = dat;
1734          //  global.iouart.sendCount = 0;
1735          //  global.iouart.sendComplete = false;
1736          //  global.iouart.sendEnable = true;
1737          //  while(!global.iouart.sendComplete); //ç­‰å¾…æ•°æ®å‘é€å®Œæˆ
1738          // }
1739          
1740          // ////å‘é€ä¸€ä¸²å­—èŠ‚
1741          // void uart9Send(unsigned char* buff,unsigned char len)
1742          // {
1743          //  while(len)
1744          //  {
1745          //    uart9SendByte(*buff);
1746          //    --len; 
1747          //    if(len != 0) ++buff;
1748          //  }
1749          // }
1750          
1751          // #define UART9_RD P03
1752          // #define UART9_TD_H set_P04
1753          // #define UART9_TD_L clr_P04
1754          
1755          // void initUart9(void)
1756          // {
1757          //  P04_Quasi_Mode; //åœ¨ç”µè·¯ä¸­çš„æ ‡å·ä¸ºRx,ä½†æ˜¯ç”µè·¯ä¸æ”¹çš„è¯éœ€è¦è½¯ä»¶è®¾ç½®ä¸ºTx
1758          //  P03_Quasi_Mode; //åœ¨ç”µè·¯ä¸­çš„æ ‡å·ä¸ºTx,ä½†æ˜¯ç”µè·¯ä¸æ”¹çš„è¯éœ€è¦è½¯ä»¶è®¾ç½®ä¸ºRx
1759          
1760          //  TMOD |= 0x02; //æ¨¡å¼2,8ä½è‡ªåŠ¨é‡è£…è½½
1761          //  clr_T0M;  //12åˆ†é¢‘
1762          //  TH0 = 256 - 139;  //9600
1763          //  set_ET0;  //ä½¿èƒ½å®šæ—¶å™¨0ä¸­æ–­
1764          //  set_EA; //ä½¿èƒ½æ€»ä¸­æ–­
1765          //  set_TR0;  //å¼€å¯å®šæ—¶å™¨0
1766          // }
1767          
1768          // //1èµ·å§‹ä½--8æ•°æ®ä½--1åœæ­¢ä½
1769          // void uart9_isr(void)
1770          // {
1771          //  unsigned char i,sum = 0;
1772          
1773          //  ////////æ¥æ”¶éƒ¨åˆ†////////
1774          //  if(global.iouart.recEnable == false)
1775          //  {
1776          //    if(!UART9_RD) //RDè„šè¢«æ‹‰ä½--å³æ¥æ”¶åˆ°èµ·å§‹ä½--èµ·å§‹ä½ä¸º0
1777          //    {
1778          //      global.iouart.recEnable = true;
1779          //      global.iouart.recCount = 0;
1780          //      global.iouart.recData = 0x00;
1781          //    }
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 31  

1782          //  }
1783          //  else
1784          //  {
1785          //    //æ¥æ”¶æ•°æ®
1786          //    if(global.iouart.recCount <= 7)
1787          //    {
1788          //      global.iouart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½
             -“å‰æ•°æ®ä½ï¼Œæ”¶åˆ°æ•°æ®ä½åˆ™åˆ·æ–°
1789          //      ++global.iouart.recCount;
1790          //      global.iouart.recData >>= 1;
1791          //      if(UART9_RD)
1792          //      {
1793          //        global.iouart.recData |= 0x80;  //ä½ä½åœ¨å…ˆ
1794          //      }
1795          //    }
1796          //    else if(global.iouart.recCount == 8)
1797          //    {
1798          //      if(UART9_RD)  //RDè„šè¢«æ‹‰é«˜--å³æ¥æ”¶åˆ°åœæ­¢ä½--åœæ­¢ä½ä¸º1
1799          //      {
1800          //        global.iouart.recComplete = true;
1801          //      }
1802          //      global.iouart.recTimeOutCount = 0;  //å…³é—­è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ™ä¸è®¡æ—¶
1803          //      global.iouart.recEnable = false;
1804          //    }
1805          //  }
1806          
1807          //  ////æ•°æ®å¤„ç†
1808          //  if(global.iouart.recComplete == true)
1809          //  {
1810          //    global.iouart.recComplete = false;
1811              
1812          //    //åˆ¤æ–­æ¥æ”¶çš„æ•°æ®æ˜¯å¦ç¬¦åˆé€šä¿¡æ ¼å¼
1813          //    if(global.iouart.nowIndex == 0 && global.iouart.recData == 0x96)  //å¤´
1814          //    {
1815          //      global.iouart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½
             -“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1816          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;
1817          //      ++global.iouart.nowIndex;
1818          //    }
1819          //    else if(global.iouart.nowIndex == 1)  //æ•°æ®é•¿åº¦
1820          //    {
1821          //      global.iouart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ
             -™æ”¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1822          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //é•¿åº¦ï¼šä»å¤´åˆ°æ ¡éªŒ
1823          //      ++global.iouart.nowIndex;
1824          //    }
1825          //    else if(global.iouart.nowIndex >= 2 && global.iouart.nowIndex <= global.iouart.recBuff[1]-2)  //å‡å»
             -äº†æ ¡éªŒå­—èŠ‚ï¼Œå› ä¸ºä¸‹æ ‡æ¯”å®é™…é•¿åº¦å°1ï¼Œæ‰€ä»¥-2
1826          //    {
1827          //      global.iouart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ
             -™æ”¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1828          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //æ•°æ®
1829          //      ++global.iouart.nowIndex;
1830          //    }
1831          //    else if(global.iouart.nowIndex == global.iouart.recBuff[1]-1) //æ ¡éªŒ
1832          //    {
1833          //      //ä¹‹åæ›´æ”¹æ¨¡å¼ï¼Œå°†è€—æ—¶æ“ä½œéƒ½ç§»èµ°
1834          
1835          //      global.iouart.recTimeOutCount = 0;  //å…³é—­è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ™ä¸è®¡æ—¶
1836          //      for(i = 0;i <= global.iouart.recBuff[1] - 2;i++)  //è®¡ç®—æ ¡éªŒå’Œ
1837          //      {
1838          //        sum += global.iouart.recBuff[i];
C51 COMPILER V9.60.0.0   FUNC                                                              12/20/2019 13:45:34 PAGE 32  

1839          //      }
1840          //      if(sum == global.iouart.recData)  //æ ¡éªŒé€šè¿‡
1841          //      {
1842          //        global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //æ ¡éªŒ
1843          //        uart9_fun(global.iouart.recBuff); //åŠŸèƒ½åˆ¤æ–­
1844          //      }
1845          //      global.iouart.nowIndex = 0;
1846          //    }
1847          //  }
1848          
1849          //  ////////å‘é€éƒ¨åˆ†////////
1850          //  if(global.iouart.sendEnable)
1851          //  {
1852          //    if (global.iouart.sendCount == 0)
1853          //    {
1854          //      UART9_TD_L; //äº§ç”Ÿä¸€ä¸ªèµ·å§‹ä½--0
1855          //      ++global.iouart.sendCount;
1856          //    }
1857          //    else if(global.iouart.sendCount >= 1 && global.iouart.sendCount <= 8)
1858          //    {
1859          //      if( (global.iouart.sendData >> (global.iouart.sendCount-1)) & 0x01) //å…ˆå‘ä½ä½
1860          //      {
1861          //        UART9_TD_H;
1862          //      }
1863          //      else
1864          //      {
1865          //        UART9_TD_L;
1866          //      }
1867          //      ++global.iouart.sendCount;
1868          //    }
1869          //    else if (global.iouart.sendCount == 9)
1870          //    {
1871          //      UART9_TD_H; //äº§ç”Ÿä¸€ä¸ªåœæ­¢ä½--1
1872          //      global.iouart.sendCount = 0;
1873          //      global.iouart.sendEnable = false;
1874          //      global.iouart.sendComplete = true;
1875          //    }
1876          //  }
1877          // }
1878          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   6120    ----
   CONSTANT SIZE    =     32    ----
   XDATA SIZE       =      1      59
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
