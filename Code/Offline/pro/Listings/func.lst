C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE FUNC
OBJECT MODULE PLACED IN .\Objects\func.obj
COMPILER INVOKED BY: C:\Users\M\AppData\Local\Keil\Keil_v4\C51\BIN\C51.EXE ..\lib\user\src\func.c LARGE OPTIMIZE(8,SPEED
                    -) BROWSE INCDIR(..\lib\n76e003\Include;..\lib\user\inc) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\Listings\func.lst
                    -) TABS(2) OBJECT(.\Objects\func.obj)

line level    source

   1          #include "func.h"
   2          
   3          void updateDeviceState(void);
   4          void configWifi(void);
   5          void sendDeviceStateToWifi(void);
   6          void topRequestForSet(void);
   7          
   8          void sendDeviceStateToTop(void);
   9          void sendSetDataToTop(void);
  10          void sendAckToTop(void);
  11          
  12          unsigned char isNoWater(void);
  13          
  14          void parseDataFromTop(void);
  15          void OneWire_init(void);
  16          void oneWire_write(unsigned char* buff,unsigned char len);
  17          unsigned char oneWire_read(unsigned char* buff);
  18          unsigned char figureSum(unsigned char* buff,unsigned char len);
  19          
  20          void parseDataFromWifi(void);
  21          unsigned char figureSum0(unsigned char* buff,unsigned char len);
  22          void uart0_sendData(unsigned char* buff,unsigned char len);
  23          
  24          void initRtc(void);
  25          void firstInitRtc(void);
  26          void rtcGetTime(void);
  27          void rtcSetTime(void);
  28          
  29          unsigned char isFristStart(void);
  30          void saveDataToFlash(void);
  31          void readDataFromFlash(void);
  32          
  33          void figureCountdown(void);
  34          void figureEndTime(void);
  35          
  36          #define initWifiResetPin() P05_PushPull_Mode;set_P05
  37          #define WifiReset() P05_PushPull_Mode;clr_P05
  38          
  39          void init(void)
  40          {
  41   1        LIGHT_CLOSE;
  42   1        global.device.light = false;
  43   1        global.set.light = false;
  44   1        WATER_CLOSE;
  45   1        global.device.water = false;
  46   1        global.set.water = false;
  47   1        OneWire_init();
  48   1        initRtc();
  49   1        initWifiResetPin();
  50   1        // Timer3_Delay100ms(5);
  51   1      
  52   1        //å¦‚æœä¸ºç¬¬ä¸€æ¬¡å¼€æœº
  53   1        if(isFristStart() == true)
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 2   

  54   1        {
  55   2          firstInitRtc(); //åˆå§‹åŒ–rtcè®¾ç½®
  56   2          //è¿™é‡Œå¯ä»¥åˆå§‹åŒ–é¢„çº¦æ•°æ®ï¼Œé»˜è®¤åˆå§‹åŒ–ä¸º0
  57   2          global.set.startLightHour = 0;
  58   2          global.set.startLightMinute = 0;
  59   2          global.set.keepLightHour = 0;
  60   2          global.set.keepLightMinute = 0;
  61   2          global.set.endLightHour = 0;
  62   2          global.set.endLightMinute = 0;
  63   2          global.set.startWaterHour = 0;
  64   2          global.set.startWaterHour = 0;
  65   2          global.set.keepWaterHour = 0;
  66   2          global.set.keepWaterMinute = 0;
  67   2          global.set.endWaterHour = 0;
  68   2          global.set.endWaterMinute = 0;
  69   2          global.set.waterCycleDay = 1;
  70   2          global.device.nextWaterDayCountDown = 1;
  71   2          saveDataToFlash();
  72   2          #ifdef DEBUG
                  uart0_sendData("is first",8);
                  #endif
  75   2        }
  76   1        else
  77   1        {
  78   2          readDataFromFlash();  //è¯»å–é¢„çº¦æ•°æ®
  79   2          #ifdef DEBUG
                  uart0_sendData("not first",9);
                  #endif
  82   2        }
  83   1      #ifdef OFFLINE
  84   1        rtcGetTime();
  85   1        figureEndTime();  //ä¸Šç”µæ—¶å…ˆè®¡ç®—ä¸€æ¬¡å¼€å§‹ç»“æŸçš„æ—¶é—´
  86   1        figureCountdown();  //è®¡ç®—å€’è®¡æ—¶
  87   1      #endif
  88   1        // Timer3_Delay100ms(5);
  89   1      }
  90          
  91          ///////////////////////////////////////////////Run//////////////////////////////////////////////////////
  92          
  93          //è¿è¡Œåœ¨å®šæ—¶å™¨3ä¸­ï¼Œä¸­æ–­æ—¶é—´ä¸º1ms
  94          void run(void)
  95          {
  96   1        /////////////////////////å¤„ç†ä¸€äº›è®¡æ—¶åŠŸèƒ½//////////////////////////
  97   1      #ifdef ONLINE
                if(++global.work.workTimeCount >= 2000) //2s
                {
                  global.work.workTimeCount = 0;
              
                  global.time.getTimeFlag = true; //è·å–ä¸€æ¬¡rtcæ—¶é—´
                }
                //ä¸²å£æ¥æ”¶è¶…æ—¶è®¡æ—¶
                if(global.uart.recTimeOutCount > 0 && global.uart.recTimeOutCount < 1000)
                {
                  ++global.iouart.recTimeOutCount;
                }
              
                if(global.uart.recvDataTimeOutFlag == false && global.uart.recvDataTimeOutClear == false) //æœªè¶…æ—¶ä¸”æ
             -œªåœ¨æ¸…ç†è®¡æ—¶
                {
                  if(++global.uart.recvDataTimeOutMs >= 1000) //1ç§’
                  {
                    global.uart.recvDataTimeOutMs = 0;
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 3   

                    if(++global.uart.recvDataTimeOutSec >= 60)  //1åˆ†é’Ÿ
                    {
                      global.uart.recvDataTimeOutSec = 0;
                      if(++global.uart.recvDataTimeOutMinute >= 10) //10åˆ†é’Ÿ
                      {
                        global.uart.recvDataTimeOutMs = 0;
                        global.uart.recvDataTimeOutSec = 0;
                        global.uart.recvDataTimeOutMinute = 0;
                        global.uart.recvDataTimeOutFlag = true; //è¶…æ—¶
                      }
                    }
                  }
                }
                else if(global.uart.recvDataTimeOutFlag == true)  //ååˆ†é’Ÿæ²¡æœ‰æ”¶åˆ°æ¥è‡ªWiFiçš„æ•°æ®ï¼Œåˆ™æœ‰å¯èƒ
             -½é”™è¯¯è¿›å…¥ä¸€é”®é…ç½®,å¤ä½WiFi
                {
                  if(++global.uart.recvDataTimeOutMs >= 500)  //500ms
                  {
                    global.uart.recvDataTimeOutMs = 0;
                    global.uart.recvDataTimeOutSec = 0;
                    global.uart.recvDataTimeOutMinute = 0;
                    global.uart.recvDataTimeOutFlag = false;
                    initWifiResetPin();
                  }
                  else
                  {
                    WifiReset();  //å¤ä½WiFi
                  }
                }
              #endif
 144   1      #ifdef OFFLINE
 145   1        if(++global.work.workTimeCount >= 1000) //1s
 146   1        {
 147   2          global.work.workTimeCount = 0;
 148   2      
 149   2          global.time.getTimeFlag = true; //è·å–ä¸€æ¬¡rtcæ—¶é—´
 150   2        }
 151   1      
 152   1      //åˆ¤æ–­æ˜¯å¦ç¼ºæ°´
 153   1        if(isNoWater())
 154   1        {
 155   2          ///////æ–°çš„ç¼ºæ°´æŠ¥è­¦é€»è¾‘
 156   2          switch(global.work.checkNoWaterFolw)
 157   2          {
 158   3            case 0:
 159   3            {
 160   4              if(global.device.water == false) { global.work.checkNoWaterFolw = 1; }  //åœ¨æœªæµ‡æ°´çš„æ—¶å€™
 161   4              else { global.work.checkNoWaterFolw = 2; }  //åœ¨æœªæµ‡æ°´çš„æ—¶å€™,å¹¶ä¸”å…³é—­æ°´æ³µ(ä»…å…³é—­è®¾å¤‡ç
             -š„è¿è¡Œ,ä¸å…³é—­è®¾å¤‡çš„çŠ¶æ€)
 162   4            } break;
 163   3            case 1:
 164   3            {
 165   4              if(++global.work.checkNoWaterCount > 100) //è¿ç»­ç¼ºæ°´100ms
 166   4              {
 167   5                global.work.checkNoWaterCount = 0;
 168   5                global.work.checkNoWaterFolw = 0;
 169   5                global.device.noWater = true;
 170   5                global.device.water = false;
 171   5                WATER_CLOSE;
 172   5              }
 173   4            } break;
 174   3            case 2:
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 4   

 175   3            {
 176   4              if(++global.work.checkNoWaterCount > 5*60000) //è¿ç»­ç¼ºæ°´5min
 177   4              {
 178   5                global.work.checkNoWaterCount = 0;
 179   5                global.work.checkNoWaterFolw = 0;
 180   5                global.device.noWater = true;
 181   5                global.device.water = false;
 182   5              }
 183   4              WATER_CLOSE;
 184   4            } break;
 185   3          }
 186   2        }
 187   1        else
 188   1        {
 189   2          if(global.work.checkNoWaterFolw == 2 && global.device.water == true)  //åœ¨ç­‰å¾…çš„æ—¶å€™ç¼ºæ°´å–æ¶ˆ,ä¸
             -”è®¾å¤‡çŠ¶æ€ä¾æ—§,åˆ™æ¢å¤è®¾å¤‡è¿è¡Œ
 190   2          {
 191   3            WATER_OPEN;
 192   3          }
 193   2          global.work.checkNoWaterFolw = 0;
 194   2          global.work.checkNoWaterCount = 0;
 195   2      
 196   2          global.device.noWater = false;
 197   2        }
 198   1        
 199   1      #endif
 200   1      }
 201          
 202          //
 203          //è¿è¡Œåœ¨main-whileä¸­
 204          //ç”¨äºæ‰§è¡Œä¸€äº›è€—æ—¶æ“ä½œ
 205          //
 206          void runMain(void)
 207          {
 208   1        static char lastMinute = -1;
 209   1      
 210   1      #ifdef ONLINE
                parseDataFromTop();
                parseDataFromWifi();
              
                //åˆ¤æ–­æ˜¯å¦ç¼ºæ°´
                if(isNoWater())
                {
                  global.device.noWater = true;
                  global.device.water = false;
                  WATER_CLOSE;
                  // global.set.noWater = true;
                }
                else
                {
                  global.device.noWater = false;
                  // global.set.noWater = false;
                }
              
                //è·å–RTCæ—¶é—´
                if(global.time.getTimeFlag == true)
                {
                  rtcGetTime();
                  global.time.getTimeFlag = false;
                }
                //æ¯è¿‡ä¸€åˆ†é’Ÿæ‰§è¡Œçš„æ“ä½œ
                if(lastMinute != global.time.minute)
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 5   

                {
                  lastMinute = global.time.minute;  //è®°å½•å½“å‰çš„åˆ†é’Ÿ
                  // figureCountdown();
                }
              
              /////////////////////////////////////////////////////////////////////////////////
              
                updateDeviceState();  //æ›´æ–°è®¾å¤‡çŠ¶æ€
              
              ////////////////////////////////////////////////////////å’Œ wifi æ¨¡å—çš„é€šä¿¡//////////////////////////
             -///////////////////////////////////////
              /////////////////////////æ¥æ”¶/////////////////////////
                // ///////// wifi è®¾ç½®è®¾å¤‡æ•°æ®//////////
                if(global.work.wifiSetDeviceFlag == true)
                {
                  global.device.light = global.set.light;
                  if(global.device.light == true) { LIGHT_OPEN; }
                  else { LIGHT_CLOSE; }
                  global.device.water = global.set.water;
                  if(global.device.water == true && global.device.noWater == false) { WATER_OPEN; } //
                  else { WATER_CLOSE; global.device.water =  false; }
                  global.device.getStateFlag = true;  //å°†æ›´æ–°çš„è®¾å¤‡çŠ¶æ€å‘Šè¯‰ä»æœº
                  global.work.wifiSetDeviceFlag = false;
                }
              /////////////////////////å‘é€/////////////////////////
                ////////ä¸€é”®é…ç½®////////
                if(global.work.wifiConfigFlag == true)
                {
                  global.work.wifiConfigFlag = false;
                  configWifi();
                }
                /////////é¡¶æ¿è¯·æ±‚è®¾ç½®è®¾å¤‡æ•°æ®/////////
                if(global.work.serventSetDevieDataFlag == true)
                {
                  global.work.serventSetDevieDataFlag = false;
                  topRequestForSet();
                }
                /////////å¾€ wifi å‘é€è®¾å¤‡æ•°æ®////////
                if(global.work.wifiGetDeviceFlag == true)
                {
                  global.work.wifiGetDeviceFlag = false;
                  sendDeviceStateToWifi();
                  if(global.device.wifi == online) rtcSetTime();  //åˆ¤æ–­æ—¶é—´å·®åï¼Œæœ‰æ¡ä»¶é€‰æ‹©è®¾ç½®ä¸å¦
                }
              
              ////////////////////////////////////////////////////////å’Œ é¡¶æ¿ çš„é€šä¿¡//////////////////////////////
             -///////////////////////////////////
              /////////////////////////æ¥æ”¶/////////////////////////
                //////////é¡¶æ¿çš„è¯·æ±‚///////////////
                if(global.work.serventSetDevieSateFlag == true)
                {
                  global.work.serventSetDevieSateFlag = false;
                  switch(global.work.keyDo)
                  {
                    case 0x01: { global.device.wifi = connecting; global.work.wifiConfigFlag = true;}break;
                    case 0x10: { global.set.light = false; global.work.serventSetDevieDataFlag = true;}break;
                    case 0x11: { global.set.light = true; global.work.serventSetDevieDataFlag = true;}break;
                    case 0x20: { global.set.water = false; global.work.serventSetDevieDataFlag = true;}break;
                    case 0x21: { global.set.water = true; global.work.serventSetDevieDataFlag = true;}break;
                  }
                }
              
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 6   

              /////////////////////////å‘é€/////////////////////////
                //////////å¾€ é¡¶æ¿ å‘é€è®¾å¤‡æ•°æ®///////////////////
                if(global.device.getStateFlag == true)  //æ”¶åˆ°è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚æˆ–è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚ï¼Œä»–ä
             -»¬çš„å“åº”ç›¸åŒ
                {
                  sendDeviceStateToTop();
                  global.device.getStateFlag = false;
                }
                //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®///////////////////
                if(global.set.getDataFlag == true)
                {
                  global.set.getDataFlag = false;
                  sendSetDataToTop();
                }
                //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®å“åº”///////////////////
                if(global.set.setDatFlag == true) //æ”¶åˆ°è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
                {
                  global.set.setDatFlag = false;
                  sendAckToTop();
                  if(global.set.setRtcTimeDataFlag == true) //ç­‰äº0xffè¯´æ˜ä¸ä¿®æ”¹rtcï¼Œé‚£ä¸ç­‰äºæ—¶ä¿®æ”¹
                  {
                    rtcSetTime();
                  }
                  global.work.serventSetDevieDataFlag = true; //å‘WIFIå‘èµ·è®¾ç½®è¯·æ±‚
                }
              #endif
 321   1      #ifdef OFFLINE
 322   1        parseDataFromTop();
 323   1      
 324   1        
 325   1      
 326   1        //è·å–RTCæ—¶é—´
 327   1        if(global.time.getTimeFlag == true)
 328   1        {
 329   2          rtcGetTime();
 330   2          global.time.getTimeFlag = false;
 331   2        }
 332   1        //æ¯è¿‡ä¸€åˆ†é’Ÿæ‰§è¡Œçš„æ“ä½œ
 333   1        if(lastMinute != global.time.minute)
 334   1        {
 335   2          lastMinute = global.time.minute;  //è®°å½•å½“å‰çš„åˆ†é’Ÿ
 336   2          figureEndTime();  //å…ˆè®¡ç®—ä¸€æ¬¡å¼€å§‹ç»“æŸçš„æ—¶é—´
 337   2          figureCountdown();  //è®¡ç®—å€’è®¡æ—¶
 338   2        }
 339   1        
 340   1      /////////////////////////////////////////////////////////////////////////////////
 341   1      
 342   1        if(global.device.light == true) { LIGHT_OPEN; }
 343   1        else if(global.device.light == false) { LIGHT_CLOSE; }
 344   1        if(global.device.water == true && global.device.noWater == false && global.work.checkNoWaterFolw == 0) { 
             -WATER_OPEN; }
 345   1        else if(global.device.water == false || global.device.noWater == true) { WATER_CLOSE; }
 346   1      
 347   1      ////////////////////////////////////////////////////////å’Œ é¡¶æ¿ çš„é€šä¿¡//////////////////////////////
             -///////////////////////////////////
 348   1      /////////////////////////æ¥æ”¶/////////////////////////
 349   1        //////////é¡¶æ¿çš„è¯·æ±‚///////////////
 350   1        if(global.work.serventSetDevieSateFlag == true)
 351   1        {
 352   2          global.work.serventSetDevieSateFlag = false;
 353   2          switch(global.work.keyDo)
 354   2          {
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 7   

 355   3            case 0x10: { global.device.light = false; global.device.getStateFlag = true; }break;
 356   3            case 0x11: { global.device.light = true; global.device.getStateFlag = true; }break;
 357   3            case 0x20: { global.device.water = false; global.device.getStateFlag = true; }break;
 358   3            case 0x21: { global.device.water = true; global.device.getStateFlag = true; }break;
 359   3          }
 360   2        }
 361   1      
 362   1      /////////////////////////å‘é€/////////////////////////
 363   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾å¤‡æ•°æ®///////////////////
 364   1        if(global.device.getStateFlag == true)  //æ”¶åˆ°è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚æˆ–è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚ï¼Œä»–ä
             -»¬çš„å“åº”ç›¸åŒ
 365   1        {
 366   2          sendDeviceStateToTop();
 367   2          global.device.getStateFlag = false;
 368   2        }
 369   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®///////////////////
 370   1        if(global.set.getDataFlag == true)
 371   1        {
 372   2          global.set.getDataFlag = false;
 373   2          readDataFromFlash();
 374   2          sendSetDataToTop();
 375   2        }
 376   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®å“åº”///////////////////
 377   1        if(global.set.setDatFlag == true) //æ”¶åˆ°è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
 378   1        {
 379   2          global.set.setDatFlag = false;
 380   2          if(global.set.setRtcTimeDataFlag == true) //ç­‰äº0xffè¯´æ˜ä¸ä¿®æ”¹rtcï¼Œé‚£ä¸ç­‰äºæ—¶ä¿®æ”¹
 381   2          {
 382   3            global.set.setRtcTimeDataFlag = false;
 383   3            rtcSetTime();
 384   3          }
 385   2          if(global.set.setTimeDataFlag == true)  //ä¿å­˜é¢„çº¦å‚æ•°
 386   2          {
 387   3            global.set.setTimeDataFlag = false;
 388   3            saveDataToFlash();
 389   3          }
 390   2          sendAckToTop(); //å‘é€å“åº”
 391   2          figureEndTime();  //è®¡ç®—å¼€å§‹ç»“æŸçš„æ—¶é—´
 392   2          figureCountdown();  //è®¡ç®—å€’è®¡æ—¶
 393   2        }
 394   1      #endif
 395   1      }
 396          
 397          //
 398          //æ›´æ–°è®¾å¤‡çŠ¶æ€
 399          //
 400          void updateDeviceState(void)
 401          {
 402   1        //æ›´æ–° wifi è¿æ¥çŠ¶æ€
 403   1        if(global.work.wifiStateUpdateFlag == true)
 404   1        {
 405   2          global.work.wifiStateUpdateFlag = false;
 406   2          global.device.wifi = global.set.wifiConnectState;
 407   2        }
 408   1        //æ›´æ–° ç…§æ˜ çŠ¶æ€
 409   1        if(global.work.lightSateUpdateFlag == true)
 410   1        {
 411   2          global.work.lightSateUpdateFlag = false;
 412   2          global.device.light = global.set.light;
 413   2        }
 414   1        //æ›´æ–° æµ‡æ°´ çŠ¶æ€
 415   1        if(global.work.waterSateUpdateFlag == true)
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 8   

 416   1        {
 417   2          global.work.waterSateUpdateFlag = false;
 418   2          global.device.water = global.set.water;
 419   2        }
 420   1        //æ›´æ–° ç¼ºæ°´ çŠ¶æ€
 421   1        if(global.work.nowaterSateUpdateFlag == true)
 422   1        {
 423   2          global.work.nowaterSateUpdateFlag = false;
 424   2          global.device.noWater = global.set.noWater;
 425   2        }
 426   1      }
 427          
 428          //
 429          // å‘ wifi å‘é€ä¸€é”®é…ç½®å‘½ä»¤
 430          //
 431          void configWifi(void)
 432          {
 433   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 434   1        global.uart.sendBuff[1] = 11; //é•¿åº¦
 435   1      
 436   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 437   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 438   1        global.uart.sendBuff[4] = 0x10; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 439   1        global.uart.sendBuff[5] = 0x01; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 440   1      
 441   1        global.uart.sendBuff[6] = 0x11;
 442   1        global.uart.sendBuff[7] = 0x22;
 443   1        global.uart.sendBuff[8] = 0x33;
 444   1        global.uart.sendBuff[9] = 0x44;
 445   1        global.uart.sendBuff[10] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 446   1      
 447   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 448   1      }
 449          
 450          //
 451          //å‘ wifi å‘é€è®¾å¤‡çŠ¶æ€
 452          //
 453          void sendDeviceStateToWifi(void)
 454          {
 455   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 456   1        global.uart.sendBuff[1] = 20; //é•¿åº¦
 457   1      
 458   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 459   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 460   1        global.uart.sendBuff[4] = 0x28; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 461   1        global.uart.sendBuff[5] = 0x01; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 462   1      
 463   1        global.uart.sendBuff[6] = global.time.year; //rtcå¹´è°ƒæ•´
 464   1        global.uart.sendBuff[7] = global.time.month;  //rtcæœˆè°ƒæ•´
 465   1        global.uart.sendBuff[8] = global.time.day;  //rtcæ—¥è°ƒæ•´
 466   1        global.uart.sendBuff[9] = global.time.hour; //rtcæ—¶è°ƒæ•´
 467   1        global.uart.sendBuff[10] = global.time.minute;  //rtcåˆ†è°ƒæ•´
 468   1        global.uart.sendBuff[11] = global.time.sec; //rtcç§’è°ƒæ•´
 469   1      
 470   1        global.uart.sendBuff[12] = global.device.temperature>>8;
 471   1        global.uart.sendBuff[13] = global.device.temperature&0xff;
 472   1        global.uart.sendBuff[14] = global.device.water; //æµ‡æ°´çŠ¶æ€
 473   1        global.uart.sendBuff[15] = global.device.light; //ç…§æ˜çŠ¶æ€
 474   1        global.uart.sendBuff[16] = global.device.noWater; //ç¼ºæ°´çŠ¶æ€
 475   1      
 476   1        global.uart.sendBuff[17] = 0x01;  //ç‰ˆæœ¬ä¿¡æ¯é«˜å­—èŠ‚
 477   1        global.uart.sendBuff[18] = 0x01;  //ç‰ˆæœ¬ä¿¡æ¯ä½å­—èŠ‚
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 9   

 478   1        global.uart.sendBuff[19] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 479   1      
 480   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 481   1      }
 482          
 483          //
 484          //å‘ wifi å‘é€æ¥è‡ª Top çš„è®¾ç½®è¯·æ±‚
 485          //
 486          void topRequestForSet(void)
 487          {
 488   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 489   1        global.uart.sendBuff[1] = 24; //é•¿åº¦
 490   1      
 491   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 492   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 493   1        global.uart.sendBuff[4] = 0x10; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 494   1        global.uart.sendBuff[5] = 0x03; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 495   1      
 496   1        if(global.set.setTimeDataFlag == true)
 497   1        {
 498   2          global.uart.sendBuff[6] = global.set.startLightHour;  //ç…§æ˜å¯åŠ¨å°æ—¶è°ƒæ•´--0xFFå³ä¸åšè°ƒæ•´
 499   2          global.uart.sendBuff[7] = global.set.startLightMinute;  //ç…§æ˜å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 500   2          global.uart.sendBuff[8] = global.set.keepLightHour; //ç…§æ˜æŒç»­å°æ—¶è°ƒæ•´
 501   2          global.uart.sendBuff[9] = global.set.keepLightMinute; //ç…§æ˜æŒç»­åˆ†é’Ÿè°ƒæ•´
 502   2          global.uart.sendBuff[10] = global.set.startWaterHour; //æµ‡æ°´å¯åŠ¨å°æ—¶è°ƒæ•´
 503   2          global.uart.sendBuff[11] = global.set.startWaterMinute; //æµ‡æ°´å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 504   2          global.uart.sendBuff[12] = global.set.keepWaterHour;  //æµ‡æ°´æŒç»­å°æ—¶è°ƒæ•´
 505   2          global.uart.sendBuff[13] = global.set.keepWaterMinute;  //æµ‡æ°´æŒç»­åˆ†é’Ÿè°ƒæ•´
 506   2          global.uart.sendBuff[14] = global.set.waterCycleDay;  //æµ‡æ°´å‘¨æœŸæ—¶é—´è°ƒæ•´
 507   2          global.set.setTimeDataFlag = false;
 508   2        }
 509   1        else
 510   1        {
 511   2          global.uart.sendBuff[6] = 0xff;//global.set.startLightHour; //ç…§æ˜å¯åŠ¨å°æ—¶è°ƒæ•´--0xFFå³ä¸åšè°ƒ
             -æ•´
 512   2          global.uart.sendBuff[7] = 0xff;//global.set.startLightMinute; //ç…§æ˜å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 513   2          global.uart.sendBuff[8] = 0xff;//global.set.keepLightHour;  //ç…§æ˜æŒç»­å°æ—¶è°ƒæ•´
 514   2          global.uart.sendBuff[9] = 0xff;//global.set.keepLightMinute;  //ç…§æ˜æŒç»­åˆ†é’Ÿè°ƒæ•´
 515   2          global.uart.sendBuff[10] = 0xff;//global.set.startWaterHour;  //æµ‡æ°´å¯åŠ¨å°æ—¶è°ƒæ•´
 516   2          global.uart.sendBuff[11] = 0xff;//global.set.startWaterMinute;  //æµ‡æ°´å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 517   2          global.uart.sendBuff[12] = 0xff;//global.set.keepWaterHour; //æµ‡æ°´æŒç»­å°æ—¶è°ƒæ•´
 518   2          global.uart.sendBuff[13] = 0xff;//global.set.keepWaterMinute; //æµ‡æ°´æŒç»­åˆ†é’Ÿè°ƒæ•´
 519   2          global.uart.sendBuff[14] = 0xff;//global.set.waterCycleDay; //æµ‡æ°´å‘¨æœŸæ—¶é—´è°ƒæ•´
 520   2        }
 521   1      
 522   1        global.uart.sendBuff[15] = global.set.light;  //è¯·æ±‚ç…§æ˜è®¾ç½®
 523   1        global.uart.sendBuff[16] = global.set.water;  //è¯·æ±‚æµ‡æ°´è®¾ç½®
 524   1      
 525   1        global.uart.sendBuff[17] = 0xff;//global.set.year;  //å¹´è°ƒæ•´
 526   1        global.uart.sendBuff[18] = 0xff;//global.set.month; //æœˆè°ƒæ•´
 527   1        global.uart.sendBuff[19] = 0xff;//global.set.day; //æ—¥è°ƒæ•´
 528   1        if(global.set.setRtcTimeDataFlag == true)
 529   1        {
 530   2          global.uart.sendBuff[20] = global.set.hour; //æ—¶è°ƒæ•´
 531   2          global.uart.sendBuff[21] = global.set.minute; //åˆ†è°ƒæ•´
 532   2          global.uart.sendBuff[22] = 0;//global.set.sec;  //ç§’è°ƒæ•´
 533   2          global.set.setRtcTimeDataFlag = false;
 534   2        }
 535   1        else
 536   1        {
 537   2          global.uart.sendBuff[20] = 0xff;//global.set.hour;  //æ—¶è°ƒæ•´
 538   2          global.uart.sendBuff[21] = 0xff;//global.set.minute;  //åˆ†è°ƒæ•´
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 10  

 539   2          global.uart.sendBuff[22] = 0xff;//global.set.sec; //ç§’è°ƒæ•´
 540   2        }
 541   1      
 542   1        global.uart.sendBuff[23] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 543   1      
 544   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 545   1      }
 546          
 547          //
 548          //å‘ é¡¶æ¿ å‘é€è®¾å¤‡çŠ¶æ€
 549          //
 550          void sendDeviceStateToTop(void)
 551          {
 552   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 553   1        global.iouart.sendBuff[1] = 18; //é•¿åº¦
 554   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 555   1        global.iouart.sendBuff[3] = 0x02; //æ¶ˆæ¯ç±»å‹dä½8ä½
 556   1      #ifdef ONLINE
                global.iouart.sendBuff[4] = global.device.wifi;
              #endif
 559   1      #ifdef OFFLINE
 560   1        global.iouart.sendBuff[4] = offline;
 561   1      #endif
 562   1        global.iouart.sendBuff[5] = 0x00;
 563   1        global.iouart.sendBuff[6] = global.device.light;
 564   1        global.iouart.sendBuff[7] = global.device.water;
 565   1        global.iouart.sendBuff[8] = global.device.noWater;
 566   1        global.iouart.sendBuff[9] = global.device.nextStartLightCountDown>>8;
 567   1        global.iouart.sendBuff[10] = global.device.nextStartLightCountDown&0x00ff;
 568   1        global.iouart.sendBuff[11] = global.device.endLightCountDown>>8;
 569   1        global.iouart.sendBuff[12] = global.device.endLightCountDown&0x00ff;
 570   1        global.iouart.sendBuff[13] = global.device.nextStartWaterCountDown>>8;
 571   1        global.iouart.sendBuff[14] = global.device.nextStartWaterCountDown&0x00ff;
 572   1        global.iouart.sendBuff[15] = global.device.endWaterCountDown>>8;
 573   1        global.iouart.sendBuff[16] = global.device.endWaterCountDown&0x00ff;
 574   1        global.iouart.sendBuff[17] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 575   1      
 576   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 577   1      }
 578          
 579          //
 580          //å‘ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®
 581          //
 582          void sendSetDataToTop(void)
 583          {
 584   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 585   1        global.iouart.sendBuff[1] = 16; //é•¿åº¦
 586   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 587   1        global.iouart.sendBuff[3] = 0x04; //æ¶ˆæ¯ç±»å‹dä½8ä½
 588   1        global.iouart.sendBuff[4] = global.time.hour;
 589   1        global.iouart.sendBuff[5] = global.time.minute;
 590   1        global.iouart.sendBuff[6] = global.set.startLightHour;
 591   1        global.iouart.sendBuff[7] = global.set.startLightMinute;
 592   1        global.iouart.sendBuff[8] = global.set.keepLightHour;
 593   1        global.iouart.sendBuff[9] = global.set.keepLightMinute;
 594   1        global.iouart.sendBuff[10] = global.set.startWaterHour;
 595   1        global.iouart.sendBuff[11] = global.set.startWaterMinute;
 596   1        global.iouart.sendBuff[12] = global.set.keepWaterHour;
 597   1        global.iouart.sendBuff[13] = global.set.keepWaterMinute;
 598   1        global.iouart.sendBuff[14] = global.set.waterCycleDay;
 599   1        global.iouart.sendBuff[15] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 600   1      
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 11  

 601   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 602   1        #ifdef DEBUG
                uart0_sendData(global.iouart.sendBuff,global.iouart.sendBuff[1]);
                #endif
 605   1      }
 606          
 607          //
 608          //å‘ é¡¶æ¿ å‘é€å“åº”
 609          //
 610          void sendAckToTop(void)
 611          {
 612   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 613   1        global.iouart.sendBuff[1] = 5;  //é•¿åº¦
 614   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 615   1        global.iouart.sendBuff[3] = 0x07; //æ¶ˆæ¯ç±»å‹dä½8ä½
 616   1        global.iouart.sendBuff[4] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 617   1      
 618   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 619   1      }
 620          
 621          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 622          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 623          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 624          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 625          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 626          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 627          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 628          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 629          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 630          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 631          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 632          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 633          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 634          
 635          unsigned char isNoWater(void)
 636          {
 637   1        NOWATER_INIT;
 638   1        if(IS_NOWATER == 0)
 639   1        {
 640   2          return true;
 641   2        }
 642   1      
 643   1        return false;
 644   1      }
 645          
 646          void parseDataFromTop(void)
 647          {
 648   1        unsigned char len = 0,sum = 0;
 649   1        unsigned char buff[32] = {0};
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 12  

 650   1        unsigned int cmd = 0;
 651   1        len = oneWire_read(buff);
 652   1        if(len != 0)  //å¤§äº0åˆ™è¯´æ˜æœ‰æ•°æ®åŒ…
 653   1        {
 654   2          sum = figureSum(buff,len-1);
 655   2          if(buff[0] == 0x96 && buff[len-1] == sum) //ç¡®è®¤åŒ…å¤´å’Œæ ¡éªŒ
 656   2          {
 657   3            cmd = buff[2]<<8 | buff[3];
 658   3            switch(cmd)
 659   3            {
 660   4              case 0x0001:  //è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚  //é¡¶æ¿ç´¢è¦è®¾å¤‡çŠ¶æ€æ•°æ®ï¼Œå¹¶ç»™å‡ºå½“å‰æ¸©åº¦
 661   4              {
 662   5                global.device.temperature = buff[4]<<8 | buff[5]; //æ‹¿åˆ°æ¸©åº¦
 663   5                global.device.getStateFlag = true;  //æ ‡è®°è·å–çŠ¶æ€æ ‡å¿—ï¼Œå°†è¦å‘é€è®¾å¤‡çŠ¶æ€ç»™é¡¶æ¿
 664   5              }break;
 665   4              case 0x0003:  //è®¾ç½®å‚æ•°è·å–è¯·æ±‚
 666   4              {
 667   5                global.set.getDataFlag = true;
 668   5              }break;
 669   4              case 0x0005:  //è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚ï¼ŒæŒ‰ä¸‹ç…§æ˜æˆ–æµ‡æ°´æˆ–è¿wifi
 670   4              {
 671   5                global.work.keyDo = buff[4];
 672   5                global.work.serventSetDevieSateFlag = true; //åˆ¤æ–­é”®å€¼ï¼Œå¹¶ä¸”å‘é€ç»™æ¨¡å—å†³æ–­
 673   5              }break;
 674   4              case 0x0006:  //è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
 675   4              {
 676   5                if(buff[4] != 0xff)
 677   5                {
 678   6                  global.set.hour = buff[4];
 679   6                  global.set.minute = buff[5];
 680   6                  global.set.sec = 0;
 681   6                  global.set.setRtcTimeDataFlag = true; //è®¾ç½®äº†rtcæ—¶é—´
 682   6                }
 683   5                else global.set.setRtcTimeDataFlag = false;
 684   5                if(buff[6] != 0xff)
 685   5                {
 686   6                  global.set.startLightHour = buff[6];
 687   6                  global.set.startLightMinute = buff[7];
 688   6                  global.set.keepLightHour = buff[8];
 689   6                  global.set.keepLightMinute = buff[9];
 690   6                  global.set.startWaterHour = buff[10];
 691   6                  global.set.startWaterMinute = buff[11];
 692   6                  global.set.keepWaterHour = buff[12];
 693   6                  global.set.keepWaterMinute = buff[13];
 694   6                  global.set.waterCycleDay = buff[14];
 695   6                  global.device.nextWaterDayCountDown = buff[14];
 696   6                  global.set.setTimeDataFlag = true;  //è®¾ç½®äº†ç…§æ˜æµ‡æ°´çš„æ—¶é—´
 697   6                }
 698   5                else global.set.setTimeDataFlag = false;
 699   5      
 700   5                global.set.setDatFlag = true;
 701   5              }break;
 702   4            }
 703   3          }
 704   2        }
 705   1      }
 706          
 707          /////////////////////////////////////////////////å•æ€»çº¿é€šä¿¡//////////////////////////////////////////
             -//////////////
 708          
 709          #define ONE_WIRE_A P03
 710          #define ONE_WIRE_A_MODE P03_Quasi_Mode
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 13  

 711          #define ONE_WIRE_A_H set_P03
 712          #define ONE_WIRE_A_L clr_P03
 713          #define ONE_WIRE_B P04
 714          #define ONE_WIRE_B_MODE P04_Quasi_Mode
 715          #define ONE_WIRE_B_H set_P04
 716          #define ONE_WIRE_B_L clr_P04
 717          
 718          #define ONE_WIRE_READ ONE_WIRE_B
 719          #define ONE_WIRE_WRITE(b) if(b) ONE_WIRE_A_H; else ONE_WIRE_A_L
 720          
 721          void OneWire_init(void)
 722          {
 723   1        ONE_WIRE_A_MODE;
 724   1        ONE_WIRE_B_MODE;
 725   1      
 726   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿
 727   1      }
 728          
 729          void oneWire_start(void)
 730          {
 731   1        ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºèµ·å§‹ä¿¡å·
 732   1        Timer0_Delay1ms(10);
 733   1      }
 734          
 735          void oneWire_stop(void)
 736          {
 737   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿ä½œä¸ºåœæ­¢ä¿¡å·
 738   1      }
 739          
 740          //
 741          //  å†™ä¸€ä¸ªå­—èŠ‚å…«ä½æ•°æ®
 742          //
 743          void oneWire_writeByte(unsigned char dat)
 744          {
 745   1        unsigned char i = 8;
 746   1      
 747   1        while(i--)
 748   1        {
 749   2          ONE_WIRE_WRITE(1);  //æ‹‰é«˜å†™æ€»çº¿ä¼ è¾“ä¸€ä½æ•°æ®
 750   2          if(dat & 0x80)
 751   2            Timer0_Delay100us(5); //å†™é«˜ç”µå¹³
 752   2          else
 753   2            Timer0_Delay100us(2); //å†™ä½ç”µå¹³
 754   2          dat <<= 1;
 755   2          ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºä½ä¹‹é—´çš„é—´éš”
 756   2          Timer0_Delay100us(2);
 757   2        }
 758   1      }
 759          
 760          //
 761          //  å†™æ•°æ®åŒ…ï¼Œé€šä¿¡è§„åˆ™ä¸­ï¼Œèµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¿…é¡»ä¸ºæ•°æ®åŒ…çš„é•¿åº¦(è¯¥å­—èŠ‚
             -ä¸è®¡ç®—åœ¨é•¿åº¦å†…)
 762          //
 763          void oneWire_write(unsigned char* buff,unsigned char len)
 764          {
 765   1        oneWire_start();  //èµ·å§‹ä¿¡å·
 766   1        oneWire_writeByte(len); //å‘é€æ•°æ®é•¿åº¦
 767   1        while(len--)  //æ•°æ®åŒ…é•¿åº¦
 768   1        {
 769   2          oneWire_writeByte(*buff); //å‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®
 770   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 771   2        }
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 14  

 772   1        oneWire_stop(); //åœæ­¢ä¿¡å·
 773   1      }
 774          
 775          //
 776          //  è¯»æ•°æ®åŒ…ï¼ŒæˆåŠŸåè¿”å›æ•°æ®åŒ…é•¿åº¦,å¤±è´¥ä¸º0
 777          //
 778          unsigned char oneWire_read(unsigned char* buff)
 779          {
 780   1        unsigned int timeOut = 0;
 781   1        unsigned char count = 0,dat = 0,transFlag = 0,index = 0,lenFlag = 0,lenCount = 0,len = 0;
 782   1        if(!ONE_WIRE_READ)  //ä½ç”µå¹³ï¼Œæ”¶åˆ°èµ·å§‹ä¿¡å·
 783   1        {
 784   2          while(1)
 785   2          {
 786   3            if(ONE_WIRE_READ) //é«˜ç”µå¹³ï¼Œè®¡ç®—æŒç»­æ—¶é—´
 787   3            {
 788   4              ++count;  //è®°å½•é«˜ç”µå¹³æŒç»­æ—¶é—´
 789   4              transFlag = 1;  //ç”µå¹³è·³å˜æ ‡å¿—
 790   4            }
 791   3            else if(!ONE_WIRE_READ && transFlag == 1) //è¯»æ€»çº¿ä¸ºä½ç”µå¹³å¹¶ä¸”åªæœ‰åœ¨ç”µå¹³è·³å˜åæ‰è¿›å…
             -¥
 792   3            { //ä¸€ä½æ•°æ®ç»“æŸï¼Œåˆ¤æ–­ä¹‹å‰çš„é«˜ç”µå¹³ä¼ è¾“çš„æ˜¯1è¿˜æ˜¯0
 793   4              dat <<= 1;
 794   4              if(count > 3) //å¤§äº300uså°±ç®—é«˜ç”µå¹³
 795   4                dat |= 1;
 796   4              count = 0;  //æ¸…é«˜ç”µå¹³è®¡æ•°
 797   4              timeOut = 0;  //æ¸…è¶…æ—¶è®¡æ•°
 798   4              transFlag = 0;  //æ¸…ç”µå¹³è·³å˜æ ‡å¿—
 799   4              if(++index == 8)  //æ¯è¯»å…«ä½ï¼Œå³ä¸€ä¸ªå­—èŠ‚è¿›å…¥ä¸€æ¬¡
 800   4              {
 801   5                if(lenFlag == 0)  //èµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œç”¨äºè¯´æ˜æ•°æ®åŒ…çš„é•¿åº¦
 802   5                {
 803   6                  lenFlag = 1;  //å·²æ¥æ”¶åˆ°é•¿åº¦
 804   6                  len = dat;
 805   6                }
 806   5                else  //æ•°æ®åŒ…çš„å†…å®¹
 807   5                {
 808   6                  *buff = dat;
 809   6                  if(++lenCount == len) //æ•°æ®åŒ…æ¥æ”¶å®Œæˆ
 810   6                  {
 811   7                    Timer0_Delay100us(3); //ç­‰ä½ç”µå¹³è¿‡å»ï¼Œä»¥é˜²æ­¢è¿ç»­ä¼ è¾“æ—¶é”™è¯¯çš„å°†ç”¨ä½œé—´éš”çš„ä½
             -ç”µå¹³è¯†åˆ«ä¸ºèµ·å§‹ä¿¡å·
 812   7                    return len; //ç»“æŸ,å¹¶è¿”å›é•¿åº¦
 813   7                  }
 814   6                  else  //æ²¡æ¥æ”¶å®Œæˆå°±ç»§ç»­æ¥æ”¶ï¼Œè¿™é‡Œå•ç‹¬è‡ªå¢æ˜¯ä¸ºäº†é˜²æ­¢æº¢å‡º
 815   6                  {
 816   7                    ++buff;
 817   7                  }
 818   6                  
 819   6                }
 820   5                index = 0;  //æ¸…è®¡æ•°
 821   5                dat = 0x00; //æ¸…å˜é‡
 822   5              }
 823   4            }
 824   3            Timer0_Delay100us(1); //è¶…æ—¶å¤„ç†
 825   3            if(++timeOut > 200) return 0; //è¶…æ—¶
 826   3          }
 827   2        }
 828   1        return 0;
 829   1      }
 830          
 831          //
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 15  

 832          //å’Œæ ¡éªŒè®¡ç®—
 833          //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
 834          //
 835          unsigned char figureSum(unsigned char* buff,unsigned char len)
 836          {
 837   1        unsigned char sum = 0;
 838   1      
 839   1        while(len--)
 840   1        {
 841   2          sum += *buff;
 842   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 843   2        }
 844   1        return sum;
 845   1      }
 846          
 847          ///////////////////////////////////////////////ä¸²å£0åŠŸèƒ½//////////////////////////////////////////////
             -////////
 848          
 849          void uart0_fun(unsigned char* buff);  //å£°æ˜
 850          //
 851          //  å¤„ç†æ•°æ®
 852          //
 853          void parseDataFromWifi(void)
 854          {
 855   1        unsigned char sum = 0;
 856   1        if(global.uart.recvCmdCount > 0)  //æœ‰å¾…å¤„ç†çš„æŒ‡ä»¤
 857   1        {
 858   2          if(global.uart.recvCmdCount > UARTBUFFCMDMAXSIZE - 1) //å¦‚æœå¾…å¤„ç†çš„æŒ‡ä»¤è¿‡å¤šï¼Œå¤§äºä¸Šé™-1(
             -å› ä¸ºæ­£åœ¨æ¥æ”¶çš„æŒ‡ä»¤ä¼šå ç”¨ä¸€æ¡ï¼Œæ‰€ä»¥è¦-1)
 859   2          {
 860   3            //å› ä¸ºå¾…å¤„ç†è¿‡å¤šäº†ï¼Œæ‰€ä»¥ç¼“å†²åŒºä¸­æ¯ä¸€æ¡éƒ½è¢«å ç”¨äº†ï¼Œæ‰€ä»¥å¤„ç†å½“å‰åœ¨æ¥æ”¶çš
             -„ä¸‹æ ‡çš„+2ï¼Œä¹‹æ‰€ä»¥ä¸æ˜¯+1æ˜¯ä¸ºäº†é˜²æ­¢è¿˜åœ¨å¤„ç†+1æ—¶ï¼Œå½“å‰çš„ä¸‹æ ‡å°±æ¥æ”¶å®Œäº†æ¥ç€åˆå¼€å§‹æ¥æ”¶+1
             -å¯¼è‡´æ•°æ®é”™ä¹±
 861   3            //ä¾‹å¦‚å½“å‰åœ¨æ¥æ”¶çš„ä¸‹æ ‡æ˜¯0ï¼Œé‚£ä¹ˆå¦‚æœå¤„ç†1æ—¶ï¼Œè¿˜æœªå¤„ç†å®Œ1å°±æ¥æ”¶å®Œ0äº†ï¼Œæ¥ç
             -€åˆå¼€å§‹æ¥æ”¶1ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´é”™ä¹±
 862   3            if(global.uart.recvCmdNowIndex + 2 > UARTBUFFCMDMAXSIZE - 1)  //å¦‚æœä¸‹æ ‡+2ä¼šè¶…è¿‡æœ€å¤§ä¸‹æ ‡ï¼Œåˆ
             -™è®¡ç®—ä¸‹æ ‡
 863   3            {
 864   4              global.uart.recvCmdIndex = 2 - (UARTBUFFCMDMAXSIZE - 1 - global.uart.recvCmdNowIndex);  //è¶…å‡ºå¤šå°‘å
             -ˆ™ä»0åŠ ä¸Šå¤šå°‘ï¼Œæœ€å¤šåŠ 2
 865   4            }
 866   3            else
 867   3            {
 868   4              global.uart.recvCmdIndex = global.uart.recvCmdNowIndex + 2;
 869   4            }
 870   3          }
 871   2          else  //å¾…å¤„ç†çš„æŒ‡ä»¤ä¸å¤š,åˆ™ç›´æ¥å¤„ç†å½“å‰æ¥æ”¶çš„ä¸Šä¸€æ¡
 872   2          {
 873   3            if(global.uart.recvCmdNowIndex == 0)
 874   3            {
 875   4              global.uart.recvCmdIndex = UARTBUFFCMDMAXSIZE - 1;
 876   4            }
 877   3            else
 878   3            {
 879   4              global.uart.recvCmdIndex = global.uart.recvCmdNowIndex - 1;
 880   4            }
 881   3          }
 882   2          
 883   2          //å¤„ç†æŒ‡ä»¤
 884   2          sum = figureSum0(global.uart.recvDealBuff[global.uart.recvCmdIndex],global.uart.recvDealBuff[global.uart
             -.recvCmdIndex][1]-1);
 885   2          if(sum == global.uart.recvDealBuff[global.uart.recvCmdIndex][global.uart.recvDealBuff[global.uart.recvCm
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 16  

             -dIndex][1]-1])  //æ ¡éªŒé€šè¿‡
 886   2          {
 887   3            global.uart.recvDataTimeOutClear = true;  //å¼€å¯æ¸…ç†æ ‡å¿—ï¼Œé˜²æ­¢æ¸…ç†æ—¶è¢«ä¸­æ–­ä¿®æ”¹
 888   3            global.uart.recvDataTimeOutMs = 0;
 889   3            global.uart.recvDataTimeOutSec = 0;
 890   3            global.uart.recvDataTimeOutMinute = 0;
 891   3            global.uart.recvDataTimeOutClear = false; //å…³é—­æ¸…ç†æ ‡å¿—ï¼Œè®©ä¸­æ–­ç»§ç»­è®¡æ—¶
 892   3            uart0_fun(global.uart.recvDealBuff[global.uart.recvCmdIndex]);  //åŠŸèƒ½åˆ¤æ–­
 893   3          }
 894   2          --global.uart.recvCmdCount; //å¾…å¤„ç†æŒ‡ä»¤-1
 895   2        }
 896   1      }
 897          
 898          //
 899          //å’Œæ ¡éªŒè®¡ç®—
 900          //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
 901          //
 902          unsigned char figureSum0(unsigned char* buff,unsigned char len)
 903          {
 904   1        unsigned char sum = 0;
 905   1      
 906   1        while(len--)
 907   1        {
 908   2          sum += *buff;
 909   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 910   2        }
 911   1        sum = ~sum;
 912   1        sum += 1;
 913   1        return sum;
 914   1      }
 915          
 916          void uart0_fun(unsigned char* buff)
 917          {
 918   1        unsigned int messageType = 0,temp = 0;
 919   1        messageType = (buff[4]<<8) | buff[5];
 920   1        switch(messageType)
 921   1        {
 922   2          case 0x1801:  //ä¸€é”®é…ç½®å“åº”
 923   2          {
 924   3            
 925   3          }break;
 926   2          case 0x1803:  //è®¾ç½®å‚æ•°å“åº”
 927   2          {
 928   3            
 929   3          }break;
 930   2          case 0x1002:  //ç½‘ç»œçŠ¶æ€
 931   2          {
 932   3            if(buff[7] == 0x00) global.set.wifiConnectState = connectToAp;  //è¿æ¥è·¯ç”±
 933   3            else if(buff[7] == 0x01 && buff[8] == 0x00) global.set.wifiConnectState = connectToService; //è¿æ¥è‡³
             -è·¯ç”±
 934   3            else if(buff[8] == 0x01)  global.set.wifiConnectState = online; //è¿æ¥è‡³æœåŠ¡å™¨
 935   3      
 936   3            global.work.wifiStateUpdateFlag = true; //ç½®ä½ wifi çŠ¶æ€æ›´æ–°æ ‡å¿—
 937   3          }break;
 938   2          case 0x2001:  //WIFIæ¨¡å—è¯·æ±‚è®¾å¤‡çŠ¶æ€å¹¶ç»™æ—¶é—´
 939   2          {
 940   3            if(buff[6] != 0xff)
 941   3            {
 942   4              global.set.year = buff[6];// + 2000;
 943   4            }
 944   3            if(buff[7] != 0xff)
 945   3            {
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 17  

 946   4              global.set.month = buff[7];
 947   4            }
 948   3            if(buff[8] != 0xff)
 949   3            {
 950   4              global.set.day = buff[8];
 951   4            }
 952   3            if(buff[9] != 0xff)
 953   3            {
 954   4              global.set.hour = buff[9];
 955   4            }
 956   3            if(buff[10] != 0xff)
 957   3            {
 958   4              global.set.minute = buff[10];
 959   4            }
 960   3            if(buff[11] != 0xff)
 961   3            {
 962   4              global.set.sec = buff[11];
 963   4            }
 964   3            global.work.wifiGetDeviceFlag = true;
 965   3          }break;
 966   2          case 0x2002:  //WIFIæ¨¡å—è¯·æ±‚è®¾ç½®è®¾å¤‡
 967   2          {
 968   3            if(buff[6] == 0x00) global.set.water = false;
 969   3            else if(buff[6] == 0x01) global.set.water = true;
 970   3            if(buff[7] == 0x00) global.set.light = false;
 971   3            else if(buff[7] == 0x01) global.set.light = true;
 972   3      
 973   3            temp = (buff[8]<<8) | buff[9];
 974   3            global.device.nextStartWaterCountDown = temp;
 975   3            //å› ä¸ºåº•æ¿ä¸é¡¶æ¿äº¤äº’æ˜¾ç¤ºå€’è®¡æ—¶çš„æœºåˆ¶ï¼Œæ‰€ä»¥ä¸å†åˆ¤æ–­
 976   3            // if(temp != 0xffff)
 977   3            // {
 978   3            //  global.device.nextStartWaterCountDown = temp;
 979   3            // }
 980   3            temp = (buff[10]<<8) | buff[11];
 981   3            global.device.endWaterCountDown = temp;
 982   3            // if(temp != 0xffff)
 983   3            // {
 984   3            //  global.device.endWaterCountDown = temp;
 985   3            // }
 986   3            temp = (buff[12]<<8) | buff[13];
 987   3            global.device.nextStartLightCountDown = temp;
 988   3            // if(temp != 0xffff)
 989   3            // {
 990   3            //  global.device.nextStartLightCountDown = temp;
 991   3            // }
 992   3            temp = (buff[14]<<8) | buff[15];
 993   3            global.device.endLightCountDown = temp;
 994   3            // if(temp != 0xffff)
 995   3            // {
 996   3            //  global.device.endLightCountDown = temp;
 997   3            // }
 998   3      
 999   3            if(buff[16] != 0xff)
1000   3            {
1001   4              global.set.startLightHour = buff[16];
1002   4            }
1003   3            if(buff[17] != 0xff)
1004   3            {
1005   4              global.set.startLightMinute = buff[17];
1006   4            }
1007   3            if(buff[18] != 0xff)
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 18  

1008   3            {
1009   4              global.set.keepLightHour = buff[18];
1010   4            }
1011   3            if(buff[19] != 0xff)
1012   3            {
1013   4              global.set.keepLightMinute = buff[19];
1014   4            }
1015   3            if(buff[20] != 0xff)
1016   3            {
1017   4              global.set.startWaterHour = buff[20];
1018   4            }
1019   3            if(buff[21] != 0xff)
1020   3            {
1021   4              global.set.startWaterMinute = buff[21];
1022   4            }
1023   3            if(buff[22] != 0xff)
1024   3            {
1025   4              global.set.keepWaterHour = buff[22];
1026   4            }
1027   3            if(buff[23] != 0xff)
1028   3            {
1029   4              global.set.keepWaterMinute = buff[23];
1030   4            }
1031   3            if(buff[24] != 0xff)
1032   3            {
1033   4              global.set.waterCycleDay = buff[24];
1034   4            }
1035   3      
1036   3            global.work.wifiSetDeviceFlag = true;
1037   3          }break;
1038   2        }
1039   1      }
1040          
1041          void uart0_isr(unsigned char dat)
1042          {
1043   1        unsigned char sum = 0,i = 0;
1044   1        
1045   1        //è¶…æ—¶å¤„ç†
1046   1        if(global.uart.recTimeOutCount == 1000)
1047   1        {
1048   2          global.uart.recTimeOutCount = 0;  //å·²è¶…æ—¶ï¼Œå…³æ‰è¶…æ—¶è®¡æ—¶
1049   2          global.uart.nowIndex = 0; //é‡ç½®ä¸‹æ ‡
1050   2        }
1051   1        
1052   1        //åˆ¤æ–­æ¥æ”¶çš„æ•°æ®æ˜¯å¦ç¬¦åˆé€šä¿¡æ ¼å¼
1053   1        if(global.uart.nowIndex == 0 && dat == 0xAA)  //å¤´
1054   1        {
1055   2          global.uart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½“å‰æ•
             -°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1056   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;
1057   2          ++global.uart.nowIndex;
1058   2        }
1059   1        else if(global.uart.nowIndex == 1)  //æ•°æ®é•¿åº¦
1060   1        {
1061   2          if(dat > UARTBUFFDATAMAXSIZE - 14)  //é•¿åº¦å¤§äºç¼“å†²åŒºæœ€å¤§-14ï¼Œåˆ™é€€å‡ºç¨‹åºï¼Œé˜²æ­¢æº¢å‡º
1062   2          {
1063   3            global.uart.nowIndex = 0;
1064   3            return;
1065   3          }
1066   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //é•¿åº¦ï¼šä»å¤´åˆ°æ
             - ¡éªŒ
1067   2          ++global.uart.nowIndex;
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 19  

1068   2        }
1069   1        else if(global.uart.nowIndex >= 2 && global.uart.nowIndex <= global.uart.recvDealBuff[global.uart.recvCmd
             -NowIndex][1]-2) //å‡å»äº†æ ¡éªŒå­—èŠ‚ï¼Œå› ä¸ºä¸‹æ ‡æ¯”å®é™…é•¿åº¦å°1ï¼Œæ‰€ä»¥-2
1070   1        {
1071   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //æ•°æ®
1072   2          ++global.uart.nowIndex;
1073   2        }
1074   1        else if(global.uart.nowIndex == global.uart.recvDealBuff[global.uart.recvCmdNowIndex][1]-1) //è®°å½•æ”¶åˆ
             -°çš„æŒ‡ä»¤ï¼Œä¹‹ååœ¨ä¸»å¾ªç¯ä¸­å¤„ç†ï¼Œå¤„ç†æ—¶å†åšæ ¡éªŒ
1075   1        {
1076   2          global.uart.recTimeOutCount = 0;  //æ¥æ”¶åˆ°ä¸€ä¸ªå¯èƒ½å®Œæ•´çš„æ•°æ®åŒ…ï¼Œå…³æ‰è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ
             -™ä¸è®¡æ—¶
1077   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //æ•°æ®
1078   2      
1079   2          ++global.uart.recvCmdCount; //å¯¹æ¥æ”¶åˆ°çš„æŒ‡ä»¤è¿›è¡Œè®¡æ•°
1080   2          if(global.uart.recvCmdNowIndex == UARTBUFFCMDMAXSIZE - 1) //æ¥æ”¶çš„æŒ‡ä»¤æ•°é‡å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œå›
             - ä¸ºç”¨ä½œæ•°ç»„ä¸‹æ ‡æ‰€ä»¥è¿™é‡Œéœ€è¦å‡1
1081   2          {
1082   3            global.uart.recvCmdNowIndex = 0;  //é‡ç½®æˆ–è€…ä¹Ÿæœ‰å¯èƒ½ä¼šé€ æˆè¦†ç›–
1083   3          }
1084   2          else
1085   2          {
1086   3            ++global.uart.recvCmdNowIndex;
1087   3          }
1088   2      
1089   2          global.uart.nowIndex = 0;
1090   2        }
1091   1      }
1092          
1093          void delay(unsigned int a)
1094          {
1095   1        unsigned int b = 0;
1096   1        for(;a > 0;a--)
1097   1        {
1098   2          for(;b < 100;b++);
1099   2        }
1100   1      }
1101          
1102          void uart0_sendData(unsigned char* buff,unsigned char len)
1103          {
1104   1        while(len--)
1105   1        {
1106   2          //å› ä¸ºä¸‹é¢çš„é˜»å¡ç­‰å¾…ï¼Œæ‰€ä»¥è¯¥å˜é‡ä¸ä¼šå­˜åœ¨åŒæ—¶åœ¨ä¸­æ–­å’Œå‡½æ•°è°ƒç”¨æ—¶åŒæ—¶è¢«ä¿®
             -æ”¹çš„æƒ…å†µ
1107   2          global.uart.sendIsrFlag = false;  //å‘é€å®Œæˆä¼šåœ¨ä¸­æ–­ä¸­è¢«ç½®ä½
1108   2          SBUF = *buff;
1109   2          //è¿™é‡Œå­˜åœ¨å¯èƒ½å¯¼è‡´æ­»æœºçš„é—®é¢˜ï¼Œå½“å‘é€åè¢«æŸä¸­æ–­æ‰“æ–­
1110   2          //åœ¨å›åˆ°è¿™é‡Œä¹‹å‰ï¼Œä¸²å£å·²ç»å‘é€å®Œæˆï¼Œä¸­æ–­ä¸­ TI è¢«æ¸… 0
1111   2          //å¯¼è‡´å›åˆ°è¿™é‡Œä¹‹åï¼Œæ— æ³•è·³å‡ºå¾ªç¯
1112   2            // while(TI==0);
1113   2          //è¿™é‡Œä½¿ç”¨é¢å¤–çš„å˜é‡æ ‡è®°ä¸²å£å‘é€å®Œæˆæ ‡å¿—
1114   2          //å½“ä¸Šè¿°çš„æƒ…å†µå‘ç”Ÿä¹‹åï¼Œè¯¥æ ‡å¿—ä¾ç„¶æ­£å¸¸è¢«ç½®ä½
1115   2          while(global.uart.sendIsrFlag == false);  //æœªè¢«ç½®ä½å°±é˜»å¡ç­‰å¾…
1116   2          delay(20);
1117   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
1118   2        }
1119   1      }
1120          
1121          ///////////////////////////////////////////////RTC//////////////////////////////////////////////////////
1122          
1123          #define RTC_RST_H set_P01
1124          #define RTC_RST_L clr_P01
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 20  

1125          #define RTC_SCL_H set_P13
1126          #define RTC_SCL_L clr_P13
1127          #define RTC_SDA_H set_P14
1128          #define RTC_SDA_L clr_P14
1129          #define RTC_SDA P14
1130          
1131          #define RTCADDR_SEC 0x80
1132          #define RTCADDR_MINUTE 0x82
1133          #define RTCADDR_HOUR 0x84
1134          #define RTCADDR_DAY 0x86
1135          #define RTCADDR_MONTH 0x88
1136          #define RTCADDR_YEAR 0x8c
1137          #define RTCADDR_WP 0x8e //å†™ä¿æŠ¤
1138          #define RTCADDR_CHARGER 0x90  //æ¶“æµå……ç”µ
1139          
1140          #define RTC_WP_OPEN 0x80 //å†™ä¿æŠ¤å¼€
1141          #define RTC_WP_CLOSE  0x00 //å†™ä¿æŠ¤å…³
1142          #define RTC_CHARGER_LEVEL4 0xa9 //
1143          #define RTC_CHARGER_LEVEL6 0xab //åº”è¯¥æ˜¯æœ€æ…¢çš„å……ç”µ
1144          
1145          void rctWriteByte(unsigned char addr,unsigned char dat);
1146          unsigned char rtcReadByte(unsigned char addr);
1147          
1148          void initRtc(void)
1149          {
1150   1        P01_PushPull_Mode;  //NRST
1151   1        P13_PushPull_Mode;  //SCL
1152   1        P14_PushPull_Mode;  //SDA
1153   1      
1154   1        RTC_RST_L;
1155   1        RTC_SCL_H;
1156   1        RTC_SDA_H;
1157   1      }
1158          
1159          void firstInitRtc(void)
1160          {
1161   1        rctWriteByte(RTCADDR_WP,RTC_WP_CLOSE);  //å…³é—­å†™ä¿æŠ¤
1162   1        rctWriteByte(RTCADDR_SEC,0x00); //å¼€å¯è®¡æ—¶,ç§’æ¸…é›¶
1163   1        rctWriteByte(RTCADDR_HOUR,0x00);  //æ¸…é›¶å°æ—¶
1164   1        rctWriteByte(RTCADDR_MINUTE,0x00);  //æ¸…é›¶åˆ†é’Ÿ
1165   1        rctWriteByte(RTCADDR_CHARGER,RTC_CHARGER_LEVEL4);
1166   1        // rctWriteByte(RTCADDR_CHARGER,RTC_CHARGER_LEVEL6);  //è®¾ç½®æ¶“æµå……ç”µ
1167   1        rctWriteByte(RTCADDR_WP,RTC_WP_OPEN); //å¼€å¯å†™ä¿æŠ¤
1168   1      }
1169          
1170          void rctWriteByte(unsigned char addr,unsigned char dat)
1171          {
1172   1        unsigned char count;
1173   1      
1174   1        P14_PushPull_Mode;
1175   1      
1176   1        RTC_SCL_L;
1177   1        RTC_RST_H;
1178   1      
1179   1        addr &= 0xfe;
1180   1      
1181   1        for(count = 0;count < 8;count++)
1182   1        {
1183   2          RTC_SCL_L;
1184   2          if(addr & 0x01)
1185   2          {
1186   3            RTC_SDA_H;
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 21  

1187   3          }
1188   2          else
1189   2          {
1190   3            RTC_SDA_L;
1191   3          }
1192   2          addr >>= 1;
1193   2          RTC_SCL_H;
1194   2        }
1195   1      
1196   1        for(count = 0;count < 8;count++)
1197   1        {
1198   2          RTC_SCL_L;
1199   2          if(dat & 0x01)
1200   2          {
1201   3            RTC_SDA_H;
1202   3          }
1203   2          else
1204   2          {
1205   3            RTC_SDA_L;
1206   3          }
1207   2          dat >>= 1;
1208   2          RTC_SCL_H;
1209   2        }
1210   1      
1211   1        RTC_RST_L;
1212   1      }
1213          
1214          unsigned char rtcReadByte(unsigned char addr)
1215          {
1216   1        unsigned char count,dat = 0;
1217   1      
1218   1        P14_PushPull_Mode;
1219   1      
1220   1        RTC_SCL_L;
1221   1        RTC_RST_H;
1222   1      
1223   1        addr |= 0x01;
1224   1      
1225   1        for(count = 0;count < 8;count++)
1226   1        {
1227   2          RTC_SCL_L;
1228   2          if(addr & 0x01)
1229   2          {
1230   3            RTC_SDA_H;
1231   3          }
1232   2          else
1233   2          {
1234   3            RTC_SDA_L;
1235   3          }
1236   2          addr >>= 1;
1237   2          RTC_SCL_H;
1238   2        }
1239   1      
1240   1        P14_Input_Mode;
1241   1      
1242   1        for(count = 0;count < 8;count++)
1243   1        {
1244   2          RTC_SCL_H;
1245   2          if(RTC_SDA)
1246   2          {
1247   3            dat |= 0x80;
1248   3          }
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 22  

1249   2          RTC_SCL_L;  
1250   2          dat >>= 1;
1251   2        }
1252   1        RTC_RST_L;
1253   1      
1254   1        return dat;
1255   1      }
1256          
1257          void rtcGetTime(void)
1258          {
1259   1        unsigned char temp = 0;
1260   1        temp = rtcReadByte(RTCADDR_YEAR);
1261   1        global.time.year = ((temp>>4)*10) + (temp&0x0f);
1262   1        temp = rtcReadByte(RTCADDR_MONTH);
1263   1        global.time.month = ((temp>>4)*10) + (temp&0x0f);
1264   1        temp = rtcReadByte(RTCADDR_DAY);
1265   1        global.time.day = ((temp>>4)*10) + (temp&0x0f);
1266   1        temp = rtcReadByte(RTCADDR_HOUR);
1267   1        global.time.hour = ((temp>>4)*10) + (temp&0x0f);
1268   1        temp = rtcReadByte(RTCADDR_MINUTE);
1269   1        global.time.minute = ((temp>>4)*10) + (temp&0x0f);
1270   1        temp = rtcReadByte(RTCADDR_SEC);
1271   1        global.time.sec = ((temp>>4)*10) + (temp&0x0f);
1272   1      }
1273          
1274          void rtcSetTime(void)
1275          {
1276   1        unsigned char temp = 0;
1277   1        
1278   1        //å½“å¹´æœˆæ—¥æ—¶åˆ†éƒ½ç›¸åŒä¸”ç§’ç›¸å·®å°äº5ç§’åˆ™é€€å‡ºä¸è®¾ç½®ï¼Œå¦åˆ™è®¾ç½®
1279   1        if(global.set.year == global.time.year && global.set.month == global.time.month && global.set.day == glob
             -al.time.day &&
1280   1          global.set.hour == global.time.hour && global.set.minute == global.time.minute)
1281   1        {
1282   2          if(global.set.sec == global.time.sec)
1283   2            return;
1284   2          else if(global.set.sec > global.time.sec)
1285   2            temp = global.set.sec - global.time.sec;
1286   2          else if(global.set.sec < global.time.sec)
1287   2            temp = global.time.sec - global.set.sec;
1288   2          if(temp < 5) return;
1289   2        }
1290   1      
1291   1        rctWriteByte(RTCADDR_WP,RTC_WP_CLOSE);  //å…³é—­å†™ä¿æŠ¤
1292   1        temp = ((global.set.year/10)<<4) | (global.set.year%10);
1293   1        rctWriteByte(RTCADDR_YEAR,temp);
1294   1        temp = ((global.set.month/10)<<4) | (global.set.month%10);
1295   1        rctWriteByte(RTCADDR_MONTH,temp);
1296   1        temp = ((global.set.day/10)<<4) | (global.set.day%10);
1297   1        rctWriteByte(RTCADDR_DAY,temp);
1298   1        temp = ((global.set.hour/10)<<4) | (global.set.hour%10);
1299   1        rctWriteByte(RTCADDR_HOUR,temp);
1300   1        temp = ((global.set.minute/10)<<4) | (global.set.minute%10);
1301   1        rctWriteByte(RTCADDR_MINUTE,temp);
1302   1        temp = ((global.set.sec/10)<<4) | (global.set.sec%10);
1303   1        rctWriteByte(RTCADDR_SEC,0);
1304   1        rctWriteByte(RTCADDR_WP,RTC_WP_OPEN); //å¼€å¯å†™ä¿æŠ¤
1305   1        rtcGetTime();
1306   1      }
1307          
1308          ///////////////////////////////////////////////IAP Flash//////////////////////////////////////////////////
             -////
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 23  

1309          
1310          #define PAGE_ERASE_AP 0x22
1311          #define BYTE_PROGRAM_AP 0x21
1312          
1313          #define FLASHADDRHEARD 0x4550 //å­˜å‚¨é¦–åœ°å€
1314          
1315          //å­˜å‚¨åŒº--é¦–åœ°å€ç”¨äºå­˜å‚¨é¦–æ¬¡å¼€æœºæ ‡å¿—
1316          // volatile unsigned char code Data_Flash[128] _at_ 0x4550;
1317          
1318          unsigned char flash_readByte(unsigned int code* addr)
1319          {
1320   1        return (unsigned char)((*addr)>>8);
1321   1      }
1322          
1323          void iapEnable(void)
1324          {
1325   1        clr_EA;
1326   1        //ä½¿èƒ½IAP
1327   1        TA = 0xAA; //CHPCON is TA protected
1328   1        TA = 0x55;
1329   1        CHPCON |= 0x01; //IAPEN = 1, enable IAP mode
1330   1        TA = 0xAA; //IAPUEN is TA protected
1331   1        TA = 0x55;
1332   1        IAPUEN |= 0x01; //APUEN = 1, enable APROM update
1333   1        set_EA;
1334   1      }
1335          
1336          void iapErasePage(unsigned int addr)
1337          {
1338   1        //å†™å­—èŠ‚
1339   1        IAPCN = PAGE_ERASE_AP; // Program 201h with 55h
1340   1        IAPAH = HIBYTE(addr);
1341   1        IAPAL = LOBYTE(addr);
1342   1        IAPFD = 0xff;
1343   1      }
1344          
1345          void iapWriteByte(unsigned int addr,unsigned char dat)
1346          {
1347   1        //å†™å­—èŠ‚
1348   1        IAPCN = BYTE_PROGRAM_AP; // Program 201h with 55h
1349   1        IAPAH = HIBYTE(addr);
1350   1        IAPAL = LOBYTE(addr);
1351   1        IAPFD = dat;
1352   1      }
1353          
1354          void iapTrigger(void)
1355          {
1356   1        clr_EA;
1357   1        //æ‰§è¡ŒIAP
1358   1        TA = 0xAA;
1359   1        TA = 0x55;
1360   1        IAPTRG |= 0x01; //write â€˜1â€™ to IAPGO to trigger IAP process
1361   1        set_EA;
1362   1      }
1363          
1364          void iapUnenable(void)
1365          {
1366   1        clr_EA;
1367   1        //å¤±èƒ½IAP
1368   1        TA = 0xAA; //IAPUEN is TA protected
1369   1        TA = 0x55;
1370   1        IAPUEN &= ~0x01; //APUEN = 0, disable APROM update
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 24  

1371   1        TA = 0xAA; //CHPCON is TA protected
1372   1        TA = 0x55;
1373   1        CHPCON &= ~0x01; //IAPEN = 0, disable IAP mode
1374   1        set_EA;
1375   1      }
1376          
1377          unsigned char isFristStart(void)
1378          {
1379   1        if(flash_readByte(FLASHADDRHEARD) == 0xff)
1380   1        {
1381   2          iapEnable();
1382   2          iapWriteByte(FLASHADDRHEARD,0x96);  //å†™å·²å¼€æœºæ ‡å¿—
1383   2          iapTrigger();
1384   2          iapUnenable();
1385   2          return true;
1386   2        }
1387   1        else if(flash_readByte(FLASHADDRHEARD) == 0x96)
1388   1        {
1389   2          return false;
1390   2        }
1391   1        return false;
1392   1      }
1393          
1394          void resetFlash(void)
1395          {
1396   1        iapEnable();
1397   1        iapErasePage(FLASHADDRHEARD);
1398   1        iapTrigger();
1399   1        iapUnenable();
1400   1      }
1401          
1402          void saveDataToFlash(void)
1403          {
1404   1        //å…ˆè¯»å‡ºæ•°æ®
1405   1        
1406   1        //å†æ“¦é™¤
1407   1        resetFlash();
1408   1        iapEnable();
1409   1        //å†™é¦–æ¬¡å¼€æœºæ ‡å¿—
1410   1        iapWriteByte(FLASHADDRHEARD,0x96);  //éƒ½èƒ½å­˜é¢„çº¦æ•°æ®äº†ï¼Œé‚£è‚¯å®šå¼€æœºäº†ï¼Œé‚£å°±è¦é‡æ–°å†™æ 
             -‡å¿—
1411   1        iapTrigger();
1412   1        //å­˜é¢„çº¦æ•°æ®
1413   1        iapWriteByte(FLASHADDRHEARD+1,global.set.startLightHour);
1414   1        iapTrigger();
1415   1        iapWriteByte(FLASHADDRHEARD+2,global.set.startLightMinute);
1416   1        iapTrigger();
1417   1        iapWriteByte(FLASHADDRHEARD+3,global.set.keepLightHour);
1418   1        iapTrigger();
1419   1        iapWriteByte(FLASHADDRHEARD+4,global.set.keepLightMinute);
1420   1        iapTrigger();
1421   1        iapWriteByte(FLASHADDRHEARD+5,global.set.endLightHour);
1422   1        iapTrigger();
1423   1        iapWriteByte(FLASHADDRHEARD+6,global.set.endLightMinute);
1424   1        iapTrigger();
1425   1        iapWriteByte(FLASHADDRHEARD+7,global.set.startWaterHour);
1426   1        iapTrigger();
1427   1        iapWriteByte(FLASHADDRHEARD+8,global.set.startWaterMinute);
1428   1        iapTrigger();
1429   1        iapWriteByte(FLASHADDRHEARD+9,global.set.keepWaterHour);
1430   1        iapTrigger();
1431   1        iapWriteByte(FLASHADDRHEARD+10,global.set.keepWaterMinute);
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 25  

1432   1        iapTrigger();
1433   1        iapWriteByte(FLASHADDRHEARD+11,global.set.endWaterHour);
1434   1        iapTrigger();
1435   1        iapWriteByte(FLASHADDRHEARD+12,global.set.endWaterMinute);
1436   1        iapTrigger();
1437   1        iapWriteByte(FLASHADDRHEARD+13,global.set.waterCycleDay);
1438   1        iapTrigger();
1439   1        iapWriteByte(FLASHADDRHEARD+14,global.device.nextWaterDayCountDown);
1440   1        iapTrigger();
1441   1        iapUnenable();
1442   1      }
1443          
1444          void readDataFromFlash(void)
1445          {
1446   1        global.set.startLightHour = flash_readByte(FLASHADDRHEARD+1);
1447   1        global.set.startLightMinute = flash_readByte(FLASHADDRHEARD+2);
1448   1        global.set.keepLightHour = flash_readByte(FLASHADDRHEARD+3);
1449   1        global.set.keepLightMinute = flash_readByte(FLASHADDRHEARD+4);
1450   1        global.set.endLightHour = flash_readByte(FLASHADDRHEARD+5);
1451   1        global.set.endLightMinute = flash_readByte(FLASHADDRHEARD+6);
1452   1        global.set.startWaterHour = flash_readByte(FLASHADDRHEARD+7);
1453   1        global.set.startWaterMinute = flash_readByte(FLASHADDRHEARD+8);
1454   1        global.set.keepWaterHour = flash_readByte(FLASHADDRHEARD+9);
1455   1        global.set.keepWaterMinute = flash_readByte(FLASHADDRHEARD+10);
1456   1        global.set.endWaterHour = flash_readByte(FLASHADDRHEARD+11);
1457   1        global.set.endWaterMinute = flash_readByte(FLASHADDRHEARD+12);
1458   1        global.set.waterCycleDay = flash_readByte(FLASHADDRHEARD+13);
1459   1        global.device.nextWaterDayCountDown = flash_readByte(FLASHADDRHEARD+14);
1460   1      }
1461          
1462          
1463          
1464          //
1465          //è®¡ç®—å€’è®¡æ—¶ï¼Œç„¶åæ‰§è¡Œè®¡æ—¶ç»“æŸçš„ä¸€äº›æ“ä½œï¼Œæ”¾åœ¨ runMain ä¸­ï¼Œæ¯åˆ†é’Ÿè¿›å…¥ä¸€æ¬¡
1466          //
1467          void figureCountdown(void)
1468          {
1469   1        //////////////////////////////////////ç…§æ˜/////////////////////////////////////
1470   1        //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹ç…§æ˜å€’è®¡æ—¶çš„è®¡ç®—
1471   1        if(global.set.startLightHour > global.time.hour)  //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶è¿˜æœªåˆ°
1472   1        {
1473   2          if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1474   2          {
1475   3            global.device.nextStartLightCountDown = (global.set.startLightHour - global.time.hour)*60 + (global.set
             -.startLightMinute - global.time.minute);
1476   3          }
1477   2          else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1478   2          {
1479   3            global.device.nextStartLightCountDown = (global.set.startLightHour - global.time.hour)*60 - (global.tim
             -e.minute - global.set.startLightMinute);
1480   3          }
1481   2        }
1482   1        else if(global.set.startLightHour == global.time.hour)
1483   1        {
1484   2          if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1485   2          {
1486   3            global.device.nextStartLightCountDown = global.set.startLightMinute - global.time.minute;
1487   3          }
1488   2          else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1489   2          {
1490   3            global.device.nextStartLightCountDown = 24*60 - (global.time.minute - global.set.startLightMinute);
1491   3          }
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 26  

1492   2        }
1493   1        else if(global.set.startLightHour < global.time.hour) //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶å·²è¶…è¿‡
1494   1        {
1495   2          if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1496   2          {
1497   3            global.device.nextStartLightCountDown = (24 - global.time.hour + global.set.startLightHour)*60 + (globa
             -l.set.startLightMinute - global.time.minute);
1498   3          }
1499   2          else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1500   2          {
1501   3            global.device.nextStartLightCountDown = (24 - global.time.hour + global.set.startLightHour)*60 - (globa
             -l.time.minute - global.set.startLightMinute);
1502   3          }
1503   2        }
1504   1        //è·ç¦»ç»“æŸç…§æ˜å€’è®¡æ—¶çš„è®¡ç®—
1505   1        if(global.set.endLightHour > global.time.hour)  //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1506   1        {
1507   2          if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1508   2          {
1509   3            global.device.endLightCountDown = (global.set.endLightHour - global.time.hour)*60 + (global.set.endLigh
             -tMinute - global.time.minute);
1510   3          }
1511   2          else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1512   2          {
1513   3            global.device.endLightCountDown = (global.set.endLightHour - global.time.hour)*60 - (global.time.minute
             - - global.set.endLightMinute);
1514   3          }
1515   2        }
1516   1        else if(global.set.endLightHour == global.time.hour)
1517   1        {
1518   2          if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1519   2          {
1520   3            global.device.endLightCountDown = global.set.endLightMinute - global.time.minute;
1521   3          }
1522   2          else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1523   2          {
1524   3            global.device.endLightCountDown = 24*60 - (global.time.minute - global.set.endLightMinute);
1525   3          }
1526   2        }
1527   1        else if(global.set.endLightHour < global.time.hour) //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶å·²è¶…è¿‡
1528   1        {
1529   2          if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1530   2          {
1531   3            global.device.endLightCountDown = (24 - global.time.hour + global.set.endLightHour)*60 + (global.set.en
             -dLightMinute - global.time.minute);
1532   3          }
1533   2          else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1534   2          {
1535   3            global.device.endLightCountDown = (24 - global.time.hour + global.set.endLightHour)*60 - (global.time.m
             -inute - global.set.endLightMinute);
1536   3          }
1537   2        }
1538   1      
1539   1        //////////////////////////////////////æµ‡æ°´/////////////////////////////////////
1540   1      
1541   1        if(global.time.hour == 0 && global.time.minute == 0)  //é›¶ç‚¹ï¼Œåšæµ‡æ°´å‘¨æœŸè®¡ç®—
1542   1        {
1543   2          //æ¯å¤©é›¶ç‚¹å‡ä¸€å¤©ï¼Œå‡åˆ°1åˆ™å½“å¤©æµ‡æ°´ï¼Œæµ‡æ°´ç»“æŸåé‡ç½®ã€‚
1544   2          if(global.device.nextWaterDayCountDown > 1) --global.device.nextWaterDayCountDown;
1545   2      
1546   2          if(global.device.nextWaterDayCountDown == 0)  //å¦‚æœä¸º0ï¼Œåˆ™é‡ç½®
1547   2          {
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 27  

1548   3            global.device.nextWaterDayCountDown = global.set.waterCycleDay;
1549   3          }
1550   2          saveDataToFlash();
1551   2        }
1552   1      
1553   1        //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹æµ‡æ°´å€’è®¡æ—¶çš„è®¡ç®—
1554   1        if(global.set.startWaterHour > global.time.hour)  //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1555   1        {
1556   2          if(global.set.startWaterMinute > global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1557   2          {
1558   3            global.device.nextStartWaterCountDown = (global.set.startWaterHour - global.time.hour)*60 + (global.set
             -.startWaterMinute - global.time.minute);
1559   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60; //å†åŠ ä¸Šå‘¨æ
             -œŸå¤©æ•°çš„åç§»
1560   3          }
1561   2          else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1562   2          {
1563   3            global.device.nextStartWaterCountDown = (global.set.startWaterHour - global.time.hour)*60 - (global.tim
             -e.minute - global.set.startWaterMinute);
1564   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1565   3          }
1566   2        }
1567   1        else if(global.set.startWaterHour == global.time.hour)
1568   1        {
1569   2          if(global.set.startWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1570   2          {
1571   3            global.device.nextStartWaterCountDown = global.set.startWaterMinute - global.time.minute;
1572   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60; //å†åŠ ä¸Šå‘¨æ
             -œŸå¤©æ•°çš„åç§»
1573   3          }
1574   2          else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1575   2          {
1576   3            global.device.nextStartWaterCountDown = 24*60 - (global.time.minute - global.set.startWaterMinute);
1577   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1578   3          }
1579   2        }
1580   1        else if(global.set.startWaterHour < global.time.hour) //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶å·²è¶…è¿‡
1581   1        {
1582   2          if(global.set.startWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1583   2          {
1584   3            global.device.nextStartWaterCountDown = (24 - global.time.hour + global.set.startWaterHour)*60 + (globa
             -l.set.startWaterMinute - global.time.minute);
1585   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1586   3          }
1587   2          else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1588   2          {
1589   3            global.device.nextStartWaterCountDown = (24 - global.time.hour + global.set.startWaterHour)*60 - (globa
             -l.time.minute - global.set.startWaterMinute);
1590   3            global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1591   3          }
1592   2        }
1593   1        //è·ç¦»ç»“æŸæµ‡æ°´å€’è®¡æ—¶çš„è®¡ç®—
1594   1        if(global.set.endWaterHour > global.time.hour)  //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1595   1        {
1596   2          if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1597   2          {
1598   3            global.device.endWaterCountDown = (global.set.endWaterHour - global.time.hour)*60 + (global.set.endWate
             -rMinute - global.time.minute);
1599   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1600   3          }
1601   2          else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1602   2          {
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 28  

1603   3            global.device.endWaterCountDown = (global.set.endWaterHour - global.time.hour)*60 - (global.time.minute
             - - global.set.endWaterMinute);
1604   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1605   3          }
1606   2        }
1607   1        else if(global.set.endWaterHour == global.time.hour)
1608   1        {
1609   2          if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1610   2          {
1611   3            global.device.endWaterCountDown = global.set.endWaterMinute - global.time.minute;
1612   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1613   3          }
1614   2          else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1615   2          {
1616   3            global.device.endWaterCountDown = 24*60 - (global.time.minute - global.set.endWaterMinute);
1617   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1618   3          }
1619   2        }
1620   1        else if(global.set.endWaterHour < global.time.hour) //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶å·²è¶…è¿‡
1621   1        {
1622   2          if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ°
1623   2          {
1624   3            global.device.endWaterCountDown = (24 - global.time.hour + global.set.endWaterHour)*60 + (global.set.en
             -dWaterMinute - global.time.minute);
1625   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1626   3          }
1627   2          else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1628   2          {
1629   3            global.device.endWaterCountDown = (24 - global.time.hour + global.set.endWaterHour)*60 - (global.time.m
             -inute - global.set.endWaterMinute);
1630   3            global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1631   3          }
1632   2        }
1633   1      
1634   1        /////////////////////////////////////////////////////////////æ ¹æ®å€’è®¡æ—¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå¯¹åº”æ“ä½
             -œ//////////////////////////////////////////////////////////////
1635   1        if(global.device.nextStartWaterCountDown == 0)  //ç»“æŸç…§æ˜,è¿™é‡Œçš„ä¸ç®¡åœ¨çº¿ç¦»çº¿ï¼Œåªæ˜¯ä¸ºäº†é
             -‡ç½®æµ‡æ°´å‘¨æœŸçš„è®¡æ—¶
1636   1        {
1637   2          global.device.nextWaterDayCountDown = global.set.waterCycleDay;
1638   2        }
1639   1        /////////////å‰ææ˜¯å¤„äºç¦»çº¿çŠ¶æ€ï¼Œåœ¨çº¿çŠ¶æ€çš„æ§åˆ¶æœ‰wifiæ¨¡å—è´Ÿè´£///////////////
1640   1        if(global.device.wifi == offline)
1641   1        {
1642   2          if(global.device.nextStartLightCountDown == 0)  //è®¡æ—¶åˆ°0ï¼Œè¯´æ˜å¯ä»¥å¼€å§‹ç…§æ˜äº†
1643   2          {
1644   3            global.device.light = true;
1645   3            LIGHT_OPEN;
1646   3          }
1647   2          if(global.device.endLightCountDown == 0)  //ç»“æŸç…§æ˜
1648   2          {
1649   3            global.device.light = false;
1650   3            LIGHT_CLOSE;
1651   3          }
1652   2          if(global.device.nextStartWaterCountDown == 0)  //è®¡æ—¶åˆ°0ï¼Œè¯´æ˜å¯ä»¥å¼€å§‹æµ‡æ°´äº†
1653   2          {
1654   3            global.device.water = true;
1655   3            WATER_OPEN;
1656   3          }
1657   2          if(global.device.endWaterCountDown == 0)  //ç»“æŸç…§æ˜
1658   2          {
1659   3            global.device.water = false;
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 29  

1660   3            WATER_CLOSE;
1661   3          }
1662   2        }
1663   1      }
1664          
1665          //é€šè¿‡å¼€å§‹å’ŒæŒç»­æ—¶é—´ï¼Œè®¡ç®—ç»“æŸæ—¶é—´
1666          void figureEndTime(void)
1667          {
1668   1        //////é¦–å…ˆè®¡ç®—åˆ†é’Ÿ//////////
1669   1        if(global.set.startLightMinute + global.set.keepLightMinute >= 60)  //ä¸åœ¨åŒä¸€å°æ—¶äº†ï¼Œéœ€è¦è®©å°
             -æ—¶åŠ ä¸€
1670   1        {
1671   2          global.set.endLightMinute = global.set.startLightMinute + global.set.keepLightMinute - 60;
1672   2          if((global.set.startLightHour + global.set.keepLightHour + 1) >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1673   2          {
1674   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour + 1 - 24;
1675   3          }
1676   2          else  //åœ¨åŒä¸€å¤©
1677   2          {
1678   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour + 1;
1679   3          }
1680   2          
1681   2        }
1682   1        else  //åœ¨åŒä¸€å°æ—¶
1683   1        {
1684   2          global.set.endLightMinute = global.set.startLightMinute + global.set.keepLightMinute;
1685   2          if(global.set.startLightHour + global.set.keepLightHour >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1686   2          {
1687   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour - 24;
1688   3          }
1689   2          else  //åœ¨åŒä¸€å¤©
1690   2          {
1691   3            global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour;
1692   3          }
1693   2        }
1694   1      
1695   1        
1696   1        if(global.set.startWaterMinute + global.set.keepWaterMinute >= 60)  //ä¸åœ¨åŒä¸€å°æ—¶äº†ï¼Œéœ€è¦è®©å°
             -æ—¶åŠ ä¸€
1697   1        {
1698   2          global.set.endWaterMinute = global.set.startWaterMinute + global.set.keepWaterMinute - 60;
1699   2          if((global.set.startWaterHour + global.set.keepWaterHour + 1) >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1700   2          {
1701   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour + 1 - 24;
1702   3          }
1703   2          else  //åœ¨åŒä¸€å¤©
1704   2          {
1705   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour + 1;
1706   3          }
1707   2          
1708   2        }
1709   1        else  //åœ¨åŒä¸€å°æ—¶
1710   1        {
1711   2          global.set.endWaterMinute = global.set.startWaterMinute + global.set.keepWaterMinute;
1712   2          if(global.set.startWaterHour + global.set.keepWaterHour >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1713   2          {
1714   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour - 24;
1715   3          }
1716   2          else  //åœ¨åŒä¸€å¤©
1717   2          {
1718   3            global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour;
1719   3          }
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 30  

1720   2        }
1721   1      }
1722          
1723          
1724          ///////////////////////////////////////////////////////////////////////////////////è¢«åºŸå¼ƒçš„æ–¹æ³•/////
             -///////////////////////////////////////////////////////////
1725          
1726          ///////////////////////////////////////////////ä¸²å£9åŠŸèƒ½//////////////////////////////////////////////
             -////////
1727          
1728          // void uart9_fun(unsigned char* buff)
1729          // {
1730          //  switch(buff[3]) //ä¸‹æ ‡2å’Œ3ä¸ºæ¶ˆæ¯ç±»å‹ï¼Œä½†ç›®å‰2ä¸º0x00æ‰€ä»¥åˆ¤æ–­3å³å¯
1731          //  {
1732          //    case 0x01:  //è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚  //é¡¶æ¿ç´¢è¦è®¾å¤‡çŠ¶æ€æ•°æ®ï¼Œå¹¶ç»™å‡ºå½“å‰æ¸©åº¦
1733          //    {
1734          //      global.device.temperature = buff[4]<<8 | buff[5]; //æ‹¿åˆ°æ¸©åº¦
1735          //      global.device.getStateFlag = true;  //æ ‡è®°è·å–çŠ¶æ€æ ‡å¿—ï¼Œå°†è¦å‘é€è®¾å¤‡çŠ¶æ€ç»™é¡¶æ¿
1736          //    }break;
1737          //    case 0x03:  //è®¾ç½®å‚æ•°è·å–è¯·æ±‚
1738          //    {
1739          //      global.set.getDataFlag = true;
1740          //    }break;
1741          //    case 0x05:  //è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚ï¼ŒæŒ‰ä¸‹ç…§æ˜æˆ–æµ‡æ°´æˆ–è¿wifi
1742          //    {
1743          //      global.work.keyDo = buff[4];
1744          //      global.work.serventSetDevieSateFlag = true; //åˆ¤æ–­é”®å€¼ï¼Œå¹¶ä¸”å‘é€ç»™æ¨¡å—å†³æ–­
1745          //    }break;
1746          //    case 0x06:  //è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
1747          //    {
1748          //      global.set.hour = buff[4];
1749          //      global.set.minute = buff[5];
1750          //      global.set.startLightHour = buff[6];
1751          //      global.set.startLightMinute = buff[7];
1752          //      global.set.keepLightHour = buff[8];
1753          //      global.set.keepLightMinute = buff[9];
1754          //      global.set.startWaterHour = buff[10];
1755          //      global.set.startWaterMinute = buff[11];
1756          //      global.set.keepWaterHour = buff[12];
1757          //      global.set.keepWaterMinute = buff[13];
1758          //      global.set.waterCycleDay = buff[14];
1759          
1760          //      global.set.setDatFlag = true;
1761          //    }break;
1762          //  }
1763          // }
1764          
1765          // ////å‘é€ä¸€ä¸ªå­—èŠ‚
1766          // void uart9SendByte(unsigned char dat)
1767          // {
1768          //  // while(runData.iouart.recEnable); //å½“æ¥æ”¶ä½¿èƒ½æ—¶ï¼Œä¸å‘é€æ•°æ®ï¼Œç­‰å¾…æ¥æ”¶å®Œæ¯•å†å‘é
             -€  //æµ‹è¯•åå‘ç°å¹¶æ²¡æœ‰è½¯ç”¨
1769          //  global.iouart.sendData = dat;
1770          //  global.iouart.sendCount = 0;
1771          //  global.iouart.sendComplete = false;
1772          //  global.iouart.sendEnable = true;
1773          //  while(!global.iouart.sendComplete); //ç­‰å¾…æ•°æ®å‘é€å®Œæˆ
1774          // }
1775          
1776          // ////å‘é€ä¸€ä¸²å­—èŠ‚
1777          // void uart9Send(unsigned char* buff,unsigned char len)
1778          // {
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 31  

1779          //  while(len)
1780          //  {
1781          //    uart9SendByte(*buff);
1782          //    --len; 
1783          //    if(len != 0) ++buff;
1784          //  }
1785          // }
1786          
1787          // #define UART9_RD P03
1788          // #define UART9_TD_H set_P04
1789          // #define UART9_TD_L clr_P04
1790          
1791          // void initUart9(void)
1792          // {
1793          //  P04_Quasi_Mode; //åœ¨ç”µè·¯ä¸­çš„æ ‡å·ä¸ºRx,ä½†æ˜¯ç”µè·¯ä¸æ”¹çš„è¯éœ€è¦è½¯ä»¶è®¾ç½®ä¸ºTx
1794          //  P03_Quasi_Mode; //åœ¨ç”µè·¯ä¸­çš„æ ‡å·ä¸ºTx,ä½†æ˜¯ç”µè·¯ä¸æ”¹çš„è¯éœ€è¦è½¯ä»¶è®¾ç½®ä¸ºRx
1795          
1796          //  TMOD |= 0x02; //æ¨¡å¼2,8ä½è‡ªåŠ¨é‡è£…è½½
1797          //  clr_T0M;  //12åˆ†é¢‘
1798          //  TH0 = 256 - 139;  //9600
1799          //  set_ET0;  //ä½¿èƒ½å®šæ—¶å™¨0ä¸­æ–­
1800          //  set_EA; //ä½¿èƒ½æ€»ä¸­æ–­
1801          //  set_TR0;  //å¼€å¯å®šæ—¶å™¨0
1802          // }
1803          
1804          // //1èµ·å§‹ä½--8æ•°æ®ä½--1åœæ­¢ä½
1805          // void uart9_isr(void)
1806          // {
1807          //  unsigned char i,sum = 0;
1808          
1809          //  ////////æ¥æ”¶éƒ¨åˆ†////////
1810          //  if(global.iouart.recEnable == false)
1811          //  {
1812          //    if(!UART9_RD) //RDè„šè¢«æ‹‰ä½--å³æ¥æ”¶åˆ°èµ·å§‹ä½--èµ·å§‹ä½ä¸º0
1813          //    {
1814          //      global.iouart.recEnable = true;
1815          //      global.iouart.recCount = 0;
1816          //      global.iouart.recData = 0x00;
1817          //    }
1818          //  }
1819          //  else
1820          //  {
1821          //    //æ¥æ”¶æ•°æ®
1822          //    if(global.iouart.recCount <= 7)
1823          //    {
1824          //      global.iouart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½
             -“å‰æ•°æ®ä½ï¼Œæ”¶åˆ°æ•°æ®ä½åˆ™åˆ·æ–°
1825          //      ++global.iouart.recCount;
1826          //      global.iouart.recData >>= 1;
1827          //      if(UART9_RD)
1828          //      {
1829          //        global.iouart.recData |= 0x80;  //ä½ä½åœ¨å…ˆ
1830          //      }
1831          //    }
1832          //    else if(global.iouart.recCount == 8)
1833          //    {
1834          //      if(UART9_RD)  //RDè„šè¢«æ‹‰é«˜--å³æ¥æ”¶åˆ°åœæ­¢ä½--åœæ­¢ä½ä¸º1
1835          //      {
1836          //        global.iouart.recComplete = true;
1837          //      }
1838          //      global.iouart.recTimeOutCount = 0;  //å…³é—­è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ™ä¸è®¡æ—¶
1839          //      global.iouart.recEnable = false;
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 32  

1840          //    }
1841          //  }
1842          
1843          //  ////æ•°æ®å¤„ç†
1844          //  if(global.iouart.recComplete == true)
1845          //  {
1846          //    global.iouart.recComplete = false;
1847              
1848          //    //åˆ¤æ–­æ¥æ”¶çš„æ•°æ®æ˜¯å¦ç¬¦åˆé€šä¿¡æ ¼å¼
1849          //    if(global.iouart.nowIndex == 0 && global.iouart.recData == 0x96)  //å¤´
1850          //    {
1851          //      global.iouart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½
             -“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1852          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;
1853          //      ++global.iouart.nowIndex;
1854          //    }
1855          //    else if(global.iouart.nowIndex == 1)  //æ•°æ®é•¿åº¦
1856          //    {
1857          //      global.iouart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ
             -™æ”¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1858          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //é•¿åº¦ï¼šä»å¤´åˆ°æ ¡éªŒ
1859          //      ++global.iouart.nowIndex;
1860          //    }
1861          //    else if(global.iouart.nowIndex >= 2 && global.iouart.nowIndex <= global.iouart.recBuff[1]-2)  //å‡å»
             -äº†æ ¡éªŒå­—èŠ‚ï¼Œå› ä¸ºä¸‹æ ‡æ¯”å®é™…é•¿åº¦å°1ï¼Œæ‰€ä»¥-2
1862          //    {
1863          //      global.iouart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ
             -™æ”¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1864          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //æ•°æ®
1865          //      ++global.iouart.nowIndex;
1866          //    }
1867          //    else if(global.iouart.nowIndex == global.iouart.recBuff[1]-1) //æ ¡éªŒ
1868          //    {
1869          //      //ä¹‹åæ›´æ”¹æ¨¡å¼ï¼Œå°†è€—æ—¶æ“ä½œéƒ½ç§»èµ°
1870          
1871          //      global.iouart.recTimeOutCount = 0;  //å…³é—­è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ™ä¸è®¡æ—¶
1872          //      for(i = 0;i <= global.iouart.recBuff[1] - 2;i++)  //è®¡ç®—æ ¡éªŒå’Œ
1873          //      {
1874          //        sum += global.iouart.recBuff[i];
1875          //      }
1876          //      if(sum == global.iouart.recData)  //æ ¡éªŒé€šè¿‡
1877          //      {
1878          //        global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //æ ¡éªŒ
1879          //        uart9_fun(global.iouart.recBuff); //åŠŸèƒ½åˆ¤æ–­
1880          //      }
1881          //      global.iouart.nowIndex = 0;
1882          //    }
1883          //  }
1884          
1885          //  ////////å‘é€éƒ¨åˆ†////////
1886          //  if(global.iouart.sendEnable)
1887          //  {
1888          //    if (global.iouart.sendCount == 0)
1889          //    {
1890          //      UART9_TD_L; //äº§ç”Ÿä¸€ä¸ªèµ·å§‹ä½--0
1891          //      ++global.iouart.sendCount;
1892          //    }
1893          //    else if(global.iouart.sendCount >= 1 && global.iouart.sendCount <= 8)
1894          //    {
1895          //      if( (global.iouart.sendData >> (global.iouart.sendCount-1)) & 0x01) //å…ˆå‘ä½ä½
1896          //      {
1897          //        UART9_TD_H;
C51 COMPILER V9.60.0.0   FUNC                                                              12/23/2019 14:29:10 PAGE 33  

1898          //      }
1899          //      else
1900          //      {
1901          //        UART9_TD_L;
1902          //      }
1903          //      ++global.iouart.sendCount;
1904          //    }
1905          //    else if (global.iouart.sendCount == 9)
1906          //    {
1907          //      UART9_TD_H; //äº§ç”Ÿä¸€ä¸ªåœæ­¢ä½--1
1908          //      global.iouart.sendCount = 0;
1909          //      global.iouart.sendEnable = false;
1910          //      global.iouart.sendComplete = true;
1911          //    }
1912          //  }
1913          // }
1914          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   6277    ----
   CONSTANT SIZE    =     32    ----
   XDATA SIZE       =      1      59
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
