C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE FUNC
OBJECT MODULE PLACED IN .\Objects\func.obj
COMPILER INVOKED BY: C:\Users\M\AppData\Local\Keil\Keil_v4\C51\BIN\C51.EXE ..\lib\user\src\func.c LARGE OPTIMIZE(8,SPEED
                    -) BROWSE INCDIR(..\lib\n76e003\Include;..\lib\user\inc) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\Listings\func.lst
                    -) TABS(2) OBJECT(.\Objects\func.obj)

line level    source

   1          #include "func.h"
   2          
   3          void updateDeviceState(void);
   4          void configWifi(void);
   5          void sendDeviceStateToWifi(void);
   6          void topRequestForSet(void);
   7          
   8          void sendDeviceStateToTop(void);
   9          void sendSetDataToTop(void);
  10          void sendAckToTop(void);
  11          
  12          unsigned char isNoWater(void);
  13          
  14          void parseDataFromTop(void);
  15          void OneWire_init(void);
  16          void oneWire_write(unsigned char* buff,unsigned char len);
  17          unsigned char oneWire_read(unsigned char* buff);
  18          unsigned char figureSum(unsigned char* buff,unsigned char len);
  19          
  20          void parseDataFromWifi(void);
  21          unsigned char figureSum0(unsigned char* buff,unsigned char len);
  22          void uart0_sendData(unsigned char* buff,unsigned char len);
  23          
  24          void initRtc(void);
  25          void firstInitRtc(void);
  26          void rtcGetTime(void);
  27          void rtcSetTime(void);
  28          
  29          unsigned char isFristStart(void);
  30          void saveDataToFlash(void);
  31          void readDataFromFlash(void);
  32          
  33          #define initWifiResetPin() P05_PushPull_Mode;set_P05
  34          #define WifiReset() P05_PushPull_Mode;clr_P05
  35          
  36          void init(void)
  37          {
  38   1        LIGHT_CLOSE;
  39   1        global.device.light = false;
  40   1        global.set.light = false;
  41   1        WATER_CLOSE;
  42   1        global.device.water = false;
  43   1        global.set.water = false;
  44   1        OneWire_init();
  45   1        initRtc();
  46   1        initWifiResetPin();
  47   1        // Timer3_Delay100ms(5);
  48   1      
  49   1        //å¦‚æœä¸ºç¬¬ä¸€æ¬¡å¼€æœº
  50   1        if(isFristStart() == true)
  51   1        {
  52   2          firstInitRtc(); //åˆå§‹åŒ–rtcè®¾ç½®
  53   2          //è¿™é‡Œå¯ä»¥åˆå§‹åŒ–é¢„çº¦æ•°æ®ï¼Œé»˜è®¤åˆå§‹åŒ–ä¸º0
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 2   

  54   2          global.set.startLightHour = 0;
  55   2          global.set.startLightMinute = 0;
  56   2          global.set.keepLightHour = 0;
  57   2          global.set.keepLightMinute = 0;
  58   2          global.set.endLightHour = 0;
  59   2          global.set.endLightMinute = 0;
  60   2          global.set.startWaterHour = 0;
  61   2          global.set.startWaterHour = 0;
  62   2          global.set.keepWaterHour = 0;
  63   2          global.set.keepWaterMinute = 0;
  64   2          global.set.endWaterHour = 0;
  65   2          global.set.endWaterMinute = 0;
  66   2          global.set.waterCycleDay = 1;
  67   2      //    figureEndTime();
  68   2          saveDataToFlash();
  69   2        }
  70   1        else
  71   1        {
  72   2          readDataFromFlash();  //è¯»å–é¢„çº¦æ•°æ®
  73   2        }
  74   1        
  75   1        // Timer3_Delay100ms(5);
  76   1      }
  77          
  78          ///////////////////////////////////////////////Run//////////////////////////////////////////////////////
  79          
  80          //è¿è¡Œåœ¨å®šæ—¶å™¨3ä¸­ï¼Œä¸­æ–­æ—¶é—´ä¸º1ms
  81          void run(void)
  82          {
  83   1        /////////////////////////å¤„ç†ä¸€äº›è®¡æ—¶åŠŸèƒ½//////////////////////////
  84   1        if(++global.work.workTimeCount >= 2000) //2s
  85   1        {
  86   2          global.work.workTimeCount = 0;
  87   2      
  88   2          global.time.getTimeFlag = true; //è·å–ä¸€æ¬¡rtcæ—¶é—´
  89   2        }
  90   1        //ä¸²å£æ¥æ”¶è¶…æ—¶è®¡æ—¶
  91   1        if(global.uart.recTimeOutCount > 0 && global.uart.recTimeOutCount < 1000)
  92   1        {
  93   2          ++global.iouart.recTimeOutCount;
  94   2        }
  95   1      
  96   1        if(global.uart.recvDataTimeOutFlag == false && global.uart.recvDataTimeOutClear == false) //æœªè¶…æ—¶ä¸”æ
             -œªåœ¨æ¸…ç†è®¡æ—¶
  97   1        {
  98   2          if(++global.uart.recvDataTimeOutMs >= 1000) //1ç§’
  99   2          {
 100   3            global.uart.recvDataTimeOutMs = 0;
 101   3            if(++global.uart.recvDataTimeOutSec >= 60)  //1åˆ†é’Ÿ
 102   3            {
 103   4              global.uart.recvDataTimeOutSec = 0;
 104   4              if(++global.uart.recvDataTimeOutMinute >= 10) //10åˆ†é’Ÿ
 105   4              {
 106   5                global.uart.recvDataTimeOutMs = 0;
 107   5                global.uart.recvDataTimeOutSec = 0;
 108   5                global.uart.recvDataTimeOutMinute = 0;
 109   5                global.uart.recvDataTimeOutFlag = true; //è¶…æ—¶
 110   5              }
 111   4            }
 112   3          }
 113   2        }
 114   1        else if(global.uart.recvDataTimeOutFlag == true)  //ååˆ†é’Ÿæ²¡æœ‰æ”¶åˆ°æ¥è‡ªWiFiçš„æ•°æ®ï¼Œåˆ™æœ‰å¯èƒ
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 3   

             -½é”™è¯¯è¿›å…¥ä¸€é”®é…ç½®,å¤ä½WiFi
 115   1        {
 116   2          if(++global.uart.recvDataTimeOutMs >= 500)  //500ms
 117   2          {
 118   3            global.uart.recvDataTimeOutMs = 0;
 119   3            global.uart.recvDataTimeOutSec = 0;
 120   3            global.uart.recvDataTimeOutMinute = 0;
 121   3            global.uart.recvDataTimeOutFlag = false;
 122   3            initWifiResetPin();
 123   3          }
 124   2          else
 125   2          {
 126   3            WifiReset();  //å¤ä½WiFi
 127   3          }
 128   2          
 129   2        }
 130   1      }
 131          
 132          //
 133          //è¿è¡Œåœ¨main-whileä¸­
 134          //ç”¨äºæ‰§è¡Œä¸€äº›è€—æ—¶æ“ä½œ
 135          //
 136          void runMain(void)
 137          {
 138   1        static char lastMinute = -1;
 139   1      
 140   1        parseDataFromTop();
 141   1        parseDataFromWifi();
 142   1      
 143   1        //åˆ¤æ–­æ˜¯å¦ç¼ºæ°´
 144   1        if(isNoWater())
 145   1        {
 146   2          global.device.noWater = true;
 147   2          global.device.water = false;
 148   2          WATER_CLOSE;
 149   2          // global.set.noWater = true;
 150   2        }
 151   1        else
 152   1        {
 153   2          global.device.noWater = false;
 154   2          // global.set.noWater = false;
 155   2        }
 156   1      
 157   1        //è·å–RTCæ—¶é—´
 158   1        if(global.time.getTimeFlag == true)
 159   1        {
 160   2          rtcGetTime();
 161   2          global.time.getTimeFlag = false;
 162   2        }
 163   1        //æ¯è¿‡ä¸€åˆ†é’Ÿæ‰§è¡Œçš„æ“ä½œ
 164   1        if(lastMinute != global.time.minute)
 165   1        {
 166   2          lastMinute = global.time.minute;  //è®°å½•å½“å‰çš„åˆ†é’Ÿ
 167   2          // figureCountdown();
 168   2        }
 169   1      
 170   1      ///////////////////////////////////ä¸å†åŒºåˆ†å•æœºç‰ˆå’Œç½‘ç»œç‰ˆ,ç»Ÿä¸€ç”±WiFiæ¨¡å—æ§åˆ¶é€»è¾‘ç­‰ï¼Œ
             -å•ç‰‡æœºåªè´Ÿè´£æ•°æ®ä¸­è½¬//////////////////////////////////////////////
 171   1      
 172   1        updateDeviceState();  //æ›´æ–°è®¾å¤‡çŠ¶æ€
 173   1      
 174   1      ////////////////////////////////////////////////////////å’Œ wifi æ¨¡å—çš„é€šä¿¡//////////////////////////
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 4   

             -///////////////////////////////////////
 175   1      /////////////////////////æ¥æ”¶/////////////////////////
 176   1        // ///////// wifi è®¾ç½®è®¾å¤‡æ•°æ®//////////
 177   1        if(global.work.wifiSetDeviceFlag == true)
 178   1        {
 179   2          global.device.light = global.set.light;
 180   2          if(global.device.light == true) { LIGHT_OPEN; }
 181   2          else { LIGHT_CLOSE; }
 182   2          global.device.water = global.set.water;
 183   2          if(global.device.water == true && global.device.noWater == false) { WATER_OPEN; } //
 184   2          else { WATER_CLOSE; global.device.water =  false; }
 185   2          global.device.getStateFlag = true;  //å°†æ›´æ–°çš„è®¾å¤‡çŠ¶æ€å‘Šè¯‰ä»æœº
 186   2          global.work.wifiSetDeviceFlag = false;
 187   2        }
 188   1      /////////////////////////å‘é€/////////////////////////
 189   1        ////////ä¸€é”®é…ç½®////////
 190   1        if(global.work.wifiConfigFlag == true)
 191   1        {
 192   2          global.work.wifiConfigFlag = false;
 193   2          configWifi();
 194   2        }
 195   1        /////////é¡¶æ¿è¯·æ±‚è®¾ç½®è®¾å¤‡æ•°æ®/////////
 196   1        if(global.work.serventSetDevieDataFlag == true)
 197   1        {
 198   2          global.work.serventSetDevieDataFlag = false;
 199   2          topRequestForSet();
 200   2        }
 201   1        /////////å¾€ wifi å‘é€è®¾å¤‡æ•°æ®////////
 202   1        if(global.work.wifiGetDeviceFlag == true)
 203   1        {
 204   2          global.work.wifiGetDeviceFlag = false;
 205   2          sendDeviceStateToWifi();
 206   2          if(global.device.wifi == online) rtcSetTime();  //åˆ¤æ–­æ—¶é—´å·®åï¼Œæœ‰æ¡ä»¶é€‰æ‹©è®¾ç½®ä¸å¦
 207   2        }
 208   1      
 209   1      ////////////////////////////////////////////////////////å’Œ é¡¶æ¿ çš„é€šä¿¡//////////////////////////////
             -///////////////////////////////////
 210   1      /////////////////////////æ¥æ”¶/////////////////////////
 211   1        //////////é¡¶æ¿çš„è¯·æ±‚///////////////
 212   1        if(global.work.serventSetDevieSateFlag == true)
 213   1        {
 214   2          global.work.serventSetDevieSateFlag = false;
 215   2          switch(global.work.keyDo)
 216   2          {
 217   3            case 0x01: { global.device.wifi = connecting; global.work.wifiConfigFlag = true;}break;
 218   3            case 0x10: { global.set.light = false; global.work.serventSetDevieDataFlag = true;}break;
 219   3            case 0x11: { global.set.light = true; global.work.serventSetDevieDataFlag = true;}break;
 220   3            case 0x20: { global.set.water = false; global.work.serventSetDevieDataFlag = true;}break;
 221   3            case 0x21: { global.set.water = true; global.work.serventSetDevieDataFlag = true;}break;
 222   3          }
 223   2        }
 224   1      
 225   1      /////////////////////////å‘é€/////////////////////////
 226   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾å¤‡æ•°æ®///////////////////
 227   1        if(global.device.getStateFlag == true)  //æ”¶åˆ°è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚æˆ–è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚ï¼Œä»–ä
             -»¬çš„å“åº”ç›¸åŒ
 228   1        {
 229   2          sendDeviceStateToTop();
 230   2          global.device.getStateFlag = false;
 231   2        }
 232   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®///////////////////
 233   1        if(global.set.getDataFlag == true)
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 5   

 234   1        {
 235   2          global.set.getDataFlag = false;
 236   2          sendSetDataToTop();
 237   2        }
 238   1        //////////å¾€ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®å“åº”///////////////////
 239   1        if(global.set.setDatFlag == true) //æ”¶åˆ°è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
 240   1        {
 241   2          global.set.setDatFlag = false;
 242   2          sendAckToTop();
 243   2          if(global.set.setRtcTimeDataFlag == true) //ç­‰äº0xffè¯´æ˜ä¸ä¿®æ”¹rtcï¼Œé‚£ä¸ç­‰äºæ—¶ä¿®æ”¹
 244   2          {
 245   3            rtcSetTime();
 246   3          }
 247   2          global.work.serventSetDevieDataFlag = true; //å‘WIFIå‘èµ·è®¾ç½®è¯·æ±‚
 248   2        }
 249   1      }
 250          
 251          //
 252          //æ›´æ–°è®¾å¤‡çŠ¶æ€
 253          //
 254          void updateDeviceState(void)
 255          {
 256   1        //æ›´æ–° wifi è¿æ¥çŠ¶æ€
 257   1        if(global.work.wifiStateUpdateFlag == true)
 258   1        {
 259   2          global.work.wifiStateUpdateFlag = false;
 260   2          global.device.wifi = global.set.wifiConnectState;
 261   2        }
 262   1        //æ›´æ–° ç…§æ˜ çŠ¶æ€
 263   1        if(global.work.lightSateUpdateFlag == true)
 264   1        {
 265   2          global.work.lightSateUpdateFlag = false;
 266   2          global.device.light = global.set.light;
 267   2        }
 268   1        //æ›´æ–° æµ‡æ°´ çŠ¶æ€
 269   1        if(global.work.waterSateUpdateFlag == true)
 270   1        {
 271   2          global.work.waterSateUpdateFlag = false;
 272   2          global.device.water = global.set.water;
 273   2        }
 274   1        //æ›´æ–° ç¼ºæ°´ çŠ¶æ€
 275   1        if(global.work.nowaterSateUpdateFlag == true)
 276   1        {
 277   2          global.work.nowaterSateUpdateFlag = false;
 278   2          global.device.noWater = global.set.noWater;
 279   2        }
 280   1      }
 281          
 282          //
 283          // å‘ wifi å‘é€ä¸€é”®é…ç½®å‘½ä»¤
 284          //
 285          void configWifi(void)
 286          {
 287   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 288   1        global.uart.sendBuff[1] = 11; //é•¿åº¦
 289   1      
 290   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 291   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 292   1        global.uart.sendBuff[4] = 0x10; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 293   1        global.uart.sendBuff[5] = 0x01; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 294   1      
 295   1        global.uart.sendBuff[6] = 0x11;
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 6   

 296   1        global.uart.sendBuff[7] = 0x22;
 297   1        global.uart.sendBuff[8] = 0x33;
 298   1        global.uart.sendBuff[9] = 0x44;
 299   1        global.uart.sendBuff[10] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 300   1      
 301   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 302   1      }
 303          
 304          //
 305          //å‘ wifi å‘é€è®¾å¤‡çŠ¶æ€
 306          //
 307          void sendDeviceStateToWifi(void)
 308          {
 309   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 310   1        global.uart.sendBuff[1] = 20; //é•¿åº¦
 311   1      
 312   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 313   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 314   1        global.uart.sendBuff[4] = 0x28; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 315   1        global.uart.sendBuff[5] = 0x01; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 316   1      
 317   1        global.uart.sendBuff[6] = global.time.year; //rtcå¹´è°ƒæ•´
 318   1        global.uart.sendBuff[7] = global.time.month;  //rtcæœˆè°ƒæ•´
 319   1        global.uart.sendBuff[8] = global.time.day;  //rtcæ—¥è°ƒæ•´
 320   1        global.uart.sendBuff[9] = global.time.hour; //rtcæ—¶è°ƒæ•´
 321   1        global.uart.sendBuff[10] = global.time.minute;  //rtcåˆ†è°ƒæ•´
 322   1        global.uart.sendBuff[11] = global.time.sec; //rtcç§’è°ƒæ•´
 323   1      
 324   1        global.uart.sendBuff[12] = global.device.temperature>>8;
 325   1        global.uart.sendBuff[13] = global.device.temperature&0xff;
 326   1        global.uart.sendBuff[14] = global.device.water; //æµ‡æ°´çŠ¶æ€
 327   1        global.uart.sendBuff[15] = global.device.light; //ç…§æ˜çŠ¶æ€
 328   1        global.uart.sendBuff[16] = global.device.noWater; //ç¼ºæ°´çŠ¶æ€
 329   1      
 330   1        global.uart.sendBuff[17] = 0x01;  //ç‰ˆæœ¬ä¿¡æ¯é«˜å­—èŠ‚
 331   1        global.uart.sendBuff[18] = 0x01;  //ç‰ˆæœ¬ä¿¡æ¯ä½å­—èŠ‚
 332   1        global.uart.sendBuff[19] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 333   1      
 334   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 335   1      }
 336          
 337          //
 338          //å‘ wifi å‘é€æ¥è‡ª Top çš„è®¾ç½®è¯·æ±‚
 339          //
 340          void topRequestForSet(void)
 341          {
 342   1        global.uart.sendBuff[0] = 0xAA; //èµ·å§‹æ ‡å¿—
 343   1        global.uart.sendBuff[1] = 24; //é•¿åº¦
 344   1      
 345   1        global.uart.sendBuff[2] = 0x10; //åŒ…æè¿°é«˜å­—èŠ‚
 346   1        global.uart.sendBuff[3] = 0x00; //åŒ…æè¿°ä½å­—èŠ‚
 347   1        global.uart.sendBuff[4] = 0x10; //æ¶ˆæ¯ç±»å‹é«˜å­—èŠ‚
 348   1        global.uart.sendBuff[5] = 0x03; //æ¶ˆæ¯ç±»å‹ä½å­—èŠ‚
 349   1      
 350   1        if(global.set.setTimeDataFlag == true)
 351   1        {
 352   2          global.uart.sendBuff[6] = global.set.startLightHour;  //ç…§æ˜å¯åŠ¨å°æ—¶è°ƒæ•´--0xFFå³ä¸åšè°ƒæ•´
 353   2          global.uart.sendBuff[7] = global.set.startLightMinute;  //ç…§æ˜å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 354   2          global.uart.sendBuff[8] = global.set.keepLightHour; //ç…§æ˜æŒç»­å°æ—¶è°ƒæ•´
 355   2          global.uart.sendBuff[9] = global.set.keepLightMinute; //ç…§æ˜æŒç»­åˆ†é’Ÿè°ƒæ•´
 356   2          global.uart.sendBuff[10] = global.set.startWaterHour; //æµ‡æ°´å¯åŠ¨å°æ—¶è°ƒæ•´
 357   2          global.uart.sendBuff[11] = global.set.startWaterMinute; //æµ‡æ°´å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 7   

 358   2          global.uart.sendBuff[12] = global.set.keepWaterHour;  //æµ‡æ°´æŒç»­å°æ—¶è°ƒæ•´
 359   2          global.uart.sendBuff[13] = global.set.keepWaterMinute;  //æµ‡æ°´æŒç»­åˆ†é’Ÿè°ƒæ•´
 360   2          global.uart.sendBuff[14] = global.set.waterCycleDay;  //æµ‡æ°´å‘¨æœŸæ—¶é—´è°ƒæ•´
 361   2          global.set.setTimeDataFlag = false;
 362   2        }
 363   1        else
 364   1        {
 365   2          global.uart.sendBuff[6] = 0xff;//global.set.startLightHour; //ç…§æ˜å¯åŠ¨å°æ—¶è°ƒæ•´--0xFFå³ä¸åšè°ƒ
             -æ•´
 366   2          global.uart.sendBuff[7] = 0xff;//global.set.startLightMinute; //ç…§æ˜å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 367   2          global.uart.sendBuff[8] = 0xff;//global.set.keepLightHour;  //ç…§æ˜æŒç»­å°æ—¶è°ƒæ•´
 368   2          global.uart.sendBuff[9] = 0xff;//global.set.keepLightMinute;  //ç…§æ˜æŒç»­åˆ†é’Ÿè°ƒæ•´
 369   2          global.uart.sendBuff[10] = 0xff;//global.set.startWaterHour;  //æµ‡æ°´å¯åŠ¨å°æ—¶è°ƒæ•´
 370   2          global.uart.sendBuff[11] = 0xff;//global.set.startWaterMinute;  //æµ‡æ°´å¯åŠ¨åˆ†é’Ÿè°ƒæ•´
 371   2          global.uart.sendBuff[12] = 0xff;//global.set.keepWaterHour; //æµ‡æ°´æŒç»­å°æ—¶è°ƒæ•´
 372   2          global.uart.sendBuff[13] = 0xff;//global.set.keepWaterMinute; //æµ‡æ°´æŒç»­åˆ†é’Ÿè°ƒæ•´
 373   2          global.uart.sendBuff[14] = 0xff;//global.set.waterCycleDay; //æµ‡æ°´å‘¨æœŸæ—¶é—´è°ƒæ•´
 374   2        }
 375   1      
 376   1        global.uart.sendBuff[15] = global.set.light;  //è¯·æ±‚ç…§æ˜è®¾ç½®
 377   1        global.uart.sendBuff[16] = global.set.water;  //è¯·æ±‚æµ‡æ°´è®¾ç½®
 378   1      
 379   1        global.uart.sendBuff[17] = 0xff;//global.set.year;  //å¹´è°ƒæ•´
 380   1        global.uart.sendBuff[18] = 0xff;//global.set.month; //æœˆè°ƒæ•´
 381   1        global.uart.sendBuff[19] = 0xff;//global.set.day; //æ—¥è°ƒæ•´
 382   1        if(global.set.setRtcTimeDataFlag == true)
 383   1        {
 384   2          global.uart.sendBuff[20] = global.set.hour; //æ—¶è°ƒæ•´
 385   2          global.uart.sendBuff[21] = global.set.minute; //åˆ†è°ƒæ•´
 386   2          global.uart.sendBuff[22] = 0;//global.set.sec;  //ç§’è°ƒæ•´
 387   2          global.set.setRtcTimeDataFlag = false;
 388   2        }
 389   1        else
 390   1        {
 391   2          global.uart.sendBuff[20] = 0xff;//global.set.hour;  //æ—¶è°ƒæ•´
 392   2          global.uart.sendBuff[21] = 0xff;//global.set.minute;  //åˆ†è°ƒæ•´
 393   2          global.uart.sendBuff[22] = 0xff;//global.set.sec; //ç§’è°ƒæ•´
 394   2        }
 395   1      
 396   1        global.uart.sendBuff[23] = figureSum0(global.uart.sendBuff,global.uart.sendBuff[1]-1);  //è®¡ç®—æ ¡éªŒå’Œ
 397   1      
 398   1        uart0_sendData(global.uart.sendBuff,global.uart.sendBuff[1]); //å‘é€
 399   1      }
 400          
 401          //
 402          //å‘ é¡¶æ¿ å‘é€è®¾å¤‡çŠ¶æ€
 403          //
 404          void sendDeviceStateToTop(void)
 405          {
 406   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 407   1        global.iouart.sendBuff[1] = 18; //é•¿åº¦
 408   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 409   1        global.iouart.sendBuff[3] = 0x02; //æ¶ˆæ¯ç±»å‹dä½8ä½
 410   1        global.iouart.sendBuff[4] = global.device.wifi;
 411   1        global.iouart.sendBuff[5] = 0x00;
 412   1        global.iouart.sendBuff[6] = global.device.light;
 413   1        global.iouart.sendBuff[7] = global.device.water;
 414   1        global.iouart.sendBuff[8] = global.device.noWater;
 415   1        global.iouart.sendBuff[9] = global.device.nextStartLightCountDown>>8;
 416   1        global.iouart.sendBuff[10] = global.device.nextStartLightCountDown&0x00ff;
 417   1        global.iouart.sendBuff[11] = global.device.endLightCountDown>>8;
 418   1        global.iouart.sendBuff[12] = global.device.endLightCountDown&0x00ff;
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 8   

 419   1        global.iouart.sendBuff[13] = global.device.nextStartWaterCountDown>>8;
 420   1        global.iouart.sendBuff[14] = global.device.nextStartWaterCountDown&0x00ff;
 421   1        global.iouart.sendBuff[15] = global.device.endWaterCountDown>>8;
 422   1        global.iouart.sendBuff[16] = global.device.endWaterCountDown&0x00ff;
 423   1        global.iouart.sendBuff[17] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 424   1      
 425   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 426   1      }
 427          
 428          //
 429          //å‘ é¡¶æ¿ å‘é€è®¾ç½®æ•°æ®
 430          //
 431          void sendSetDataToTop(void)
 432          {
 433   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 434   1        global.iouart.sendBuff[1] = 16; //é•¿åº¦
 435   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 436   1        global.iouart.sendBuff[3] = 0x04; //æ¶ˆæ¯ç±»å‹dä½8ä½
 437   1        global.iouart.sendBuff[4] = global.time.hour;
 438   1        global.iouart.sendBuff[5] = global.time.minute;
 439   1        global.iouart.sendBuff[6] = global.set.startLightHour;
 440   1        global.iouart.sendBuff[7] = global.set.startLightMinute;
 441   1        global.iouart.sendBuff[8] = global.set.keepLightHour;
 442   1        global.iouart.sendBuff[9] = global.set.keepLightMinute;
 443   1        global.iouart.sendBuff[10] = global.set.startWaterHour;
 444   1        global.iouart.sendBuff[11] = global.set.startWaterMinute;
 445   1        global.iouart.sendBuff[12] = global.set.keepWaterHour;
 446   1        global.iouart.sendBuff[13] = global.set.keepWaterMinute;
 447   1        global.iouart.sendBuff[14] = global.set.waterCycleDay;
 448   1        global.iouart.sendBuff[15] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 449   1      
 450   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 451   1      }
 452          
 453          //
 454          //å‘ é¡¶æ¿ å‘é€å“åº”
 455          //
 456          void sendAckToTop(void)
 457          {
 458   1        global.iouart.sendBuff[0] = 0x96; //å¤´
 459   1        global.iouart.sendBuff[1] = 5;  //é•¿åº¦
 460   1        global.iouart.sendBuff[2] = 0x00; //æ¶ˆæ¯ç±»å‹é«˜8ä½
 461   1        global.iouart.sendBuff[3] = 0x07; //æ¶ˆæ¯ç±»å‹dä½8ä½
 462   1        global.iouart.sendBuff[4] = figureSum(global.iouart.sendBuff,global.iouart.sendBuff[1]-1);
 463   1      
 464   1        oneWire_write(global.iouart.sendBuff,global.iouart.sendBuff[1]);
 465   1      }
 466          
 467          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 468          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 469          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 470          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 471          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 472          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 473          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 9   

 474          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 475          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 476          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 477          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 478          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 479          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -//////////////////////////////////////////////////////////////////////////
 480          
 481          unsigned char isNoWater(void)
 482          {
 483   1        NOWATER_INIT;
 484   1        if(IS_NOWATER == 0)
 485   1        {
 486   2          return true;
 487   2        }
 488   1      
 489   1        return false;
 490   1      }
 491          
 492          void parseDataFromTop(void)
 493          {
 494   1        unsigned char len = 0,sum = 0;
 495   1        unsigned char buff[32] = {0};
 496   1        unsigned int cmd = 0;
 497   1        len = oneWire_read(buff);
 498   1        if(len != 0)  //å¤§äº0åˆ™è¯´æ˜æœ‰æ•°æ®åŒ…
 499   1        {
 500   2          sum = figureSum(buff,len-1);
 501   2          if(buff[0] == 0x96 && buff[len-1] == sum) //ç¡®è®¤åŒ…å¤´å’Œæ ¡éªŒ
 502   2          {
 503   3            cmd = buff[2]<<8 | buff[3];
 504   3            switch(cmd)
 505   3            {
 506   4              case 0x0001:  //è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚  //é¡¶æ¿ç´¢è¦è®¾å¤‡çŠ¶æ€æ•°æ®ï¼Œå¹¶ç»™å‡ºå½“å‰æ¸©åº¦
 507   4              {
 508   5                global.device.temperature = buff[4]<<8 | buff[5]; //æ‹¿åˆ°æ¸©åº¦
 509   5                global.device.getStateFlag = true;  //æ ‡è®°è·å–çŠ¶æ€æ ‡å¿—ï¼Œå°†è¦å‘é€è®¾å¤‡çŠ¶æ€ç»™é¡¶æ¿
 510   5              }break;
 511   4              case 0x0003:  //è®¾ç½®å‚æ•°è·å–è¯·æ±‚
 512   4              {
 513   5                global.set.getDataFlag = true;
 514   5              }break;
 515   4              case 0x0005:  //è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚ï¼ŒæŒ‰ä¸‹ç…§æ˜æˆ–æµ‡æ°´æˆ–è¿wifi
 516   4              {
 517   5                global.work.keyDo = buff[4];
 518   5                global.work.serventSetDevieSateFlag = true; //åˆ¤æ–­é”®å€¼ï¼Œå¹¶ä¸”å‘é€ç»™æ¨¡å—å†³æ–­
 519   5              }break;
 520   4              case 0x0006:  //è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
 521   4              {
 522   5                if(buff[4] != 0xff)
 523   5                {
 524   6                  global.set.setRtcTimeDataFlag = true; //è®¾ç½®äº†rtcæ—¶é—´
 525   6                  global.set.hour = buff[4];
 526   6                  global.set.minute = buff[5];
 527   6                  global.set.sec = 0;
 528   6                }
 529   5                else global.set.setRtcTimeDataFlag = false;
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 10  

 530   5                if(buff[6] != 0xff) global.set.setTimeDataFlag = true;  //è®¾ç½®äº†ç…§æ˜æµ‡æ°´çš„æ—¶é—´
 531   5                global.set.startLightHour = buff[6];
 532   5                global.set.startLightMinute = buff[7];
 533   5                global.set.keepLightHour = buff[8];
 534   5                global.set.keepLightMinute = buff[9];
 535   5                global.set.startWaterHour = buff[10];
 536   5                global.set.startWaterMinute = buff[11];
 537   5                global.set.keepWaterHour = buff[12];
 538   5                global.set.keepWaterMinute = buff[13];
 539   5                global.set.waterCycleDay = buff[14];
 540   5      
 541   5                global.set.setDatFlag = true;
 542   5              }break;
 543   4            }
 544   3          }
 545   2        }
 546   1      }
 547          
 548          /////////////////////////////////////////////////å•æ€»çº¿é€šä¿¡//////////////////////////////////////////
             -//////////////
 549          
 550          #define ONE_WIRE_A P03
 551          #define ONE_WIRE_A_MODE P03_Quasi_Mode
 552          #define ONE_WIRE_A_H set_P03
 553          #define ONE_WIRE_A_L clr_P03
 554          #define ONE_WIRE_B P04
 555          #define ONE_WIRE_B_MODE P04_Quasi_Mode
 556          #define ONE_WIRE_B_H set_P04
 557          #define ONE_WIRE_B_L clr_P04
 558          
 559          #define ONE_WIRE_READ ONE_WIRE_B
 560          #define ONE_WIRE_WRITE(b) if(b) ONE_WIRE_A_H; else ONE_WIRE_A_L
 561          
 562          void OneWire_init(void)
 563          {
 564   1        ONE_WIRE_A_MODE;
 565   1        ONE_WIRE_B_MODE;
 566   1      
 567   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿
 568   1      }
 569          
 570          void oneWire_start(void)
 571          {
 572   1        ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºèµ·å§‹ä¿¡å·
 573   1        Timer0_Delay1ms(10);
 574   1      }
 575          
 576          void oneWire_stop(void)
 577          {
 578   1        ONE_WIRE_WRITE(1);  //æ‹‰é«˜ä»¥é‡Šæ”¾å†™æ€»çº¿ä½œä¸ºåœæ­¢ä¿¡å·
 579   1      }
 580          
 581          //
 582          //  å†™ä¸€ä¸ªå­—èŠ‚å…«ä½æ•°æ®
 583          //
 584          void oneWire_writeByte(unsigned char dat)
 585          {
 586   1        unsigned char i = 8;
 587   1      
 588   1        while(i--)
 589   1        {
 590   2          ONE_WIRE_WRITE(1);  //æ‹‰é«˜å†™æ€»çº¿ä¼ è¾“ä¸€ä½æ•°æ®
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 11  

 591   2          if(dat & 0x80)
 592   2            Timer0_Delay100us(5); //å†™é«˜ç”µå¹³
 593   2          else
 594   2            Timer0_Delay100us(2); //å†™ä½ç”µå¹³
 595   2          dat <<= 1;
 596   2          ONE_WIRE_WRITE(0);  //æ‹‰ä½å†™æ€»çº¿ä½œä¸ºä½ä¹‹é—´çš„é—´éš”
 597   2          Timer0_Delay100us(2);
 598   2        }
 599   1      }
 600          
 601          //
 602          //  å†™æ•°æ®åŒ…ï¼Œé€šä¿¡è§„åˆ™ä¸­ï¼Œèµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¿…é¡»ä¸ºæ•°æ®åŒ…çš„é•¿åº¦(è¯¥å­—èŠ‚
             -ä¸è®¡ç®—åœ¨é•¿åº¦å†…)
 603          //
 604          void oneWire_write(unsigned char* buff,unsigned char len)
 605          {
 606   1        oneWire_start();  //èµ·å§‹ä¿¡å·
 607   1        oneWire_writeByte(len); //å‘é€æ•°æ®é•¿åº¦
 608   1        while(len--)  //æ•°æ®åŒ…é•¿åº¦
 609   1        {
 610   2          oneWire_writeByte(*buff); //å‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®
 611   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 612   2        }
 613   1        oneWire_stop(); //åœæ­¢ä¿¡å·
 614   1      }
 615          
 616          //
 617          //  è¯»æ•°æ®åŒ…ï¼ŒæˆåŠŸåè¿”å›æ•°æ®åŒ…é•¿åº¦,å¤±è´¥ä¸º0
 618          //
 619          unsigned char oneWire_read(unsigned char* buff)
 620          {
 621   1        unsigned int timeOut = 0;
 622   1        unsigned char count = 0,dat = 0,transFlag = 0,index = 0,lenFlag = 0,lenCount = 0,len = 0;
 623   1        if(!ONE_WIRE_READ)  //ä½ç”µå¹³ï¼Œæ”¶åˆ°èµ·å§‹ä¿¡å·
 624   1        {
 625   2          while(1)
 626   2          {
 627   3            if(ONE_WIRE_READ) //é«˜ç”µå¹³ï¼Œè®¡ç®—æŒç»­æ—¶é—´
 628   3            {
 629   4              ++count;  //è®°å½•é«˜ç”µå¹³æŒç»­æ—¶é—´
 630   4              transFlag = 1;  //ç”µå¹³è·³å˜æ ‡å¿—
 631   4            }
 632   3            else if(!ONE_WIRE_READ && transFlag == 1) //è¯»æ€»çº¿ä¸ºä½ç”µå¹³å¹¶ä¸”åªæœ‰åœ¨ç”µå¹³è·³å˜åæ‰è¿›å…
             -¥
 633   3            { //ä¸€ä½æ•°æ®ç»“æŸï¼Œåˆ¤æ–­ä¹‹å‰çš„é«˜ç”µå¹³ä¼ è¾“çš„æ˜¯1è¿˜æ˜¯0
 634   4              dat <<= 1;
 635   4              if(count > 3) //å¤§äº300uså°±ç®—é«˜ç”µå¹³
 636   4                dat |= 1;
 637   4              count = 0;  //æ¸…é«˜ç”µå¹³è®¡æ•°
 638   4              timeOut = 0;  //æ¸…è¶…æ—¶è®¡æ•°
 639   4              transFlag = 0;  //æ¸…ç”µå¹³è·³å˜æ ‡å¿—
 640   4              if(++index == 8)  //æ¯è¯»å…«ä½ï¼Œå³ä¸€ä¸ªå­—èŠ‚è¿›å…¥ä¸€æ¬¡
 641   4              {
 642   5                if(lenFlag == 0)  //èµ·å§‹ä¿¡å·åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œç”¨äºè¯´æ˜æ•°æ®åŒ…çš„é•¿åº¦
 643   5                {
 644   6                  lenFlag = 1;  //å·²æ¥æ”¶åˆ°é•¿åº¦
 645   6                  len = dat;
 646   6                }
 647   5                else  //æ•°æ®åŒ…çš„å†…å®¹
 648   5                {
 649   6                  *buff = dat;
 650   6                  if(++lenCount == len) //æ•°æ®åŒ…æ¥æ”¶å®Œæˆ
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 12  

 651   6                  {
 652   7                    Timer0_Delay100us(3); //ç­‰ä½ç”µå¹³è¿‡å»ï¼Œä»¥é˜²æ­¢è¿ç»­ä¼ è¾“æ—¶é”™è¯¯çš„å°†ç”¨ä½œé—´éš”çš„ä½
             -ç”µå¹³è¯†åˆ«ä¸ºèµ·å§‹ä¿¡å·
 653   7                    return len; //ç»“æŸ,å¹¶è¿”å›é•¿åº¦
 654   7                  }
 655   6                  else  //æ²¡æ¥æ”¶å®Œæˆå°±ç»§ç»­æ¥æ”¶ï¼Œè¿™é‡Œå•ç‹¬è‡ªå¢æ˜¯ä¸ºäº†é˜²æ­¢æº¢å‡º
 656   6                  {
 657   7                    ++buff;
 658   7                  }
 659   6                  
 660   6                }
 661   5                index = 0;  //æ¸…è®¡æ•°
 662   5                dat = 0x00; //æ¸…å˜é‡
 663   5              }
 664   4            }
 665   3            Timer0_Delay100us(1); //è¶…æ—¶å¤„ç†
 666   3            if(++timeOut > 200) return 0; //è¶…æ—¶
 667   3          }
 668   2        }
 669   1        return 0;
 670   1      }
 671          
 672          //
 673          //å’Œæ ¡éªŒè®¡ç®—
 674          //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
 675          //
 676          unsigned char figureSum(unsigned char* buff,unsigned char len)
 677          {
 678   1        unsigned char sum = 0;
 679   1      
 680   1        while(len--)
 681   1        {
 682   2          sum += *buff;
 683   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 684   2        }
 685   1        return sum;
 686   1      }
 687          
 688          ///////////////////////////////////////////////ä¸²å£0åŠŸèƒ½//////////////////////////////////////////////
             -////////
 689          
 690          void uart0_fun(unsigned char* buff);  //å£°æ˜
 691          //
 692          //  å¤„ç†æ•°æ®
 693          //
 694          void parseDataFromWifi(void)
 695          {
 696   1        unsigned char sum = 0;
 697   1        if(global.uart.recvCmdCount > 0)  //æœ‰å¾…å¤„ç†çš„æŒ‡ä»¤
 698   1        {
 699   2          if(global.uart.recvCmdCount > UARTBUFFCMDMAXSIZE - 1) //å¦‚æœå¾…å¤„ç†çš„æŒ‡ä»¤è¿‡å¤šï¼Œå¤§äºä¸Šé™-1(
             -å› ä¸ºæ­£åœ¨æ¥æ”¶çš„æŒ‡ä»¤ä¼šå ç”¨ä¸€æ¡ï¼Œæ‰€ä»¥è¦-1)
 700   2          {
 701   3            //å› ä¸ºå¾…å¤„ç†è¿‡å¤šäº†ï¼Œæ‰€ä»¥ç¼“å†²åŒºä¸­æ¯ä¸€æ¡éƒ½è¢«å ç”¨äº†ï¼Œæ‰€ä»¥å¤„ç†å½“å‰åœ¨æ¥æ”¶çš
             -„ä¸‹æ ‡çš„+2ï¼Œä¹‹æ‰€ä»¥ä¸æ˜¯+1æ˜¯ä¸ºäº†é˜²æ­¢è¿˜åœ¨å¤„ç†+1æ—¶ï¼Œå½“å‰çš„ä¸‹æ ‡å°±æ¥æ”¶å®Œäº†æ¥ç€åˆå¼€å§‹æ¥æ”¶+1
             -å¯¼è‡´æ•°æ®é”™ä¹±
 702   3            //ä¾‹å¦‚å½“å‰åœ¨æ¥æ”¶çš„ä¸‹æ ‡æ˜¯0ï¼Œé‚£ä¹ˆå¦‚æœå¤„ç†1æ—¶ï¼Œè¿˜æœªå¤„ç†å®Œ1å°±æ¥æ”¶å®Œ0äº†ï¼Œæ¥ç
             -€åˆå¼€å§‹æ¥æ”¶1ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´é”™ä¹±
 703   3            if(global.uart.recvCmdNowIndex + 2 > UARTBUFFCMDMAXSIZE - 1)  //å¦‚æœä¸‹æ ‡+2ä¼šè¶…è¿‡æœ€å¤§ä¸‹æ ‡ï¼Œåˆ
             -™è®¡ç®—ä¸‹æ ‡
 704   3            {
 705   4              global.uart.recvCmdIndex = 2 - (UARTBUFFCMDMAXSIZE - 1 - global.uart.recvCmdNowIndex);  //è¶…å‡ºå¤šå°‘å
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 13  

             -ˆ™ä»0åŠ ä¸Šå¤šå°‘ï¼Œæœ€å¤šåŠ 2
 706   4            }
 707   3            else
 708   3            {
 709   4              global.uart.recvCmdIndex = global.uart.recvCmdNowIndex + 2;
 710   4            }
 711   3          }
 712   2          else  //å¾…å¤„ç†çš„æŒ‡ä»¤ä¸å¤š,åˆ™ç›´æ¥å¤„ç†å½“å‰æ¥æ”¶çš„ä¸Šä¸€æ¡
 713   2          {
 714   3            if(global.uart.recvCmdNowIndex == 0)
 715   3            {
 716   4              global.uart.recvCmdIndex = UARTBUFFCMDMAXSIZE - 1;
 717   4            }
 718   3            else
 719   3            {
 720   4              global.uart.recvCmdIndex = global.uart.recvCmdNowIndex - 1;
 721   4            }
 722   3          }
 723   2          
 724   2          //å¤„ç†æŒ‡ä»¤
 725   2          sum = figureSum0(global.uart.recvDealBuff[global.uart.recvCmdIndex],global.uart.recvDealBuff[global.uart
             -.recvCmdIndex][1]-1);
 726   2          if(sum == global.uart.recvDealBuff[global.uart.recvCmdIndex][global.uart.recvDealBuff[global.uart.recvCm
             -dIndex][1]-1])  //æ ¡éªŒé€šè¿‡
 727   2          {
 728   3            global.uart.recvDataTimeOutClear = true;  //å¼€å¯æ¸…ç†æ ‡å¿—ï¼Œé˜²æ­¢æ¸…ç†æ—¶è¢«ä¸­æ–­ä¿®æ”¹
 729   3            global.uart.recvDataTimeOutMs = 0;
 730   3            global.uart.recvDataTimeOutSec = 0;
 731   3            global.uart.recvDataTimeOutMinute = 0;
 732   3            global.uart.recvDataTimeOutClear = false; //å…³é—­æ¸…ç†æ ‡å¿—ï¼Œè®©ä¸­æ–­ç»§ç»­è®¡æ—¶
 733   3            uart0_fun(global.uart.recvDealBuff[global.uart.recvCmdIndex]);  //åŠŸèƒ½åˆ¤æ–­
 734   3          }
 735   2          --global.uart.recvCmdCount; //å¾…å¤„ç†æŒ‡ä»¤-1
 736   2        }
 737   1      }
 738          
 739          //
 740          //å’Œæ ¡éªŒè®¡ç®—
 741          //unsigned char len : éœ€è¦è®¡ç®—çš„é•¿åº¦
 742          //
 743          unsigned char figureSum0(unsigned char* buff,unsigned char len)
 744          {
 745   1        unsigned char sum = 0;
 746   1      
 747   1        while(len--)
 748   1        {
 749   2          sum += *buff;
 750   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 751   2        }
 752   1        sum = ~sum;
 753   1        sum += 1;
 754   1        return sum;
 755   1      }
 756          
 757          void uart0_fun(unsigned char* buff)
 758          {
 759   1        unsigned int messageType = 0,temp = 0;
 760   1        messageType = (buff[4]<<8) | buff[5];
 761   1        switch(messageType)
 762   1        {
 763   2          case 0x1801:  //ä¸€é”®é…ç½®å“åº”
 764   2          {
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 14  

 765   3            
 766   3          }break;
 767   2          case 0x1803:  //è®¾ç½®å‚æ•°å“åº”
 768   2          {
 769   3            
 770   3          }break;
 771   2          case 0x1002:  //ç½‘ç»œçŠ¶æ€
 772   2          {
 773   3            if(buff[7] == 0x00) global.set.wifiConnectState = connectToAp;  //è¿æ¥è·¯ç”±
 774   3            else if(buff[7] == 0x01 && buff[8] == 0x00) global.set.wifiConnectState = connectToService; //è¿æ¥è‡³
             -è·¯ç”±
 775   3            else if(buff[8] == 0x01)  global.set.wifiConnectState = online; //è¿æ¥è‡³æœåŠ¡å™¨
 776   3      
 777   3            global.work.wifiStateUpdateFlag = true; //ç½®ä½ wifi çŠ¶æ€æ›´æ–°æ ‡å¿—
 778   3          }break;
 779   2          case 0x2001:  //WIFIæ¨¡å—è¯·æ±‚è®¾å¤‡çŠ¶æ€å¹¶ç»™æ—¶é—´
 780   2          {
 781   3            if(buff[6] != 0xff)
 782   3            {
 783   4              global.set.year = buff[6];// + 2000;
 784   4            }
 785   3            if(buff[7] != 0xff)
 786   3            {
 787   4              global.set.month = buff[7];
 788   4            }
 789   3            if(buff[8] != 0xff)
 790   3            {
 791   4              global.set.day = buff[8];
 792   4            }
 793   3            if(buff[9] != 0xff)
 794   3            {
 795   4              global.set.hour = buff[9];
 796   4            }
 797   3            if(buff[10] != 0xff)
 798   3            {
 799   4              global.set.minute = buff[10];
 800   4            }
 801   3            if(buff[11] != 0xff)
 802   3            {
 803   4              global.set.sec = buff[11];
 804   4            }
 805   3            global.work.wifiGetDeviceFlag = true;
 806   3          }break;
 807   2          case 0x2002:  //WIFIæ¨¡å—è¯·æ±‚è®¾ç½®è®¾å¤‡
 808   2          {
 809   3            if(buff[6] == 0x00) global.set.water = false;
 810   3            else if(buff[6] == 0x01) global.set.water = true;
 811   3            if(buff[7] == 0x00) global.set.light = false;
 812   3            else if(buff[7] == 0x01) global.set.light = true;
 813   3      
 814   3            temp = (buff[8]<<8) | buff[9];
 815   3            global.device.nextStartWaterCountDown = temp;
 816   3            //å› ä¸ºåº•æ¿ä¸é¡¶æ¿äº¤äº’æ˜¾ç¤ºå€’è®¡æ—¶çš„æœºåˆ¶ï¼Œæ‰€ä»¥ä¸å†åˆ¤æ–­
 817   3            // if(temp != 0xffff)
 818   3            // {
 819   3            //  global.device.nextStartWaterCountDown = temp;
 820   3            // }
 821   3            temp = (buff[10]<<8) | buff[11];
 822   3            global.device.endWaterCountDown = temp;
 823   3            // if(temp != 0xffff)
 824   3            // {
 825   3            //  global.device.endWaterCountDown = temp;
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 15  

 826   3            // }
 827   3            temp = (buff[12]<<8) | buff[13];
 828   3            global.device.nextStartLightCountDown = temp;
 829   3            // if(temp != 0xffff)
 830   3            // {
 831   3            //  global.device.nextStartLightCountDown = temp;
 832   3            // }
 833   3            temp = (buff[14]<<8) | buff[15];
 834   3            global.device.endLightCountDown = temp;
 835   3            // if(temp != 0xffff)
 836   3            // {
 837   3            //  global.device.endLightCountDown = temp;
 838   3            // }
 839   3      
 840   3            if(buff[16] != 0xff)
 841   3            {
 842   4              global.set.startLightHour = buff[16];
 843   4            }
 844   3            if(buff[17] != 0xff)
 845   3            {
 846   4              global.set.startLightMinute = buff[17];
 847   4            }
 848   3            if(buff[18] != 0xff)
 849   3            {
 850   4              global.set.keepLightHour = buff[18];
 851   4            }
 852   3            if(buff[19] != 0xff)
 853   3            {
 854   4              global.set.keepLightMinute = buff[19];
 855   4            }
 856   3            if(buff[20] != 0xff)
 857   3            {
 858   4              global.set.startWaterHour = buff[20];
 859   4            }
 860   3            if(buff[21] != 0xff)
 861   3            {
 862   4              global.set.startWaterMinute = buff[21];
 863   4            }
 864   3            if(buff[22] != 0xff)
 865   3            {
 866   4              global.set.keepWaterHour = buff[22];
 867   4            }
 868   3            if(buff[23] != 0xff)
 869   3            {
 870   4              global.set.keepWaterMinute = buff[23];
 871   4            }
 872   3            if(buff[24] != 0xff)
 873   3            {
 874   4              global.set.waterCycleDay = buff[24];
 875   4            }
 876   3      
 877   3            global.work.wifiSetDeviceFlag = true;
 878   3          }break;
 879   2        }
 880   1      }
 881          
 882          void uart0_isr(unsigned char dat)
 883          {
 884   1        unsigned char sum = 0,i = 0;
 885   1        
 886   1        //è¶…æ—¶å¤„ç†
 887   1        if(global.uart.recTimeOutCount == 1000)
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 16  

 888   1        {
 889   2          global.uart.recTimeOutCount = 0;  //å·²è¶…æ—¶ï¼Œå…³æ‰è¶…æ—¶è®¡æ—¶
 890   2          global.uart.nowIndex = 0; //é‡ç½®ä¸‹æ ‡
 891   2        }
 892   1        
 893   1        //åˆ¤æ–­æ¥æ”¶çš„æ•°æ®æ˜¯å¦ç¬¦åˆé€šä¿¡æ ¼å¼
 894   1        if(global.uart.nowIndex == 0 && dat == 0xAA)  //å¤´
 895   1        {
 896   2          global.uart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½“å‰æ•
             -°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
 897   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;
 898   2          ++global.uart.nowIndex;
 899   2        }
 900   1        else if(global.uart.nowIndex == 1)  //æ•°æ®é•¿åº¦
 901   1        {
 902   2          if(dat > UARTBUFFDATAMAXSIZE - 14)  //é•¿åº¦å¤§äºç¼“å†²åŒºæœ€å¤§-14ï¼Œåˆ™é€€å‡ºç¨‹åºï¼Œé˜²æ­¢æº¢å‡º
 903   2          {
 904   3            global.uart.nowIndex = 0;
 905   3            return;
 906   3          }
 907   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //é•¿åº¦ï¼šä»å¤´åˆ°æ
             - ¡éªŒ
 908   2          ++global.uart.nowIndex;
 909   2        }
 910   1        else if(global.uart.nowIndex >= 2 && global.uart.nowIndex <= global.uart.recvDealBuff[global.uart.recvCmd
             -NowIndex][1]-2) //å‡å»äº†æ ¡éªŒå­—èŠ‚ï¼Œå› ä¸ºä¸‹æ ‡æ¯”å®é™…é•¿åº¦å°1ï¼Œæ‰€ä»¥-2
 911   1        {
 912   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //æ•°æ®
 913   2          ++global.uart.nowIndex;
 914   2        }
 915   1        else if(global.uart.nowIndex == global.uart.recvDealBuff[global.uart.recvCmdNowIndex][1]-1) //è®°å½•æ”¶åˆ
             -°çš„æŒ‡ä»¤ï¼Œä¹‹ååœ¨ä¸»å¾ªç¯ä¸­å¤„ç†ï¼Œå¤„ç†æ—¶å†åšæ ¡éªŒ
 916   1        {
 917   2          global.uart.recTimeOutCount = 0;  //æ¥æ”¶åˆ°ä¸€ä¸ªå¯èƒ½å®Œæ•´çš„æ•°æ®åŒ…ï¼Œå…³æ‰è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ
             -™ä¸è®¡æ—¶
 918   2          global.uart.recvDealBuff[global.uart.recvCmdNowIndex][global.uart.nowIndex] = dat;  //æ•°æ®
 919   2      
 920   2          ++global.uart.recvCmdCount; //å¯¹æ¥æ”¶åˆ°çš„æŒ‡ä»¤è¿›è¡Œè®¡æ•°
 921   2          if(global.uart.recvCmdNowIndex == UARTBUFFCMDMAXSIZE - 1) //æ¥æ”¶çš„æŒ‡ä»¤æ•°é‡å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œå›
             - ä¸ºç”¨ä½œæ•°ç»„ä¸‹æ ‡æ‰€ä»¥è¿™é‡Œéœ€è¦å‡1
 922   2          {
 923   3            global.uart.recvCmdNowIndex = 0;  //é‡ç½®æˆ–è€…ä¹Ÿæœ‰å¯èƒ½ä¼šé€ æˆè¦†ç›–
 924   3          }
 925   2          else
 926   2          {
 927   3            ++global.uart.recvCmdNowIndex;
 928   3          }
 929   2      
 930   2          global.uart.nowIndex = 0;
 931   2        }
 932   1      }
 933          
 934          void delay(unsigned int a)
 935          {
 936   1        unsigned int b = 0;
 937   1        for(;a > 0;a--)
 938   1        {
 939   2          for(;b < 100;b++);
 940   2        }
 941   1      }
 942          
 943          void uart0_sendData(unsigned char* buff,unsigned char len)
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 17  

 944          {
 945   1        while(len--)
 946   1        {
 947   2          //å› ä¸ºä¸‹é¢çš„é˜»å¡ç­‰å¾…ï¼Œæ‰€ä»¥è¯¥å˜é‡ä¸ä¼šå­˜åœ¨åŒæ—¶åœ¨ä¸­æ–­å’Œå‡½æ•°è°ƒç”¨æ—¶åŒæ—¶è¢«ä¿®
             -æ”¹çš„æƒ…å†µ
 948   2          global.uart.sendIsrFlag = false;  //å‘é€å®Œæˆä¼šåœ¨ä¸­æ–­ä¸­è¢«ç½®ä½
 949   2          SBUF = *buff;
 950   2          //è¿™é‡Œå­˜åœ¨å¯èƒ½å¯¼è‡´æ­»æœºçš„é—®é¢˜ï¼Œå½“å‘é€åè¢«æŸä¸­æ–­æ‰“æ–­
 951   2          //åœ¨å›åˆ°è¿™é‡Œä¹‹å‰ï¼Œä¸²å£å·²ç»å‘é€å®Œæˆï¼Œä¸­æ–­ä¸­ TI è¢«æ¸… 0
 952   2          //å¯¼è‡´å›åˆ°è¿™é‡Œä¹‹åï¼Œæ— æ³•è·³å‡ºå¾ªç¯
 953   2            // while(TI==0);
 954   2          //è¿™é‡Œä½¿ç”¨é¢å¤–çš„å˜é‡æ ‡è®°ä¸²å£å‘é€å®Œæˆæ ‡å¿—
 955   2          //å½“ä¸Šè¿°çš„æƒ…å†µå‘ç”Ÿä¹‹åï¼Œè¯¥æ ‡å¿—ä¾ç„¶æ­£å¸¸è¢«ç½®ä½
 956   2          while(global.uart.sendIsrFlag == false);  //æœªè¢«ç½®ä½å°±é˜»å¡ç­‰å¾…
 957   2          delay(20);
 958   2          if(len != 0) ++buff;  //é˜²æ­¢æº¢å‡º
 959   2        }
 960   1      }
 961          
 962          ///////////////////////////////////////////////RTC//////////////////////////////////////////////////////
 963          
 964          #define RTC_RST_H set_P01
 965          #define RTC_RST_L clr_P01
 966          #define RTC_SCL_H set_P13
 967          #define RTC_SCL_L clr_P13
 968          #define RTC_SDA_H set_P14
 969          #define RTC_SDA_L clr_P14
 970          #define RTC_SDA P14
 971          
 972          #define RTCADDR_SEC 0x80
 973          #define RTCADDR_MINUTE 0x82
 974          #define RTCADDR_HOUR 0x84
 975          #define RTCADDR_DAY 0x86
 976          #define RTCADDR_MONTH 0x88
 977          #define RTCADDR_YEAR 0x8c
 978          #define RTCADDR_WP 0x8e //å†™ä¿æŠ¤
 979          #define RTCADDR_CHARGER 0x90  //æ¶“æµå……ç”µ
 980          
 981          #define RTC_WP_OPEN 0x80 //å†™ä¿æŠ¤å¼€
 982          #define RTC_WP_CLOSE  0x00 //å†™ä¿æŠ¤å…³
 983          #define RTC_CHARGER_LEVEL4 0xa9 //
 984          #define RTC_CHARGER_LEVEL6 0xab //åº”è¯¥æ˜¯æœ€æ…¢çš„å……ç”µ
 985          
 986          void rctWriteByte(unsigned char addr,unsigned char dat);
 987          unsigned char rtcReadByte(unsigned char addr);
 988          
 989          void initRtc(void)
 990          {
 991   1        P01_PushPull_Mode;  //NRST
 992   1        P13_PushPull_Mode;  //SCL
 993   1        P14_PushPull_Mode;  //SDA
 994   1      
 995   1        RTC_RST_L;
 996   1        RTC_SCL_H;
 997   1        RTC_SDA_H;
 998   1      }
 999          
1000          void firstInitRtc(void)
1001          {
1002   1        rctWriteByte(RTCADDR_WP,RTC_WP_CLOSE);  //å…³é—­å†™ä¿æŠ¤
1003   1        rctWriteByte(RTCADDR_SEC,0x00); //å¼€å¯è®¡æ—¶,ç§’æ¸…é›¶
1004   1        rctWriteByte(RTCADDR_HOUR,0x00);  //æ¸…é›¶å°æ—¶
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 18  

1005   1        rctWriteByte(RTCADDR_MINUTE,0x00);  //æ¸…é›¶åˆ†é’Ÿ
1006   1        rctWriteByte(RTCADDR_CHARGER,RTC_CHARGER_LEVEL4);
1007   1        // rctWriteByte(RTCADDR_CHARGER,RTC_CHARGER_LEVEL6);  //è®¾ç½®æ¶“æµå……ç”µ
1008   1        rctWriteByte(RTCADDR_WP,RTC_WP_OPEN); //å¼€å¯å†™ä¿æŠ¤
1009   1      }
1010          
1011          void rctWriteByte(unsigned char addr,unsigned char dat)
1012          {
1013   1        unsigned char count;
1014   1      
1015   1        P14_PushPull_Mode;
1016   1      
1017   1        RTC_SCL_L;
1018   1        RTC_RST_H;
1019   1      
1020   1        addr &= 0xfe;
1021   1      
1022   1        for(count = 0;count < 8;count++)
1023   1        {
1024   2          RTC_SCL_L;
1025   2          if(addr & 0x01)
1026   2          {
1027   3            RTC_SDA_H;
1028   3          }
1029   2          else
1030   2          {
1031   3            RTC_SDA_L;
1032   3          }
1033   2          addr >>= 1;
1034   2          RTC_SCL_H;
1035   2        }
1036   1      
1037   1        for(count = 0;count < 8;count++)
1038   1        {
1039   2          RTC_SCL_L;
1040   2          if(dat & 0x01)
1041   2          {
1042   3            RTC_SDA_H;
1043   3          }
1044   2          else
1045   2          {
1046   3            RTC_SDA_L;
1047   3          }
1048   2          dat >>= 1;
1049   2          RTC_SCL_H;
1050   2        }
1051   1      
1052   1        RTC_RST_L;
1053   1      }
1054          
1055          unsigned char rtcReadByte(unsigned char addr)
1056          {
1057   1        unsigned char count,dat = 0;
1058   1      
1059   1        P14_PushPull_Mode;
1060   1      
1061   1        RTC_SCL_L;
1062   1        RTC_RST_H;
1063   1      
1064   1        addr |= 0x01;
1065   1      
1066   1        for(count = 0;count < 8;count++)
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 19  

1067   1        {
1068   2          RTC_SCL_L;
1069   2          if(addr & 0x01)
1070   2          {
1071   3            RTC_SDA_H;
1072   3          }
1073   2          else
1074   2          {
1075   3            RTC_SDA_L;
1076   3          }
1077   2          addr >>= 1;
1078   2          RTC_SCL_H;
1079   2        }
1080   1      
1081   1        P14_Input_Mode;
1082   1      
1083   1        for(count = 0;count < 8;count++)
1084   1        {
1085   2          RTC_SCL_H;
1086   2          if(RTC_SDA)
1087   2          {
1088   3            dat |= 0x80;
1089   3          }
1090   2          RTC_SCL_L;  
1091   2          dat >>= 1;
1092   2        }
1093   1        RTC_RST_L;
1094   1      
1095   1        return dat;
1096   1      }
1097          
1098          void rtcGetTime(void)
1099          {
1100   1        unsigned char temp = 0;
1101   1        temp = rtcReadByte(RTCADDR_YEAR);
1102   1        global.time.year = ((temp>>4)*10) + (temp&0x0f);
1103   1        temp = rtcReadByte(RTCADDR_MONTH);
1104   1        global.time.month = ((temp>>4)*10) + (temp&0x0f);
1105   1        temp = rtcReadByte(RTCADDR_DAY);
1106   1        global.time.day = ((temp>>4)*10) + (temp&0x0f);
1107   1        temp = rtcReadByte(RTCADDR_HOUR);
1108   1        global.time.hour = ((temp>>4)*10) + (temp&0x0f);
1109   1        temp = rtcReadByte(RTCADDR_MINUTE);
1110   1        global.time.minute = ((temp>>4)*10) + (temp&0x0f);
1111   1        temp = rtcReadByte(RTCADDR_SEC);
1112   1        global.time.sec = ((temp>>4)*10) + (temp&0x0f);
1113   1      }
1114          
1115          void rtcSetTime(void)
1116          {
1117   1        unsigned char temp = 0;
1118   1        
1119   1        //å½“å¹´æœˆæ—¥æ—¶åˆ†éƒ½ç›¸åŒä¸”ç§’ç›¸å·®å°äº5ç§’åˆ™é€€å‡ºä¸è®¾ç½®ï¼Œå¦åˆ™è®¾ç½®
1120   1        if(global.set.year == global.time.year && global.set.month == global.time.month && global.set.day == glob
             -al.time.day &&
1121   1          global.set.hour == global.time.hour && global.set.minute == global.time.minute)
1122   1        {
1123   2          if(global.set.sec == global.time.sec)
1124   2            return;
1125   2          else if(global.set.sec > global.time.sec)
1126   2            temp = global.set.sec - global.time.sec;
1127   2          else if(global.set.sec < global.time.sec)
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 20  

1128   2            temp = global.time.sec - global.set.sec;
1129   2          if(temp < 5) return;
1130   2        }
1131   1      
1132   1        rctWriteByte(RTCADDR_WP,RTC_WP_CLOSE);  //å…³é—­å†™ä¿æŠ¤
1133   1        temp = ((global.set.year/10)<<4) | (global.set.year%10);
1134   1        rctWriteByte(RTCADDR_YEAR,temp);
1135   1        temp = ((global.set.month/10)<<4) | (global.set.month%10);
1136   1        rctWriteByte(RTCADDR_MONTH,temp);
1137   1        temp = ((global.set.day/10)<<4) | (global.set.day%10);
1138   1        rctWriteByte(RTCADDR_DAY,temp);
1139   1        temp = ((global.set.hour/10)<<4) | (global.set.hour%10);
1140   1        rctWriteByte(RTCADDR_HOUR,temp);
1141   1        temp = ((global.set.minute/10)<<4) | (global.set.minute%10);
1142   1        rctWriteByte(RTCADDR_MINUTE,temp);
1143   1        temp = ((global.set.sec/10)<<4) | (global.set.sec%10);
1144   1        rctWriteByte(RTCADDR_SEC,0);
1145   1        rctWriteByte(RTCADDR_WP,RTC_WP_OPEN); //å¼€å¯å†™ä¿æŠ¤
1146   1        rtcGetTime();
1147   1      }
1148          
1149          ///////////////////////////////////////////////IAP Flash//////////////////////////////////////////////////
             -////
1150          
1151          #define PAGE_ERASE_AP 0x22
1152          #define BYTE_PROGRAM_AP 0x21
1153          
1154          #define FLASHADDRHEARD 0x4550 //å­˜å‚¨é¦–åœ°å€
1155          
1156          //å­˜å‚¨åŒº--é¦–åœ°å€ç”¨äºå­˜å‚¨é¦–æ¬¡å¼€æœºæ ‡å¿—
1157          // volatile unsigned char code Data_Flash[128] _at_ 0x4550;
1158          
1159          unsigned char flash_readByte(unsigned int code* addr)
1160          {
1161   1        return (unsigned char)((*addr)>>8);
1162   1      }
1163          
1164          void iapEnable(void)
1165          {
1166   1        clr_EA;
1167   1        //ä½¿èƒ½IAP
1168   1        TA = 0xAA; //CHPCON is TA protected
1169   1        TA = 0x55;
1170   1        CHPCON |= 0x01; //IAPEN = 1, enable IAP mode
1171   1        TA = 0xAA; //IAPUEN is TA protected
1172   1        TA = 0x55;
1173   1        IAPUEN |= 0x01; //APUEN = 1, enable APROM update
1174   1        set_EA;
1175   1      }
1176          
1177          void iapErasePage(unsigned int addr)
1178          {
1179   1        //å†™å­—èŠ‚
1180   1        IAPCN = PAGE_ERASE_AP; // Program 201h with 55h
1181   1        IAPAH = HIBYTE(addr);
1182   1        IAPAL = LOBYTE(addr);
1183   1        IAPFD = 0xff;
1184   1      }
1185          
1186          void iapWriteByte(unsigned int addr,unsigned char dat)
1187          {
1188   1        //å†™å­—èŠ‚
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 21  

1189   1        IAPCN = BYTE_PROGRAM_AP; // Program 201h with 55h
1190   1        IAPAH = HIBYTE(addr);
1191   1        IAPAL = LOBYTE(addr);
1192   1        IAPFD = dat;
1193   1      }
1194          
1195          void iapTrigger(void)
1196          {
1197   1        clr_EA;
1198   1        //æ‰§è¡ŒIAP
1199   1        TA = 0xAA;
1200   1        TA = 0x55;
1201   1        IAPTRG |= 0x01; //write â€˜1â€™ to IAPGO to trigger IAP process
1202   1        set_EA;
1203   1      }
1204          
1205          void iapUnenable(void)
1206          {
1207   1        clr_EA;
1208   1        //å¤±èƒ½IAP
1209   1        TA = 0xAA; //IAPUEN is TA protected
1210   1        TA = 0x55;
1211   1        IAPUEN &= ~0x01; //APUEN = 0, disable APROM update
1212   1        TA = 0xAA; //CHPCON is TA protected
1213   1        TA = 0x55;
1214   1        CHPCON &= ~0x01; //IAPEN = 0, disable IAP mode
1215   1        set_EA;
1216   1      }
1217          
1218          unsigned char isFristStart(void)
1219          {
1220   1        if(flash_readByte(FLASHADDRHEARD) == 0xff)
1221   1        {
1222   2          iapEnable();
1223   2          iapWriteByte(FLASHADDRHEARD,0x96);  //å†™å·²å¼€æœºæ ‡å¿—
1224   2          iapTrigger();
1225   2          iapUnenable();
1226   2          return true;
1227   2        }
1228   1        else if(flash_readByte(FLASHADDRHEARD) == 0x96)
1229   1        {
1230   2          return false;
1231   2        }
1232   1        return false;
1233   1      }
1234          
1235          void resetFlash(void)
1236          {
1237   1        iapEnable();
1238   1        iapErasePage(FLASHADDRHEARD);
1239   1        iapTrigger();
1240   1        iapUnenable();
1241   1      }
1242          
1243          void saveDataToFlash(void)
1244          {
1245   1        //å…ˆè¯»å‡ºæ•°æ®
1246   1        
1247   1        //å†æ“¦é™¤
1248   1        resetFlash();
1249   1        iapEnable();
1250   1        //å†™é¦–æ¬¡å¼€æœºæ ‡å¿—
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 22  

1251   1        iapWriteByte(FLASHADDRHEARD,0x96);  //éƒ½èƒ½å­˜é¢„çº¦æ•°æ®äº†ï¼Œé‚£è‚¯å®šå¼€æœºäº†ï¼Œé‚£å°±è¦é‡æ–°å†™æ 
             -‡å¿—
1252   1        iapTrigger();
1253   1        //å­˜é¢„çº¦æ•°æ®
1254   1        iapWriteByte(FLASHADDRHEARD+1,global.set.startLightHour);
1255   1        iapTrigger();
1256   1        iapWriteByte(FLASHADDRHEARD+2,global.set.startLightMinute);
1257   1        iapTrigger();
1258   1        iapWriteByte(FLASHADDRHEARD+3,global.set.keepLightHour);
1259   1        iapTrigger();
1260   1        iapWriteByte(FLASHADDRHEARD+4,global.set.keepLightMinute);
1261   1        iapTrigger();
1262   1        iapWriteByte(FLASHADDRHEARD+5,global.set.endLightHour);
1263   1        iapTrigger();
1264   1        iapWriteByte(FLASHADDRHEARD+6,global.set.endLightMinute);
1265   1        iapTrigger();
1266   1        iapWriteByte(FLASHADDRHEARD+7,global.set.startWaterHour);
1267   1        iapTrigger();
1268   1        iapWriteByte(FLASHADDRHEARD+8,global.set.startWaterMinute);
1269   1        iapTrigger();
1270   1        iapWriteByte(FLASHADDRHEARD+9,global.set.keepWaterHour);
1271   1        iapTrigger();
1272   1        iapWriteByte(FLASHADDRHEARD+10,global.set.keepWaterMinute);
1273   1        iapTrigger();
1274   1        iapWriteByte(FLASHADDRHEARD+11,global.set.endWaterHour);
1275   1        iapTrigger();
1276   1        iapWriteByte(FLASHADDRHEARD+12,global.set.endWaterMinute);
1277   1        iapTrigger();
1278   1        iapWriteByte(FLASHADDRHEARD+13,global.set.waterCycleDay);
1279   1        iapTrigger();
1280   1        iapUnenable();
1281   1      }
1282          
1283          void readDataFromFlash(void)
1284          {
1285   1        global.set.startLightHour = flash_readByte(FLASHADDRHEARD+1);
1286   1        global.set.startLightMinute = flash_readByte(FLASHADDRHEARD+2);
1287   1        global.set.keepLightHour = flash_readByte(FLASHADDRHEARD+3);
1288   1        global.set.keepLightMinute = flash_readByte(FLASHADDRHEARD+4);
1289   1        global.set.endLightHour = flash_readByte(FLASHADDRHEARD+5);
1290   1        global.set.endLightMinute = flash_readByte(FLASHADDRHEARD+6);
1291   1        global.set.startWaterHour = flash_readByte(FLASHADDRHEARD+7);
1292   1        global.set.startWaterMinute = flash_readByte(FLASHADDRHEARD+8);
1293   1        global.set.keepWaterHour = flash_readByte(FLASHADDRHEARD+9);
1294   1        global.set.keepWaterMinute = flash_readByte(FLASHADDRHEARD+10);
1295   1        global.set.endWaterHour = flash_readByte(FLASHADDRHEARD+11);
1296   1        global.set.endWaterMinute = flash_readByte(FLASHADDRHEARD+12);
1297   1        global.set.waterCycleDay = flash_readByte(FLASHADDRHEARD+13);
1298   1      }
1299          
1300          
1301          ///////////////////////////////////////////////////////////////////////////////////è¢«åºŸå¼ƒçš„æ–¹æ³•/////
             -///////////////////////////////////////////////////////////
1302          
1303          
1304          //
1305          //è®¡ç®—å€’è®¡æ—¶ï¼Œç„¶åæ‰§è¡Œè®¡æ—¶ç»“æŸçš„ä¸€äº›æ“ä½œï¼Œæ”¾åœ¨ runMain ä¸­ï¼Œæ¯åˆ†é’Ÿè¿›å…¥ä¸€æ¬¡
1306          //
1307          // void figureCountdown(void)
1308          // {
1309          //  //////////////////////////////////////ç…§æ˜/////////////////////////////////////
1310          //  //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹ç…§æ˜å€’è®¡æ—¶çš„è®¡ç®—
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 23  

1311          //  if(global.set.startLightHour > global.time.hour)  //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶è¿˜æœªåˆ°
1312          //  {
1313          //    if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾
             -åˆ°
1314          //    {
1315          //      global.device.nextStartLightCountDown = (global.set.startLightHour - global.time.hour)*60 + (global.
             -set.startLightMinute - global.time.minute);
1316          //    }
1317          //    else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡ä
             -º†
1318          //    {
1319          //      global.device.nextStartLightCountDown = (global.set.startLightHour - global.time.hour)*60 - (global.
             -time.minute - global.set.startLightMinute);
1320          //    }
1321          //  }
1322          //  else if(global.set.startLightHour == global.time.hour)
1323          //  {
1324          //    if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾
             -åˆ°
1325          //    {
1326          //      global.device.nextStartLightCountDown = global.set.startLightMinute - global.time.minute;
1327          //    }
1328          //    else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡ä
             -º†
1329          //    {
1330          //      global.device.nextStartLightCountDown = 24*60 - (global.time.minute - global.set.startLightMinute);
1331          //    }
1332          //  }
1333          //  else if(global.set.startLightHour < global.time.hour) //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶å·²è¶…è¿‡
1334          //  {
1335          //    if(global.set.startLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾
             -åˆ°
1336          //    {
1337          //      global.device.nextStartLightCountDown = (24 - global.time.hour + global.set.startLightHour)*60 + (gl
             -obal.set.startLightMinute - global.time.minute);
1338          //    }
1339          //    else if (global.set.startLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡ä
             -º†
1340          //    {
1341          //      global.device.nextStartLightCountDown = (24 - global.time.hour + global.set.startLightHour)*60 - (gl
             -obal.time.minute - global.set.startLightMinute);
1342          //    }
1343          //  }
1344          //  //è·ç¦»ç»“æŸç…§æ˜å€’è®¡æ—¶çš„è®¡ç®—
1345          //  if(global.set.endLightHour > global.time.hour)  //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1346          //  {
1347          //    if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ
             -°
1348          //    {
1349          //      global.device.endLightCountDown = (global.set.endLightHour - global.time.hour)*60 + (global.set.endL
             -ightMinute - global.time.minute);
1350          //    }
1351          //    else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1352          //    {
1353          //      global.device.endLightCountDown = (global.set.endLightHour - global.time.hour)*60 - (global.time.min
             -ute - global.set.endLightMinute);
1354          //    }
1355          //  }
1356          //  else if(global.set.endLightHour == global.time.hour)
1357          //  {
1358          //    if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ
             -°
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 24  

1359          //    {
1360          //      global.device.endLightCountDown = global.set.endLightMinute - global.time.minute;
1361          //    }
1362          //    else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1363          //    {
1364          //      global.device.endLightCountDown = 24*60 - (global.time.minute - global.set.endLightMinute);
1365          //    }
1366          //  }
1367          //  else if(global.set.endLightHour < global.time.hour) //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶å·²è¶…è¿‡
1368          //  {
1369          //    if(global.set.endLightMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ
             -°
1370          //    {
1371          //      global.device.endLightCountDown = (24 - global.time.hour + global.set.endLightHour)*60 + (global.set
             -.endLightMinute - global.time.minute);
1372          //    }
1373          //    else if (global.set.endLightMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1374          //    {
1375          //      global.device.endLightCountDown = (24 - global.time.hour + global.set.endLightHour)*60 - (global.tim
             -e.minute - global.set.endLightMinute);
1376          //    }
1377          //  }
1378          
1379          //  //////////////////////////////////////æµ‡æ°´/////////////////////////////////////
1380          
1381          //  if(global.time.hour == 0 && global.time.minute == 0)  //é›¶ç‚¹ï¼Œåšæµ‡æ°´å‘¨æœŸè®¡ç®—
1382          //  {
1383          //    //æ¯å¤©é›¶ç‚¹å‡ä¸€å¤©ï¼Œå‡åˆ°1åˆ™å½“å¤©æµ‡æ°´ï¼Œæµ‡æ°´ç»“æŸåé‡ç½®ã€‚
1384          //    if(global.device.nextWaterDayCountDown > 1) --global.device.nextWaterDayCountDown;
1385          
1386          //    if(global.device.nextWaterDayCountDown == 0)  //å¦‚æœä¸º0ï¼Œåˆ™é‡ç½®
1387          //    {
1388          //      global.device.nextWaterDayCountDown = global.set.waterCycleDay;
1389          //    }
1390          //  }
1391          
1392          //  //è·ç¦»ä¸‹ä¸€æ¬¡å¼€å§‹æµ‡æ°´å€’è®¡æ—¶çš„è®¡ç®—
1393          //  if(global.set.startWaterHour > global.time.hour)  //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1394          //  {
1395          //    if(global.set.startWaterMinute > global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾å
             -ˆ°
1396          //    {
1397          //      global.device.nextStartWaterCountDown = (global.set.startWaterHour - global.time.hour)*60 + (global.
             -set.startWaterMinute - global.time.minute);
1398          //      global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60; //å†åŠ ä¸Šå
             -‘¨æœŸå¤©æ•°çš„åç§»
1399          //    }
1400          //    else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡ä
             -º†
1401          //    {
1402          //      global.device.nextStartWaterCountDown = (global.set.startWaterHour - global.time.hour)*60 - (global.
             -time.minute - global.set.startWaterMinute);
1403          //      global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1404          //    }
1405          //  }
1406          //  else if(global.set.startWaterHour == global.time.hour)
1407          //  {
1408          //    if(global.set.startWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾
             -åˆ°
1409          //    {
1410          //      global.device.nextStartWaterCountDown = global.set.startWaterMinute - global.time.minute;
1411          //      global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60; //å†åŠ ä¸Šå
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 25  

             -‘¨æœŸå¤©æ•°çš„åç§»
1412          //    }
1413          //    else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡ä
             -º†
1414          //    {
1415          //      global.device.nextStartWaterCountDown = 24*60 - (global.time.minute - global.set.startWaterMinute);
1416          //      global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1417          //    }
1418          //  }
1419          //  else if(global.set.startWaterHour < global.time.hour) //è¯´æ˜è®¾å®šå¼€å§‹çš„å°æ—¶å·²è¶…è¿‡
1420          //  {
1421          //    if(global.set.startWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾
             -åˆ°
1422          //    {
1423          //      global.device.nextStartWaterCountDown = (24 - global.time.hour + global.set.startWaterHour)*60 + (gl
             -obal.set.startWaterMinute - global.time.minute);
1424          //      global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1425          //    }
1426          //    else if (global.set.startWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šå¼€å§‹çš„åˆ†é’Ÿå·²ç»è¶…è¿‡ä
             -º†
1427          //    {
1428          //      global.device.nextStartWaterCountDown = (24 - global.time.hour + global.set.startWaterHour)*60 - (gl
             -obal.time.minute - global.set.startWaterMinute);
1429          //      global.device.nextStartWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1430          //    }
1431          //  }
1432          //  //è·ç¦»ç»“æŸæµ‡æ°´å€’è®¡æ—¶çš„è®¡ç®—
1433          //  if(global.set.endWaterHour > global.time.hour)  //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶è¿˜æœªåˆ°æˆ–æ­£è¾¾åˆ°
1434          //  {
1435          //    if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ
             -°
1436          //    {
1437          //      global.device.endWaterCountDown = (global.set.endWaterHour - global.time.hour)*60 + (global.set.endW
             -aterMinute - global.time.minute);
1438          //      global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1439          //    }
1440          //    else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1441          //    {
1442          //      global.device.endWaterCountDown = (global.set.endWaterHour - global.time.hour)*60 - (global.time.min
             -ute - global.set.endWaterMinute);
1443          //      global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1444          //    }
1445          //  }
1446          //  else if(global.set.endWaterHour == global.time.hour)
1447          //  {
1448          //    if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ
             -°
1449          //    {
1450          //      global.device.endWaterCountDown = global.set.endWaterMinute - global.time.minute;
1451          //      global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1452          //    }
1453          //    else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1454          //    {
1455          //      global.device.endWaterCountDown = 24*60 - (global.time.minute - global.set.endWaterMinute);
1456          //      global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1457          //    }
1458          //  }
1459          //  else if(global.set.endWaterHour < global.time.hour) //è¯´æ˜è®¾å®šç»“æŸçš„å°æ—¶å·²è¶…è¿‡
1460          //  {
1461          //    if(global.set.endWaterMinute >= global.time.minute) //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿè¿˜æ²¡åˆ°æˆ–æ­£è¾¾åˆ
             -°
1462          //    {
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 26  

1463          //      global.device.endWaterCountDown = (24 - global.time.hour + global.set.endWaterHour)*60 + (global.set
             -.endWaterMinute - global.time.minute);
1464          //      global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1465          //    }
1466          //    else if (global.set.endWaterMinute < global.time.minute)  //è¯´æ˜è®¾å®šç»“æŸçš„åˆ†é’Ÿå·²ç»è¶…è¿‡äº†
1467          //    {
1468          //      global.device.endWaterCountDown = (24 - global.time.hour + global.set.endWaterHour)*60 - (global.tim
             -e.minute - global.set.endWaterMinute);
1469          //      global.device.endWaterCountDown += (global.device.nextWaterDayCountDown-1)*24*60;
1470          //    }
1471          //  }
1472          
1473          //  /////////////////////////////////////////////////////////////æ ¹æ®å€’è®¡æ—¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå¯¹åº”æ“
             -ä½œ//////////////////////////////////////////////////////////////
1474          //  if(global.device.nextStartWaterCountDown == 0)  //ç»“æŸç…§æ˜,è¿™é‡Œçš„ä¸ç®¡åœ¨çº¿ç¦»çº¿ï¼Œåªæ˜¯ä¸ºä
             -º†é‡ç½®æµ‡æ°´å‘¨æœŸçš„è®¡æ—¶
1475          //  {
1476          //    global.device.nextWaterDayCountDown = global.set.waterCycleDay;
1477          //  }
1478          //  /////////////å‰ææ˜¯å¤„äºç¦»çº¿çŠ¶æ€ï¼Œåœ¨çº¿çŠ¶æ€çš„æ§åˆ¶æœ‰wifiæ¨¡å—è´Ÿè´£///////////////
1479          //  if(global.device.wifi == offline)
1480          //  {
1481          //    if(global.device.nextStartLightCountDown == 0)  //è®¡æ—¶åˆ°0ï¼Œè¯´æ˜å¯ä»¥å¼€å§‹ç…§æ˜äº†
1482          //    {
1483          //      global.device.light = true;
1484          //      LIGHT_OPEN;
1485          //    }
1486          //    if(global.device.endLightCountDown == 0)  //ç»“æŸç…§æ˜
1487          //    {
1488          //      global.device.light = false;
1489          //      LIGHT_CLOSE;
1490          //    }
1491          //    if(global.device.nextStartWaterCountDown == 0)  //è®¡æ—¶åˆ°0ï¼Œè¯´æ˜å¯ä»¥å¼€å§‹æµ‡æ°´äº†
1492          //    {
1493          //      global.device.water = true;
1494          //      WATER_OPEN;
1495          //    }
1496          //    if(global.device.endWaterCountDown == 0)  //ç»“æŸç…§æ˜
1497          //    {
1498          //      global.device.water = false;
1499          //      WATER_CLOSE;
1500          //    }
1501          //  }
1502          // }
1503          
1504          // //é€šè¿‡å¼€å§‹å’ŒæŒç»­æ—¶é—´ï¼Œè®¡ç®—ç»“æŸæ—¶é—´
1505          // void figureEndTime(void)
1506          // {
1507          //  //////é¦–å…ˆè®¡ç®—åˆ†é’Ÿ//////////
1508          //  if(global.set.startLightMinute + global.set.keepLightMinute >= 60)  //ä¸åœ¨åŒä¸€å°æ—¶äº†ï¼Œéœ€è¦è®©
             -å°æ—¶åŠ ä¸€
1509          //  {
1510          //    global.set.endLightMinute = global.set.startLightMinute + global.set.keepLightMinute - 60;
1511          //    if((global.set.startLightHour + global.set.keepLightHour + 1) >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1512          //    {
1513          //      global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour + 1 - 24;
1514          //    }
1515          //    else  //åœ¨åŒä¸€å¤©
1516          //    {
1517          //      global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour + 1;
1518          //    }
1519              
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 27  

1520          //  }
1521          //  else  //åœ¨åŒä¸€å°æ—¶
1522          //  {
1523          //    global.set.endLightMinute = global.set.startLightMinute + global.set.keepLightMinute;
1524          //    if(global.set.startLightHour + global.set.keepLightHour >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1525          //    {
1526          //      global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour - 24;
1527          //    }
1528          //    else  //åœ¨åŒä¸€å¤©
1529          //    {
1530          //      global.set.endLightHour = global.set.startLightHour + global.set.keepLightHour;
1531          //    }
1532          //  }
1533          
1534            
1535          //  if(global.set.startWaterMinute + global.set.keepWaterMinute >= 60)  //ä¸åœ¨åŒä¸€å°æ—¶äº†ï¼Œéœ€è¦è®©
             -å°æ—¶åŠ ä¸€
1536          //  {
1537          //    global.set.endWaterMinute = global.set.startWaterMinute + global.set.keepWaterMinute - 60;
1538          //    if((global.set.startWaterHour + global.set.keepWaterHour + 1) >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1539          //    {
1540          //      global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour + 1 - 24;
1541          //    }
1542          //    else  //åœ¨åŒä¸€å¤©
1543          //    {
1544          //      global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour + 1;
1545          //    }
1546              
1547          //  }
1548          //  else  //åœ¨åŒä¸€å°æ—¶
1549          //  {
1550          //    global.set.endWaterMinute = global.set.startWaterMinute + global.set.keepWaterMinute;
1551          //    if(global.set.startWaterHour + global.set.keepWaterHour >= 24)  //å¼€å§‹ç»“æŸä¸åœ¨åŒä¸€å¤©
1552          //    {
1553          //      global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour - 24;
1554          //    }
1555          //    else  //åœ¨åŒä¸€å¤©
1556          //    {
1557          //      global.set.endWaterHour = global.set.startWaterHour + global.set.keepWaterHour;
1558          //    }
1559          //  }
1560          // }
1561          
1562          
1563          ///////////////////////////////////////////////ä¸²å£9åŠŸèƒ½//////////////////////////////////////////////
             -////////
1564          
1565          // void uart9_fun(unsigned char* buff)
1566          // {
1567          //  switch(buff[3]) //ä¸‹æ ‡2å’Œ3ä¸ºæ¶ˆæ¯ç±»å‹ï¼Œä½†ç›®å‰2ä¸º0x00æ‰€ä»¥åˆ¤æ–­3å³å¯
1568          //  {
1569          //    case 0x01:  //è®¾å¤‡çŠ¶æ€è·å–è¯·æ±‚  //é¡¶æ¿ç´¢è¦è®¾å¤‡çŠ¶æ€æ•°æ®ï¼Œå¹¶ç»™å‡ºå½“å‰æ¸©åº¦
1570          //    {
1571          //      global.device.temperature = buff[4]<<8 | buff[5]; //æ‹¿åˆ°æ¸©åº¦
1572          //      global.device.getStateFlag = true;  //æ ‡è®°è·å–çŠ¶æ€æ ‡å¿—ï¼Œå°†è¦å‘é€è®¾å¤‡çŠ¶æ€ç»™é¡¶æ¿
1573          //    }break;
1574          //    case 0x03:  //è®¾ç½®å‚æ•°è·å–è¯·æ±‚
1575          //    {
1576          //      global.set.getDataFlag = true;
1577          //    }break;
1578          //    case 0x05:  //è®¾å¤‡çŠ¶æ€è®¾ç½®è¯·æ±‚ï¼ŒæŒ‰ä¸‹ç…§æ˜æˆ–æµ‡æ°´æˆ–è¿wifi
1579          //    {
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 28  

1580          //      global.work.keyDo = buff[4];
1581          //      global.work.serventSetDevieSateFlag = true; //åˆ¤æ–­é”®å€¼ï¼Œå¹¶ä¸”å‘é€ç»™æ¨¡å—å†³æ–­
1582          //    }break;
1583          //    case 0x06:  //è®¾ç½®å‚æ•°è®¾ç½®è¯·æ±‚
1584          //    {
1585          //      global.set.hour = buff[4];
1586          //      global.set.minute = buff[5];
1587          //      global.set.startLightHour = buff[6];
1588          //      global.set.startLightMinute = buff[7];
1589          //      global.set.keepLightHour = buff[8];
1590          //      global.set.keepLightMinute = buff[9];
1591          //      global.set.startWaterHour = buff[10];
1592          //      global.set.startWaterMinute = buff[11];
1593          //      global.set.keepWaterHour = buff[12];
1594          //      global.set.keepWaterMinute = buff[13];
1595          //      global.set.waterCycleDay = buff[14];
1596          
1597          //      global.set.setDatFlag = true;
1598          //    }break;
1599          //  }
1600          // }
1601          
1602          // ////å‘é€ä¸€ä¸ªå­—èŠ‚
1603          // void uart9SendByte(unsigned char dat)
1604          // {
1605          //  // while(runData.iouart.recEnable); //å½“æ¥æ”¶ä½¿èƒ½æ—¶ï¼Œä¸å‘é€æ•°æ®ï¼Œç­‰å¾…æ¥æ”¶å®Œæ¯•å†å‘é
             -€  //æµ‹è¯•åå‘ç°å¹¶æ²¡æœ‰è½¯ç”¨
1606          //  global.iouart.sendData = dat;
1607          //  global.iouart.sendCount = 0;
1608          //  global.iouart.sendComplete = false;
1609          //  global.iouart.sendEnable = true;
1610          //  while(!global.iouart.sendComplete); //ç­‰å¾…æ•°æ®å‘é€å®Œæˆ
1611          // }
1612          
1613          // ////å‘é€ä¸€ä¸²å­—èŠ‚
1614          // void uart9Send(unsigned char* buff,unsigned char len)
1615          // {
1616          //  while(len)
1617          //  {
1618          //    uart9SendByte(*buff);
1619          //    --len; 
1620          //    if(len != 0) ++buff;
1621          //  }
1622          // }
1623          
1624          // #define UART9_RD P03
1625          // #define UART9_TD_H set_P04
1626          // #define UART9_TD_L clr_P04
1627          
1628          // void initUart9(void)
1629          // {
1630          //  P04_Quasi_Mode; //åœ¨ç”µè·¯ä¸­çš„æ ‡å·ä¸ºRx,ä½†æ˜¯ç”µè·¯ä¸æ”¹çš„è¯éœ€è¦è½¯ä»¶è®¾ç½®ä¸ºTx
1631          //  P03_Quasi_Mode; //åœ¨ç”µè·¯ä¸­çš„æ ‡å·ä¸ºTx,ä½†æ˜¯ç”µè·¯ä¸æ”¹çš„è¯éœ€è¦è½¯ä»¶è®¾ç½®ä¸ºRx
1632          
1633          //  TMOD |= 0x02; //æ¨¡å¼2,8ä½è‡ªåŠ¨é‡è£…è½½
1634          //  clr_T0M;  //12åˆ†é¢‘
1635          //  TH0 = 256 - 139;  //9600
1636          //  set_ET0;  //ä½¿èƒ½å®šæ—¶å™¨0ä¸­æ–­
1637          //  set_EA; //ä½¿èƒ½æ€»ä¸­æ–­
1638          //  set_TR0;  //å¼€å¯å®šæ—¶å™¨0
1639          // }
1640          
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 29  

1641          // //1èµ·å§‹ä½--8æ•°æ®ä½--1åœæ­¢ä½
1642          // void uart9_isr(void)
1643          // {
1644          //  unsigned char i,sum = 0;
1645          
1646          //  ////////æ¥æ”¶éƒ¨åˆ†////////
1647          //  if(global.iouart.recEnable == false)
1648          //  {
1649          //    if(!UART9_RD) //RDè„šè¢«æ‹‰ä½--å³æ¥æ”¶åˆ°èµ·å§‹ä½--èµ·å§‹ä½ä¸º0
1650          //    {
1651          //      global.iouart.recEnable = true;
1652          //      global.iouart.recCount = 0;
1653          //      global.iouart.recData = 0x00;
1654          //    }
1655          //  }
1656          //  else
1657          //  {
1658          //    //æ¥æ”¶æ•°æ®
1659          //    if(global.iouart.recCount <= 7)
1660          //    {
1661          //      global.iouart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½
             -“å‰æ•°æ®ä½ï¼Œæ”¶åˆ°æ•°æ®ä½åˆ™åˆ·æ–°
1662          //      ++global.iouart.recCount;
1663          //      global.iouart.recData >>= 1;
1664          //      if(UART9_RD)
1665          //      {
1666          //        global.iouart.recData |= 0x80;  //ä½ä½åœ¨å…ˆ
1667          //      }
1668          //    }
1669          //    else if(global.iouart.recCount == 8)
1670          //    {
1671          //      if(UART9_RD)  //RDè„šè¢«æ‹‰é«˜--å³æ¥æ”¶åˆ°åœæ­¢ä½--åœæ­¢ä½ä¸º1
1672          //      {
1673          //        global.iouart.recComplete = true;
1674          //      }
1675          //      global.iouart.recTimeOutCount = 0;  //å…³é—­è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ™ä¸è®¡æ—¶
1676          //      global.iouart.recEnable = false;
1677          //    }
1678          //  }
1679          
1680          //  ////æ•°æ®å¤„ç†
1681          //  if(global.iouart.recComplete == true)
1682          //  {
1683          //    global.iouart.recComplete = false;
1684              
1685          //    //åˆ¤æ–­æ¥æ”¶çš„æ•°æ®æ˜¯å¦ç¬¦åˆé€šä¿¡æ ¼å¼
1686          //    if(global.iouart.nowIndex == 0 && global.iouart.recData == 0x96)  //å¤´
1687          //    {
1688          //      global.iouart.recTimeOutCount = 1;  //å¼€å¯è¶…æ—¶è®¡æ—¶ï¼Œä¸º1åˆ™è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ”¾å¼ƒå½
             -“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1689          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;
1690          //      ++global.iouart.nowIndex;
1691          //    }
1692          //    else if(global.iouart.nowIndex == 1)  //æ•°æ®é•¿åº¦
1693          //    {
1694          //      global.iouart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ
             -™æ”¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1695          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //é•¿åº¦ï¼šä»å¤´åˆ°æ ¡éªŒ
1696          //      ++global.iouart.nowIndex;
1697          //    }
1698          //    else if(global.iouart.nowIndex >= 2 && global.iouart.nowIndex <= global.iouart.recBuff[1]-2)  //å‡å»
             -äº†æ ¡éªŒå­—èŠ‚ï¼Œå› ä¸ºä¸‹æ ‡æ¯”å®é™…é•¿åº¦å°1ï¼Œæ‰€ä»¥-2
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 30  

1699          //    {
1700          //      global.iouart.recTimeOutCount = 1;  //é‡ç½®è¶…æ—¶è®¡æ—¶ï¼Œå¦‚æœä¸º0åˆ™ä¸è®¡æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ
             -™æ”¾å¼ƒå½“å‰æ•°æ®åŒ…ï¼Œæ”¶åˆ°æ•°æ®åŒ…åˆ™åˆ·æ–°
1701          //      global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //æ•°æ®
1702          //      ++global.iouart.nowIndex;
1703          //    }
1704          //    else if(global.iouart.nowIndex == global.iouart.recBuff[1]-1) //æ ¡éªŒ
1705          //    {
1706          //      //ä¹‹åæ›´æ”¹æ¨¡å¼ï¼Œå°†è€—æ—¶æ“ä½œéƒ½ç§»èµ°
1707          
1708          //      global.iouart.recTimeOutCount = 0;  //å…³é—­è¶…æ—¶è®¡æ—¶ï¼Œä¸º0åˆ™ä¸è®¡æ—¶
1709          //      for(i = 0;i <= global.iouart.recBuff[1] - 2;i++)  //è®¡ç®—æ ¡éªŒå’Œ
1710          //      {
1711          //        sum += global.iouart.recBuff[i];
1712          //      }
1713          //      if(sum == global.iouart.recData)  //æ ¡éªŒé€šè¿‡
1714          //      {
1715          //        global.iouart.recBuff[global.iouart.nowIndex] = global.iouart.recData;  //æ ¡éªŒ
1716          //        uart9_fun(global.iouart.recBuff); //åŠŸèƒ½åˆ¤æ–­
1717          //      }
1718          //      global.iouart.nowIndex = 0;
1719          //    }
1720          //  }
1721          
1722          //  ////////å‘é€éƒ¨åˆ†////////
1723          //  if(global.iouart.sendEnable)
1724          //  {
1725          //    if (global.iouart.sendCount == 0)
1726          //    {
1727          //      UART9_TD_L; //äº§ç”Ÿä¸€ä¸ªèµ·å§‹ä½--0
1728          //      ++global.iouart.sendCount;
1729          //    }
1730          //    else if(global.iouart.sendCount >= 1 && global.iouart.sendCount <= 8)
1731          //    {
1732          //      if( (global.iouart.sendData >> (global.iouart.sendCount-1)) & 0x01) //å…ˆå‘ä½ä½
1733          //      {
1734          //        UART9_TD_H;
1735          //      }
1736          //      else
1737          //      {
1738          //        UART9_TD_L;
1739          //      }
1740          //      ++global.iouart.sendCount;
1741          //    }
1742          //    else if (global.iouart.sendCount == 9)
1743          //    {
1744          //      UART9_TD_H; //äº§ç”Ÿä¸€ä¸ªåœæ­¢ä½--1
1745          //      global.iouart.sendCount = 0;
1746          //      global.iouart.sendEnable = false;
1747          //      global.iouart.sendComplete = true;
1748          //    }
1749          //  }
1750          // }
1751          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4585    ----
   CONSTANT SIZE    =     32    ----
   XDATA SIZE       =      1      59
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
C51 COMPILER V9.60.0.0   FUNC                                                              11/07/2019 15:42:57 PAGE 31  

   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
